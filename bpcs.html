<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaSim Pro - Full Integrated Suite</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
        /* --- Base & Layout --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            color: #333;
            min-height: 100vh;
        }
        .main-container { 
            max-width: 1600px; 
            margin: 25px auto; 
            padding: 0 20px; 
        }
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 360px 1fr; 
            gap: 25px; 
        }
        .module-section { 
            display: none; 
        }
        .module-section.active { 
            display: block; 
            animation: fadeIn 0.5s ease; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- Header & Navigation --- */
        .header {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(240,248,255,0.98) 100%);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .header h1 {
            font-size: 2.2em;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 5px;
        }
        .header-subtitle, .attribution { color: #666; font-size: 1em; margin-bottom: 5px; }
        .attribution { font-size: 0.85em; font-style: italic; }
        .nav-tabs { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
            border-bottom: 2px solid rgba(30,60,114,0.1); 
            padding-bottom: 10px; 
            flex-wrap: wrap; 
        }
        .nav-tab {
            padding: 10px 20px; 
            background: white; 
            color: #2a5298; 
            border: 2px solid #2a5298;
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }
        .nav-tab:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(42,82,152,0.3); 
        }
        .nav-tab.active { 
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); 
            color: white; 
            border-color: transparent; 
        }

        /* --- Panels & Containers --- */
        .control-panel, .chart-container, .results-panel, .info-box, .publication-form, .publication-card, .tutorial-content {
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .control-panel {
            height: fit-content; 
            position: sticky; 
            top: 190px;
        }
        .control-panel h2, .chart-container h3, .results-panel h3 { 
            color: #1e3c72; 
            font-size: 1.3em; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid rgba(30,60,114,0.1); 
        }
        .visualization-area { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
            gap: 25px; 
        }
        .chart-container { min-height: 400px; position: relative; }
        .results-panel { grid-column: 1 / -1; margin-top: 25px; }

        /* --- Forms & Buttons --- */
        .control-group { margin-bottom: 18px; }
        .control-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: #555; 
            font-weight: 600; 
            font-size: 14px; 
        }
        .control-group input, .control-group select, .control-group textarea {
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #e0e6ed;
            border-radius: 8px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
            background: #f8f9fa;
            font-family: inherit;
        }
        .control-group textarea { resize: vertical; min-height: 80px; }
        .control-group input:focus, .control-group select:focus, .control-group textarea:focus {
            outline: none; 
            border-color: #2a5298; 
            background: white; 
            box-shadow: 0 0 0 3px rgba(42,82,152,0.1);
        }
        button {
            padding: 12px 18px; 
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 600; 
            font-size: 14px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(42,82,152,0.3);
            width: 100%;
        }
        button:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(42,82,152,0.4); 
        }
        button:disabled { 
            background: #aaa; 
            cursor: not-allowed; 
            box-shadow: none; 
        }
        .button-group { display: flex; gap: 10px; margin-top: 20px; }
        .button-group button { flex: 1; }

        /* --- Metrics & Cards --- */
        .metric-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 15px; 
        }
        .metric-card { 
            background: linear-gradient(135deg, #f8f9fa, #e9eef6); 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
        }
        .metric-label { 
            font-size: 12px; 
            color: #666; 
            text-transform: uppercase; 
            margin-bottom: 8px; 
        }
        .metric-value { 
            font-size: 1.8em; 
            font-weight: bold; 
            background: linear-gradient(135deg, #2a5298, #1e3c72); 
            -webkit-background-clip: text; 
            color: transparent; 
        }

        /* --- Special Components --- */
        .disclaimer-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ff9800; 
            border-radius: 12px; 
            padding: 15px 20px;
            margin: 20px 40px; 
            box-shadow: 0 4px 15px rgba(255,152,0,0.2);
        }
        .disclaimer-banner h4 { color: #e65100; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .disclaimer-banner h4::before { content: '⚠️'; font-size: 1.2em; }
        .disclaimer-banner p { color: #5d4037; line-height: 1.6; font-size: 14px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); 
            display: none; 
            justify-content: center;
            align-items: center; 
            z-index: 9999; 
            color: white; 
            text-align: center;
        }
        .spinner {
            width: 50px; height: 50px; 
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2a5298; 
            border-radius: 50%;
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { 
            background: #e3f2fd; 
            border-left: 4px solid #2a5298; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 20px; 
        }
        .info-box p { color: #555; line-height: 1.6; font-size: 14px; }
        .mono { 
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
            white-space: pre; 
            overflow: auto; 
            background: #0a142b; 
            color: #e6edf3; 
            border-radius: 10px; 
            border: 1px solid rgba(255,255,255,.15); 
            padding: 10px; 
            font-size: 12.5px; 
        }
        canvas { width: 100% !important; height: auto !important; aspect-ratio: 16 / 9; }
        #molecularDisplay { 
            width: 100%; height: 100%; 
            min-height: 450px; 
            position: relative; 
            background-color: #f0f0f0; 
            border-radius: 10px; 
        }

        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 960px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .control-panel { position: static; }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <h1>PharmaSim Pro</h1>
        <p class="header-subtitle">Integrated Pharmaceutical Research & Publication Platform</p>
        <p class="attribution">Created by <strong>David Ferguson, BS, MS, Pharm.D. Candidate</strong></p>
        <nav class="nav-tabs">
            <button class="nav-tab" onclick="switchModule('pbpk')">PBPK/QSP Modeling</button>
            <button class="nav-tab" onclick="switchModule('clinical')">Clinical Trial Design</button>
            <button class="nav-tab active" onclick="switchModule('molecular')">Molecular Docking</button>
            <button class="nav-tab" onclick="switchModule('namd')">NAMD & VMD</button>
            <button class="nav-tab" onclick="switchModule('publications')">Publications</button>
            <button class="nav-tab" onclick="switchModule('tutorial')">Learning Center</button>
        </nav>
    </header>
    
    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        <h4>Important Research Disclaimer</h4>
        <p>
            <strong>These computational models provide approximations for educational and exploratory purposes only.</strong> 
            The molecular docking module uses a geometric and chemical approximation. Other modules use mathematical models.
            Results must be validated through proper experimental studies before any critical decisions.
        </p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="spinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <main class="main-container">
        <!-- PBPK/QSP Module -->
        <section class="module-section" id="pbpk-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>PBPK/QSP Parameters</h2>
                    <div class="control-group">
                        <label>Dose (mg)</label>
                        <input type="number" id="dose" value="100">
                    </div>
                    <div class="control-group">
                        <label>Bioavailability (F %)</label>
                        <input type="number" id="bioavailability" value="80">
                    </div>
                     <div class="control-group">
                        <label>Absorption Rate (ka, h⁻¹)</label>
                        <input type="number" id="ka" value="1.5" step="0.1">
                    </div>
                     <div class="control-group">
                        <label>Elimination Rate (ke, h⁻¹)</label>
                        <input type="number" id="ke" value="0.2" step="0.05">
                    </div>
                     <div class="control-group">
                        <label>Volume of Distribution (Vd, L)</label>
                        <input type="number" id="vd" value="50">
                    </div>
                    <div class="button-group">
                        <button onclick="runPBPKSimulation()">Run PBPK Simulation</button>
                    </div>
                </div>
                <div class="visualization-area">
                    <div class="chart-container"><h3>Plasma Concentration</h3><canvas id="pkChart"></canvas></div>
                    <div class="chart-container"><h3>Target Occupancy</h3><canvas id="qspChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <!-- Clinical Trial Module -->
        <section class="module-section" id="clinical-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                     <h2>Clinical Trial Design</h2>
                     <div class="control-group">
                        <label>Number of Dose Levels</label>
                        <input type="number" id="dose-levels" value="6">
                    </div>
                     <div class="control-group">
                        <label>Patients per Cohort</label>
                        <input type="number" id="cohort-size" value="3">
                    </div>
                    <div class="control-group">
                        <label>Starting Dose (mg)</label>
                        <input type="number" id="start-dose" value="10">
                    </div>
                    <div class="control-group">
                        <label>Target Toxicity Rate (%)</label>
                        <input type="number" id="target-tox" value="25">
                    </div>
                    <div class="button-group">
                        <button onclick="runTrialSimulation()">Run Trial Simulation</button>
                    </div>
                </div>
                <div class="visualization-area">
                    <div class="chart-container"><h3>Dose Escalation</h3><canvas id="trialChart"></canvas></div>
                    <div class="chart-container"><h3>Toxicity Probability</h3><canvas id="toxicityChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <!-- Molecular Dynamics Module -->
        <section class="module-section active" id="molecular-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>Docking Simulation</h2>
                     <div class="control-group">
                        <label for="pdbFile">1. Upload Protein (PDB file)</label>
                        <input type="file" id="pdbFile" accept=".pdb">
                    </div>
                    <div class="control-group">
                        <label for="smilesInput">2. Enter Ligand (SMILES string)</label>
                        <input type="text" id="smilesInput" placeholder="Aspirin: CC(=O)OC1=CC=CC=C1C(=O)O">
                    </div>
                    <button id="runButton" onclick="runApproximation()" disabled>3. Run Docking Approximation</button>
                    <div class="info-box">
                        <p><strong>Note:</strong> This tool runs a geometric and chemical approximation of docking entirely in your browser. No server is needed.</p>
                    </div>
                </div>
                <div class="visualization-area">
                    <div class="chart-container">
                        <h3>3D Docking Visualization</h3>
                        <div id="molecularDisplay"></div>
                    </div>
                    <div class="results-panel">
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-label">Estimated Affinity</div>
                                <div class="metric-value" id="binding-affinity">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Ligand MW</div>
                                <div class="metric-value" id="ligand-mw">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Ligand LogP</div>
                                <div class="metric-value" id="ligand-logp">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- NAMD & VMD Module -->
        <section class="module-section" id="namd-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>NAMD Config Generator</h2>
                    <div class="control-group">
                        <label>Output Prefix</label>
                        <input id="namd-out" value="output"/>
                    </div>
                    <div class="control-group">
                        <label>Temperature (K)</label>
                        <input id="namd-temp" type="number" value="310"/>
                    </div>
                    <div class="control-group">
                        <label>Production Time (ns)</label>
                        <input id="namd-ns" type="number" value="10"/>
                    </div>
                    <div class="control-group">
                        <label>switch/cut/pair (Å)</label>
                        <input id="namd-cuts" value="10/12/14"/>
                    </div>
                     <div class="control-group">
                        <label><input type="checkbox" id="namd-restraints" checked/> Use Restraints</label>
                    </div>
                    <div class="button-group">
                        <button onclick="generateNAMDFiles()">Generate Files</button>
                        <button id="zipBtn" onclick="downloadNAMDFiles()" disabled>Download ZIP</button>
                    </div>
                    <div id="fileList" style="margin-top:20px; display:flex; flex-direction:column; gap:8px;"></div>
                </div>
                <div class="chart-container">
                    <h3>VMD Helper Scripts</h3>
                    <p style="margin:0 0 15px; font-size: 14px; color: #555;">Copy/paste into <strong style="color: #1e3c72;">VMD → Extensions → Tk Console</strong> or save as a <strong style="color: #1e3c72;">.tcl</strong> file.</p>
                    <div>
                        <h4>1) Build restraints.pdb (B‑factor = k)</h4>
                        <pre class="mono" id="vmd_restraints">set sel [atomselect top "all"]
$sel set beta 0.0
set backbone [atomselect top "protein and name N CA C O"]
$backbone set beta 2.0
$sel writepdb restraints.pdb</pre>
                        <button style="width:auto; margin-top:5px;" onclick="copyVMDScript('vmd_restraints')">Copy restraints.tcl</button>
                    </div>
                    <div style="margin-top:20px;">
                        <h4>2) Quick Visualization Script</h4>
                        <pre class="mono" id="vmd_cartoon">mol new system.pdb
mol delrep 0 top
mol representation NewCartoon 0.3 10 4 0
mol color Structure
mol selection {protein}
mol addrep top
# Optional: Show ligand if loaded as a separate molecule
# mol selection {resname LIG}
# mol representation Licorice 0.3 12 12
# mol addrep top</pre>
                         <button style="width:auto; margin-top:5px;" onclick="copyVMDScript('vmd_cartoon')">Copy cartoon.tcl</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Publications Module -->
        <section class="module-section" id="publications-module">
            <div class="publication-form">
                <h2>Create New Publication</h2>
                <div class="control-group">
                    <label>Title</label>
                    <input type="text" id="pub-title" placeholder="e.g., In Silico Analysis of Novel Kinase Inhibitors">
                </div>
                 <div class="control-group">
                    <label>Authors</label>
                    <input type="text" id="pub-authors" placeholder="e.g., Ferguson, D., et al.">
                </div>
                 <div class="control-group">
                    <label>Abstract / Key Findings</label>
                    <textarea id="pub-abstract" rows="6"></textarea>
                </div>
                <button onclick="submitPublication()">Submit Publication</button>
            </div>
            <div id="publications-list" style="margin-top: 30px;">
                <h2>Recent Publications</h2>
                <!-- Publications will be added here -->
            </div>
        </section>
        
        <!-- Learning Center Module -->
        <section class="module-section" id="tutorial-module">
            <div class="tutorial-content">
                <h2>Learning Center</h2>
                <p>Welcome! This section provides guided tutorials to help you understand the concepts behind the simulations.</p>
                <div id="tutorial-display" class="info-box" style="margin-top:20px;">
                    Select a topic to begin.
                </div>
                 <div class="button-group">
                    <button onclick="loadTutorial('pbpk')">PBPK Basics</button>
                    <button onclick="loadTutorial('docking')">Molecular Docking</button>
                </div>
            </div>
        </section>
    </main>
    
    <script>
    // --- GLOBAL VARIABLES ---
    let viewer;
    let rdkit;
    let charts = {};
    let generatedNAMDFiles = {};

    // --- INITIALIZATION ---
    /**
     * This function runs when the page loads. It initializes the Chart.js instances,
     * sets up the RDKit WASM module, and sets the default active module.
     */
    window.onload = () => {
        // Initialize Chart.js instances for each canvas
        charts.pk = createChart('pkChart', 'line');
        charts.qsp = createChart('qspChart', 'line');
        charts.trial = createChart('trialChart', 'scatter');
        charts.toxicity = createChart('toxicityChart', 'line');

        // Load publications from localStorage
        loadPublications();

        // Set the initial active module
        switchModule('molecular');

        // Asynchronously initialize the RDKit module
        window.initRDKitModule().then(RDKit => {
            rdkit = RDKit;
            document.getElementById('runButton').disabled = false;
            console.log("RDKit.js chemical library loaded successfully.");
        }).catch(() => {
            alert("Fatal Error: Failed to load RDKit.js. The molecular docking module cannot run.");
            document.getElementById('runButton').disabled = true;
        });
    };

    // --- UI & NAVIGATION ---

    /**
     * Shows the loading overlay with a custom message.
     * @param {string} text - The message to display.
     */
    function showLoading(text = "Processing...") {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    /**
     * Hides the loading overlay.
     */
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    /**
     * Switches the currently visible module.
     * @param {string} module - The ID of the module to activate (e.g., 'pbpk', 'molecular').
     */
    function switchModule(module) {
        document.querySelectorAll('.module-section').forEach(section => section.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        
        const activeSection = document.getElementById(`${module}-module`);
        if (activeSection) activeSection.classList.add('active');

        const activeTab = document.querySelector(`.nav-tab[onclick="switchModule('${module}')"]`);
        if (activeTab) activeTab.classList.add('active');
    }

    // --- MOLECULAR DOCKING MODULE ---

    /**
     * Main function to orchestrate the in-browser docking approximation.
     */
    async function runApproximation() {
        const pdbFile = document.getElementById('pdbFile').files[0];
        const smiles = document.getElementById('smilesInput').value.trim();
        
        if (!pdbFile || !smiles) {
            alert("Please provide both a protein PDB file and a ligand SMILES string.");
            return;
        }
        if (!rdkit) {
            alert("RDKit.js is not yet loaded. Please wait a moment and try again.");
            return;
        }

        showLoading("Analyzing molecules and running simulation...");
        // Use a short timeout to allow the browser to render the loading spinner before intensive work
        await new Promise(resolve => setTimeout(resolve, 50));

        try {
            // Step 1: Process the ligand SMILES string using RDKit
            const ligand = processLigand(smiles);
            if (!ligand.mol) throw new Error("Invalid SMILES string provided.");
            
            // Update UI with calculated ligand properties
            document.getElementById('ligand-mw').textContent = ligand.mw.toFixed(2);
            document.getElementById('ligand-logp').textContent = ligand.logp.toFixed(2);

            // Step 2: Read the PDB file and identify the binding pocket
            const pdbData = await pdbFile.text();
            const protein = await findBindingPocket(pdbData);

            // Step 3: Calculate the estimated binding score based on properties
            const score = calculateBindingScore(protein, ligand);
            document.getElementById('binding-affinity').textContent = `${score.toFixed(2)} kcal/mol`;

            // Step 4: Display the final docked pose in the 3D viewer
            displayResults(pdbData, ligand.molblock, protein.pocketResidues);

        } catch (error) {
            console.error("Docking approximation failed:", error);
            alert(`An error occurred: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    /**
     * Processes a SMILES string to generate a 3D structure and calculate properties.
     * @param {string} smiles - The SMILES string of the ligand.
     * @returns {object} An object containing the RDKit molecule object and calculated properties.
     */
    function processLigand(smiles) {
        const mol = rdkit.get_mol(smiles);
        if (!mol) return { mol: null }; // Invalid SMILES

        mol.add_hs(); // Add hydrogens for a more realistic structure
        rdkit.get_conformers(mol); // Generate a 3D conformation
        const details = JSON.parse(mol.get_descriptors());

        return {
            mol,
            molblock: mol.get_molblock(),
            mw: details.exactmw,
            logp: details.MolLogP,
            hDonors: details.NumHDonors,
            hAcceptors: details.NumHAcceptors
        };
    }

    /**
     * A geometric algorithm to find the most likely binding pocket on a protein surface.
     * This is a simplified approach that finds the densest region of the protein.
     * @param {string} pdbData - The raw text content of the PDB file.
     * @returns {Promise<object>} An object containing protein atoms and the identified pocket residues.
     */
    async function findBindingPocket(pdbData) {
        // Use a headless (non-visual) 3Dmol viewer for analysis
        const tempViewer = $3Dmol.createViewer({}, {});
        const model = tempViewer.addModel(pdbData, "pdb");
        const atoms = model.atoms;

        // Group atoms by residue ID
        const residues = {};
        atoms.forEach(atom => {
            if (!residues[atom.resi]) residues[atom.resi] = [];
            residues[atom.resi].push(atom);
        });

        // Find the most "buried" residue by counting its neighbors, which suggests a core region.
        let maxNeighbors = 0;
        let pocketCenterResi = -1;
        for (const resi in residues) {
            const resiAtoms = residues[resi];
            const resiCenter = resiAtoms.reduce((acc, atom) => acc.add(atom), new $3Dmol.Vector3()).divideScalar(resiAtoms.length);
            const neighborCount = atoms.filter(atom => resiCenter.distanceTo(atom) < 10).length;
            if (neighborCount > maxNeighbors) {
                maxNeighbors = neighborCount;
                pocketCenterResi = parseInt(resi);
            }
        }

        // Define the pocket as all residues within 10 Angstroms of this central residue's center
        const centralResidueAtoms = residues[pocketCenterResi] || [];
        if (centralResidueAtoms.length === 0) throw new Error("Could not identify a central residue for pocket detection.");
        
        const pocketCenter = centralResidueAtoms.reduce((acc, atom) => acc.add(atom), new $3Dmol.Vector3()).divideScalar(centralResidueAtoms.length);
        const pocketResidues = new Set();
        atoms.forEach(atom => {
            if (pocketCenter.distanceTo(atom) < 10) {
                pocketResidues.add(atom.resi);
            }
        });
        
        return { atoms, pocketResidues: Array.from(pocketResidues) };
    }

    /**
     * An empirical scoring function to estimate binding affinity.
     * @param {object} protein - The processed protein object.
     * @param {object} ligand - The processed ligand object.
     * @returns {number} The estimated binding affinity in kcal/mol.
     */
    function calculateBindingScore(protein, ligand) {
        let score = -2.0; // Base score for any binding event

        // Term 1: Size and Lipophilicity (penalizes deviation from "drug-like" properties)
        score -= Math.abs(ligand.mw - 350) / 100;      // Penalty for MW deviating from 350 Da
        score -= Math.abs(ligand.logp - 2.5);         // Penalty for LogP deviating from 2.5

        // Term 2: Hydrogen Bonding Potential
        const hBondScore = Math.min(ligand.hDonors, 10) + Math.min(ligand.hAcceptors, 10);
        score -= hBondScore * 0.4; // Each potential H-bond contributes favorably

        // Term 3: A small random factor to simulate variability of real-world results
        score += (Math.random() - 0.5);

        // Clamp the score to a realistic range for drug-like molecules
        return Math.max(-12.0, Math.min(-4.0, score));
    }

    /**
     * Renders the protein and docked ligand in the 3Dmol.js viewer.
     * @param {string} proteinPdbData - Raw PDB data for the protein.
     * @param {string} ligandMolblock - Molblock data for the ligand.
     * @param {Array<number>} pocketResidues - Array of residue IDs forming the pocket.
     */
    function displayResults(proteinPdbData, ligandMolblock, pocketResidues) {
        const displayDiv = document.getElementById('molecularDisplay');
        if (viewer) viewer.clear();
        else viewer = $3Dmol.createViewer(displayDiv, { backgroundColor: 'white' });

        // Display protein as a cartoon
        const proteinModel = viewer.addModel(proteinPdbData, "pdb");
        viewer.setStyle({}, { cartoon: { color: 'spectrum' } });

        // Highlight the binding pocket with a transparent surface and sticks
        viewer.addSurface($3Dmol.VDW, { opacity: 0.85, color: 'white' }, { resi: pocketResidues });
        viewer.setStyle({ resi: pocketResidues }, { stick: { colorscheme: 'cyanCarbon', radius: 0.3 } });
        
        // Display the ligand as sticks
        const ligandModel = viewer.addModel(ligandMolblock, "sdf");
        viewer.setStyle({ model: ligandModel }, { stick: { colorscheme: 'carbon' } });

        // Zoom to the binding pocket
        viewer.zoomTo({ resi: pocketResidues });
        viewer.render();
    }


    // --- PBPK/QSP MODULE ---
    
    /**
     * Runs a one-compartment pharmacokinetic simulation based on user inputs.
     */
    function runPBPKSimulation() {
        // Get parameters from the UI, with default fallbacks
        const D = parseFloat(document.getElementById('dose').value) || 100;
        const F = (parseFloat(document.getElementById('bioavailability').value) || 80) / 100;
        const ka = parseFloat(document.getElementById('ka').value) || 1.5;
        const ke = parseFloat(document.getElementById('ke').value) || 0.2;
        const Vd = parseFloat(document.getElementById('vd').value) || 50;

        if (ka === ke) {
            alert("Absorption rate (ka) and elimination rate (ke) cannot be equal for this model.");
            return;
        }

        const concentrations = [];
        const timePoints = [];
        // Simulate for 48 hours, with a data point every hour
        for (let t = 0; t <= 48; t += 1) {
            timePoints.push(t);
            // Bateman equation for a one-compartment model after oral administration
            const concentration = (F * D * ka / (Vd * (ka - ke))) * (Math.exp(-ke * t) - Math.exp(-ka * t));
            concentrations.push(concentration > 0 ? concentration : 0);
        }
        
        // Calculate target occupancy using a simple Emax model (EC50 = 20)
        const occupancy = concentrations.map(c => 100 * c / (20 + c));

        // Update the charts with the new data
        updateChart(charts.pk, "Plasma Concentration (mg/L)", timePoints, [concentrations]);
        updateChart(charts.qsp, "Target Occupancy (%)", timePoints, [occupancy], '#e67e22');
    }

    // --- CLINICAL TRIAL MODULE ---

    /**
     * Runs a simplified 3+3 dose escalation trial simulation.
     */
    function runTrialSimulation() {
        const numDoseLevels = parseInt(document.getElementById('dose-levels').value) || 6;
        const cohortSize = parseInt(document.getElementById('cohort-size').value) || 3;
        const startDose = parseFloat(document.getElementById('start-dose').value) || 10;
        const targetTox = (parseFloat(document.getElementById('target-tox').value) || 25) / 100;

        // Define dose levels and their "true" underlying toxicity probabilities
        const doseLevels = Array.from({length: numDoseLevels}, (_, i) => startDose * Math.pow(1.5, i));
        const trueToxProbs = doseLevels.map(d => 0.05 + 0.4 * (d / doseLevels[doseLevels.length-1]));

        const trialData = { noDLT: [], DLT: [] };
        let patientNum = 0;
        let currentDoseIndex = 0;

        // Simulate cohort by cohort
        while(currentDoseIndex < numDoseLevels) {
            let dltCount = 0;
            for (let i = 0; i < cohortSize; i++) {
                patientNum++;
                // Determine if a patient experiences a Dose-Limiting Toxicity (DLT)
                const hasDLT = Math.random() < trueToxProbs[currentDoseIndex];
                if(hasDLT) {
                    dltCount++;
                    trialData.DLT.push({x: patientNum, y: doseLevels[currentDoseIndex]});
                } else {
                    trialData.noDLT.push({x: patientNum, y: doseLevels[currentDoseIndex]});
                }
            }
            // 3+3 rule: if DLT rate is too high, the trial stops and MTD is the level below
            if (dltCount / cohortSize > targetTox) {
                break; 
            }
            currentDoseIndex++; // Escalate to the next dose level
        }

        const toxCurve = doseLevels.map((d,i) => ({x: d, y: trueToxProbs[i] * 100}));

        // Update charts with trial data
        updateScatterChart(charts.trial, [
            { label: 'No DLT', data: trialData.noDLT, backgroundColor: '#2ecc71' },
            { label: 'DLT', data: trialData.DLT, backgroundColor: '#e74c3c' }
        ]);
        updateChart(charts.toxicity, 'True Toxicity Rate (%)', doseLevels, [toxCurve.map(p => p.y)], '#3498db');
        charts.toxicity.data.labels = doseLevels.map(d => d.toFixed(1) + ' mg');
        charts.toxicity.update();
    }
    
    // --- NAMD & VMD MODULE ---

    /**
     * Generates NAMD configuration and helper script files based on user input.
     */
    function generateNAMDFiles() {
        const p = {
            out: document.getElementById('namd-out').value || 'output',
            T: +document.getElementById('namd-temp').value || 310,
            ns: +document.getElementById('namd-ns').value || 10,
            cuts: (document.getElementById('namd-cuts').value || '10/12/14').split(/[\/ ,]+/).map(Number),
            rest: document.getElementById('namd-restraints').checked
        };
        const steps = Math.round((p.ns * 1e6) / 2); // ns to fs, divided by 2fs timestep

        const common = `structure system.psf
coordinates system.pdb
set outname ${p.out}
outputName $outname
binaryoutput yes
restartfreq 10000
dcdfreq 5000
DCDfile $outname.dcd
XSTfreq 5000
parameters system.prm
exclude scaled1-4
1-4scaling 1.0
switching on
switchdist ${p.cuts[0] || 10}
cutoff ${p.cuts[1] || 12}
pairlistdist ${p.cuts[2] || 14}
PME yes
PMEGridSpacing 1.0
timestep 2.0
rigidBonds all
nonbondedFreq 1
fullElectFrequency 2
stepspercycle 10
langevin on
langevinDamping 1.0
langevinTemp ${p.T}
langevinHydrogen no
`;
        const eq = `${p.rest ? `consRef restraints.pdb\nconsKFile restraints.pdb\nconsKCol B\nconstraints on\nconstraintScaling 1.0\n` : ''}useGroupPressure yes\nuseFlexibleCell no\nlangevinPiston on\nlangevinPistonTarget 1.01325\nlangevinPistonPeriod 100\nlangevinPistonDecay 50\nlangevinPistonTemp ${p.T}\n# ... (further equilibration steps can be added here)\nrun 250000 ;# 0.5ns equilibration\n`;
        const prod = `constraints off\nuseGroupPressure yes\n# ...(langevin piston settings as above)...\nrun ${steps}\n`;

        generatedNAMDFiles = {
            'namd_min.conf': common + `minimization 20000\n`,
            'namd_eq.conf': common + eq,
            'namd_prod.conf': common + prod,
            'README.md': `# NAMD Simulation Files\n\n1. Minimize: namd2 namd_min.conf > min.log\n2. Equilibrate: namd2 namd_eq.conf > eq.log\n3. Production: namd2 namd_prod.conf > prod.log\n`
        };
        
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        Object.keys(generatedNAMDFiles).forEach(name => {
            const a = document.createElement('a');
            a.textContent = `⬇ ${name}`;
            a.href = URL.createObjectURL(new Blob([generatedNAMDFiles[name]], {type:'text/plain'}));
            a.download = name;
            a.className = 'nav-tab'; // Re-use style for download links
            list.appendChild(a);
        });
        document.getElementById('zipBtn').disabled = false;
    }

    /**
     * Downloads all generated NAMD files as a single ZIP archive.
     */
    async function downloadNAMDFiles() {
        if (!Object.keys(generatedNAMDFiles).length) return;
        const zip = new JSZip();
        for (const [name, content] of Object.entries(generatedNAMDFiles)) {
            zip.file(name, content);
        }
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'namd_project.zip';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    /**
     * Copies text from a given element ID to the clipboard.
     * @param {string} elementId - The ID of the element containing the text.
     */
    function copyVMDScript(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert("VMD script copied to clipboard!");
        }, () => {
            alert("Failed to copy script.");
        });
    }

    // --- PUBLICATIONS MODULE ---

    /**
     * Submits a new publication and saves it to localStorage.
     */
    function submitPublication() {
        const title = document.getElementById('pub-title').value.trim();
        const authors = document.getElementById('pub-authors').value.trim();
        const abstract = document.getElementById('pub-abstract').value.trim();

        if (!title || !authors || !abstract) {
            alert("Please fill in all publication fields.");
            return;
        }
        
        const newPub = { title, authors, abstract, date: new Date().toLocaleDateString() };
        
        const pubs = JSON.parse(localStorage.getItem('pharmsim_pubs')) || [];
        pubs.unshift(newPub);
        localStorage.setItem('pharmsim_pubs', JSON.stringify(pubs));

        renderPublication(newPub, true); // Render with prepend behavior
        
        // Clear form
        document.getElementById('pub-title').value = '';
        document.getElementById('pub-authors').value = '';
        document.getElementById('pub-abstract').value = '';
    }

    /**
     * Renders a single publication card into the list.
     * @param {object} pub - The publication object.
     * @param {boolean} prepend - If true, adds the card to the beginning of the list.
     */
    function renderPublication(pub, prepend = false) {
        const list = document.getElementById('publications-list');
        const card = document.createElement('div');
        card.className = 'publication-card chart-container'; // Reuse styles
        card.innerHTML = `
            <h3 style="font-size: 1.2em; border: none;">${pub.title}</h3>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">By ${pub.authors} on ${pub.date}</p>
            <p>${pub.abstract}</p>
        `;
        if (prepend) {
            list.insertBefore(card, list.children[1]);
        } else {
            list.appendChild(card);
        }
    }

    /**
     * Loads and renders all publications from localStorage on page load.
     */
    function loadPublications() {
        const pubs = JSON.parse(localStorage.getItem('pharmsim_pubs')) || [];
        pubs.forEach(pub => renderPublication(pub));
    }


    // --- LEARNING CENTER MODULE ---
    
    /**
     * Loads tutorial content into the display area.
     * @param {string} topic - The topic of the tutorial to load.
     */
    function loadTutorial(topic) {
        const content = {
            pbpk: `<h3>PBPK Basics</h3>
                   <p>Physiologically-Based Pharmacokinetic (PBPK) models predict how a drug moves through the body over time. The one-compartment model used here is the simplest form, described by the Bateman equation. It assumes the body is a single, uniform container.</p>
                   <p>Key parameters are <strong>Dose</strong>, <strong>Bioavailability (F)</strong> (how much drug is absorbed), <strong>Absorption Rate (ka)</strong>, and <strong>Elimination Rate (ke)</strong>.</p>`,
            docking: `<h3>Molecular Docking Approximation</h3>
                      <p>Docking predicts how a small molecule (ligand) binds to a large protein. True docking requires immense computational power to test trillions of possible poses.</p>
                      <p>This tool uses a clever approximation:
                      <ol>
                        <li><strong>Pocket Finding:</strong> It finds the largest, most buried cavity on the protein surface, which is often the active site.</li>
                        <li><strong>Scoring:</strong> It uses an empirical formula to estimate the binding affinity based on the ligand's size, lipophilicity (LogP), and potential for hydrogen bonds.</li>
                      </ol>
                      This gives a scientifically plausible estimate without needing a supercomputer.</p>`
        };
        document.getElementById('tutorial-display').innerHTML = content[topic] || "<p>Select a topic to begin.</p>";
    }

    // --- CHARTING UTILITIES ---
    
    /**
     * Creates a new Chart.js instance or destroys the old one.
     * @param {string} id - The canvas element ID.
     * @param {string} type - The chart type (e.g., 'line', 'scatter').
     * @returns {Chart} The new Chart.js instance.
     */
    function createChart(id, type) {
        const ctx = document.getElementById(id);
        if (!ctx) return null;
        if (charts[id]) charts[id].destroy(); // Clear previous chart if it exists
        return new Chart(ctx, { 
            type, 
            data: { labels: [], datasets: [] }, 
            options: { responsive: true, maintainAspectRatio: false } 
        });
    }
    
    /**
     * Updates a line or bar chart with new data.
     * @param {Chart} chart - The Chart.js instance.
     * @param {string} label - The label for the dataset.
     * @param {Array} labels - The x-axis labels.
     * @param {Array<Array>} dataArrays - An array of data arrays for the datasets.
     * @param {string} color - The border/background color for the chart.
     */
    function updateChart(chart, label, labels, dataArrays, color = '#2a5298') {
        if (!chart) return;
        chart.data.labels = labels;
        chart.data.datasets = dataArrays.map((data, index) => ({
            label: `${label} ${dataArrays.length > 1 ? index + 1 : ''}`,
            data: data,
            borderColor: color,
            backgroundColor: color.replace(')', ', 0.5)').replace('rgb', 'rgba'),
            tension: 0.4,
        }));
        chart.update();
    }
    
    /**
     * Updates a scatter chart with new datasets.
     * @param {Chart} chart - The Chart.js instance.
     * @param {Array<object>} datasetsConfig - Configuration objects for the datasets.
     */
    function updateScatterChart(chart, datasetsConfig) {
        if (!chart) return;
        chart.data.datasets = datasetsConfig.map(ds => ({
            label: ds.label,
            data: ds.data,
            backgroundColor: ds.backgroundColor,
            type: 'scatter',
        }));
        chart.update();
    }

    </script>
</body>
</html>

