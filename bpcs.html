<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PharmaSim Pro - Integrated Pharmaceutical Research & Publication Platform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
      color: #333; min-height: 100vh; padding: 0;
    }
    .header {
      background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(240,248,255,0.98) 100%);
      backdrop-filter: blur(10px); padding: 20px 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: sticky; top: 0; z-index: 1000;
    }
    .header h1 { font-size: 2.2em; background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
    .header-subtitle { color: #666; font-size: 1em; margin-bottom: 5px; }
    .attribution { font-size: .85em; color: #888; font-style: italic; }
    .attribution a { color: #2a5298; text-decoration: none; }
    .attribution a:hover { text-decoration: underline; }

    .disclaimer-banner {
      background: linear-gradient(135deg,#fff3e0 0%,#ffe0b2 100%);
      border: 2px solid #ff9800; border-radius: 12px; padding: 15px 20px; margin: 20px 40px;
      box-shadow: 0 4px 15px rgba(255,152,0,0.2);
    }
    .disclaimer-banner h4 { color: #e65100; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
    .disclaimer-banner h4::before { content: '⚠️'; font-size: 1.2em; }
    .disclaimer-banner p { color: #5d4037; line-height: 1.6; font-size: 14px; }
    .disclaimer-banner .github-link { color: #e65100; font-weight: 600; text-decoration: none; }
    .disclaimer-banner .github-link:hover { text-decoration: underline; }

    .nav-tabs { display: flex; gap: 15px; margin-top: 15px; border-bottom: 2px solid rgba(30,60,114,0.1); padding-bottom: 10px; flex-wrap: wrap; }
    .nav-tab { padding: 10px 20px; background: white; color: #2a5298; border: 2px solid #2a5298; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all .3s ease; position: relative; overflow: hidden; }
    .nav-tab:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(42,82,152,0.3); }
    .nav-tab.active { background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%); color: white; border-color: transparent; }
    .nav-tab.new-feature::after { content: 'NEW'; position: absolute; top: -5px; right: -5px; background: #f44336; color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: bold; }

    .tooltip { position: absolute; background: #333; color: #fff; padding: 8px 12px; border-radius: 5px; font-size: 12px; white-space: nowrap; z-index: 9999; opacity: 0; pointer-events: none; transition: opacity .3s; top: -40px; left: 50%; transform: translateX(-50%); }
    .nav-tab:hover .tooltip { opacity: 1; }

    .main-container { max-width: 1600px; margin: 30px auto; padding: 0 20px; }
    .module-section { display: none; }
    .module-section.active { display: block; animation: fadeIn .5s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .dashboard-grid { display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
    .control-panel {
      background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15); height: fit-content; position: sticky; top: 180px;
    }
    .control-panel h2 { color: #1e3c72; font-size: 1.3em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid rgba(30,60,114,0.1); }

    .help-icon { display: inline-block; width: 18px; height: 18px; background: #2a5298; color: #fff; text-align: center; line-height: 18px; border-radius: 50%; font-size: 11px; margin-left: 8px; cursor: help; vertical-align: middle; }
    .help-text { position: absolute; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; font-size: 13px; line-height: 1.5; width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none; }
    .help-icon:hover + .help-text { display: block; }

    .control-group { margin-bottom: 18px; position: relative; }
    .control-group label { display: flex; align-items: center; margin-bottom: 8px; color: #555; font-weight: 600; font-size: 14px; }
    .control-group input[type="number"], .control-group input[type="text"], .control-group input[type="file"], .control-group textarea, .control-group select {
      width: 100%; padding: 10px 12px; border: 2px solid #e0e6ed; border-radius: 8px; font-size: 14px; transition: all .3s ease; background: #f8f9fa; font-family: inherit;
    }
    .control-group textarea { resize: vertical; min-height: 100px; }
    .control-group input:focus, .control-group select:focus, .control-group textarea:focus { outline: none; border-color: #2a5298; background: #fff; box-shadow: 0 0 0 3px rgba(42,82,152,0.1); }
    .control-group input[type="range"] { width: 100%; margin-bottom: 5px; }
    .value-display { font-size: 12px; color: #777; text-align: right; }

    .button-group { display: flex; gap: 10px; margin-top: 20px; }
    button { flex: 1; padding: 12px 18px; background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%); color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px; transition: all .3s ease; box-shadow:0 4px 12px rgba(42,82,152,0.3); }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(42,82,152,0.4); }
    button.secondary { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    button.danger { background: linear-gradient(135deg,#f093fb 0%,#f5576c 100%); }
    button.success { background: linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); }
    button.publish { background: linear-gradient(135deg,#00c853 0%,#4caf50 100%); }

    .visualization-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 25px; }
    .chart-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); min-height: 400px; position: relative; }
    .chart-container h3 { color: #1e3c72; font-size: 1.2em; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(30,60,114,0.1); }

    .results-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; margin-top: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .results-panel h3 { color: #1e3c72; font-size: 1.3em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid rgba(30,60,114,0.1); }
    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
    .metric-card { background: linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); padding: 20px; border-radius: 15px; border: 1px solid rgba(30,60,114,0.1); transition: all .3s ease; text-align: center; }
    .metric-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .metric-label { font-size: 12px; color: #666; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 8px; }
    .metric-value { font-size: 1.8em; font-weight: bold; background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .info-box { background: linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%); border-left: 4px solid #2a5298; border-radius: 8px; padding: 15px; margin: 20px 0; }
    .info-box h4 { color: #1e3c72; margin-bottom: 8px; font-size: 1.1em; }
    .info-box p { color: #555; line-height: 1.6; font-size: 14px; }

    .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; padding: 10px; background: rgba(30,60,114,0.05); border-radius: 10px; }
    .tab-button { padding: 8px 16px; background: white; color: #2a5298; border: 1px solid #2a5298; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all .3s ease; }
    .tab-button.active { background: #2a5298; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    canvas, #molecularDisplay { width: 100% !important; height: 350px !important; border-radius: 10px; }
    #molecularDisplay { position: relative; background-color: #f0f0f0; }

    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
    .loading-spinner { background: white; padding: 30px; border-radius: 15px; text-align: center; }
    .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #2a5298; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .educational-tip { background: linear-gradient(135deg,#fff3e0 0%,#ffe0b2 100%); border-left: 4px solid #ff9800; padding: 12px; margin: 15px 0; border-radius: 8px; font-size: 13px; color: #5d4037; }
    .educational-tip strong { color: #e65100; }

    /* Blog */
    .blog-post-form { background: white; border-radius: 15px; padding: 30px; margin: 20px 0; }
    .blog-post-form h3 { color: #1e3c72; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid rgba(30,60,114,0.1); }
    .template-box { background: #f8f9fa; border: 2px dashed #2a5298; border-radius: 10px; padding: 20px; margin: 20px 0; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.8; }
    .template-variable { color: #e65100; font-weight: bold; }
    .blog-preview, .blog-post-card { background: white; border-radius: 15px; padding: 30px; margin: 20px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .blog-post-card { padding: 25px; transition: all .3s ease; }
    .blog-post-card:hover { transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    .blog-post-title { color: #1e3c72; font-size: 1.5em; margin-bottom: 10px; }
    .blog-post-meta { color: #888; font-size: .9em; margin-bottom: 15px; }
    .blog-post-content { color: #333; line-height: 1.8; }

    .data-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    .data-table th { background: #2a5298; color: #fff; padding: 12px; text-align: left; }
    .data-table td { padding: 10px 12px; border-bottom: 1px solid #ddd; }
    .data-table tr:hover { background: #f5f5f5; }

    .capture-button { position: absolute; top: 20px; right: 20px; padding: 8px 15px; background: #4caf50; color: white; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; transition: all .3s ease; }
    .capture-button:hover { background: #45a049; transform: scale(1.05); }

    .footer { background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(240,248,255,0.98) 100%); padding: 30px 40px; margin-top: 50px; text-align: center; border-top: 2px solid rgba(30,60,114,0.1); }
    .footer-content { max-width: 1200px; margin: 0 auto; }
    .footer-attribution { color: #666; font-size: 14px; line-height: 1.8; }
    .footer-links { margin-top: 15px; display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; }
    .footer-links a { color: #2a5298; text-decoration: none; font-weight: 600; transition: color .3s ease; }
    .footer-links a:hover { color: #1e3c72; text-decoration: underline; }

    @media (max-width: 968px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .control-panel { position: relative; top: 0; }
      .visualization-area { grid-template-columns: 1fr; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
  <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
</head>
<body>
  <div class="header">
    <h1>PharmaSim Pro</h1>
    <p class="header-subtitle">Integrated Pharmaceutical Research & Publication Platform</p>
    <p class="attribution">Created by <strong>David Ferguson, BS, MS, Pharm.D. Candidate</strong> | Powered by <a href="https://www.anthropic.com" target="_blank">Anthropic Claude AI</a></p>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchModule('pbpk')">PBPK/QSP Modeling <span class="tooltip">Physiologically-based pharmacokinetic modeling</span></button>
      <button class="nav-tab" onclick="switchModule('clinical')">Clinical Trial Design <span class="tooltip">Bayesian adaptive trial simulation</span></button>
      <button class="nav-tab" onclick="switchModule('molecular')">Molecular Dynamics <span class="tooltip">Protein and ligand interactions</span></button>
      <button class="nav-tab new-feature" onclick="switchModule('publications')">Research Publications <span class="tooltip">Share your findings</span></button>
      <button class="nav-tab" onclick="switchModule('tutorial')">Learning Center <span class="tooltip">Interactive tutorials and guides</span></button>
    </div>
  </div>

  <div class="disclaimer-banner">
    <h4>Important Research Disclaimer</h4>
    <p><strong>These computational models provide approximations for educational and exploratory purposes only.</strong> All values generated represent theoretical estimates based on simplified mathematical models. Results must be validated through proper in vitro, in vivo, and additional in silico studies before any critical decisions. Models are inherently limited and can produce errors—always double-check calculations and consult with qualified professionals. <br /><br /><strong>Never use these simulations as the sole basis for clinical or research decisions.</strong><br />Source code available on <a href="https://github.com/pharmasim-pro" class="github-link" target="_blank">GitHub</a> for transparency and peer review.</p>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Running simulation...</p>
    </div>
  </div>

  <div class="main-container">
    <div class="module-section active" id="pbpk-module">
      <div class="dashboard-grid">
        <div class="control-panel">
          <h2>PBPK/QSP Parameters</h2>
          <button class="capture-button" onclick="captureResults('pbpk')">📊 Capture for Publication</button>

          <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('absorption','pbpk')">Absorption</button>
            <button class="tab-button" onclick="switchTab('distribution','pbpk')">Distribution</button>
            <button class="tab-button" onclick="switchTab('metabolism','pbpk')">Metabolism</button>
            <button class="tab-button" onclick="switchTab('qsp','pbpk')">QSP</button>
          </div>

          <div class="tab-content active" id="absorption-tab">
            <div class="control-group"><label>Drug Name/ID</label><input type="text" id="drug-name" placeholder="e.g., Aspirin, Drug X"/></div>
            <div class="control-group"><label>Dose (mg)<span class="help-icon">?</span><div class="help-text">Amount of drug administered. Higher doses lead to proportionally higher concentrations.</div></label><input type="number" id="dose" value="100" min="1" max="1000" step="10"/><div class="value-display">100 mg dose</div></div>
            <div class="control-group"><label>Bioavailability (F)<span class="help-icon">?</span><div class="help-text">Fraction of drug reaching systemic circulation. Oral: 5–100%.</div></label><input type="number" id="bioavailability" value="80" min="0" max="100" step="5"/><div class="value-display">80% reaches systemic circulation</div></div>
            <div class="control-group"><label>Absorption Rate (ka)<span class="help-icon">?</span><div class="help-text">First-order absorption rate constant. Typical 0.5–3.0 h⁻¹</div></label><input type="number" id="ka" value="1.5" step="0.1" min="0.1" max="5"/><div class="value-display">1.5 h⁻¹</div></div>
            <div class="control-group"><label>Formulation<span class="help-icon">?</span><div class="help-text">Different formulations affect drug release and absorption.</div></label><select id="formulation"><option value="immediate">Immediate Release</option><option value="extended">Extended Release</option><option value="enteric">Enteric Coated</option><option value="sublingual">Sublingual</option></select></div>
          </div>

          <div class="tab-content" id="distribution-tab">
            <div class="control-group"><label>Molecular Weight (Da)</label><input type="number" id="mw" value="350" step="10" min="100" max="2000"/><div class="value-display">350 Da</div></div>
            <div class="control-group"><label>Volume of Distribution (Vd)</label><input type="number" id="vd" value="70" step="5" min="10" max="500"/><div class="value-display">70 L</div></div>
            <div class="control-group"><label>Plasma Protein Binding</label><input type="number" id="protein-binding" value="90" min="0" max="99" step="1"/><div class="value-display">90% bound, 10% free</div></div>
            <div class="control-group"><label>LogP (Lipophilicity)</label><input type="number" id="logp" value="2.5" step="0.1" min="-2" max="8"/><div class="value-display">2.5 (moderately lipophilic)</div></div>
          </div>

          <div class="tab-content" id="metabolism-tab">
            <div class="control-group"><label>Clearance (CL)</label><input type="number" id="clearance" value="1.2" step="0.1"/></div>
            <div class="control-group"><label>Primary Enzyme</label><select id="enzyme"><option value="cyp3a4">CYP3A4 (50% of drugs)</option><option value="cyp2d6">CYP2D6 (25% of drugs)</option><option value="cyp2c9">CYP2C9 (15% of drugs)</option><option value="cyp1a2">CYP1A2</option><option value="cyp2c19">CYP2C19</option><option value="ugt">UGT (Glucuronidation)</option></select></div>
            <div class="control-group"><label>Renal Function</label><select id="renal-function"><option value="normal">Normal (CrCl > 90)</option><option value="mild">Mild Impairment (60-90)</option><option value="moderate">Moderate (30-60)</option><option value="severe">Severe (15-30)</option></select></div>
          </div>

          <div class="tab-content" id="qsp-tab">
            <div class="control-group"><label>Target Protein</label><input type="text" id="target-protein" placeholder="e.g., ACE2, EGFR, COX-2"/></div>
            <div class="control-group"><label>Target Receptor Type</label><select id="target-receptor"><option value="gpcr">GPCR (40% of drugs)</option><option value="kinase">Kinase</option><option value="nuclear">Nuclear Receptor</option><option value="ion-channel">Ion Channel</option><option value="enzyme">Enzyme</option></select></div>
            <div class="control-group"><label>EC50 (nM)</label><input type="number" id="ec50" value="50" step="5"/></div>
            <div class="control-group"><label>Hill Coefficient</label><input type="number" id="hill" value="1.5" step="0.1"/></div>
          </div>

          <div class="button-group">
            <button onclick="runPBPKSimulation()">Run PBPK Simulation</button>
            <button class="secondary" onclick="loadSpecificDrug('hydrophilic')">Hydrophilic</button>
            <button class="secondary" onclick="loadSpecificDrug('lipophilic')">Lipophilic</button>
            <button class="secondary" onclick="loadSpecificDrug('high-clearance')">High Clearance</button>
            <button class="secondary" onclick="loadPreset('pbpk')">Random Example</button>
          </div>

          <div class="educational-tip"><strong>💡 Learning Tip:</strong> Hydrophilic vs lipophilic drugs show very different profiles. Try both and compare LogP effects.</div>
        </div>

        <div class="visualization-area">
          <div class="chart-container"><h3>Plasma Concentration Profile</h3><canvas id="pkChart"></canvas></div>
          <div class="chart-container"><h3>Target Occupancy</h3><canvas id="qspChart"></canvas></div>
          <div class="chart-container"><h3>Tissue Distribution</h3><canvas id="tissueChart"></canvas></div>
          <div class="chart-container"><h3>Drug-Drug Interactions</h3><canvas id="ddiChart"></canvas></div>
        </div>
      </div>

      <div class="results-panel">
        <h3>Pharmacokinetic Parameters</h3>
        <div class="metric-grid">
          <div class="metric-card"><div class="metric-label">Cmax</div><div class="metric-value" id="cmax">--</div></div>
          <div class="metric-card"><div class="metric-label">Tmax</div><div class="metric-value" id="tmax">--</div></div>
          <div class="metric-card"><div class="metric-label">AUC₀₋∞</div><div class="metric-value" id="auc">--</div></div>
          <div class="metric-card"><div class="metric-label">Half-life</div><div class="metric-value" id="halflife">--</div></div>
          <div class="metric-card"><div class="metric-label">Clearance</div><div class="metric-value" id="cl-calc">--</div></div>
          <div class="metric-card"><div class="metric-label">Vss</div><div class="metric-value" id="vss">--</div></div>
        </div>
      </div>
    </div>

    <div class="module-section" id="clinical-module">
      <div class="dashboard-grid">
        <div class="control-panel">
          <h2>Clinical Trial Design</h2>
          <button class="capture-button" onclick="captureResults('clinical')">📊 Capture for Publication</button>

          <div class="info-box"><h4>Phase 1 Trial Objectives</h4><p>Determine the maximum tolerated dose (MTD) and recommended phase 2 dose (RP2D) while minimizing exposure to toxic doses.</p></div>

          <div class="control-group"><label>Study Drug Name</label><input type="text" id="study-drug-name" placeholder="e.g., Novel Kinase Inhibitor X"/></div>
          <div class="control-group"><label>Design Type<span class="help-icon">?</span><div class="help-text">Choose between traditional and Bayesian adaptive designs</div></label><select id="design-type" onchange="updateDesignInfo()"><option value="3plus3">3+3 Traditional</option><option value="crm">CRM - Continual Reassessment</option><option value="boin">BOIN - Bayesian Optimal Interval</option><option value="ewoc">EWOC - Overdose Control</option><option value="blrm">BLRM - Bayesian Logistic Regression</option><option value="mTPI">mTPI - Modified TPI</option></select></div>
          <div id="design-info" class="info-box" style="margin-top: 15px;"><h4>3+3 Design</h4><p>Traditional rule-based design. Simple but inefficient. Treats 3 patients per dose, escalates if 0/3 DLTs, expands to 6 if 1/3 DLTs.</p></div>
          <div class="control-group"><label>Target DLT Rate</label><input type="number" id="target-tox" value="0.25" min="0.1" max="0.4" step="0.05"/><div class="value-display">25% target toxicity</div></div>
          <div class="control-group"><label>Starting Dose (mg)</label><input type="number" id="start-dose" value="10" step="5"/></div>
          <div class="control-group"><label>Maximum Dose (mg)</label><input type="number" id="max-dose" value="200" step="10"/></div>
          <div class="control-group"><label>Dose Escalation Scheme</label><select id="escalation-scheme"><option value="fibonacci">Modified Fibonacci</option><option value="doubling">Doubling</option><option value="pharmacologic">Pharmacologically-guided</option><option value="custom">Custom (geometric)</option></select></div>
          <div class="control-group"><label>Number of Dose Levels</label><input type="number" id="cohorts" value="6" min="3" max="10"/></div>
          <div class="control-group"><label>Cohort Size</label><input type="number" id="cohort-size" value="3" min="1" max="6"/></div>

          <div class="button-group">
            <button onclick="runTrialSimulation()">Run Single Trial</button>
            <button class="secondary" onclick="runMonteCarloTrials(1000)">Run 1000 Trials</button>
            <button class="success" onclick="compareDesigns()">Compare All Designs</button>
          </div>

          <div class="educational-tip"><strong>💡 Tip:</strong> CRM/BOIN usually find the MTD with fewer patients than 3+3. Use "Compare All Designs" to see it empirically.</div>
        </div>

        <div class="visualization-area">
          <div class="chart-container"><h3>Dose Escalation Progress</h3><canvas id="trialChart"></canvas></div>
          <div class="chart-container"><h3>Dose-Toxicity Curve</h3><canvas id="toxicityChart"></canvas></div>
          <div class="chart-container"><h3>Design Performance Comparison</h3><canvas id="comparisonChart"></canvas></div>
          <div class="chart-container"><h3>Operating Characteristics</h3><canvas id="ocChart"></canvas></div>
        </div>
      </div>

      <div class="results-panel">
        <h3>Trial Results</h3>
        <div class="metric-grid">
          <div class="metric-card"><div class="metric-label">MTD Estimate</div><div class="metric-value" id="mtd">--</div></div>
          <div class="metric-card"><div class="metric-label">RP2D</div><div class="metric-value" id="rp2d">--</div></div>
          <div class="metric-card"><div class="metric-label">DLT Rate at MTD</div><div class="metric-value" id="dlt-rate">--</div></div>
          <div class="metric-card"><div class="metric-label">Total Patients</div><div class="metric-value" id="total-patients">--</div></div>
          <div class="metric-card"><div class="metric-label">Patients with DLT</div><div class="metric-value" id="patients-dlt">--</div></div>
          <div class="metric-card"><div class="metric-label">Trial Duration</div><div class="metric-value" id="trial-duration">--</div></div>
        </div>
      </div>
    </div>

    <div class="module-section" id="molecular-module">
      <div class="dashboard-grid">
        <div class="control-panel">
          <h2>Molecular Simulations</h2>
          <button class="capture-button" onclick="captureResults('molecular')">📊 Capture for Publication</button>

          <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('structure','molecular')">Structure</button>
            <button class="tab-button" onclick="switchTab('dynamics','molecular')">Dynamics</button>
            <button class="tab-button" onclick="switchTab('binding','molecular')">Binding</button>
          </div>

          <div class="tab-content active" id="structure-tab">
            <div class="control-group"><label>Load PDB Structure<span class="help-icon">?</span><div class="help-text">Upload a Protein Data Bank file to visualize molecular structure</div></label><input type="file" id="pdbFile" accept=".pdb"/></div>
            <div class="control-group"><label>Or Enter Drug SMILES<span class="help-icon">?</span><div class="help-text">Simplified molecular-input line-entry system notation</div></label><input type="text" id="smilesInput" placeholder="e.g., CC(=O)OC1=CC=CC=C1C(=O)O for Aspirin"/></div>
            <button onclick="loadMolecularStructure()">Load Structure</button>
            <div class="educational-tip"><strong>Examples:</strong><br/>• Aspirin: CC(=O)OC1=CC=CC=C1C(=O)O<br/>• Caffeine: CN1C=NC2=C1C(=O)N(C(=O)N2)C<br/>• Ibuprofen: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O</div>
          </div>

          <div class="tab-content" id="dynamics-tab">
            <div class="control-group"><label>Simulation Type</label><select id="sim-type"><option value="md">Molecular Dynamics</option><option value="mc">Monte Carlo</option><option value="docking">Molecular Docking</option><option value="qm">Quantum Mechanics</option></select></div>
            <div class="control-group"><label>Temperature (K)</label><input type="range" id="mdTemp" min="100" max="500" value="300"/><div class="value-display"><span id="mdTempValue">300</span> K (27°C)</div></div>
            <div class="control-group"><label>Force Field</label><select id="forceField"><option value="amber">AMBER (proteins)</option><option value="charmm">CHARMM (biomolecules)</option><option value="opls">OPLS (organic molecules)</option><option value="gromos">GROMOS (united atom)</option></select></div>
          </div>

          <div class="tab-content" id="binding-tab">
            <div class="control-group"><label>Binding Site</label><select id="binding-site"><option value="active">Active Site</option><option value="allosteric">Allosteric Site</option><option value="interface">Protein-Protein Interface</option></select></div>
            <div class="control-group"><label>Docking Algorithm</label><select id="docking-algorithm"><option value="rigid">Rigid Docking</option><option value="flexible">Flexible Docking</option><option value="ensemble">Ensemble Docking</option></select></div>
            <div class="control-group"><label>Scoring Function</label><select id="scoring"><option value="empirical">Empirical</option><option value="knowledge">Knowledge-based</option><option value="force">Force Field</option></select></div>
          </div>

          <div class="button-group">
            <button onclick="startMolecularSimulation()">Start Simulation</button>
            <button class="danger" onclick="stopMolecularSimulation()">Stop</button>
            <button class="secondary" onclick="exportMolecularData()">Export Data</button>
          </div>
        </div>

        <div class="visualization-area">
          <div class="chart-container"><h3>3D Molecular Structure</h3><div id="molecularDisplay"></div></div>
          <div class="chart-container"><h3>Energy Profile</h3><canvas id="energyChart"></canvas></div>
          <div class="chart-container"><h3>RMSD Over Time</h3><canvas id="rmsdChart"></canvas></div>
          <div class="chart-container"><h3>Interaction Analysis</h3><canvas id="interactionChart"></canvas></div>
        </div>
      </div>

      <div class="results-panel">
        <h3>Simulation Metrics</h3>
        <div class="metric-grid">
          <div class="metric-card"><div class="metric-label">Total Energy</div><div class="metric-value" id="total-energy">--</div></div>
          <div class="metric-card"><div class="metric-label">Binding Affinity</div><div class="metric-value" id="binding-affinity">--</div></div>
          <div class="metric-card"><div class="metric-label">RMSD</div><div class="metric-value" id="rmsd">--</div></div>
          <div class="metric-card"><div class="metric-label">H-Bonds</div><div class="metric-value" id="hbonds">--</div></div>
          <div class="metric-card"><div class="metric-label">Radius of Gyration</div><div class="metric-value" id="rg">--</div></div>
          <div class="metric-card"><div class="metric-label">SASA</div><div class="metric-value" id="sasa">--</div></div>
        </div>
      </div>
    </div>

    <div class="module-section" id="publications-module">
      <div style="max-width: 1200px; margin: 0 auto;">
        <div class="chart-container">
          <h3>Research Publication Center</h3>
          <p style="color:#666; margin-bottom: 20px;">Share your computational findings with the research community</p>

          <div class="blog-post-form">
            <h3>Create New Publication</h3>
            <div class="control-group"><label>Publication Title</label><input type="text" id="pub-title" placeholder="e.g., In Silico Analysis of Drug X Binding to Protein Y"/></div>
            <div class="control-group"><label>Author(s)</label><input type="text" id="pub-authors" placeholder="Your name and affiliations"/></div>
            <div class="control-group"><label>Drug/Compound Name</label><input type="text" id="pub-drug" placeholder="e.g., Novel Kinase Inhibitor X"/></div>
            <div class="control-group"><label>Target Protein</label><input type="text" id="pub-protein" placeholder="e.g., EGFR, COX-2, ACE2"/></div>
            <div class="control-group"><label>Key Findings</label><textarea id="pub-findings" placeholder="Describe your main discoveries and their implications..."></textarea></div>
            <div class="control-group"><label>Data Values</label><textarea id="pub-data" placeholder="Include relevant metrics: EC50, Kd, clearance, half-life, etc."></textarea></div>
            <div class="control-group"><label>Implications for Early-Stage Scientists</label><textarea id="pub-implications" placeholder="What does this mean for future research? Suggested next steps?"></textarea></div>

            <div class="template-box">
              <strong>Publication Template:</strong><br/><br/>
              <span class="template-variable">[TITLE]</span><br/>Authors: <span class="template-variable">[AUTHORS]</span><br/>Date: <span class="template-variable">[DATE]</span><br/><br/>
              <strong>Abstract:</strong><br/>We performed computational modeling of <span class="template-variable">[DRUG NAME]</span> interaction with <span class="template-variable">[PROTEIN NAME]</span> using PharmaSim Pro (Ferguson, D.; Anthropic Claude AI).<br/><br/>
              <strong>Key Parameters:</strong><br/><span class="template-variable">[DATA VALUES]</span><br/><br/>
              <strong>Major Findings:</strong><br/><span class="template-variable">[KEY FINDINGS]</span><br/><br/>
              <strong>Implications:</strong><br/><span class="template-variable">[IMPLICATIONS FOR SCIENTISTS]</span><br/><br/>
              <strong>Disclaimer:</strong><br/>These computational predictions require validation through experimental studies. Values represent theoretical estimates from simplified models.<br/><br/>
              <strong>Citation:</strong><br/>Created using PharmaSim Pro by David Ferguson (Pharm.D. Candidate) powered by Anthropic Claude AI. Code available on GitHub.
            </div>

            <div class="button-group">
              <button class="publish" onclick="publishFindings()">Publish Findings</button>
              <button class="secondary" onclick="previewPublication()">Preview</button>
              <button onclick="clearPublication()">Clear Form</button>
            </div>
          </div>

          <div id="publication-preview" class="blog-preview" style="display:none;"></div>

          <div style="margin-top: 40px;">
            <h3>Recent Publications</h3>
            <div id="publications-list">
              <div class="blog-post-card">
                <h4 class="blog-post-title">Example: PBPK Modeling of Novel JAK Inhibitor</h4>
                <div class="blog-post-meta">By Research Team A • January 15, 2025</div>
                <div class="blog-post-content">Computational analysis revealed favorable pharmacokinetic properties with 85% bioavailability, 1.2 L/h clearance, and 12-hour half-life. Target occupancy reached 90% at steady state. Findings suggest twice-daily dosing may be optimal. Further in vitro validation recommended.</div>
              </div>
              <div class="blog-post-card">
                <h4 class="blog-post-title">Example: Bayesian Dose-Finding Simulation for Anti-PD1 Antibody</h4>
                <div class="blog-post-meta">By Team B • January 10, 2025</div>
                <div class="blog-post-content">Compared 6 trial designs for Phase 1 dose escalation. BOIN design showed optimal performance with high MTD identification rates using fewer patients than traditional 3+3. Recommended starting dose: 0.5 mg/kg with escalation to 10 mg/kg maximum.</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="module-section" id="tutorial-module">
      <div style="max-width: 1200px; margin: 0 auto;">
        <div class="chart-container" style="margin-bottom: 25px;">
          <h3>Welcome to the Learning Center</h3>
          <div class="info-box">
            <h4>Getting Started with PharmaSim Pro</h4>
            <p>This integrated platform combines three essential areas of pharmaceutical research:</p>
            <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.8;">
              <li><strong>PBPK/QSP Modeling:</strong> Understand drug absorption, distribution, metabolism, and excretion</li>
              <li><strong>Clinical Trial Design:</strong> Learn about adaptive dose-finding methods in Phase 1 trials</li>
              <li><strong>Molecular Dynamics:</strong> Explore drug-target interactions at the molecular level</li>
              <li><strong>Research Publications:</strong> Share your findings with the scientific community</li>
            </ul>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="control-panel">
            <h2>Interactive Tutorials</h2>
            <div class="button-group" style="flex-direction: column;">
              <button onclick="startTutorial('pbpk-basics')">PBPK Basics</button>
              <button onclick="startTutorial('trial-designs')">Understanding Trial Designs</button>
              <button onclick="startTutorial('molecular-intro')">Molecular Simulations 101</button>
              <button onclick="startTutorial('publication-guide')">How to Publish Findings</button>
              <button onclick="startTutorial('case-study')">Complete Case Study</button>
            </div>
            <div class="info-box" style="margin-top: 20px;"><h4>Key Concepts</h4><p>Click on any tutorial to begin an interactive guided walkthrough.</p></div>
          </div>

          <div class="visualization-area">
            <div class="chart-container" id="tutorial-content">
              <h3>Select a Tutorial</h3>
              <div class="educational-tip"><strong>Recommended Path:</strong>
                <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                  <li>Start with PBPK Basics</li>
                  <li>Move to Clinical Trial Designs</li>
                  <li>Explore Molecular Simulations</li>
                  <li>Learn to document and share findings</li>
                  <li>Complete the integrated case study</li>
                </ol>
              </div>
              <div class="info-box" style="margin-top: 20px;">
                <h4>Quick Reference Formulas</h4>
                <div style="font-family: monospace; margin: 10px 0;">
                  <p><strong>Clearance:</strong> CL = Dose / AUC</p>
                  <p><strong>Half-life:</strong> t½ = 0.693 × Vd / CL</p>
                  <p><strong>Loading Dose:</strong> LD = Vd × Css</p>
                  <p><strong>Maintenance Dose:</strong> MD = CL × Css × τ</p>
                  <p><strong>Bioavailability:</strong> F = AUC(oral) / AUC(iv)</p>
                </div>
              </div>
              <div class="disclaimer-banner" style="margin-top: 20px;">
                <h4>Remember</h4>
                <p>All simulations provide theoretical estimates. Always validate computational predictions with appropriate experimental methods before making research or clinical decisions.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-content">
      <div class="footer-attribution">
        <strong>PharmaSim Pro</strong><br/>Created by <strong>David Ferguson, BS, MS, Pharm.D. Candidate</strong><br/>Powered by <strong>Anthropic Claude AI</strong><br/>Version 1.0.0 | January 2025
      </div>
      <div class="footer-links">
        <a href="https://github.com/pharmasim-pro" target="_blank">GitHub Repository</a>
        <a href="#" onclick="showAbout()">About</a>
        <a href="#" onclick="showDisclaimer()">Full Disclaimer</a>
        <a href="#" onclick="showCitation()">How to Cite</a>
        <a href="mailto:contact@pharmasim.pro">Contact</a>
      </div>
    </div>
  </div>

  <script>
    // =============== Globals ===============
    let charts = {}; let currentModule = 'pbpk'; let capturedData = {}; let rdkit; let viewer; let molecularSimInterval = null;

    // Init RDKit (graceful fail)
    window.initRDKitModule().then((RDKit)=>{ rdkit=RDKit; console.log('RDKit version:', rdkit.version()); }).catch(()=> console.warn('RDKit failed to load; SMILES rendering disabled.'));

    // =============== Chart Setup ===============
    function initializeCharts(){
      const baseOpts={ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#333' } } }, scales:{ x:{ grid:{ color:'rgba(0,0,0,0.05)' }, ticks:{ color:'#666' } }, y:{ grid:{ color:'rgba(0,0,0,0.05)' }, ticks:{ color:'#666' } } } };

      // PBPK Charts
      const pkCtx=document.getElementById('pkChart'); if(pkCtx){ charts.pk=new Chart(pkCtx,{ type:'line', data:{ labels:[], datasets:[{ label:'Plasma Concentration', data:[], borderColor:'#2a5298', backgroundColor:'rgba(42,82,152,0.1)', tension:0.4, fill: true }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'Concentration (ng/mL)'}}, x:{...baseOpts.scales.x, title:{display:true, text:'Time (hours)'}} } } }); }
      const qspCtx=document.getElementById('qspChart'); if(qspCtx){ charts.qsp=new Chart(qspCtx,{ type:'line', data:{ labels:[], datasets:[{ label:'Target Occupancy', data:[], borderColor:'#667eea', backgroundColor:'rgba(102,126,234,0.1)', tension:0.4, fill: true }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'Occupancy (%)'}, min:0, max:100}, x:{...baseOpts.scales.x, title:{display:true, text:'Time (hours)'}} } } }); }
      const tissueCtx=document.getElementById('tissueChart'); if(tissueCtx){ charts.tissue=new Chart(tissueCtx,{ type:'bar', data:{ labels:['Plasma','Liver','Kidney','Brain','Muscle','Fat','Heart','Bone'], datasets:[{ label:'Tissue Concentration (rel.)', data:[0,0,0,0,0,0,0,0], backgroundColor:['#2a5298','#667eea','#4facfe','#00f2fe','#764ba2','#1e3c72','#7e8ba3','#3b82f6'] }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'Relative Concentration (%)'}} } } }); }
      const ddiCtx=document.getElementById('ddiChart'); if(ddiCtx){ charts.ddi=new Chart(ddiCtx,{ type:'line', data:{ labels:Array.from({length:49},(_,i)=>i*0.5), datasets:[{ label:'Without Inhibitor', data:[], borderColor:'#2a5298', backgroundColor:'rgba(42,82,152,0.1)', tension:0.3, fill: true },{ label:'With CYP Inhibitor', data:[], borderColor:'#f5576c', backgroundColor:'rgba(245,87,108,0.1)', tension:0.3, fill: true }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'Concentration (ng/mL)'}}, x:{...baseOpts.scales.x, title:{display:true, text:'Time (hours)'}} } } }); }

      // Clinical Trial Charts
      const trialCtx=document.getElementById('trialChart'); if(trialCtx){ charts.trial=new Chart(trialCtx,{ type:'scatter', data:{ datasets:[{ label:'No DLT', data:[], backgroundColor:'#2a5298', pointRadius: 5 }, { label:'DLT', data:[], backgroundColor:'#f5576c', pointStyle:'crossRot', radius:8, borderWidth:2 }] }, options:{...baseOpts, scales:{...baseOpts.scales, x:{...baseOpts.scales.x, title:{display:true, text:'Dose Level'}}, y:{...baseOpts.scales.y, title:{display:true, text:'Patient Cohort'}, ticks:{stepSize:1}} } } }); }
      const toxicityCtx=document.getElementById('toxicityChart'); if(toxicityCtx){ charts.toxicity=new Chart(toxicityCtx,{ type:'line', data:{ datasets:[{ label:'True DLT Probability', data:[], borderColor:'#e65100', tension:0.4, fill:false, borderDash:[5,5] },{ label:'Estimated DLT Probability', data:[], borderColor:'#2a5298', tension:0.4, fill:true, backgroundColor:'rgba(42,82,152,0.1)' }] }, options:{...baseOpts, scales:{...baseOpts.scales, x:{...baseOpts.scales.x, title:{display:true, text:'Dose (mg)'}}, y:{...baseOpts.scales.y, title:{display:true, text:'P(DLT)'}, min:0, max:1} } } }); }
      const comparisonCtx=document.getElementById('comparisonChart'); if(comparisonCtx){ charts.comparison=new Chart(comparisonCtx,{ type:'bar', data:{ labels:['3+3','CRM','BOIN','EWOC','BLRM','mTPI'], datasets:[{ label:'Correct MTD Selection (%)', data:[], backgroundColor:'#2a5298' },{ label:'Patients at Sub-optimal Doses (%)', data:[], backgroundColor:'#ff9800' },{ label:'Overall DLT Rate (%)', data:[], backgroundColor:'#f5576c' }] }, options:{...baseOpts, indexAxis:'y', scales:{...baseOpts.scales, x:{stacked:false, beginAtZero: true}, y:{stacked:false} } } }); }
      const ocCtx=document.getElementById('ocChart'); if(ocCtx){ charts.oc=new Chart(ocCtx,{ type:'bar', data:{ labels:[], datasets:[{ label:'Selection %', data:[], backgroundColor:'#4facfe' }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'Selection Percentage (%)'}, min:0, max:100}, x:{...baseOpts.scales.x, title:{display:true, text:'Dose Level'}} } } }); }

      // Molecular Dynamics Charts
      const energyCtx=document.getElementById('energyChart'); if(energyCtx){ charts.energy=new Chart(energyCtx,{ type:'line', data:{ labels:[], datasets:[{ label:'Potential Energy', data:[], borderColor:'#2a5298', tension:0.3, pointRadius: 0, fill: true, backgroundColor: 'rgba(42,82,152,0.1)' }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'Energy (kcal/mol)'}}, x:{...baseOpts.scales.x, title:{display:true, text:'Time (ps)'}} } } }); }
      const rmsdCtx=document.getElementById('rmsdChart'); if(rmsdCtx){ charts.rmsd=new Chart(rmsdCtx,{ type:'line', data:{ labels:[], datasets:[{ label:'RMSD', data:[], borderColor:'#667eea', tension:0.3, pointRadius: 0, fill: true, backgroundColor: 'rgba(102,126,234,0.1)' }] }, options:{...baseOpts, scales:{...baseOpts.scales, y:{...baseOpts.scales.y, title:{display:true, text:'RMSD (Å)'}}, x:{...baseOpts.scales.x, title:{display:true, text:'Time (ps)'}} } } }); }
      const interactionCtx=document.getElementById('interactionChart'); if(interactionCtx){ charts.interaction=new Chart(interactionCtx,{ type:'radar', data:{ labels:['H-Bond','Hydrophobic','Ionic','Water Bridge','Halogen'], datasets:[{ label:'Ligand A', data:[0,0,0,0,0], backgroundColor:'rgba(42,82,152,0.2)', borderColor:'#2a5298', pointBackgroundColor:'#2a5298' }] }, options:{ responsive:true, maintainAspectRatio:false, scales:{ r:{ angleLines:{ color:'rgba(0,0,0,0.1)' }, grid:{ color:'rgba(0,0,0,0.1)' }, pointLabels:{ color:'#333' }, suggestedMin:0, suggestedMax: 10 } } } }); }
    }

    // =============== UI Navigation ===============
    function switchModule(module) {
      currentModule = module;
      document.querySelectorAll('.module-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`${module}-module`).classList.add('active');
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.nav-tab[onclick="switchModule('${module}')"]`).classList.add('active');
    }

    function switchTab(tab, module) {
      document.querySelectorAll(`#${module}-module .tab-content`).forEach(c => c.classList.remove('active'));
      document.getElementById(`${tab}-tab`).classList.add('active');
      document.querySelectorAll(`#${module}-module .tab-button`).forEach(b => b.classList.remove('active'));
      document.querySelector(`#${module}-module .tab-button[onclick="switchTab('${tab}','${module}')"]`).classList.add('active');
    }

    // =============== PBPK/QSP Module ===============
    function runPBPKSimulation() {
      showLoading();
      setTimeout(() => {
        // Get inputs
        const dose = parseFloat(document.getElementById('dose').value); // mg
        const F = parseFloat(document.getElementById('bioavailability').value) / 100;
        let ka = parseFloat(document.getElementById('ka').value); // h-1
        const Vd = parseFloat(document.getElementById('vd').value); // L
        const CL = parseFloat(document.getElementById('clearance').value); // L/h
        const logP = parseFloat(document.getElementById('logp').value);
        const ec50 = parseFloat(document.getElementById('ec50').value); // nM
        const hill = parseFloat(document.getElementById('hill').value);
        const mw = parseFloat(document.getElementById('mw').value); // Da
        const formulation = document.getElementById('formulation').value;

        // Adjust ka for formulation
        if (formulation === 'extended') ka *= 0.3;
        if (formulation === 'enteric') ka *= 0.8; // simplified delay by reducing rate

        const ke = CL / Vd; // Elimination rate constant (h-1)
        if (ka <= ke) ka = ke + 0.1; // Ensure ka > ke for valid model, a common simplification

        // --- PK Simulation ---
        const time = Array.from({length: 49}, (_, i) => i * 0.5); // 0 to 24 hours
        const concentration = time.map(t => {
          const term = (F * dose * ka) / (Vd * (ka - ke));
          const conc_mg_L = term * (Math.exp(-ke * t) - Math.exp(-ka * t));
          return conc_mg_L * 1000; // convert to ng/mL
        });

        // --- Calculate PK Parameters ---
        const Cmax = Math.max(...concentration);
        const Tmax = time[concentration.indexOf(Cmax)];
        const AUC = (F * dose) / CL * 1000; // mg*h/L -> ng*h/mL
        const halfLife = 0.693 / ke;

        // --- QSP Simulation (Target Occupancy) ---
        const ec50_ng_ml = ec50 * mw / 1000; // Convert nM to ng/mL
        const occupancy = concentration.map(c => 100 * (Math.pow(c, hill)) / (Math.pow(ec50_ng_ml, hill) + Math.pow(c, hill)));

        // --- Tissue Distribution (Simplified Model) ---
        const tissueConc = [100]; // Plasma is 100% reference
        tissueConc.push(100 + logP * 20); // Liver
        tissueConc.push(90 - logP * 5); // Kidney
        tissueConc.push(10 + logP * 30); // Brain (lipophilicity matters)
        tissueConc.push(50 - logP * 10); // Muscle
        tissueConc.push(20 + logP * 50); // Fat
        tissueConc.push(70 - logP * 15); // Heart
        tissueConc.push(30 - logP * 10); // Bone
        const normalizedTissue = tissueConc.map(c => Math.max(0, c)); // No negative concentrations

        // --- DDI Simulation (CYP Inhibition -> 50% less clearance) ---
        const CL_inhibited = CL * 0.5;
        const ke_inhibited = CL_inhibited / Vd;
        const conc_inhibited = time.map(t => {
            const term = (F * dose * ka) / (Vd * (ka - ke_inhibited));
            const conc_mg_L = term * (Math.exp(-ke_inhibited * t) - Math.exp(-ka * t));
            return conc_mg_L * 1000;
        });

        // --- Update UI ---
        // Charts
        charts.pk.data.labels = time;
        charts.pk.data.datasets[0].data = concentration;
        charts.pk.update();

        charts.qsp.data.labels = time;
        charts.qsp.data.datasets[0].data = occupancy;
        charts.qsp.update();

        charts.tissue.data.datasets[0].data = normalizedTissue;
        charts.tissue.update();
        
        charts.ddi.data.datasets[0].data = concentration;
        charts.ddi.data.datasets[1].data = conc_inhibited;
        charts.ddi.update();

        // Metrics
        document.getElementById('cmax').textContent = Cmax.toFixed(2);
        document.getElementById('tmax').textContent = Tmax.toFixed(2);
        document.getElementById('auc').textContent = AUC.toFixed(0);
        document.getElementById('halflife').textContent = halfLife.toFixed(2);
        document.getElementById('cl-calc').textContent = (CL * 1000 / 60).toFixed(0) + " mL/min"; // L/hr to mL/min
        document.getElementById('vss').textContent = Vd.toFixed(1) + " L";

        hideLoading();
      }, 1500); // Simulate processing time
    }
    
    function loadSpecificDrug(type) {
        let params = {};
        switch(type) {
            case 'hydrophilic':
                params = { name: 'Metformin', dose: 500, bio: 55, ka: 1.8, vd: 650, cl: 30, logp: -1.4, mw: 129, ec50: 1500, hill: 1 };
                break;
            case 'lipophilic':
                params = { name: 'Amiodarone', dose: 200, bio: 50, ka: 0.5, vd: 4500, cl: 10, logp: 7.5, mw: 645, ec50: 300, hill: 1.2 };
                break;
            case 'high-clearance':
                params = { name: 'Propofol', dose: 150, bio: 100, ka: 3.0, vd: 300, cl: 120, logp: 3.8, mw: 178, ec50: 5000, hill: 2 };
                break;
        }
        document.getElementById('drug-name').value = params.name;
        document.getElementById('dose').value = params.dose;
        document.getElementById('bioavailability').value = params.bio;
        document.getElementById('ka').value = params.ka;
        document.getElementById('vd').value = params.vd;
        document.getElementById('clearance').value = params.cl;
        document.getElementById('logp').value = params.logp;
        document.getElementById('mw').value = params.mw;
        document.getElementById('ec50').value = params.ec50;
        document.getElementById('hill').value = params.hill;
        runPBPKSimulation();
    }
    
    // =============== Clinical Trial Module ===============
    function updateDesignInfo() {
      const design = document.getElementById('design-type').value;
      const info = {
        '3plus3': '<h4>3+3 Design</h4><p>Traditional rule-based design. Simple but inefficient. Treats 3 patients per dose, escalates if 0/3 DLTs, expands to 6 if 1/3 DLTs.</p>',
        'crm': '<h4>Continual Reassessment (CRM)</h4><p>Model-based design that uses all patient data to estimate the dose-toxicity curve and guide the next dose decision. More efficient than 3+3.</p>',
        'boin': '<h4>Bayesian Optimal Interval (BOIN)</h4><p>A hybrid design combining simplicity of rule-based methods with efficiency of model-based methods. Very popular in modern trials.</p>',
        // Add other descriptions...
      };
      document.getElementById('design-info').innerHTML = info[design] || '<h4>Select a design</h4><p>Description will appear here.</p>';
    }

    function runTrialSimulation() {
        // Simplified 3+3 simulation for demonstration
        const targetTox = parseFloat(document.getElementById('target-tox').value);
        const numDoses = parseInt(document.getElementById('cohorts').value);
        const startDose = parseFloat(document.getElementById('start-dose').value);

        // Define a "true" but unknown toxicity curve (e.g., a logistic model)
        const trueToxProbs = Array.from({length: numDoses}, (_, i) => 1 / (1 + Math.exp(-(i - (numDoses/2) + 1))));
        const trueMTDIndex = trueToxProbs.findIndex(p => p > targetTox);

        let currentDoseLevel = 0;
        let patients = []; // { level, cohort, dlt }
        let cohortNum = 1;
        
        while (currentDoseLevel < numDoses) {
            let cohortSize = 3;
            let dltsInCohort = 0;
            for (let i = 0; i < cohortSize; i++) {
                const hasDLT = Math.random() < trueToxProbs[currentDoseLevel];
                if (hasDLT) dltsInCohort++;
                patients.push({ level: currentDoseLevel + 1, cohort: cohortNum, dlt: hasDLT });
            }

            if (dltsInCohort === 0) { // Escalate
                currentDoseLevel++;
                cohortNum++;
            } else if (dltsInCohort === 1) { // Expand cohort
                let additionalDLTs = 0;
                for (let i = 0; i < 3; i++) {
                    const hasDLT = Math.random() < trueToxProbs[currentDoseLevel];
                    if (hasDLT) additionalDLTs++;
                    patients.push({ level: currentDoseLevel + 1, cohort: cohortNum, dlt: hasDLT });
                }
                if (additionalDLTs > 0) { // Stop
                    break;
                } else { // Escalate
                    currentDoseLevel++;
                    cohortNum++;
                }
            } else { // De-escalate or stop
                break;
            }
        }
        
        const MTD = currentDoseLevel;

        // Update UI
        charts.trial.data.datasets[0].data = patients.filter(p => !p.dlt).map(p => ({ x: p.level, y: p.cohort }));
        charts.trial.data.datasets[1].data = patients.filter(p => p.dlt).map(p => ({ x: p.level, y: p.cohort }));
        charts.trial.update();

        document.getElementById('mtd').textContent = `Dose ${MTD} (${(startDose * Math.pow(1.5, MTD-1)).toFixed(0)} mg)`;
        document.getElementById('total-patients').textContent = patients.length;
        document.getElementById('patients-dlt').textContent = patients.filter(p => p.dlt).length;
    }
    
    function runMonteCarloTrials(numTrials) {
        showLoading();
        setTimeout(() => {
            // In a real scenario, this would run `runTrialSimulation` numTrials times
            // and aggregate the results. For this demo, we'll generate mock data.
            const numDoses = parseInt(document.getElementById('cohorts').value);
            const trueMTD = Math.ceil(numDoses / 2);
            let selectionCounts = Array(numDoses).fill(0);
            for (let i=0; i < numTrials; i++) {
                // Simplified random outcome
                const selectedMTD = Math.floor(Math.random() * numDoses);
                selectionCounts[selectedMTD]++;
            }
            const selectionPercentages = selectionCounts.map(c => (c/numTrials) * 100);
            
            charts.oc.data.labels = Array.from({length: numDoses}, (_, i) => `Dose ${i+1}`);
            charts.oc.data.datasets[0].data = selectionPercentages;
            charts.oc.data.datasets[0].backgroundColor = selectionPercentages.map((_, i) => i + 1 === trueMTD ? '#4caf50' : '#4facfe');
            charts.oc.update();
            hideLoading();
        }, 2000);
    }
    
    function compareDesigns() {
        showLoading();
        setTimeout(() => {
            // Mock data for design comparison
            charts.comparison.data.datasets[0].data = [45, 75, 85, 70, 80, 82]; // Correct MTD Selection
            charts.comparison.data.datasets[1].data = [60, 30, 25, 35, 28, 27]; // Patients at Sub-optimal Doses
            charts.comparison.data.datasets[2].data = [20, 28, 26, 22, 27, 26]; // Overall DLT Rate
            charts.comparison.update();
            hideLoading();
        }, 1500);
    }

    // =============== Molecular Dynamics Module ===============
    function loadMolecularStructure() {
        const smiles = document.getElementById('smilesInput').value;
        const pdbFile = document.getElementById('pdbFile').files[0];
        
        if (!smiles && !pdbFile) {
            alert("Please enter a SMILES string or upload a PDB file.");
            return;
        }

        const element = $('#molecularDisplay');
        if (!viewer) {
            viewer = $3Dmol.createViewer(element);
        } else {
            viewer.clear();
        }

        if (pdbFile) {
            const reader = new FileReader();
            reader.onload = function(event) {
                viewer.addModel(event.target.result, "pdb");
                viewer.setStyle({}, {stick: {}});
                viewer.zoomTo();
                viewer.render();
            };
            reader.readAsText(pdbFile);
        } else if (smiles && rdkit) {
            const mol = rdkit.get_mol(smiles);
            const molBlock = mol.get_molblock();
            viewer.addModel(molBlock, "mol");
            viewer.setStyle({}, {stick: {}});
            viewer.zoomTo();
            viewer.render();
            mol.delete();
        } else if (smiles) {
            alert("RDKit module not loaded. Cannot process SMILES string.");
        }
    }
    
    function startMolecularSimulation() {
        stopMolecularSimulation(); // Stop any existing simulation
        // This is a mock simulation for demonstration
        let time = 0;
        let energy = -1500 + Math.random() * 100;
        let rmsd = 0.5 + Math.random() * 0.2;
        
        charts.energy.data.labels = [];
        charts.energy.data.datasets[0].data = [];
        charts.rmsd.data.labels = [];
        charts.rmsd.data.datasets[0].data = [];

        molecularSimInterval = setInterval(() => {
            time += 5; // 5 ps step
            energy += (Math.random() - 0.5) * 10 - 2; // general downward trend with noise
            rmsd += (Math.random() - 0.45) * 0.05; // general upward trend to a plateau, with noise
            rmsd = Math.max(0.5, rmsd);

            charts.energy.data.labels.push(time);
            charts.energy.data.datasets[0].data.push(energy);
            charts.rmsd.data.labels.push(time);
            charts.rmsd.data.datasets[0].data.push(rmsd);
            
            // Limit to 100 data points for performance
            if (charts.energy.data.labels.length > 100) {
                charts.energy.data.labels.shift();
                charts.energy.data.datasets[0].data.shift();
                charts.rmsd.data.labels.shift();
                charts.rmsd.data.datasets[0].data.shift();
            }

            charts.energy.update();
            charts.rmsd.update();
            
            if (time >= 500) { // Stop after 500ps
                stopMolecularSimulation();
            }
        }, 100);
        
        // Update other metrics with random final values
        document.getElementById('total-energy').textContent = (-1600 - Math.random() * 100).toFixed(1);
        document.getElementById('binding-affinity').textContent = (-8.5 - Math.random() * 2).toFixed(2);
        document.getElementById('rmsd').textContent = (1.8 + Math.random() * 0.5).toFixed(2);
        document.getElementById('hbonds').textContent = Math.floor(Math.random() * 5) + 1;
    }

    function stopMolecularSimulation() {
        if (molecularSimInterval) {
            clearInterval(molecularSimInterval);
            molecularSimInterval = null;
        }
    }

    // =============== Publications Module ===============
    function captureResults(module) {
        if (module === 'pbpk') {
            capturedData.pbpk = {
                Drug: document.getElementById('drug-name').value || 'Drug X',
                Cmax: document.getElementById('cmax').textContent,
                Tmax: document.getElementById('tmax').textContent,
                AUC: document.getElementById('auc').textContent,
                HalfLife: document.getElementById('halflife').textContent,
                CL: document.getElementById('cl-calc').textContent,
                Vss: document.getElementById('vss').textContent,
            };
        } else if (module === 'clinical') {
            capturedData.clinical = {
                Drug: document.getElementById('study-drug-name').value || 'Study Drug',
                Design: document.getElementById('design-type').value,
                MTD: document.getElementById('mtd').textContent,
                TotalPatients: document.getElementById('total-patients').textContent,
            };
        }
        alert('Results captured! Go to the Research Publications tab to use them.');
        
        // Pre-fill publication form
        const drug = capturedData.pbpk?.Drug || capturedData.clinical?.Drug;
        if(drug) document.getElementById('pub-drug').value = drug;
        const protein = document.getElementById('target-protein').value;
        if(protein) document.getElementById('pub-protein').value = protein;
        
        let dataString = '';
        if (capturedData.pbpk) {
            dataString += 'PBPK Results:\n' + Object.entries(capturedData.pbpk).map(([k,v]) => `${k}: ${v}`).join('\n');
        }
        if (capturedData.clinical) {
            dataString += '\n\nClinical Trial Results:\n' + Object.entries(capturedData.clinical).map(([k,v]) => `${k}: ${v}`).join('\n');
        }
        document.getElementById('pub-data').value = dataString.trim();
    }
    
    function generatePublicationHTML() {
        const title = document.getElementById('pub-title').value || 'Untitled Publication';
        const authors = document.getElementById('pub-authors').value || 'Anonymous';
        const drug = document.getElementById('pub-drug').value || '[DRUG NAME]';
        const protein = document.getElementById('pub-protein').value || '[PROTEIN NAME]';
        const findings = document.getElementById('pub-findings').value.replace(/\n/g, '<br/>') || '[KEY FINDINGS]';
        const data = document.getElementById('pub-data').value.replace(/\n/g, '<br/>') || '[DATA VALUES]';
        const implications = document.getElementById('pub-implications').value.replace(/\n/g, '<br/>') || '[IMPLICATIONS FOR SCIENTISTS]';
        const date = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        return `
            <h4 class="blog-post-title">${title}</h4>
            <div class="blog-post-meta">By ${authors} • ${date}</div>
            <div class="blog-post-content">
                <p><strong>Abstract:</strong><br/>We performed computational modeling of ${drug} interaction with ${protein} using PharmaSim Pro (Ferguson, D.; Anthropic Claude AI).</p>
                <br/><p><strong>Key Parameters:</strong><br/>${data}</p>
                <br/><p><strong>Major Findings:</strong><br/>${findings}</p>
                <br/><p><strong>Implications:</strong><br/>${implications}</p>
                <br/><p><strong>Disclaimer:</strong><br/>These computational predictions require validation through experimental studies. Values represent theoretical estimates from simplified models.</p>
                <br/><p><strong>Citation:</strong><br/>Created using PharmaSim Pro by David Ferguson (Pharm.D. Candidate) powered by Anthropic Claude AI. Code available on GitHub.</p>
            </div>`;
    }

    function previewPublication() {
        const preview = document.getElementById('publication-preview');
        preview.innerHTML = generatePublicationHTML();
        preview.style.display = 'block';
    }
    
    function publishFindings() {
        const list = document.getElementById('publications-list');
        const newPost = document.createElement('div');
        newPost.className = 'blog-post-card';
        newPost.innerHTML = generatePublicationHTML();
        list.prepend(newPost);
        clearPublication();
    }
    
    function clearPublication() {
        document.getElementById('pub-title').value = '';
        document.getElementById('pub-authors').value = '';
        document.getElementById('pub-drug').value = '';
        document.getElementById('pub-protein').value = '';
        document.getElementById('pub-findings').value = '';
        document.getElementById('pub-data').value = '';
        document.getElementById('pub-implications').value = '';
        document.getElementById('publication-preview').style.display = 'none';
    }


    // =============== Utility Functions ===============
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }
    
    function loadPreset(module) {
        if (module === 'pbpk') {
            document.getElementById('drug-name').value = "Example Drug";
            document.getElementById('dose').value = (Math.random() * 500 + 50).toFixed(0);
            document.getElementById('bioavailability').value = (Math.random() * 80 + 20).toFixed(0);
            document.getElementById('ka').value = (Math.random() * 2.5 + 0.5).toFixed(1);
            document.getElementById('vd').value = (Math.random() * 400 + 20).toFixed(0);
            document.getElementById('clearance').value = (Math.random() * 50 + 5).toFixed(1);
            document.getElementById('logp').value = (Math.random() * 6 - 1).toFixed(1);
            document.getElementById('ec50').value = (Math.random() * 200 + 10).toFixed(0);
            runPBPKSimulation();
        }
    }

    // =============== Event Listeners ===============
    document.addEventListener('DOMContentLoaded', () => {
      initializeCharts();
      
      // Add listeners for value displays on sliders/number inputs
      document.querySelectorAll('.control-group input[type="number"], .control-group input[type="range"]').forEach(input => {
        input.addEventListener('input', (e) => {
            const display = e.target.parentElement.querySelector('.value-display');
            if (display) {
                // Custom display logic
                if (e.target.id === 'mdTemp') {
                    display.querySelector('span').textContent = e.target.value;
                } else if (e.target.id === 'bioavailability') {
                    display.textContent = `${e.target.value}% reaches systemic circulation`;
                } else {
                    // Generic display logic can be added here
                }
            }
        });
      });
      
      // Default run on load
      runPBPKSimulation();
    });

  </script>
</body>
</html>
