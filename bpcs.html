<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaSim Pro - Integrated Pharmaceutical Research Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            color: #333;
            min-height: 100vh;
            padding: 0;
        }
        
        .header {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,248,255,0.95) 100%);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 2.2em;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        
        .header-subtitle {
            color: #666;
            font-size: 1em;
        }
        
        .nav-tabs {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            border-bottom: 2px solid rgba(30,60,114,0.1);
            padding-bottom: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: white;
            color: #2a5298;
            border: 2px solid #2a5298;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42,82,152,0.3);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border-color: transparent;
        }
        
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .nav-tab:hover .tooltip {
            opacity: 1;
        }
        
        .main-container {
            max-width: 1600px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .module-section {
            display: none;
        }
        
        .module-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 25px;
        }
        
        .control-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            height: fit-content;
            position: sticky;
            top: 120px;
        }
        
        .control-panel h2 {
            color: #1e3c72;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(30,60,114,0.1);
        }
        
        .help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #2a5298;
            color: white;
            text-align: center;
            line-height: 18px;
            border-radius: 50%;
            font-size: 11px;
            margin-left: 8px;
            cursor: help;
            vertical-align: middle;
        }
        
        .help-text {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            line-height: 1.5;
            width: 250px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        
        .help-icon:hover + .help-text {
            display: block;
        }
        
        .control-group {
            margin-bottom: 18px;
            position: relative;
        }
        
        .control-group label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        .control-group input[type="number"],
        .control-group input[type="text"],
        .control-group input[type="file"],
        .control-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        
        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #2a5298;
            background: white;
            box-shadow: 0 0 0 3px rgba(42,82,152,0.1);
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .value-display {
            font-size: 12px;
            color: #777;
            text-align: right;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            flex: 1;
            padding: 12px 18px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(42,82,152,0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(42,82,152,0.4);
        }
        
        button.secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        button.danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .visualization-area {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
        }
        
        .chart-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            min-height: 400px;
            position: relative;
        }
        
        .chart-container h3 {
            color: #1e3c72;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(30,60,114,0.1);
        }
        
        .results-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .results-panel h3 {
            color: #1e3c72;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(30,60,114,0.1);
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(30,60,114,0.1);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .metric-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2a5298;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-box h4 {
            color: #1e3c72;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .info-box p {
            color: #555;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(30,60,114,0.05);
            border-radius: 10px;
        }
        
        .tab-button {
            padding: 8px 16px;
            background: white;
            color: #2a5298;
            border: 1px solid #2a5298;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: #2a5298;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        canvas {
            width: 100% !important;
            height: 350px !important;
            border-radius: 10px;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2a5298;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .educational-tip {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 13px;
            color: #5d4037;
        }
        
        .educational-tip strong {
            color: #e65100;
        }
        
        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .control-panel {
                position: relative;
                top: 0;
            }
            .visualization-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>PharmaSim Pro</h1>
        <p class="header-subtitle">Integrated Pharmaceutical Research Platform for Students</p>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchModule('pbpk')">
                PBPK/QSP Modeling
                <span class="tooltip">Physiologically-based pharmacokinetic modeling</span>
            </button>
            <button class="nav-tab" onclick="switchModule('clinical')">
                Clinical Trial Design
                <span class="tooltip">Bayesian adaptive trial simulation</span>
            </button>
            <button class="nav-tab" onclick="switchModule('molecular')">
                Molecular Dynamics
                <span class="tooltip">Protein and ligand interactions</span>
            </button>
            <button class="nav-tab" onclick="switchModule('tutorial')">
                Learning Center
                <span class="tooltip">Interactive tutorials and guides</span>
            </button>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Running simulation...</p>
        </div>
    </div>
    
    <div class="main-container">
        <!-- PBPK/QSP Module -->
        <div class="module-section active" id="pbpk-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>PBPK/QSP Parameters</h2>
                    
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('absorption', 'pbpk')">Absorption</button>
                        <button class="tab-button" onclick="switchTab('distribution', 'pbpk')">Distribution</button>
                        <button class="tab-button" onclick="switchTab('metabolism', 'pbpk')">Metabolism</button>
                        <button class="tab-button" onclick="switchTab('qsp', 'pbpk')">QSP</button>
                    </div>
                    
                    <div class="tab-content active" id="absorption-tab">
                        <div class="control-group">
                            <label>
                                Bioavailability (F)
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    The fraction of drug that reaches systemic circulation unchanged. 
                                    Oral drugs typically range from 5-100%.
                                </div>
                            </label>
                            <input type="number" id="bioavailability" value="80" min="0" max="100" step="5">
                            <div class="value-display">80% reaches systemic circulation</div>
                        </div>
                        <div class="control-group">
                            <label>
                                Absorption Rate (ka)
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    First-order absorption rate constant. Higher values = faster absorption.
                                    Typical range: 0.5-3.0 h⁻¹
                                </div>
                            </label>
                            <input type="number" id="ka" value="1.5" step="0.1">
                            <div class="value-display">1.5 h⁻¹</div>
                        </div>
                        <div class="control-group">
                            <label>
                                Formulation
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Different formulations affect drug release and absorption patterns
                                </div>
                            </label>
                            <select id="formulation">
                                <option value="immediate">Immediate Release</option>
                                <option value="extended">Extended Release</option>
                                <option value="enteric">Enteric Coated</option>
                                <option value="sublingual">Sublingual</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="distribution-tab">
                        <div class="control-group">
                            <label>
                                Volume of Distribution (Vd)
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Apparent volume the drug distributes into. Large Vd = extensive tissue distribution.
                                    Water-soluble drugs: ~40L, Lipophilic drugs: >100L
                                </div>
                            </label>
                            <input type="number" id="vd" value="70" step="5">
                            <div class="value-display">70 L</div>
                        </div>
                        <div class="control-group">
                            <label>
                                Plasma Protein Binding
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Percentage bound to plasma proteins (mainly albumin).
                                    Only unbound drug is pharmacologically active.
                                </div>
                            </label>
                            <input type="number" id="protein-binding" value="90" min="0" max="100">
                            <div class="value-display">90% bound, 10% free</div>
                        </div>
                        <div class="control-group">
                            <label>
                                LogP (Lipophilicity)
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Partition coefficient - measure of lipophilicity.
                                    LogP < 0: Hydrophilic, LogP > 3: Lipophilic
                                </div>
                            </label>
                            <input type="number" id="logp" value="2.5" step="0.1">
                        </div>
                    </div>
                    
                    <div class="tab-content" id="metabolism-tab">
                        <div class="control-group">
                            <label>
                                Clearance (CL)
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Volume of plasma cleared of drug per unit time.
                                    Hepatic CL typically 0.5-2.0 L/h for most drugs
                                </div>
                            </label>
                            <input type="number" id="clearance" value="1.2" step="0.1">
                            <div class="value-display">1.2 L/h</div>
                        </div>
                        <div class="control-group">
                            <label>
                                Primary Enzyme
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    CYP450 enzymes metabolize ~75% of all drugs.
                                    Important for drug-drug interactions.
                                </div>
                            </label>
                            <select id="enzyme">
                                <option value="cyp3a4">CYP3A4 (50% of drugs)</option>
                                <option value="cyp2d6">CYP2D6 (25% of drugs)</option>
                                <option value="cyp2c9">CYP2C9 (15% of drugs)</option>
                                <option value="cyp1a2">CYP1A2</option>
                                <option value="cyp2c19">CYP2C19</option>
                                <option value="ugt">UGT (Glucuronidation)</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>
                                Renal Function
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Creatinine clearance affects renal drug elimination.
                                    Normal: 90-120 mL/min
                                </div>
                            </label>
                            <select id="renal-function">
                                <option value="normal">Normal (CrCl > 90)</option>
                                <option value="mild">Mild Impairment (60-90)</option>
                                <option value="moderate">Moderate (30-60)</option>
                                <option value="severe">Severe (15-30)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="qsp-tab">
                        <div class="control-group">
                            <label>
                                Target Receptor
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    The biological target the drug binds to
                                </div>
                            </label>
                            <select id="target-receptor">
                                <option value="gpcr">GPCR (40% of drugs)</option>
                                <option value="kinase">Kinase</option>
                                <option value="nuclear">Nuclear Receptor</option>
                                <option value="ion-channel">Ion Channel</option>
                                <option value="enzyme">Enzyme</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>
                                EC50 (nM)
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Concentration producing 50% of maximum effect.
                                    Lower EC50 = more potent drug
                                </div>
                            </label>
                            <input type="number" id="ec50" value="50" step="5">
                        </div>
                        <div class="control-group">
                            <label>
                                Hill Coefficient
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Steepness of dose-response curve.
                                    n=1: Simple binding, n>1: Cooperative binding
                                </div>
                            </label>
                            <input type="number" id="hill" value="1.5" step="0.1">
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="runPBPKSimulation()">Run PBPK Simulation</button>
                        <button class="secondary" onclick="loadPreset('pbpk')">Load Example</button>
                    </div>
                    
                    <div class="educational-tip">
                        <strong>💡 Learning Tip:</strong> Start with the example preset to see typical drug parameters, then modify one parameter at a time to understand its effect on the PK profile.
                    </div>
                </div>
                
                <div class="visualization-area">
                    <div class="chart-container">
                        <h3>Plasma Concentration Profile</h3>
                        <canvas id="pkChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Target Occupancy</h3>
                        <canvas id="qspChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Tissue Distribution</h3>
                        <canvas id="tissueChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Drug-Drug Interactions</h3>
                        <canvas id="ddiChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="results-panel">
                <h3>Pharmacokinetic Parameters</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-label">Cmax</div>
                        <div class="metric-value" id="cmax">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Tmax</div>
                        <div class="metric-value" id="tmax">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">AUC₀₋∞</div>
                        <div class="metric-value" id="auc">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Half-life</div>
                        <div class="metric-value" id="halflife">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Clearance</div>
                        <div class="metric-value" id="cl-calc">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Vss</div>
                        <div class="metric-value" id="vss">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Clinical Trial Module -->
        <div class="module-section" id="clinical-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>Clinical Trial Design</h2>
                    
                    <div class="info-box">
                        <h4>Phase 1 Trial Objectives</h4>
                        <p>Determine the maximum tolerated dose (MTD) and recommended phase 2 dose (RP2D) while minimizing patient exposure to toxic doses.</p>
                    </div>
                    
                    <div class="control-group">
                        <label>
                            Design Type
                            <span class="help-icon">?</span>
                            <div class="help-text">
                                Choose between traditional and modern Bayesian adaptive designs
                            </div>
                        </label>
                        <select id="design-type" onchange="updateDesignInfo()">
                            <option value="3plus3">3+3 Traditional</option>
                            <option value="crm">CRM - Continual Reassessment</option>
                            <option value="boin">BOIN - Bayesian Optimal Interval</option>
                            <option value="ewoc">EWOC - Escalation with Overdose Control</option>
                            <option value="blrm">BLRM - Bayesian Logistic Regression</option>
                            <option value="mTPI">mTPI - Modified Toxicity Probability Interval</option>
                        </select>
                    </div>
                    
                    <div id="design-info" class="info-box" style="margin-top: 15px;">
                        <h4>3+3 Design</h4>
                        <p>Traditional rule-based design. Simple but inefficient. Treats 3 patients per dose, escalates if 0/3 DLTs, expands to 6 if 1/3 DLTs.</p>
                    </div>
                    
                    <div class="control-group">
                        <label>
                            Target DLT Rate
                            <span class="help-icon">?</span>
                            <div class="help-text">
                                Acceptable dose-limiting toxicity rate. Usually 20-33% for oncology trials
                            </div>
                        </label>
                        <input type="number" id="target-tox" value="0.25" min="0.1" max="0.4" step="0.05">
                        <div class="value-display">25% target toxicity</div>
                    </div>
                    
                    <div class="control-group">
                        <label>
                            Starting Dose (mg)
                            <span class="help-icon">?</span>
                            <div class="help-text">
                                Usually 1/10th of the dose that causes severe toxicity in 10% of animals (MABEL approach)
                            </div>
                        </label>
                        <input type="number" id="start-dose" value="10" step="5">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            Maximum Dose (mg)
                            <span class="help-icon">?</span>
                            <div class="help-text">
                                Safety ceiling based on preclinical data
                            </div>
                        </label>
                        <input type="number" id="max-dose" value="200" step="10">
                    </div>
                    
                    <div class="control-group">
                        <label>
                            Dose Escalation Scheme
                            <span class="help-icon">?</span>
                            <div class="help-text">
                                How doses increase between cohorts
                            </div>
                        </label>
                        <select id="escalation-scheme">
                            <option value="fibonacci">Modified Fibonacci (67%, 50%, 40%, 33%...)</option>
                            <option value="doubling">Doubling (100% increases)</option>
                            <option value="pharmacologic">Pharmacologically-guided</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <label>Number of Dose Levels</label>
                        <input type="number" id="cohorts" value="6" min="3" max="10">
                    </div>
                    
                    <div class="control-group">
                        <label>Cohort Size</label>
                        <input type="number" id="cohort-size" value="3" min="1" max="6">
                    </div>
                    
                    <div class="button-group">
                        <button onclick="runTrialSimulation()">Run Single Trial</button>
                        <button class="secondary" onclick="runMonteCarloTrials()">Run 1000 Trials</button>
                        <button class="success" onclick="compareDesigns()">Compare All Designs</button>
                    </div>
                    
                    <div class="educational-tip">
                        <strong>💡 Learning Tip:</strong> Modern Bayesian designs (CRM, BOIN) typically find the MTD with fewer patients than the traditional 3+3 design. Run the comparison to see the differences!
                    </div>
                </div>
                
                <div class="visualization-area">
                    <div class="chart-container">
                        <h3>Dose Escalation Progress</h3>
                        <canvas id="trialChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Dose-Toxicity Curve</h3>
                        <canvas id="toxicityChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Design Performance Comparison</h3>
                        <canvas id="comparisonChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Operating Characteristics</h3>
                        <canvas id="ocChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="results-panel">
                <h3>Trial Results</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-label">MTD Estimate</div>
                        <div class="metric-value" id="mtd">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">RP2D</div>
                        <div class="metric-value" id="rp2d">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">DLT Rate at MTD</div>
                        <div class="metric-value" id="dlt-rate">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Patients</div>
                        <div class="metric-value" id="total-patients">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Patients with DLT</div>
                        <div class="metric-value" id="patients-dlt">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Trial Duration</div>
                        <div class="metric-value" id="trial-duration">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Molecular Dynamics Module -->
        <div class="module-section" id="molecular-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>Molecular Simulations</h2>
                    
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="switchTab('structure', 'molecular')">Structure</button>
                        <button class="tab-button" onclick="switchTab('dynamics', 'molecular')">Dynamics</button>
                        <button class="tab-button" onclick="switchTab('binding', 'molecular')">Binding</button>
                    </div>
                    
                    <div class="tab-content active" id="structure-tab">
                        <div class="control-group">
                            <label>
                                Load PDB Structure
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Upload a Protein Data Bank file to visualize molecular structure
                                </div>
                            </label>
                            <input type="file" id="pdbFile" accept=".pdb">
                        </div>
                        <div class="control-group">
                            <label>
                                Or Enter Drug SMILES
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Simplified molecular-input line-entry system notation
                                </div>
                            </label>
                            <input type="text" id="smilesInput" placeholder="e.g., CC(=O)OC1=CC=CC=C1C(=O)O for Aspirin">
                        </div>
                        <button onclick="loadMolecularStructure()">Load Structure</button>
                        
                        <div class="educational-tip">
                            <strong>Example SMILES:</strong><br>
                            • Aspirin: CC(=O)OC1=CC=CC=C1C(=O)O<br>
                            • Caffeine: CN1C=NC2=C1C(=O)N(C(=O)N2)C<br>
                            • Ibuprofen: CC(C)CC1=CC=C(C=C1)C(C)C(=O)O
                        </div>
                    </div>
                    
                    <div class="tab-content" id="dynamics-tab">
                        <div class="control-group">
                            <label>
                                Simulation Type
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Different molecular simulation methods
                                </div>
                            </label>
                            <select id="sim-type">
                                <option value="md">Molecular Dynamics</option>
                                <option value="mc">Monte Carlo</option>
                                <option value="docking">Molecular Docking</option>
                                <option value="qm">Quantum Mechanics</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Temperature (K)</label>
                            <input type="range" id="mdTemp" min="100" max="500" value="300">
                            <div class="value-display"><span id="mdTempValue">300</span> K (27°C)</div>
                        </div>
                        <div class="control-group">
                            <label>Force Field</label>
                            <select id="forceField">
                                <option value="amber">AMBER (proteins)</option>
                                <option value="charmm">CHARMM (biomolecules)</option>
                                <option value="opls">OPLS (organic molecules)</option>
                                <option value="gromos">GROMOS (united atom)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="binding-tab">
                        <div class="control-group">
                            <label>
                                Binding Site
                                <span class="help-icon">?</span>
                                <div class="help-text">
                                    Active site or allosteric binding location
                                </div>
                            </label>
                            <select id="binding-site">
                                <option value="active">Active Site</option>
                                <option value="allosteric">Allosteric Site</option>
                                <option value="interface">Protein-Protein Interface</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Docking Algorithm</label>
                            <select id="docking-algorithm">
                                <option value="rigid">Rigid Docking</option>
                                <option value="flexible">Flexible Docking</option>
                                <option value="ensemble">Ensemble Docking</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label>Scoring Function</label>
                            <select id="scoring">
                                <option value="empirical">Empirical</option>
                                <option value="knowledge">Knowledge-based</option>
                                <option value="force">Force Field</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button onclick="startMolecularSimulation()">Start Simulation</button>
                        <button class="danger" onclick="stopMolecularSimulation()">Stop</button>
                        <button class="secondary" onclick="exportMolecularData()">Export Data</button>
                    </div>
                </div>
                
                <div class="visualization-area">
                    <div class="chart-container">
                        <h3>3D Molecular Structure</h3>
                        <canvas id="molecularCanvas"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Energy Profile</h3>
                        <canvas id="energyChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>RMSD Over Time</h3>
                        <canvas id="rmsdChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Interaction Analysis</h3>
                        <canvas id="interactionChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="results-panel">
                <h3>Simulation Metrics</h3>
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-label">Total Energy</div>
                        <div class="metric-value" id="total-energy">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Binding Affinity</div>
                        <div class="metric-value" id="binding-affinity">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">RMSD</div>
                        <div class="metric-value" id="rmsd">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">H-Bonds</div>
                        <div class="metric-value" id="hbonds">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Radius of Gyration</div>
                        <div class="metric-value" id="rg">--</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">SASA</div>
                        <div class="metric-value" id="sasa">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Learning Center -->
        <div class="module-section" id="tutorial-module">
            <div style="max-width: 1200px; margin: 0 auto;">
                <div class="chart-container" style="margin-bottom: 25px;">
                    <h3>Welcome to the Learning Center</h3>
                    <div class="info-box">
                        <h4>Getting Started with PharmaSim Pro</h4>
                        <p>This integrated platform combines three essential areas of pharmaceutical research:</p>
                        <ul style="margin: 15px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>PBPK/QSP Modeling:</strong> Understand drug absorption, distribution, metabolism, and excretion</li>
                            <li><strong>Clinical Trial Design:</strong> Learn about adaptive dose-finding methods in Phase 1 trials</li>
                            <li><strong>Molecular Dynamics:</strong> Explore drug-target interactions at the molecular level</li>
                        </ul>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="control-panel">
                        <h2>Interactive Tutorials</h2>
                        <div class="button-group" style="flex-direction: column;">
                            <button onclick="startTutorial('pbpk-basics')">PBPK Basics</button>
                            <button onclick="startTutorial('trial-designs')">Understanding Trial Designs</button>
                            <button onclick="startTutorial('molecular-intro')">Molecular Simulations 101</button>
                            <button onclick="startTutorial('case-study')">Complete Case Study</button>
                        </div>
                        
                        <div class="info-box" style="margin-top: 20px;">
                            <h4>Key Concepts</h4>
                            <p>Click on any tutorial to begin an interactive guided walkthrough of that module.</p>
                        </div>
                    </div>
                    
                    <div class="visualization-area">
                        <div class="chart-container" id="tutorial-content">
                            <h3>Select a Tutorial</h3>
                            <div class="educational-tip">
                                <strong>Recommended Learning Path:</strong>
                                <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Start with PBPK Basics to understand drug pharmacokinetics</li>
                                    <li>Move to Clinical Trial Designs to learn about dose finding</li>
                                    <li>Explore Molecular Simulations for drug-target interactions</li>
                                    <li>Complete the integrated case study</li>
                                </ol>
                            </div>
                            
                            <div class="info-box" style="margin-top: 20px;">
                                <h4>Quick Reference Formulas</h4>
                                <div style="font-family: monospace; margin: 10px 0;">
                                    <p><strong>Clearance:</strong> CL = Dose / AUC</p>
                                    <p><strong>Half-life:</strong> t½ = 0.693 × Vd / CL</p>
                                    <p><strong>Loading Dose:</strong> LD = Vd × Css</p>
                                    <p><strong>Maintenance Dose:</strong> MD = CL × Css × τ</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let charts = {};
        let simulations = {};
        let currentModule = 'pbpk';
        let animationFrames = {};
        
        // Initialize all charts
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#333' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#666' }
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.05)' },
                        ticks: { color: '#666' }
                    }
                }
            };
            
            // PBPK Charts
            const pkCtx = document.getElementById('pkChart');
            if (pkCtx) {
                charts.pk = new Chart(pkCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Plasma Concentration',
                            data: [],
                            borderColor: '#2a5298',
                            backgroundColor: 'rgba(42,82,152,0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...chartOptions,
                        scales: {
                            ...chartOptions.scales,
                            y: {
                                ...chartOptions.scales.y,
                                title: { display: true, text: 'Concentration (ng/mL)' }
                            },
                            x: {
                                ...chartOptions.scales.x,
                                title: { display: true, text: 'Time (hours)' }
                            }
                        }
                    }
                });
            }
            
            const qspCtx = document.getElementById('qspChart');
            if (qspCtx) {
                charts.qsp = new Chart(qspCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Target Occupancy',
                            data: [],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102,126,234,0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...chartOptions,
                        scales: {
                            ...chartOptions.scales,
                            y: {
                                ...chartOptions.scales.y,
                                title: { display: true, text: 'Occupancy (%)' },
                                min: 0,
                                max: 100
                            },
                            x: {
                                ...chartOptions.scales.x,
                                title: { display: true, text: 'Time (hours)' }
                            }
                        }
                    }
                });
            }
            
            // Clinical Trial Charts
            const trialCtx = document.getElementById('trialChart');
            if (trialCtx) {
                charts.trial = new Chart(trialCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'No DLT',
                            data: [],
                            backgroundColor: '#4facfe',
                            pointRadius: 8
                        }, {
                            label: 'DLT',
                            data: [],
                            backgroundColor: '#f5576c',
                            pointRadius: 8
                        }]
                    },
                    options: {
                        ...chartOptions,
                        scales: {
                            ...chartOptions.scales,
                            y: {
                                ...chartOptions.scales.y,
                                title: { display: true, text: 'Dose Level (mg)' }
                            },
                            x: {
                                ...chartOptions.scales.x,
                                title: { display: true, text: 'Patient Number' }
                            }
                        }
                    }
                });
            }
            
            // Initialize other charts similarly...
        }
        
        // Module switching
        function switchModule(module) {
            document.querySelectorAll('.module-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(module + '-module').classList.add('active');
            document.querySelector(`.nav-tab[onclick="switchModule('${module}')"]`).classList.add('active');
            currentModule = module;
        }
        
        // Tab switching within modules
        function switchTab(tabName, module) {
            const modulePrefix = module + '-';
            document.querySelectorAll(`#${module}-module .tab-content`).forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll(`#${module}-module .tab-button`).forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // PBPK Simulation
        class PBPKModel {
            constructor(params) {
                this.clearance = params.clearance;
                this.vd = params.vd;
                this.ka = params.ka;
                this.f = params.bioavailability / 100;
                this.dose = params.dose || 100;
                this.proteinBinding = params.proteinBinding / 100;
            }
            
            simulate(timePoints) {
                const ke = this.clearance / this.vd;
                const concentrations = [];
                
                for (let t of timePoints) {
                    let c;
                    if (Math.abs(this.ka - ke) < 1e-6) {
                        c = this.dose * this.f * this.ka * t * Math.exp(-this.ka * t) / this.vd;
                    } else {
                        c = (this.dose * this.f * this.ka / (this.vd * (this.ka - ke))) * 
                            (Math.exp(-ke * t) - Math.exp(-this.ka * t));
                    }
                    concentrations.push(Math.max(0, c * 1000));
                }
                
                return concentrations;
            }
            
            calculateMetrics(concentrations, timePoints) {
                const cmax = Math.max(...concentrations);
                const tmaxIndex = concentrations.indexOf(cmax);
                const tmax = timePoints[tmaxIndex];
                
                let auc = 0;
                for (let i = 1; i < concentrations.length; i++) {
                    auc += 0.5 * (concentrations[i] + concentrations[i-1]) * 
                           (timePoints[i] - timePoints[i-1]);
                }
                
                const ke = this.clearance / this.vd;
                const halfLife = 0.693 / ke;
                
                return { 
                    cmax: cmax.toFixed(1),
                    tmax: tmax.toFixed(1),
                    auc: auc.toFixed(0),
                    halfLife: halfLife.toFixed(1),
                    clearance: this.clearance.toFixed(2),
                    vss: (this.vd * 0.8).toFixed(1)
                };
            }
        }
        
        // Clinical Trial Simulations with multiple Bayesian designs
        class BayesianTrial {
            constructor(params) {
                this.designType = params.designType;
                this.targetToxicity = params.targetToxicity;
                this.cohorts = params.cohorts;
                this.cohortSize = params.cohortSize;
                this.startDose = params.startDose;
                this.maxDose = params.maxDose;
                this.escalationScheme = params.escalationScheme;
                this.doseLevels = this.generateDoseLevels();
            }
            
            generateDoseLevels() {
                const levels = [];
                let currentDose = this.startDose;
                levels.push(currentDose);
                
                if (this.escalationScheme === 'fibonacci') {
                    const increments = [1.67, 1.5, 1.4, 1.33, 1.33, 1.33];
                    for (let i = 0; i < this.cohorts - 1 && currentDose < this.maxDose; i++) {
                        currentDose *= increments[Math.min(i, increments.length - 1)];
                        levels.push(Math.min(currentDose, this.maxDose));
                    }
                } else if (this.escalationScheme === 'doubling') {
                    while (levels.length < this.cohorts && currentDose < this.maxDose) {
                        currentDose *= 2;
                        levels.push(Math.min(currentDose, this.maxDose));
                    }
                } else {
                    const ratio = Math.pow(this.maxDose / this.startDose, 1 / (this.cohorts - 1));
                    for (let i = 1; i < this.cohorts; i++) {
                        levels.push(this.startDose * Math.pow(ratio, i));
                    }
                }
                
                return levels;
            }
            
            getToxicityProbability(dose) {
                const steepness = 0.02;
                const midpoint = this.maxDose * 0.6;
                return 1 / (1 + Math.exp(-steepness * (dose - midpoint)));
            }
            
            runTrial() {
                switch(this.designType) {
                    case '3plus3':
                        return this.run3Plus3();
                    case 'crm':
                        return this.runCRM();
                    case 'boin':
                        return this.runBOIN();
                    case 'ewoc':
                        return this.runEWOC();
                    case 'blrm':
                        return this.runBLRM();
                    case 'mTPI':
                        return this.runmTPI();
                    default:
                        return this.run3Plus3();
                }
            }
            
            run3Plus3() {
                let currentDoseIndex = 0;
                const results = { 
                    patients: [], 
                    mtd: null,
                    totalPatients: 0,
                    patientsWithDLT: 0
                };
                let patientNum = 0;
                
                while (currentDoseIndex < this.doseLevels.length) {
                    let dlts = 0;
                    let cohortPatients = 3;
                    
                    for (let i = 0; i < cohortPatients; i++) {
                        patientNum++;
                        results.totalPatients++;
                        const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDoseIndex]);
                        if (hasDLT) {
                            dlts++;
                            results.patientsWithDLT++;
                        }
                        results.patients.push({
                            x: patientNum,
                            y: this.doseLevels[currentDoseIndex],
                            dlt: hasDLT
                        });
                    }
                    
                    if (dlts === 0) {
                        currentDoseIndex++;
                    } else if (dlts === 1) {
                        for (let i = 0; i < 3; i++) {
                            patientNum++;
                            results.totalPatients++;
                            const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDoseIndex]);
                            if (hasDLT) {
                                dlts++;
                                results.patientsWithDLT++;
                            }
                            results.patients.push({
                                x: patientNum,
                                y: this.doseLevels[currentDoseIndex],
                                dlt: hasDLT
                            });
                        }
                        
                        if (dlts <= 1) {
                            currentDoseIndex++;
                        } else {
                            results.mtd = currentDoseIndex > 0 ? this.doseLevels[currentDoseIndex - 1] : null;
                            break;
                        }
                    } else {
                        results.mtd = currentDoseIndex > 0 ? this.doseLevels[currentDoseIndex - 1] : null;
                        break;
                    }
                    
                    if (currentDoseIndex >= this.doseLevels.length) {
                        results.mtd = this.doseLevels[this.doseLevels.length - 1];
                        break;
                    }
                }
                
                return results;
            }
            
            runCRM() {
                const results = { 
                    patients: [], 
                    mtd: null,
                    totalPatients: 0,
                    patientsWithDLT: 0
                };
                
                const skeleton = this.doseLevels.map((d, i) => 
                    0.05 + (this.targetToxicity - 0.05) * (i / (this.doseLevels.length - 1))
                );
                
                const alpha = new Array(this.doseLevels.length).fill(1);
                const beta = new Array(this.doseLevels.length).fill(1);
                
                let currentDose = 0;
                const totalPatients = this.cohorts * this.cohortSize;
                
                for (let p = 0; p < totalPatients; p++) {
                    results.totalPatients++;
                    const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDose]);
                    if (hasDLT) results.patientsWithDLT++;
                    
                    results.patients.push({
                        x: p + 1,
                        y: this.doseLevels[currentDose],
                        dlt: hasDLT
                    });
                    
                    if (hasDLT) {
                        alpha[currentDose]++;
                    } else {
                        beta[currentDose]++;
                    }
                    
                    const posteriorProbs = [];
                    for (let i = 0; i < this.doseLevels.length; i++) {
                        posteriorProbs.push(alpha[i] / (alpha[i] + beta[i]));
                    }
                    
                    let minDiff = Math.abs(posteriorProbs[0] - this.targetToxicity);
                    let nextDose = 0;
                    
                    for (let i = 1; i < posteriorProbs.length; i++) {
                        const diff = Math.abs(posteriorProbs[i] - this.targetToxicity);
                        if (diff < minDiff && posteriorProbs[i] <= this.targetToxicity + 0.1) {
                            minDiff = diff;
                            nextDose = i;
                        }
                    }
                    
                    currentDose = nextDose;
                }
                
                results.mtd = this.doseLevels[currentDose];
                return results;
            }
            
            runBOIN() {
                const results = { 
                    patients: [], 
                    mtd: null,
                    totalPatients: 0,
                    patientsWithDLT: 0
                };
                
                let currentDose = 0;
                const lambda_e = this.targetToxicity - 0.05;
                const lambda_d = this.targetToxicity + 0.05;
                
                for (let cohort = 0; cohort < this.cohorts; cohort++) {
                    let dlts = 0;
                    
                    for (let i = 0; i < this.cohortSize; i++) {
                        results.totalPatients++;
                        const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDose]);
                        if (hasDLT) {
                            dlts++;
                            results.patientsWithDLT++;
                        }
                        
                        results.patients.push({
                            x: results.totalPatients,
                            y: this.doseLevels[currentDose],
                            dlt: hasDLT
                        });
                    }
                    
                    const observedRate = dlts / this.cohortSize;
                    
                    if (observedRate <= lambda_e && currentDose < this.doseLevels.length - 1) {
                        currentDose++;
                    } else if (observedRate >= lambda_d && currentDose > 0) {
                        currentDose--;
                    }
                }
                
                results.mtd = this.doseLevels[currentDose];
                return results;
            }
            
            runEWOC() {
                // EWOC with overdose control
                const results = { 
                    patients: [], 
                    mtd: null,
                    totalPatients: 0,
                    patientsWithDLT: 0
                };
                
                const alpha = 0.25; // Feasibility bound
                let currentDose = 0;
                const totalPatients = this.cohorts * this.cohortSize;
                
                for (let p = 0; p < totalPatients; p++) {
                    results.totalPatients++;
                    const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDose]);
                    if (hasDLT) results.patientsWithDLT++;
                    
                    results.patients.push({
                        x: p + 1,
                        y: this.doseLevels[currentDose],
                        dlt: hasDLT
                    });
                    
                    // Simplified EWOC logic - ensure overdose probability < alpha
                    const overdoseProb = this.getToxicityProbability(this.doseLevels[currentDose]);
                    
                    if (overdoseProb < this.targetToxicity && currentDose < this.doseLevels.length - 1) {
                        if (Math.random() > alpha) currentDose++;
                    } else if (overdoseProb > this.targetToxicity && currentDose > 0) {
                        currentDose--;
                    }
                }
                
                results.mtd = this.doseLevels[currentDose];
                return results;
            }
            
            runBLRM() {
                // Bayesian Logistic Regression Method
                const results = { 
                    patients: [], 
                    mtd: null,
                    totalPatients: 0,
                    patientsWithDLT: 0
                };
                
                let currentDose = 0;
                const doseHistory = [];
                const responseHistory = [];
                
                const totalPatients = this.cohorts * this.cohortSize;
                
                for (let p = 0; p < totalPatients; p++) {
                    results.totalPatients++;
                    const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDose]);
                    if (hasDLT) results.patientsWithDLT++;
                    
                    results.patients.push({
                        x: p + 1,
                        y: this.doseLevels[currentDose],
                        dlt: hasDLT
                    });
                    
                    doseHistory.push(this.doseLevels[currentDose]);
                    responseHistory.push(hasDLT ? 1 : 0);
                    
                    // Simplified logistic regression
                    if (doseHistory.length >= 3) {
                        const avgResponse = responseHistory.reduce((a, b) => a + b, 0) / responseHistory.length;
                        
                        if (avgResponse < this.targetToxicity && currentDose < this.doseLevels.length - 1) {
                            currentDose++;
                        } else if (avgResponse > this.targetToxicity && currentDose > 0) {
                            currentDose--;
                        }
                    }
                }
                
                results.mtd = this.doseLevels[currentDose];
                return results;
            }
            
            runmTPI() {
                // Modified Toxicity Probability Interval
                const results = { 
                    patients: [], 
                    mtd: null,
                    totalPatients: 0,
                    patientsWithDLT: 0
                };
                
                let currentDose = 0;
                const epsilon1 = 0.05;
                const epsilon2 = 0.05;
                const pT = this.targetToxicity;
                
                for (let cohort = 0; cohort < this.cohorts; cohort++) {
                    let dlts = 0;
                    
                    for (let i = 0; i < this.cohortSize; i++) {
                        results.totalPatients++;
                        const hasDLT = Math.random() < this.getToxicityProbability(this.doseLevels[currentDose]);
                        if (hasDLT) {
                            dlts++;
                            results.patientsWithDLT++;
                        }
                        
                        results.patients.push({
                            x: results.totalPatients,
                            y: this.doseLevels[currentDose],
                            dlt: hasDLT
                        });
                    }
                    
                    const observedToxicity = dlts / this.cohortSize;
                    
                    // mTPI decision rules
                    if (observedToxicity <= pT - epsilon1 && currentDose < this.doseLevels.length - 1) {
                        currentDose++; // Escalate
                    } else if (observedToxicity >= pT + epsilon2 && currentDose > 0) {
                        currentDose--; // De-escalate
                    }
                    // Stay at current dose if within interval
                }
                
                results.mtd = this.doseLevels[currentDose];
                return results;
            }
        }
        
        // Run PBPK Simulation
        function runPBPKSimulation() {
            showLoading();
            
            setTimeout(() => {
                const params = {
                    clearance: parseFloat(document.getElementById('clearance').value),
                    vd: parseFloat(document.getElementById('vd').value),
                    ka: parseFloat(document.getElementById('ka').value),
                    bioavailability: parseFloat(document.getElementById('bioavailability').value),
                    proteinBinding: parseFloat(document.getElementById('protein-binding').value)
                };
                
                const timePoints = [];
                for (let t = 0; t <= 48; t += 0.5) {
                    timePoints.push(t);
                }
                
                const model = new PBPKModel(params);
                const concentrations = model.simulate(timePoints);
                const metrics = model.calculateMetrics(concentrations, timePoints);
                
                // Update charts
                charts.pk.data.labels = timePoints;
                charts.pk.data.datasets[0].data = concentrations;
                charts.pk.update();
                
                // Update QSP chart
                const occupancy = concentrations.map(c => {
                    const ec50 = parseFloat(document.getElementById('ec50').value);
                    const hill = parseFloat(document.getElementById('hill').value);
                    return (Math.pow(c, hill) / (Math.pow(ec50, hill) + Math.pow(c, hill))) * 100;
                });
                
                charts.qsp.data.labels = timePoints;
                charts.qsp.data.datasets[0].data = occupancy;
                charts.qsp.update();
                
                // Update metrics
                document.getElementById('cmax').textContent = metrics.cmax;
                document.getElementById('tmax').textContent = metrics.tmax + ' h';
                document.getElementById('auc').textContent = metrics.auc;
                document.getElementById('halflife').textContent = metrics.halfLife + ' h';
                document.getElementById('cl-calc').textContent = metrics.clearance + ' L/h';
                document.getElementById('vss').textContent = metrics.vss + ' L';
                
                hideLoading();
            }, 500);
        }
        
        // Run Clinical Trial Simulation
        function runTrialSimulation() {
            showLoading();
            
            setTimeout(() => {
                const params = {
                    designType: document.getElementById('design-type').value,
                    targetToxicity: parseFloat(document.getElementById('target-tox').value),
                    cohorts: parseInt(document.getElementById('cohorts').value),
                    cohortSize: parseInt(document.getElementById('cohort-size').value),
                    startDose: parseFloat(document.getElementById('start-dose').value),
                    maxDose: parseFloat(document.getElementById('max-dose').value),
                    escalationScheme: document.getElementById('escalation-scheme').value
                };
                
                const trial = new BayesianTrial(params);
                const results = trial.runTrial();
                
                // Update chart
                const noDLT = results.patients.filter(p => !p.dlt);
                const withDLT = results.patients.filter(p => p.dlt);
                
                charts.trial.data.datasets[0].data = noDLT;
                charts.trial.data.datasets[1].data = withDLT;
                charts.trial.update();
                
                // Update metrics
                document.getElementById('mtd').textContent = results.mtd ? results.mtd.toFixed(0) + ' mg' : 'Not Found';
                document.getElementById('rp2d').textContent = results.mtd ? (results.mtd * 0.8).toFixed(0) + ' mg' : 'N/A';
                document.getElementById('dlt-rate').textContent = results.mtd ? 
                    (trial.getToxicityProbability(results.mtd) * 100).toFixed(1) + '%' : 'N/A';
                document.getElementById('total-patients').textContent = results.totalPatients;
                document.getElementById('patients-dlt').textContent = results.patientsWithDLT;
                document.getElementById('trial-duration').textContent = 
                    Math.ceil(results.totalPatients / 3 * 4) + ' weeks';
                
                hideLoading();
            }, 500);
        }
        
        // Monte Carlo Trials
        function runMonteCarloTrials() {
            showLoading();
            
            setTimeout(() => {
                const params = {
                    designType: document.getElementById('design-type').value,
                    targetToxicity: parseFloat(document.getElementById('target-tox').value),
                    cohorts: parseInt(document.getElementById('cohorts').value),
                    cohortSize: parseInt(document.getElementById('cohort-size').value),
                    startDose: parseFloat(document.getElementById('start-dose').value),
                    maxDose: parseFloat(document.getElementById('max-dose').value),
                    escalationScheme: document.getElementById('escalation-scheme').value
                };
                
                const mtdEstimates = [];
                const patientCounts = [];
                
                for (let i = 0; i < 1000; i++) {
                    const trial = new BayesianTrial(params);
                    const result = trial.runTrial();
                    
                    if (result.mtd) {
                        mtdEstimates.push(result.mtd);
                    }
                    patientCounts.push(result.totalPatients);
                }
                
                const successRate = (mtdEstimates.length / 1000) * 100;
                const meanMTD = mtdEstimates.reduce((a, b) => a + b, 0) / mtdEstimates.length;
                const meanPatients = patientCounts.reduce((a, b) => a + b, 0) / patientCounts.length;
                
                alert(`Monte Carlo Results (1000 trials):\n\n` +
                      `Success Rate: ${successRate.toFixed(1)}%\n` +
                      `Mean MTD: ${meanMTD.toFixed(0)} mg\n` +
                      `Average Patients: ${meanPatients.toFixed(0)}\n` +
                      `Design: ${params.designType.toUpperCase()}`);
                
                hideLoading();
            }, 1000);
        }
        
        // Compare all trial designs
        function compareDesigns() {
            showLoading();
            
            setTimeout(() => {
                const baseParams = {
                    targetToxicity: parseFloat(document.getElementById('target-tox').value),
                    cohorts: parseInt(document.getElementById('cohorts').value),
                    cohortSize: parseInt(document.getElementById('cohort-size').value),
                    startDose: parseFloat(document.getElementById('start-dose').value),
                    maxDose: parseFloat(document.getElementById('max-dose').value),
                    escalationScheme: document.getElementById('escalation-scheme').value
                };
                
                const designs = ['3plus3', 'crm', 'boin', 'ewoc', 'blrm', 'mTPI'];
                const results = {};
                
                designs.forEach(design => {
                    const params = { ...baseParams, designType: design };
                    const mtdEstimates = [];
                    const patientCounts = [];
                    
                    for (let i = 0; i < 100; i++) {
                        const trial = new BayesianTrial(params);
                        const result = trial.runTrial();
                        
                        if (result.mtd) {
                            mtdEstimates.push(result.mtd);
                        }
                        patientCounts.push(result.totalPatients);
                    }
                    
                    results[design] = {
                        successRate: (mtdEstimates.length / 100) * 100,
                        meanPatients: patientCounts.reduce((a, b) => a + b, 0) / patientCounts.length
                    };
                });
                
                // Create comparison visualization
                let comparisonText = 'Design Comparison Results:\n\n';
                designs.forEach(design => {
                    comparisonText += `${design.toUpperCase()}:\n`;
                    comparisonText += `  Success Rate: ${results[design].successRate.toFixed(1)}%\n`;
                    comparisonText += `  Avg Patients: ${results[design].meanPatients.toFixed(0)}\n\n`;
                });
                
                alert(comparisonText);
                hideLoading();
            }, 1500);
        }
        
        // Update design info
        function updateDesignInfo() {
            const designType = document.getElementById('design-type').value;
            const infoBox = document.getElementById('design-info');
            
            const designDescriptions = {
                '3plus3': {
                    title: '3+3 Design',
                    description: 'Traditional rule-based design. Simple but inefficient. Treats 3 patients per dose, escalates if 0/3 DLTs, expands to 6 if 1/3 DLTs.'
                },
                'crm': {
                    title: 'CRM - Continual Reassessment Method',
                    description: 'Model-based design that continuously updates toxicity estimates using Bayesian inference. More efficient than 3+3.'
                },
                'boin': {
                    title: 'BOIN - Bayesian Optimal Interval',
                    description: 'Interval-based design that\'s simpler than CRM but more efficient than 3+3. Makes decisions based on toxicity intervals.'
                },
                'ewoc': {
                    title: 'EWOC - Escalation with Overdose Control',
                    description: 'Conservative Bayesian design that explicitly controls the probability of overdosing patients.'
                },
                'blrm': {
                    title: 'BLRM - Bayesian Logistic Regression',
                    description: 'Uses logistic regression to model the dose-toxicity relationship. Flexible and efficient.'
                },
                'mTPI': {
                    title: 'mTPI - Modified Toxicity Probability Interval',
                    description: 'Improved interval design with better statistical properties than BOIN. User-friendly implementation.'
                }
            };
            
            const info = designDescriptions[designType];
            infoBox.innerHTML = `<h4>${info.title}</h4><p>${info.description}</p>`;
        }
        
        // Load presets
        function loadPreset(module) {
            if (module === 'pbpk') {
                document.getElementById('bioavailability').value = 85;
                document.getElementById('ka').value = 1.2;
                document.getElementById('vd').value = 65;
                document.getElementById('clearance').value = 1.0;
                document.getElementById('protein-binding').value = 92;
                document.getElementById('ec50').value = 45;
                document.getElementById('hill').value = 1.4;
                
                alert('Loaded example: Typical oral small molecule drug parameters');
                runPBPKSimulation();
            }
        }
        
        // Start tutorial
        function startTutorial(tutorialType) {
            const contentDiv = document.getElementById('tutorial-content');
            
            const tutorials = {
                'pbpk-basics': {
                    title: 'PBPK Basics Tutorial',
                    content: `
                        <h3>Understanding PBPK Models</h3>
                        <div class="info-box">
                            <h4>What is PBPK?</h4>
                            <p>Physiologically-Based Pharmacokinetic modeling predicts drug concentrations in different body tissues over time.</p>
                        </div>
                        <div class="educational-tip">
                            <strong>Key Parameters:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Clearance (CL):</strong> How fast the body removes the drug</li>
                                <li><strong>Volume of Distribution (Vd):</strong> How widely the drug spreads in the body</li>
                                <li><strong>Bioavailability (F):</strong> Fraction reaching systemic circulation</li>
                                <li><strong>Half-life:</strong> Time for concentration to drop by 50%</li>
                            </ul>
                        </div>
                        <button onclick="switchModule('pbpk')">Try PBPK Module</button>
                    `
                },
                'trial-designs': {
                    title: 'Clinical Trial Designs',
                    content: `
                        <h3>Phase 1 Trial Designs Explained</h3>
                        <div class="info-box">
                            <h4>Traditional vs Modern Designs</h4>
                            <p>Modern Bayesian designs find the MTD faster with fewer patients than traditional 3+3.</p>
                        </div>
                        <table style="width: 100%; margin: 20px 0;">
                            <tr>
                                <th style="text-align: left; padding: 10px; border-bottom: 2px solid #ddd;">Design</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 2px solid #ddd;">Efficiency</th>
                                <th style="text-align: left; padding: 10px; border-bottom: 2px solid #ddd;">Best Use</th>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">3+3</td>
                                <td style="padding: 10px;">Low</td>
                                <td style="padding: 10px;">Simple, small trials</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">CRM</td>
                                <td style="padding: 10px;">High</td>
                                <td style="padding: 10px;">Model-based optimization</td>
                            </tr>
                            <tr>
                                <td style="padding: 10px;">BOIN</td>
                                <td style="padding: 10px;">Medium-High</td>
                                <td style="padding: 10px;">Balance of simplicity and efficiency</td>
                            </tr>
                        </table>
                        <button onclick="switchModule('clinical')">Explore Trial Designs</button>
                    `
                }
            };
            
            const tutorial = tutorials[tutorialType];
            if (tutorial) {
                contentDiv.innerHTML = tutorial.content;
            }
        }
        
        // Helper functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Molecular dynamics functions (simplified)
        function loadMolecularStructure() {
            alert('Structure loaded! Visualization will appear in the canvas.');
        }
        
        function startMolecularSimulation() {
            alert('Molecular dynamics simulation started!');
        }
        
        function stopMolecularSimulation() {
            alert('Simulation stopped.');
        }
        
        function exportMolecularData() {
            alert('Exporting molecular data...');
        }
        
        // Initialize on load
        window.onload = function() {
            initializeCharts();
            updateDesignInfo();
            
            // Add input listeners for range sliders
            document.getElementById('mdTemp').addEventListener('input', function() {
                document.getElementById('mdTempValue').textContent = this.value;
            });
        };
    </script>
</body>
</html>
