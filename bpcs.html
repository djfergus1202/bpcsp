<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaSim Pro - Full Integrated Suite</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
        /* --- Base & Layout --- */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            color: #333;
            min-height: 100vh;
        }
        .main-container { 
            max-width: 1600px; 
            margin: 25px auto; 
            padding: 0 20px; 
        }
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: 360px 1fr; 
            gap: 25px; 
        }
        .module-section { 
            display: none; 
        }
        .module-section.active { 
            display: block; 
            animation: fadeIn 0.5s ease; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- Header & Navigation --- */
        .header {
            background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(240,248,255,0.98) 100%);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .header h1 {
            font-size: 2.2em;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
            margin-bottom: 5px;
        }
        .header-subtitle, .attribution { color: #666; font-size: 1em; margin-bottom: 5px; }
        .attribution { font-size: 0.85em; font-style: italic; }
        .nav-tabs { 
            display: flex; 
            gap: 10px; 
            margin-top: 15px; 
            border-bottom: 2px solid rgba(30,60,114,0.1); 
            padding-bottom: 10px; 
            flex-wrap: wrap; 
        }
        .nav-tab {
            padding: 10px 20px; 
            background: white; 
            color: #2a5298; 
            border: 2px solid #2a5298;
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.3s ease; 
        }
        .nav-tab:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(42,82,152,0.3); 
        }
        .nav-tab.active { 
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); 
            color: white; 
            border-color: transparent; 
        }

        /* --- Panels & Containers --- */
        .control-panel, .chart-container, .results-panel, .info-box, .publication-form, .publication-card, .tutorial-content {
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .control-panel {
            height: fit-content; 
            position: sticky; 
            top: 190px;
        }
        .control-panel h2, .chart-container h3, .results-panel h3 { 
            color: #1e3c72; 
            font-size: 1.3em; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid rgba(30,60,114,0.1); 
        }
        .visualization-area { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
            gap: 25px; 
        }
        .chart-container { min-height: 400px; position: relative; }
        .results-panel { grid-column: 1 / -1; margin-top: 25px; }

        /* --- Forms & Buttons --- */
        .control-group { margin-bottom: 18px; }
        .control-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: #555; 
            font-weight: 600; 
            font-size: 14px; 
        }
        .control-group input, .control-group select, .control-group textarea {
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid #e0e6ed;
            border-radius: 8px; 
            font-size: 14px; 
            transition: all 0.3s ease; 
            background: #f8f9fa;
            font-family: inherit;
        }
        .control-group textarea { resize: vertical; min-height: 80px; }
        .control-group input:focus, .control-group select:focus, .control-group textarea:focus {
            outline: none; 
            border-color: #2a5298; 
            background: white; 
            box-shadow: 0 0 0 3px rgba(42,82,152,0.1);
        }
        button {
            padding: 12px 18px; 
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-weight: 600; 
            font-size: 14px; 
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(42,82,152,0.3);
            width: 100%;
        }
        button:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(42,82,152,0.4); 
        }
        button:disabled { 
            background: #aaa; 
            cursor: not-allowed; 
            box-shadow: none; 
        }
        .button-group { display: flex; gap: 10px; margin-top: 20px; }
        .button-group button { flex: 1; }

        /* --- Metrics & Cards --- */
        .metric-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); 
            gap: 15px; 
        }
        .metric-card { 
            background: linear-gradient(135deg, #f8f9fa, #e9eef6); 
            padding: 20px; 
            border-radius: 15px; 
            text-align: center; 
        }
        .metric-label { 
            font-size: 12px; 
            color: #666; 
            text-transform: uppercase; 
            margin-bottom: 8px; 
        }
        .metric-value { 
            font-size: 1.8em; 
            font-weight: bold; 
            background: linear-gradient(135deg, #2a5298, #1e3c72); 
            -webkit-background-clip: text; 
            color: transparent; 
        }

        /* --- Special Components --- */
        .disclaimer-banner {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ff9800; 
            border-radius: 12px; 
            padding: 15px 20px;
            margin: 20px 40px; 
            box-shadow: 0 4px 15px rgba(255,152,0,0.2);
        }
        .disclaimer-banner h4 { color: #e65100; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .disclaimer-banner h4::before { content: '⚠️'; font-size: 1.2em; }
        .disclaimer-banner p { color: #5d4037; line-height: 1.6; font-size: 14px; }
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); 
            display: none; 
            justify-content: center;
            align-items: center; 
            z-index: 9999; 
            color: white; 
            text-align: center;
        }
        .spinner {
            width: 50px; height: 50px; 
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2a5298; 
            border-radius: 50%;
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { 
            background: #e3f2fd; 
            border-left: 4px solid #2a5298; 
            border-radius: 8px; 
            padding: 15px; 
            margin-top: 20px; 
        }
        .info-box p { color: #555; line-height: 1.6; font-size: 14px; }
        .mono { 
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
            white-space: pre; 
            overflow: auto; 
            background: #0a142b; 
            color: #e6edf3; 
            border-radius: 10px; 
            border: 1px solid rgba(255,255,255,.15); 
            padding: 10px; 
            font-size: 12.5px; 
        }
        canvas { width: 100% !important; height: auto !important; aspect-ratio: 16 / 9; }
        #molecularDisplay { 
            width: 100%; height: 100%; 
            min-height: 450px; 
            position: relative; 
            background-color: #f0f0f0; 
            border-radius: 10px; 
        }

        /* --- Media Queries for Responsiveness --- */
        @media (max-width: 960px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .control-panel { position: static; }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <h1>PharmaSim Pro</h1>
        <p class="header-subtitle">Integrated Pharmaceutical Research & Publication Platform</p>
        <p class="attribution">Created by <strong>David Ferguson, BS, MS, Pharm.D. Candidate</strong></p>
        <nav class="nav-tabs">
            <button class="nav-tab" onclick="switchModule('pbpk')">PBPK/QSP Modeling</button>
            <button class="nav-tab" onclick="switchModule('clinical')">Clinical Trial Design</button>
            <button class="nav-tab active" onclick="switchModule('molecular')">Molecular Docking</button>
            <button class="nav-tab" onclick="switchModule('md_setup')">MD Simulation Setup</button>
            <button class="nav-tab" onclick="switchModule('publications')">Publications</button>
            <button class="nav-tab" onclick="switchModule('tutorial')">Learning Center</button>
        </nav>
    </header>
    
    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        <h4>Important Research Disclaimer</h4>
        <p>
            <strong>These computational models provide approximations for educational and exploratory purposes only.</strong> 
            The molecular docking module uses a geometric and chemical approximation. Other modules use mathematical models.
            Results must be validated through proper experimental studies before any critical decisions.
        </p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div>
            <div class="spinner"></div>
            <p id="loadingText">Processing...</p>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <main class="main-container">
        <!-- PBPK/QSP Module -->
        <section class="module-section" id="pbpk-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>PBPK/QSP Parameters</h2>
                    <div class="control-group">
                        <label>Dose (mg)</label>
                        <input type="number" id="dose" value="100">
                    </div>
                    <div class="control-group">
                        <label>Bioavailability (F %)</label>
                        <input type="number" id="bioavailability" value="80">
                    </div>
                     <div class="control-group">
                        <label>Absorption Rate (ka, h⁻¹)</label>
                        <input type="number" id="ka" value="1.5" step="0.1">
                    </div>
                     <div class="control-group">
                        <label>Elimination Rate (ke, h⁻¹)</label>
                        <input type="number" id="ke" value="0.2" step="0.05">
                    </div>
                     <div class="control-group">
                        <label>Volume of Distribution (Vd, L)</label>
                        <input type="number" id="vd" value="50">
                    </div>
                    <div class="button-group">
                        <button onclick="runPBPKSimulation()">Run PBPK Simulation</button>
                    </div>
                </div>
                <div class="visualization-area">
                    <div class="chart-container"><h3>Plasma Concentration</h3><canvas id="pkChart"></canvas></div>
                    <div class="chart-container"><h3>Target Occupancy</h3><canvas id="qspChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <!-- Clinical Trial Module -->
        <section class="module-section" id="clinical-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                     <h2>Clinical Trial Design</h2>
                     <div class="control-group">
                        <label>Number of Dose Levels</label>
                        <input type="number" id="dose-levels" value="6">
                    </div>
                     <div class="control-group">
                        <label>Patients per Cohort</label>
                        <input type="number" id="cohort-size" value="3">
                    </div>
                    <div class="control-group">
                        <label>Starting Dose (mg)</label>
                        <input type="number" id="start-dose" value="10">
                    </div>
                    <div class="control-group">
                        <label>Target Toxicity Rate (%)</label>
                        <input type="number" id="target-tox" value="25">
                    </div>
                    <div class="button-group">
                        <button onclick="runTrialSimulation()">Run Trial Simulation</button>
                    </div>
                </div>
                <div class="visualization-area">
                    <div class="chart-container"><h3>Dose Escalation</h3><canvas id="trialChart"></canvas></div>
                    <div class="chart-container"><h3>Toxicity Probability</h3><canvas id="toxicityChart"></canvas></div>
                </div>
            </div>
        </section>
        
        <!-- Molecular Docking Module -->
        <section class="module-section active" id="molecular-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>Docking Simulation</h2>
                     <div class="control-group">
                        <label for="pdbFile">1. Upload Protein (PDB file)</label>
                        <input type="file" id="pdbFile" accept=".pdb">
                    </div>
                    <div class="control-group">
                        <label for="smilesInput">2. Enter Ligand (SMILES string)</label>
                        <input type="text" id="smilesInput" value="CC(=O)OC1=CC=CC=C1C(=O)O" placeholder="Aspirin: CC(=O)OC1=CC=CC=C1C(=O)O">
                    </div>
                    <button id="runButton" onclick="runApproximation()" disabled>3. Run Docking Approximation</button>
                    <div class="info-box">
                        <p><strong>Note:</strong> This tool runs a geometric and chemical approximation of docking entirely in your browser. No server is needed.</p>
                    </div>
                </div>
                <div class="visualization-area">
                    <div class="chart-container">
                        <h3>3D Docking Visualization</h3>
                        <div id="molecularDisplay"></div>
                    </div>
                    <div class="results-panel">
                        <div class="metric-grid">
                            <div class="metric-card">
                                <div class="metric-label">Est. Binding Enthalpy</div>
                                <div class="metric-value" id="binding-affinity">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Ligand MW</div>
                                <div class="metric-value" id="ligand-mw">--</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Ligand LogP</div>
                                <div class="metric-value" id="ligand-logp">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- MD Simulation Setup Module -->
        <section class="module-section" id="md_setup-module">
            <div class="dashboard-grid">
                <div class="control-panel">
                    <h2>MD Simulation File Generator</h2>
                    <div class="control-group">
                        <label>Output Prefix</label>
                        <input id="md-out" value="output"/>
                    </div>
                    <div class="control-group">
                        <label>Temperature (K)</label>
                        <input id="md-temp" type="number" value="310"/>
                    </div>
                    <div class="control-group">
                        <label>Production Time (ns)</label>
                        <input id="md-ns" type="number" value="10"/>
                    </div>
                    <div class="control-group">
                        <label>switch/cut/pair (Å)</label>
                        <input id="md-cuts" value="10/12/14"/>
                    </div>
                     <div class="control-group">
                        <label><input type="checkbox" id="md-restraints" checked/> Use Restraints</label>
                    </div>
                    <div class="button-group">
                        <button onclick="generateMDFiles()">Generate Files</button>
                        <button id="zipBtn" onclick="downloadMDFiles()" disabled>Download ZIP</button>
                    </div>
                    <div id="fileList" style="margin-top:20px; display:flex; flex-direction:column; gap:8px;"></div>
                </div>
                <div class="chart-container">
                    <h3>Visualization & Analysis Scripts</h3>
                    <p style="margin:0 0 15px; font-size: 14px; color: #555;">These scripts use TCL syntax, common in visualization programs like VMD, to prepare and analyze your system.</p>
                    <div>
                        <h4>1) Prepare Restraints File</h4>
                        <pre class="mono" id="script_restraints"># Selects all atoms and sets their B-factor (occupancy) column to 0
set sel [atomselect top "all"]
$sel set beta 0.0

# Selects only the protein backbone atoms (N, CA, C, O)
set backbone [atomselect top "protein and name N CA C O"]

# Sets the B-factor for the backbone to a non-zero value (e.g., 2.0)
# Simulation software can use this column to apply harmonic restraints.
$backbone set beta 2.0

# Writes the modified structure to a new PDB file
$sel writepdb restraints.pdb</pre>
                        <button style="width:auto; margin-top:5px;" onclick="copyMDScript('script_restraints')">Copy Restraints Script</button>
                    </div>
                    <div style="margin-top:20px;">
                        <h4>2) Quick Visualization Script</h4>
                        <pre class="mono" id="script_cartoon"># Load your system topology and coordinates
mol new system.psf
mol addfile system.pdb

# Delete the default simple lines representation
mol delrep 0 top

# Create a new, publication-quality representation
# Style: NewCartoon, with settings for smoothness
mol representation NewCartoon 0.3 10.0 4.0 0
# Color by secondary structure (alpha-helices, beta-sheets)
mol color Structure
# Apply this representation only to the protein
mol selection {protein}
mol addrep top

# Optional: Show the ligand with a different style
# mol selection {resname LIG}
# mol representation Licorice 0.3 12.0 12.0
# mol addrep top</pre>
                         <button style="width:auto; margin-top:5px;" onclick="copyMDScript('script_cartoon')">Copy Visualization Script</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Publications Module -->
        <section class="module-section" id="publications-module">
            <div class="publication-form">
                <h2>Create New Publication</h2>
                <div class="control-group">
                    <label>Title</label>
                    <input type="text" id="pub-title" placeholder="e.g., In Silico Analysis of Novel Kinase Inhibitors">
                </div>
                 <div class="control-group">
                    <label>Authors</label>
                    <input type="text" id="pub-authors" placeholder="e.g., Ferguson, D., et al.">
                </div>
                 <div class="control-group">
                    <label>Abstract / Key Findings</label>
                    <textarea id="pub-abstract" rows="6"></textarea>
                </div>
                <button onclick="submitPublication()">Submit Publication</button>
            </div>
            <div id="publications-list" style="margin-top: 30px;">
                <h2>Recent Publications</h2>
                <!-- Publications will be added here via JavaScript -->
            </div>
        </section>
        
        <!-- Learning Center Module -->
        <section class="module-section" id="tutorial-module">
            <div class="tutorial-content">
                <h2>Learning Center</h2>
                <p>Welcome! This section provides guided tutorials to help you understand the concepts behind the simulations.</p>
                <div id="tutorial-display" class="info-box" style="margin-top:20px;">
                    Select a topic to begin.
                </div>
                 <div class="button-group">
                    <button onclick="loadTutorial('pbpk')">PBPK Basics</button>
                    <button onclick="loadTutorial('docking')">Molecular Docking</button>
                    <button onclick="loadTutorial('md_setup')">MD Simulation Setup</button>
                </div>
            </div>
        </section>
    </main>
    
    <script>
    // --- GLOBAL VARIABLES ---
    let viewer; // For 3Dmol.js
    let rdkit;  // For RDKit.js
    let charts = {}; // To store Chart.js instances
    let generatedMDFiles = {}; // To store generated MD setup files

    // --- INITIALIZATION ---
    /**
     * This function runs when the page loads. It initializes all necessary components.
     */
    window.onload = () => {
        // Initialize Chart.js instances for each canvas
        charts.pk = createChart('pkChart', 'line');
        charts.qsp = createChart('qspChart', 'line');
        charts.trial = createChart('trialChart', 'scatter');
        charts.toxicity = createChart('toxicityChart', 'line');

        // Load any saved publications from the browser's local storage
        loadPublications();

        // Set the initial active module to be visible
        switchModule('molecular');

        // Asynchronously initialize the RDKit WASM module for chemistry calculations
        window.initRDKitModule().then(RDKit => {
            rdkit = RDKit;
            document.getElementById('runButton').disabled = false;
            console.log("RDKit.js chemical library loaded successfully.");
        }).catch(() => {
            alert("Fatal Error: Failed to load RDKit.js. The molecular docking module cannot run.");
            document.getElementById('runButton').disabled = true;
        });
    };

    // --- UI & NAVIGATION ---

    /**
     * Shows the loading overlay with a custom message.
     * @param {string} text - The message to display.
     */
    function showLoading(text = "Processing...") {
        document.getElementById('loadingText').textContent = text;
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    /**
     * Hides the loading overlay.
     */
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    /**
     * Switches the currently visible module based on the tab clicked.
     * @param {string} module - The ID of the module to activate (e.g., 'pbpk', 'molecular').
     */
    function switchModule(module) {
        document.querySelectorAll('.module-section').forEach(section => section.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
        
        // Use a consistent ID naming scheme
        const sectionId = `${module}-module`;
        const activeSection = document.getElementById(sectionId);
        if (activeSection) activeSection.classList.add('active');

        const activeTab = document.querySelector(`.nav-tab[onclick="switchModule('${module}')"]`);
        if (activeTab) activeTab.classList.add('active');
    }

    // --- MOLECULAR DOCKING MODULE (IN-BROWSER APPROXIMATION) ---

    /**
     * Main function to orchestrate the in-browser docking approximation.
     */
    async function runApproximation() {
        const pdbFile = document.getElementById('pdbFile').files[0];
        const smiles = document.getElementById('smilesInput').value.trim();
        
        if (!pdbFile || !smiles) {
            alert("Please provide both a protein PDB file and a ligand SMILES string.");
            return;
        }
        if (!rdkit) {
            alert("RDKit.js is not yet loaded. Please wait a moment and try again.");
            return;
        }

        showLoading("Analyzing molecules and approximating docking...");
        await new Promise(resolve => setTimeout(resolve, 50)); // Allow UI to update

        try {
            // Step 1: Process ligand SMILES using RDKit
            const ligand = processLigand(smiles);
            if (!ligand) throw new Error("Invalid SMILES string. Could not generate molecule.");
            
            // Update UI with calculated properties
            document.getElementById('ligand-mw').textContent = ligand.mw.toFixed(2);
            document.getElementById('ligand-logp').textContent = ligand.logp.toFixed(2);

            // Step 2: Read PDB file and find binding pocket
            const pdbData = await pdbFile.text();
            const protein = await findBindingPocket(pdbData);

            // Step 3: Calculate the estimated binding score
            const score = calculateBindingEnthalpy(protein, ligand);
            document.getElementById('binding-affinity').textContent = `${score.toFixed(2)} kcal/mol`;

            // Step 4: Display the final docked pose
            displayResults(pdbData, ligand.molblock, protein.pocketResidues);

        } catch (error) {
            console.error("Docking approximation failed:", error);
            alert(`An error occurred: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    /**
     * Processes a SMILES string to generate a 3D structure and calculate properties.
     * @param {string} smiles - The SMILES string of the ligand.
     * @returns {object|null} An object containing the RDKit molecule object and its properties, or null if invalid.
     */
    function processLigand(smiles) {
        let mol = null;
        try {
            mol = rdkit.get_mol(smiles);
            if (!mol) return null;

            mol.add_hs();
            
            // Correct RDKit.js function for embedding a molecule in 3D
            const embedParams = JSON.stringify({"useRandomCoords": true, "maxAttempts": 1000});
            const embedResult = rdkit.EmbedMolecule(mol, embedParams);
            if (embedResult < 0) {
                 console.warn("3D conformer generation failed, using unoptimized structure.");
            }
            rdkit.UFFOptimizeMolecule(mol); // Optimize the 3D structure

            const details = JSON.parse(mol.get_descriptors());

            return {
                mol,
                molblock: mol.get_molblock(),
                mw: details.exactmw,
                logp: details.MolLogP,
                hDonors: details.NumHDonors,
                hAcceptors: details.NumHAcceptors,
                numRotatableBonds: details.NumRotatableBonds
            };
        } catch (e) {
            console.error("RDKit processing error:", e);
            if (mol) mol.delete(); // Clean up memory
            return null;
        }
    }

    /**
     * A geometric algorithm to find the most likely binding pocket on a protein surface.
     * @param {string} pdbData - The raw text content of the PDB file.
     * @returns {Promise<object>} An object with protein atoms and identified pocket residues.
     */
    async function findBindingPocket(pdbData) {
        const tempViewer = $3Dmol.createViewer({}, {});
        const model = tempViewer.addModel(pdbData, "pdb");
        const atoms = model.atoms;

        const residues = {};
        atoms.forEach(atom => { (residues[atom.resi] = residues[atom.resi] || []).push(atom); });

        let maxNeighbors = 0;
        let pocketCenterResi = -1;
        for (const resi in residues) {
            const resiAtoms = residues[resi];
            const resiCenter = resiAtoms.reduce((acc, atom) => acc.add(atom), new $3Dmol.Vector3()).divideScalar(resiAtoms.length);
            const neighborCount = atoms.filter(atom => resiCenter.distanceTo(atom) < 10).length;
            if (neighborCount > maxNeighbors) {
                maxNeighbors = neighborCount;
                pocketCenterResi = parseInt(resi);
            }
        }

        const centralAtoms = residues[pocketCenterResi] || [];
        if (centralAtoms.length === 0) throw new Error("Could not identify a binding pocket.");
        
        const pocketCenter = centralAtoms.reduce((acc, atom) => acc.add(atom), new $3Dmol.Vector3()).divideScalar(centralAtoms.length);
        const pocketResidues = new Set();
        atoms.forEach(atom => { if (pocketCenter.distanceTo(atom) < 10) pocketResidues.add(atom.resi); });
        
        return { atoms, pocketResidues: Array.from(pocketResidues) };
    }

    /**
     * An empirical scoring function to estimate binding enthalpy (free energy of binding, ΔG).
     * @param {object} protein - The processed protein object.
     * @param {object} ligand - The processed ligand object.
     * @returns {number} The estimated binding enthalpy in kcal/mol.
     */
    function calculateBindingEnthalpy(protein, ligand) {
        // This is a simplified, empirical linear free energy model
        // ΔG = c0 + c_vdw*N_heavy + c_hbond*N_hbond + c_hydrophobic*LogP + c_rot*N_rot
        const C = {
            INTERCEPT: -1.5,      // Base affinity
            VDW_PER_ATOM: -0.03,  // Favorable contribution per heavy atom
            HBOND: -0.8,          // Favorable contribution per H-bond
            HYDROPHOBIC: -0.2,    // Favorable contribution for lipophilicity
            ROT_PENALTY: 0.3      // Unfavorable penalty for each rotatable bond
        };

        const numHeavyAtoms = ligand.mol.get_n_heavy_atoms();
        const hBondTerm = Math.min(ligand.hDonors, ligand.hAcceptors); // A simple proxy

        let score = C.INTERCEPT;
        score += C.VDW_PER_ATOM * numHeavyAtoms;
        score += C.HBOND * hBondTerm;
        score += C.HYDROPHOBIC * ligand.logp;
        score += C.ROT_PENALTY * ligand.numRotatableBonds;
        
        // Add a small random factor to simulate the inherent noise in real-world measurements/simulations
        score += (Math.random() - 0.5) * 0.5;

        // Clamp the score to a realistic range for drug-like molecules
        return Math.max(-12.0, Math.min(-4.0, score));
    }

    /**
     * Renders the protein and docked ligand in the 3Dmol.js viewer.
     * @param {string} proteinPdbData - Raw PDB data for the protein.
     * @param {string} ligandMolblock - Molblock data for the ligand.
     * @param {Array<number>} pocketResidues - Array of residue IDs forming the pocket.
     */
    function displayResults(proteinPdbData, ligandMolblock, pocketResidues) {
        const displayDiv = document.getElementById('molecularDisplay');
        if (viewer) viewer.clear();
        else viewer = $3Dmol.createViewer(displayDiv, { backgroundColor: 'white' });

        const proteinModel = viewer.addModel(proteinPdbData, "pdb");
        viewer.setStyle({}, { cartoon: { color: 'spectrum' } });

        viewer.addSurface($3Dmol.VDW, { opacity: 0.85, color: 'white' }, { resi: pocketResidues });
        viewer.setStyle({ resi: pocketResidues }, { stick: { colorscheme: 'cyanCarbon', radius: 0.3 } });
        
        const ligandModel = viewer.addModel(ligandMolblock, "sdf");
        viewer.setStyle({ model: ligandModel }, { stick: { colorscheme: 'carbon' } });

        viewer.zoomTo({ resi: pocketResidues });
        viewer.render();
    }


    // --- PBPK/QSP MODULE ---
    
    /**
     * Runs a one-compartment pharmacokinetic simulation based on user inputs.
     */
    function runPBPKSimulation() {
        const D = parseFloat(document.getElementById('dose').value) || 100;
        const F = (parseFloat(document.getElementById('bioavailability').value) || 80) / 100;
        const ka = parseFloat(document.getElementById('ka').value) || 1.5;
        const ke = parseFloat(document.getElementById('ke').value) || 0.2;
        const Vd = parseFloat(document.getElementById('vd').value) || 50;

        if (ka === ke) {
            alert("Absorption rate (ka) and elimination rate (ke) cannot be equal for this model.");
            return;
        }

        const concentrations = [];
        const timePoints = [];
        for (let t = 0; t <= 48; t += 1) {
            timePoints.push(t);
            const concentration = (F * D * ka / (Vd * (ka - ke))) * (Math.exp(-ke * t) - Math.exp(-ka * t));
            concentrations.push(concentration > 0 ? concentration : 0);
        }
        
        const occupancy = concentrations.map(c => 100 * c / (20 + c));

        updateChart(charts.pk, "Plasma Concentration (mg/L)", timePoints, [concentrations]);
        updateChart(charts.qsp, "Target Occupancy (%)", timePoints, [occupancy], '#e67e22');
    }

    // --- CLINICAL TRIAL MODULE ---

    /**
     * Runs a simplified 3+3 dose escalation trial simulation.
     */
    function runTrialSimulation() {
        const numDoseLevels = parseInt(document.getElementById('dose-levels').value) || 6;
        const cohortSize = parseInt(document.getElementById('cohort-size').value) || 3;
        const startDose = parseFloat(document.getElementById('start-dose').value) || 10;
        const targetTox = (parseFloat(document.getElementById('target-tox').value) || 25) / 100;

        const doseLevels = Array.from({length: numDoseLevels}, (_, i) => startDose * Math.pow(1.5, i));
        const trueToxProbs = doseLevels.map(d => 0.05 + 0.4 * (d / doseLevels[doseLevels.length-1]));

        const trialData = { noDLT: [], DLT: [] };
        let patientNum = 0;
        let currentDoseIndex = 0;

        while(currentDoseIndex < numDoseLevels) {
            let dltCount = 0;
            for (let i = 0; i < cohortSize; i++) {
                patientNum++;
                const hasDLT = Math.random() < trueToxProbs[currentDoseIndex];
                if(hasDLT) {
                    dltCount++;
                    trialData.DLT.push({x: patientNum, y: doseLevels[currentDoseIndex]});
                } else {
                    trialData.noDLT.push({x: patientNum, y: doseLevels[currentDoseIndex]});
                }
            }
            if (dltCount / cohortSize > targetTox) break; 
            currentDoseIndex++;
        }

        const toxCurve = doseLevels.map((d,i) => ({x: d, y: trueToxProbs[i] * 100}));

        updateScatterChart(charts.trial, [
            { label: 'No DLT', data: trialData.noDLT, backgroundColor: '#2ecc71' },
            { label: 'DLT', data: trialData.DLT, backgroundColor: '#e74c3c' }
        ]);
        updateChart(charts.toxicity, 'True Toxicity Rate (%)', doseLevels.map(d => d.toFixed(1) + ' mg'), [toxCurve.map(p => p.y)], '#3498db');
    }
    
    // --- MD SIMULATION SETUP MODULE ---

    /**
     * Generates generic MD simulation configuration files.
     */
    function generateMDFiles() {
        const p = {
            out: document.getElementById('md-out').value || 'output',
            T: +document.getElementById('md-temp').value || 310,
            ns: +document.getElementById('md-ns').value || 10,
            cuts: (document.getElementById('md-cuts').value || '10/12/14').split(/[\/ ,]+/).map(Number),
            rest: document.getElementById('md-restraints').checked
        };
        const steps = Math.round((p.ns * 1e6) / 2);

        const common = `structure          system.psf
coordinates        system.pdb
set outputname       ${p.out}
outputname           $outputname

# Basic Simulation Parameters
binaryoutput         yes
parameters           system.prm
exclude              scaled1-4
1-4scaling           1.0
timestep             2.0 ;# fs
rigidBonds           all
nonbondedFreq        1
fullElectFrequency   2
stepspercycle        20

# Force Field Cutoffs
switching            on
switchdist           ${p.cuts[0] || 10}
cutoff               ${p.cuts[1] || 12}
pairlistdist         ${p.cuts[2] || 14}

# PME for Long-Range Electrostatics
PME                  yes
PMEGridSpacing       1.0

# Temperature Control
langevin             on
langevinDamping      1.0
langevinTemp         ${p.T}
langevinHydrogen     no
`;
        const pressure = `
# Pressure Control (for NPT ensemble)
useGroupPressure      yes
useFlexibleCell       no
langevinPiston        on
langevinPistonTarget  1.01325 ;# 1 atm
langevinPistonPeriod  100
langevinPistonDecay   50
langevinPistonTemp    ${p.T}
`;
        const restraints = p.rest ? `
# Harmonic Restraints
constraints          on
consRef              restraints.pdb
consKFile            restraints.pdb
consKCol             B
constraintScaling    1.0
` : `constraints off\n`;

        generatedMDFiles = {
            'min.conf': common + `minimization         10000\n`,
            'eq.conf': common + pressure + restraints + `run 250000 ;# 0.5 ns equilibration`,
            'prod.conf': common + pressure + `run ${steps} ;# ${p.ns} ns production`,
            'README.md': `# Generic MD Simulation Files\n\nThese are example configuration files for MD engines like NAMD.\n\nWorkflow:\n1. Minimize:     md-engine min.conf > min.log\n2. Equilibrate:  md-engine eq.conf > eq.log\n3. Production:   md-engine prod.conf > prod.log\n`
        };
        
        const list = document.getElementById('fileList');
        list.innerHTML = '';
        Object.keys(generatedMDFiles).forEach(name => {
            const a = document.createElement('a');
            a.textContent = `⬇ ${name}`;
            a.href = URL.createObjectURL(new Blob([generatedMDFiles[name]], {type:'text/plain'}));
            a.download = name;
            a.className = 'nav-tab';
            list.appendChild(a);
        });
        document.getElementById('zipBtn').disabled = false;
    }

    async function downloadMDFiles() {
        if (!Object.keys(generatedMDFiles).length) return;
        const zip = new JSZip();
        for (const [name, content] of Object.entries(generatedMDFiles)) zip.file(name, content);
        const blob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'md_simulation_project.zip';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function copyMDScript(elementId) {
        const text = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(text).then(() => alert("Script copied to clipboard!"), () => alert("Failed to copy script."));
    }

    // --- PUBLICATIONS MODULE ---

    function submitPublication() {
        const title = document.getElementById('pub-title').value.trim();
        const authors = document.getElementById('pub-authors').value.trim();
        const abstract = document.getElementById('pub-abstract').value.trim();
        if (!title || !authors || !abstract) { alert("Please fill in all publication fields."); return; }
        
        const newPub = { title, authors, abstract, date: new Date().toLocaleDateString() };
        const pubs = JSON.parse(localStorage.getItem('pharmsim_pubs')) || [];
        pubs.unshift(newPub);
        localStorage.setItem('pharmsim_pubs', JSON.stringify(pubs));
        renderPublication(newPub, true);
        
        document.getElementById('pub-title').value = '';
        document.getElementById('pub-authors').value = '';
        document.getElementById('pub-abstract').value = '';
    }

    function renderPublication(pub, prepend = false) {
        const list = document.getElementById('publications-list');
        const card = document.createElement('div');
        card.className = 'publication-card chart-container';
        card.innerHTML = `
            <h3 style="font-size: 1.2em; border: none; margin-bottom: 5px;">${pub.title}</h3>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">By ${pub.authors} on ${pub.date}</p>
            <p>${pub.abstract}</p>
        `;
        if (prepend) list.insertBefore(card, list.children[1]);
        else list.appendChild(card);
    }

    function loadPublications() {
        const pubs = JSON.parse(localStorage.getItem('pharmsim_pubs')) || [];
        pubs.forEach(pub => renderPublication(pub));
    }


    // --- LEARNING CENTER MODULE ---
    
    function loadTutorial(topic) {
        const content = {
            pbpk: `<h3>PBPK Basics</h3><p>Physiologically-Based Pharmacokinetic (PBPK) models predict how a drug moves through the body over time. The one-compartment model used here is the simplest form, described by the Bateman equation. It assumes the body is a single, uniform container.</p><p>Key parameters are <strong>Dose</strong>, <strong>Bioavailability (F)</strong> (how much drug is absorbed), <strong>Absorption Rate (ka)</strong>, and <strong>Elimination Rate (ke)</strong>.</p>`,
            docking: `<h3>Molecular Docking Approximation</h3><p>Docking predicts how a small molecule (ligand) binds to a large protein. True docking requires immense computational power to test trillions of possible poses.</p><p>This tool uses a clever approximation: <ol><li><strong>Pocket Finding:</strong> It finds the largest, most buried cavity on the protein surface, which is often the active site.</li><li><strong>Scoring:</strong> It uses an empirical free energy function to estimate the binding enthalpy based on the ligand's size, lipophilicity (LogP), flexibility, and hydrogen bonding potential.</li></ol> This gives a scientifically plausible estimate without needing a supercomputer.</p>`,
            md_setup: `<h3>MD Simulation Setup</h3><p>Molecular Dynamics (MD) simulations model the movement of atoms in a system over time. This requires complex setup files.</p><p>This tool generates generic configuration files for MD engines like NAMD or GROMACS. You can adjust parameters like <strong>Temperature</strong> and <strong>Simulation Time</strong>, and the generator will create the necessary text files for minimization, equilibration, and production runs.</p>`
        };
        document.getElementById('tutorial-display').innerHTML = content[topic] || "<p>Select a topic to begin.</p>";
    }

    // --- CHARTING UTILITIES ---
    
    function createChart(id, type) {
        const ctx = document.getElementById(id);
        if (!ctx) return null;
        if (charts[id]) charts[id].destroy();
        return new Chart(ctx, { type, data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    
    function updateChart(chart, label, labels, dataArrays, color = '#2a5298') {
        if (!chart) return;
        chart.data.labels = labels;
        chart.data.datasets = dataArrays.map((data, index) => ({
            label: `${label} ${dataArrays.length > 1 ? index + 1 : ''}`,
            data, borderColor: color,
            backgroundColor: color.replace(')', ', 0.5)').replace('rgb', 'rgba'), tension: 0.4,
        }));
        chart.update();
    }
    
    function updateScatterChart(chart, datasetsConfig) {
        if (!chart) return;
        chart.data.datasets = datasetsConfig.map(ds => ({
            label: ds.label, data: ds.data,
            backgroundColor: ds.backgroundColor, type: 'scatter',
        }));
        chart.update();
    }
    </script>
</body>
</html>

