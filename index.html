<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PharmaSim Pro · In-Browser Suite</title>

<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script defer src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(135deg,#1e3c72 0%,#2a5298 50%,#7e8ba3 100%);color:#0b1630}
header{position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:blur(8px);box-shadow:0 6px 20px rgba(0,0,0,.08);z-index:10}
.nav{max-width:1400px;margin:0 auto;padding:14px 18px;display:flex;gap:10px;align-items:center;justify-content:space-between}
.tabs{display:flex;flex-wrap:wrap;gap:8px}.tab{padding:8px 14px;border:2px solid #2a5298;border-radius:18px;background:#fff;color:#2a5298;font-weight:700;cursor:pointer;transition:.2s}
.tab.active,.tab:hover{background:linear-gradient(135deg,#2a5298,#1e3c72);color:#fff;border-color:transparent;transform:translateY(-2px)}
.container{max-width:1400px;margin:22px auto;padding:0 16px}.grid{display:grid;grid-template-columns:360px 1fr;gap:22px}
.panel{background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.12);padding:18px}
label{display:block;font-size:13px;color:#334;margin:6px 0 4px}
input,textarea,select{width:100%;padding:10px 12px;border:2px solid #e0e6ed;border-radius:10px;background:#f8f9fa;font:inherit;font-size:14px}
input:focus,textarea:focus,select:focus{outline:none;border-color:#2a5298;background:#fff;box-shadow:0 0 0 3px rgba(42,82,152,.12)}
button{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(135deg,#2a5298,#1e3c72);color:#fff;font-weight:700;cursor:pointer;transition:.2s;width:100%}
button:hover:not(:disabled){box-shadow:0 4px 15px rgba(42,82,152,.4);transform:translateY(-2px)} button:disabled{opacity:.6;cursor:not-allowed}
.section{display:none}.section.active{display:block}
#viewer{width:100%;min-height:440px;border-radius:10px;background:#eef2f7}
.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px}
.metric{background:linear-gradient(135deg,#f8f9fa,#e9eef6);border-radius:12px;text-align:center;padding:12px}
.metric .v{font-size:1.35em;font-weight:800;background:linear-gradient(135deg,#2a5298,#1e3c72);-webkit-background-clip:text;background-clip:text;color:transparent}
.hint{font-size:12px;color:#476;margin-top:8px}
.status{max-width:1400px;margin:10px auto 0;background:#fffdf5;border:1px solid #fde68a;color:#854d0e;border-radius:10px;padding:10px 12px;display:none}
.status.ok{background:#f0fdf4;border-color:#bbf7d0;color:#14532d}
@media(max-width:1000px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div style="font-weight:800;color:#1e3c72">PharmaSim Pro</div>
    <div class="tabs">
      <button class="tab" data-t="pbpk">PBPK/QSP</button>
      <button class="tab" data-t="clinical">Clinical</button>
      <button class="tab active" data-t="md">Docking</button>
      <button class="tab" data-t="mdsetup">MD Setup</button>
      <button class="tab" data-t="pub">Publications</button>
      <button class="tab" data-t="learn">Learning</button>
    </div>
  </div>
</header>

<div id="status" class="status"></div>

<div class="container">
  <!-- Docking -->
  <section id="md" class="section active">
    <div class="grid">
      <div class="panel">
        <h3>Ligand Prep & Structure-Aware Heuristic Docking</h3>

        <label>Protein (PDB File)</label>
        <input type="file" id="pdbFile" accept=".pdb" />

        <div class="row" style="gap:8px;margin-top:8px">
          <div style="flex:1">
            <label>…or Fetch by PDB ID</label>
            <input id="pdbId" placeholder="e.g., 6LU7" />
          </div>
          <div style="flex:0 0 160px;display:flex;align-items:flex-end">
            <button id="fetchPdbBtn" type="button">Fetch PDB</button>
          </div>
        </div>

        <label style="margin-top:8px">Load Example from Paper</label>
        <select id="exampleSmiles">
          <option value="" disabled selected>Select a Drug Hit...</option>
          <option value="O=P(O)(O)COC(=O)C1CCCN1C(=O)c1ccc(CNS(=O)(=O)c2ccc(C)cc2)cc1">Drug Hit 1 (Zn-Chelator)</option>
          <option value="CC(C)NCc1ccc(S(=O)(=O)Nc2cccc(c2)C(=O)N2CCCC2C(=O)OCC)cc1">Drug Hit 2 (π-π Stacking)</option>
          <option value="N1=C(N)N=C(C1)CCS(=O)(=O)NCc1ccc(C(=O)OCP(=O)(O)O)cc1">Drug Hit 3 (H-Bond)</option>
          <option value="Cc1ccc(OCc2ccc(C(=O)OC[C@H]3O[C@H](O)[C@H](O)[C@@H](O)[C@@H]3CO)cc2)cc1">Drug Hit 4 (Allosteric)</option>
          <option value="CC(C)NC(=O)C1CCN(CC1)c1cccc2OCOc12">Drug Hit 5 (Reversible)</option>
          <option value="CC(C)CC(NC(=O)C1CCN(CC1)c1cccc2OCOc12)Cc1ccccc1">Drug Hit 6 (Irreversible)</option>
        </select>

        <label>Ligand (SMILES)</label>
        <input id="smiles" value="CC(=O)OC1=CC=CC=C1C(=O)O"/>

        <label>Scoring Model</label>
        <select id="scoringModel">
          <option value="balanced" selected>Balanced</option>
          <option value="hbond">H-Bond Focused</option>
          <option value="hydrophobic">Hydrophobicity Focused</option>
        </select>

        <div class="row" style="gap:8px;margin-top:8px">
          <button id="dockBtn" disabled>Run Approximate Dock</button>
          <button id="centerBtn" type="button" disabled>Re-center & Re-score</button>
        </div>

        <p class="hint" id="modelInfoText" style="margin-top:8px"></p>
      </div>

      <div class="panel">
        <h3>Results</h3>
        <div class="metrics">
          <div class="metric"><div>Total ΔG</div><div id="aff" class="v">--</div></div>
          <div class="metric"><div>Ligand MW</div><div id="mw" class="v">--</div></div>
          <div class="metric"><div>Ligand LogP</div><div id="logp" class="v">--</div></div>
        </div>
        <div class="metrics" style="margin-top:10px">
          <div class="metric"><div class="hint">ΔG vdW</div><div id="vdw_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">ΔG H-Bond</div><div id="hbond_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">ΔG Hydrophobic</div><div id="hydro_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">ΔS Rotational</div><div id="rot_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">Contacts (≤3.5Å)</div><div id="contacts" class="v">--</div></div>
          <div class="metric"><div class="hint">Clashes (&lt;1.8Å)</div><div id="clashes" class="v">--</div></div>
        </div>
      </div>

      <div class="panel" style="grid-column:1/-1">
        <h3>3D Visualization</h3>
        <div id="viewer"></div>
      </div>
    </div>
  </section>

  <!-- PBPK -->
  <section id="pbpk" class="section">
    <div class="grid">
      <div class="panel">
        <h3>PBPK/QSP Parameters</h3>
        <label>Dose (mg)</label><input id="dose" type="number" value="100" />
        <div class="row">
          <div class="col"><label>F (%)</label><input id="F" type="number" value="80"/></div>
          <div class="col"><label>ka (h⁻¹)</label><input id="ka" type="number" value="1.2" step="0.1"/></div>
          <div class="col"><label>ke (h⁻¹)</label><input id="ke" type="number" value="0.2" step="0.05"/></div>
          <div class="col"><label>Vd (L)</label><input id="Vd" type="number" value="50"/></div>
        </div>
        <div class="row" style="margin-top:10px;"><button id="runPBPKBtn">Run PBPK Simulation</button></div>
      </div>
      <div class="panel">
        <h3>Pharmacokinetic Outputs</h3>
        <canvas id="pkChart"></canvas>
        <canvas id="occChart" style="margin-top:10px;"></canvas>
      </div>
    </div>
  </section>

  <!-- Clinical -->
  <section id="clinical" class="section">
    <div class="grid">
      <div class="panel">
        <h3>3+3 Dose Escalation Simulation</h3>
        <div class="row">
          <div class="col"><label>Dose Levels</label><input id="levels" type="number" value="6"/></div>
          <div class="col"><label>Cohort Size</label><input id="cohort" type="number" value="3"/></div>
          <div class="col"><label>Start Dose (mg)</label><input id="startDose" type="number" value="10"/></div>
          <div class="col"><label>Target DLT Rate (%)</label><input id="tox" type="number" value="25"/></div>
        </div>
        <div class="row" style="margin-top:10px;"><button id="runTrialBtn">Simulate Trial</button></div>
      </div>
      <div class="panel">
        <h3>Trial Visualization</h3>
        <canvas id="trialChart"></canvas>
      </div>
    </div>
  </section>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const statusBox = $('#status');
function setStatus(msg, ok=false){ statusBox.textContent=msg; statusBox.style.display='block'; statusBox.classList.toggle('ok', ok); }

let viewer, rdkit;
let proteinModel=null, ligandModel=null, pocketResidues=[];
let pocketCenter=null;

document.addEventListener('DOMContentLoaded', async () => {
  // tabs
  document.querySelectorAll('.tab[data-t]').forEach(t=>t.addEventListener('click',()=>{
    const id=t.dataset.t;
    document.querySelectorAll('.tab[data-t]').forEach(b=>b.classList.toggle('active', b===t));
    document.querySelectorAll('.section').forEach(s=>s.classList.toggle('active', s.id===id));
  }));

  // events
  $('#exampleSmiles').addEventListener('change', e => $('#smiles').value = e.target.value);
  $('#fetchPdbBtn').addEventListener('click', fetchPdbById);
  $('#dockBtn').addEventListener('click', runApproxDock);
  $('#centerBtn').addEventListener('click', () => { if (proteinModel && ligandModel) placeLigandAndRender(); });
  $('#runPBPKBtn')?.addEventListener('click', runPBPK);

  // init libs
  try{
    await waitFor(()=> window.$3Dmol && window.initRDKitModule, 15000);
    rdkit = await window.initRDKitModule();
    $('#dockBtn').disabled = false;
    $('#centerBtn').disabled = false;
    setStatus('Libraries ready. RDKit initialized. You can dock now.', true);
  }catch(e){
    setStatus('Failed to initialize required libraries; RDKit or 3Dmol not ready.', false);
  }

  // 3D viewer
  viewer = $3Dmol.createViewer($('#viewer'), { backgroundColor: 'white' });

  // file input → load protein
  $('#pdbFile').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const pdb=await f.text();
    loadProteinFromText(pdb);
  });

  // scoring model hint
  updateModelInfo();
  $('#scoringModel').addEventListener('change', updateModelInfo);

  buildCharts(); // for PBPK tab
});

function updateModelInfo(){
  const info = {
    balanced: "Balances size, H-bonding, hydrophobics, and flexibility.",
    hbond: "Rewards donors/acceptors more; good for polar pockets.",
    hydrophobic: "Rewards nonpolar fit; penalizes excessive polarity."
  };
  $('#modelInfoText').textContent = info[$('#scoringModel').value] || '';
}

async function fetchPdbById(){
  const id = ($('#pdbId').value || '').trim().toLowerCase();
  if(!id){ alert('Enter a PDB ID'); return; }
  try{
    setStatus(`Fetching PDB ${id}…`);
    const url = `https://files.rcsb.org/download/${id}.pdb`;
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const pdb = await res.text();
    loadProteinFromText(pdb);
    setStatus(`Loaded PDB ${id}.`, true);
  }catch(err){
    console.error(err);
    setStatus(`Failed to fetch ${id}: ${err.message}`, false);
  }
}

function loadProteinFromText(pdb){
  viewer.clear();
  proteinModel = viewer.addModel(pdb, 'pdb');
  proteinModel.setStyle({}, { cartoon: { color:'spectrum' } });

  // pocket detection
  const atoms = getModelAtoms(proteinModel);
  pocketResidues = findPocketResidues(atoms);
  pocketCenter = centroidOfResidues(atoms, pocketResidues);

  if (pocketResidues.length){
    viewer.addSurface($3Dmol.VDW, { opacity:0.7, color:'white' }, { resi: pocketResidues });
    proteinModel.setStyle({ resi: pocketResidues }, { stick:{ radius:0.25, colorscheme:'cyanCarbon' } });
  }
  viewer.zoomTo(pocketResidues.length ? { resi: pocketResidues } : {});
  viewer.render();
}

function getModelAtoms(model){
  // Prefer selectedAtoms; fallbacks for older builds
  return (typeof model.selectedAtoms==='function' && model.selectedAtoms({})) ||
         (typeof model.getAtoms==='function' && model.getAtoms()) ||
         (Array.isArray(model.atoms) && model.atoms) || [];
}

async function runApproxDock(){
  if(!proteinModel){ alert('Load a protein PDB first (file or PDB ID).'); return; }
  const smi = ($('#smiles').value || '').trim();
  if(!smi){ alert('Enter a SMILES.'); return; }

  // ligand 3D with RDKit
  let lig;
  try{
    lig = rdkit.get_mol(smi);
    if(!lig) throw new Error('RDKit failed to parse SMILES');
    lig.add_hs?.();
    if (rdkit.EmbedMolecule) rdkit.EmbedMolecule(lig, JSON.stringify({ useRandomCoords:true, maxAttempts:500 }));
    rdkit.UFFOptimizeMolecule?.(lig);
  }catch(e){
    console.error(e);
    alert('Ligand preparation failed.');
    return;
  }

  const desc = JSON.parse(lig.get_descriptors());
  const ligInfo = {
    molblock: lig.get_molblock(),
    mw: desc.exactmw,
    logp: desc.MolLogP,
    hDonors: desc.NumHDonors,
    hAcceptors: desc.NumHAcceptors,
    numRotatableBonds: desc.NumRotatableBonds,
    numHeavyAtoms: (typeof lig.get_n_heavy_atoms==='function') ? lig.get_n_heavy_atoms() : (desc.NumHeavyAtoms||0)
  };
  lig.delete?.();

  // Show physchem immediately
  $('#mw').textContent = Number(ligInfo.mw).toFixed(2);
  $('#logp').textContent = Number(ligInfo.logp).toFixed(2);

  // Add/update ligand in viewer, translated to pocket
  addLigandToViewer(ligInfo.molblock);
  placeLigandAndRender();

  // Score with structure-aware terms
  scoreAndDisplay(ligInfo);
}

function addLigandToViewer(molblock){
  if (ligandModel) try{ viewer.removeModel(ligandModel); }catch{}
  ligandModel = viewer.addModel(molblock, 'sdf');
  ligandModel.setStyle({}, { stick:{ radius:0.22 } });
}

function placeLigandAndRender(){
  const atomsProt = getModelAtoms(proteinModel);
  if (!atomsProt.length){ alert('Protein atoms unavailable.'); return; }
  if (!pocketResidues.length) pocketResidues = findPocketResidues(atomsProt);
  pocketCenter = centroidOfResidues(atomsProt, pocketResidues) || centroid(atomsProt);

  // translate ligand coordinates so its centroid aligns to pocketCenter (with a tiny offset)
  const ligAtoms = getModelAtoms(ligandModel);
  const ligCenter = centroid(ligAtoms);
  const dx = (pocketCenter.x - ligCenter.x);
  const dy = (pocketCenter.y - ligCenter.y);
  const dz = (pocketCenter.z - ligCenter.z);
  const offset = normalize({x:1,y:1,z:1}); // small nudge
  for (const a of ligAtoms){
    a.x += dx + 0.8*offset.x;
    a.y += dy + 0.8*offset.y;
    a.z += dz + 0.8*offset.z;
  }
  ligandModel.setCoordinates(ligAtoms);
  viewer.setStyle({model:proteinModel},{cartoon:{color:'spectrum'}});
  if (pocketResidues.length){
    viewer.addSurface($3Dmol.VDW, { opacity:0.6, color:'white' }, { resi: pocketResidues });
  }
  ligandModel.setStyle({}, { stick:{ radius:0.22 } });
  viewer.zoomTo({resi: pocketResidues.length ? pocketResidues : undefined});
  viewer.render();
}

function scoreAndDisplay(ligInfo){
  const modelType = $('#scoringModel').value;

  // Base (ligand-only) heuristic
  const base = calculateBindingContributions(ligInfo, modelType);

  // Structure terms
  const protAtoms = getModelAtoms(proteinModel);
  const ligAtoms = getModelAtoms(ligandModel);

  // Contact: protein hetero (N,O,S) within 3.5 Å to ligand atoms
  const het = new Set(['N','O','S']);
  let contacts=0, clashes=0;
  for (const la of ligAtoms){
    for (const pa of protAtoms){
      const dx=la.x-pa.x, dy=la.y-pa.y, dz=la.z-pa.z;
      const r2=dx*dx+dy*dy+dz*dz;
      if (r2 < 3.5*3.5 && het.has(pa.elem)) contacts++;
      if (r2 < 1.8*1.8) clashes++;
    }
  }
  // Convert to energy-ish terms
  const contactBonus = -0.15 * Math.min(contacts, 50);   // cap to reduce runaway
  const clashPenalty = +0.40 * Math.min(clashes, 25);

  const total = Object.values(base).reduce((s,v)=>s+v,0) + contactBonus + clashPenalty;

  $('#aff').textContent = total.toFixed(2);
  $('#vdw_contrib').textContent = base.vdw.toFixed(2);
  $('#hbond_contrib').textContent = base.hbond.toFixed(2);
  $('#hydro_contrib').textContent = base.hydrophobic.toFixed(2);
  $('#rot_contrib').textContent = base.rotational.toFixed(2);
  $('#contacts').textContent = contacts.toString();
  $('#clashes').textContent = clashes.toString();
}

function findPocketResidues(atoms){
  if(!atoms.length) return [];
  // group by residue id
  const byRes={};
  for (const a of atoms){ const k=a.resi ?? a.resn ?? '0'; (byRes[k]=byRes[k]||[]).push(a); }
  // pick residue whose centroid has the densest 10 Å neighborhood
  let best=null, bestN=-1;
  for (const [resi,alist] of Object.entries(byRes)){
    const c = centroid(alist);
    let n=0; for (const a of atoms){ const dx=a.x-c.x, dy=a.y-c.y, dz=a.z-c.z; if(dx*dx+dy*dy+dz*dz < 100) n++; }
    if (n>bestN){ bestN=n; best=resi; }
  }
  if (!best) return [];
  const core = byRes[best];
  const c = centroid(core);
  const set=new Set();
  for (const a of atoms){ const dx=a.x-c.x,dy=a.y-c.y,dz=a.z-c.z; if(dx*dx+dy*dy+dz*dz<100) set.add(a.resi ?? a.resn ?? '0'); }
  return [...set];
}

function centroidOfResidues(atoms, resiList){
  if(!resiList || !resiList.length) return null;
  const pick = atoms.filter(a => resiList.includes(a.resi ?? a.resn ?? '0'));
  return pick.length ? centroid(pick) : null;
}
function centroid(list){
  if(!list.length) return {x:0,y:0,z:0};
  let x=0,y=0,z=0; for (const a of list){ x+=a.x; y+=a.y; z+=a.z; }
  return { x:x/list.length, y:y/list.length, z:z/list.length };
}
function normalize(v){
  const m=Math.sqrt(v.x*v.x+v.y*v.y+v.z*v.z)||1; return {x:v.x/m,y:v.y/m,z:v.z/m};
}

function calculateBindingContributions(ligand, modelType='balanced'){
  const MODELS = {
    balanced:    { INTERCEPT:-1.5, VDW_PER_ATOM:-0.035, HBOND:-0.7,  HYDROPHOBIC:-0.25, ROT_PENALTY:0.30 },
    hbond:       { INTERCEPT:-1.0, VDW_PER_ATOM:-0.030, HBOND:-1.2,  HYDROPHOBIC:-0.15, ROT_PENALTY:0.30 },
    hydrophobic: { INTERCEPT:-1.2, VDW_PER_ATOM:-0.040, HBOND:-0.5,  HYDROPHOBIC:-0.45, ROT_PENALTY:0.25 }
  };
  const C = MODELS[modelType] || MODELS.balanced;
  const hBondTerm = Math.min(ligand.hDonors, ligand.hAcceptors);
  return {
    intercept: C.INTERCEPT,
    vdw: C.VDW_PER_ATOM * ligand.numHeavyAtoms,
    hbond: C.HBOND * hBondTerm,
    hydrophobic: C.HYDROPHOBIC * ligand.logp,
    rotational: C.ROT_PENALTY * ligand.numRotatableBonds
  };
}

/* ===== PBPK (unchanged logic) ===== */
let charts={};
function buildCharts(){ if(!window.Chart) return;
  charts.pk=new Chart($('#pkChart'),{type:'line',options:{responsive:true,maintainAspectRatio:false}});
  charts.occ=new Chart($('#occChart'),{type:'line',options:{responsive:true,maintainAspectRatio:false}});
}
function updateChart(chart,label,labels,data,color='#2a5298'){
  if(!chart) return;
  chart.data={labels,datasets:[{label,data,borderColor:color,backgroundColor:'rgba(42,82,152,0.35)',pointRadius:0,tension:0.1}]};
  chart.update();
}
function runPBPK(){
  if(!charts.pk||!charts.occ){ alert('Charts not ready'); return; }
  const D=+$('#dose').value||100, Fv=(+$('#F').value||80)/100, ka=+$('#ka').value||1.2, ke=+$('#ke').value||0.2, V=+$('#Vd').value||50;
  if(Math.abs(ka-ke)<1e-9){ alert('ka and ke cannot be equal.'); return; }
  const t=[], c=[]; for(let i=0;i<=48;i++){ t.push(i); const ci=(Fv*D*ka/(V*(ka-ke)))*(Math.exp(-ke*i)-Math.exp(-ka*i)); c.push(Math.max(0,ci)); }
  const occ=c.map(v=>100*v/(20+v));
  updateChart(charts.pk,'Plasma (mg/L)',t,c);
  updateChart(charts.occ,'Target Occupancy (%)',t,occ,'#e67e22');
}

/* ===== helpers ===== */
function waitFor(cond, timeoutMs=12000){
  const start=Date.now(); return new Promise((res,rej)=>{
    (function tick(){ try{ if(cond()) return res(true);}catch{} if(Date.now()-start>timeoutMs) return rej(new Error('timeout')); setTimeout(tick,80); })();
  });
}
</script>
</body>
</html>
