<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>PharmaSim Pro · Social Computational Chemistry</title>

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Scientific Libraries -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    :root { --ink:#0b1630; --brand:#2a5298; --brand2:#1e3c72; }
    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--ink);
      background: linear-gradient(135deg,#1e3c72 0%,#2a5298 50%,#7e8ba3 100%);
    }
    .bricks{ display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:14px; align-items:start; }
    .glass{ background: rgba(255,255,255,.92); backdrop-filter: blur(10px); box-shadow: 0 10px 26px rgba(0,0,0,.12); border-radius: 16px; }
    .panel{ padding: 18px; }
    .btn{ background: linear-gradient(135deg,#2a5298,#1e3c72); color:#fff; font-weight: 700; border-radius: 10px; padding: .65rem .9rem; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn-plain{ background:#fff; border-radius:10px; padding:.6rem .9rem; font-weight:600; }
    .input, select, textarea{ width:100%; padding:.65rem .8rem; border:2px solid #e5e7eb; border-radius:10px; background:#f8f9fa; }
    .input:focus, select:focus, textarea:focus{ outline:none; border-color:#2a5298; background:#fff; box-shadow:0 0 0 3px rgba(42,82,152,.12); }
    .chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.25rem .6rem; border-radius:999px; font-weight:700; font-size:.75rem; }
    .chip.pos{ background:#ecfdf5; color:#065f46; } .chip.info{ background:#eff6ff; color:#1e3a8a; }
    .chip.warn{ background:#fff7ed; color:#9a3412; } .chip.err{ background:#fee2e2; color:#991b1b; }
    .metric{ background: linear-gradient(135deg,#f8f9fa,#e9eef6); border-radius: 12px; padding: 12px; text-align:center; }
    .metric .v{
      font-size:1.1rem; font-weight: 800;
      background: linear-gradient(135deg,#2a5298,#1e3c72);
      -webkit-background-clip:text; background-clip:text; color: transparent;
    }
    #viewer{ width:100%; min-height:420px; height:420px; border-radius:12px; background:#eef2f7; }
    #pdbDrop{ min-height:120px; max-height:160px; overflow:auto; }
    @media (max-width:640px){ #pdbDrop{ min-height:100px; max-height:120px; } }
    header{ position: sticky; top:0; z-index:40; }
    .navlink{ display:inline-flex; align-items:center; justify-content:center; padding:.5rem .75rem; border-radius:.75rem; font-weight:600; background:#fff; }
    .navlink[aria-current="page"]{ color:#fff; background: linear-gradient(135deg,#2a5298,#1e3c72); }
    main{ scroll-margin-top: 84px; }
    .feed-card{ border:1px solid #e6eaf2; border-radius:16px; padding:14px; background:#fff; }
    a.hash{ color:#1e3c72; font-weight:600; }
    .section{ display:none; }
    .section.active{ display:block; }
  </style>
</head>
<body>

  <!-- Header / Nav -->
  <header class="glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="text-2xl font-extrabold" style="color:#1e3c72">PharmaSim Pro</div>
        <span class="chip info">Social Computational Chemistry</span>
      </div>

      <nav class="flex flex-wrap gap-2" role="navigation" aria-label="Primary">
        <a href="#/md"        class="navlink" data-route="md">Docking</a>
        <a href="#/pbpk"      class="navlink" data-route="pbpk">PBPK/QSP</a>
        <a href="#/clinical"  class="navlink" data-route="clinical">Clinical</a>
        <a href="#/mdsetup"   class="navlink" data-route="mdsetup">MD Setup</a>
        <a href="#/community" class="navlink" data-route="community">Community</a>
        <a href="#/channels"  class="navlink" data-route="channels">Channels</a>
        <a href="#/pub"       class="navlink" data-route="pub">Publications</a>
        <a href="#/learn"     class="navlink" data-route="learn">Learning</a>
      </nav>

      <div class="flex items-center gap-3">
        <div id="statusBadge" class="chip warn">Initializing…</div>
        <button id="profileBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Sign In</button>
      </div>
    </div>
  </header>

  <!-- Disclaimer -->
  <div class="max-w-7xl mx-auto px-4 mt-3">
    <div class="glass panel text-sm leading-relaxed">
      <strong>Disclaimer:</strong> For <em>educational/research</em> use only. Docking scores, PBPK/QSP, and clinical simulations are approximations. Validate with experiments before decisions.
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 my-4">
    <!-- SECTION: DOCKING -->
    <section id="md" class="section active" data-title="Docking">
      <div class="bricks">
        <!-- Protein -->
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">Protein (PDB)</h2>
          <div id="pdbDrop" class="w-full border-2 border-dashed border-gray-300 rounded-xl bg-white/70 p-4 text-center text-gray-600 hover:border-indigo-400 hover:bg-white transition">
            <div class="font-semibold">Drag & Drop PDB here</div>
            <div class="text-xs">or choose a file below</div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <input type="file" id="pdbFile" accept=".pdb" class="col-span-2 input file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:bg-indigo-50 file:text-indigo-700">
            <button id="loadLocalPdbBtn" class="btn w-full">Load Local PDB</button>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-3">
            <input id="pdbId" placeholder="Fetch by PDB ID (e.g., 6LU7)" class="col-span-2 input">
            <button id="fetchPdbBtn" class="btn w-full">Fetch PDB</button>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="clearProteinBtn" class="btn-plain">Clear Protein</button>
            <button id="resetViewBtn" class="btn-plain">Reset View</button>
          </div>
        </div>

        <!-- Ligand -->
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">Ligand (SMILES)</h2>
          <input id="smiles" class="input" placeholder="Paste SMILES here (e.g., CC(=O)OC1=CC=CC=C1C(=O)O)">
          <div class="grid grid-cols-3 gap-2 mt-2">
            <select id="exampleSmiles" class="col-span-2 input">
              <option value="" selected>Choose an example…</option>
              <option value="O=P(O)(O)COC(=O)C1CCCN1C(=O)c1ccc(CNS(=O)(=O)c2ccc(C)cc2)cc1">Drug Hit 1 (Zn-Chelator)</option>
              <option value="CC(C)NCc1ccc(S(=O)(=O)Nc2cccc(c2)C(=O)N2CCCC2C(=O)OCC)cc1">Drug Hit 2 (π-π)</option>
              <option value="N1=C(N)N=C(C1)CCS(=O)(=O)NCc1ccc(C(=O)OCP(=O)(O)O)cc1">Drug Hit 3 (H-Bond)</option>
              <option value="Cc1ccc(OCc2ccc(C(=O)OC[C@H]3O[C@H](O)[C@H](O)[C@@H](O)[C@@H]3CO)cc2)cc1">Drug Hit 4 (Allosteric)</option>
              <option value="CC(C)NC(=O)C1CCN(CC1)c1cccc2OCOc12">Drug Hit 5 (Reversible)</option>
              <option value="CC(C)CC(NC(=O)C1CCN(CC1)c1cccc2OCOc12)Cc1ccccc1">Drug Hit 6 (Irreversible)</option>
            </select>
            <button id="useExampleBtn" class="btn-plain w-full">Use Example</button>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <button id="loadSmilesBtn" class="btn w-full">Load SMILES</button>
            <button id="clearLigandBtn" class="btn-plain w-full">Clear Ligand</button>
          </div>
        </div>

        <!-- Scoring / Controls -->
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">Scoring & Controls</h2>
          <label class="block text-sm font-semibold mb-1">Scoring Model</label>
          <select id="scoringModel" class="input">
            <option value="balanced" selected>Balanced</option>
            <option value="hbond">H-Bond Focused</option>
            <option value="hydrophobic">Hydrophobicity Focused</option>
          </select>
          <p class="text-sm text-gray-600 mt-2" id="modelInfoText"></p>
          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="dockBtn" class="btn" disabled>Run Approximate Dock</button>
            <button id="centerBtn" class="btn" disabled>Re-center &amp; Re-score</button>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <button id="clearAllBtn" class="btn-plain">Clear All</button>
            <button id="prefillFromDock" class="btn-plain">Use Current Dock in Post</button>
          </div>
        </div>

        <!-- Viewer -->
        <div class="glass panel lg:col-span-2">
          <h2 class="text-lg font-bold mb-2">3D Visualization</h2>
          <div id="viewer"></div>
        </div>

        <!-- Metrics -->
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">Ligand/Score Summary</h2>
          <div class="grid grid-cols-3 gap-2">
            <div class="metric"><div>Total ΔG</div><div id="aff" class="v">--</div></div>
            <div class="metric"><div>Ligand MW</div><div id="mw" class="v">--</div></div>
            <div class="metric"><div>Ligand LogP</div><div id="logp" class="v">--</div></div>
          </div>
        </div>

        <!-- Contributions -->
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">Contributions</h2>
          <div class="grid grid-cols-3 sm:grid-cols-6 gap-2">
            <div class="metric"><div class="text-xs">ΔG vdW</div><div id="vdw_contrib" class="v">--</div></div>
            <div class="metric"><div class="text-xs">ΔG H-Bond</div><div id="hbond_contrib" class="v">--</div></div>
            <div class="metric"><div class="text-xs">ΔG Hydroph.</div><div id="hydro_contrib" class="v">--</div></div>
            <div class="metric"><div class="text-xs">ΔS Rot.</div><div id="rot_contrib" class="v">--</div></div>
            <div class="metric"><div class="text-xs">Contacts</div><div id="contacts" class="v">--</div></div>
            <div class="metric"><div class="text-xs">Clashes</div><div id="clashes" class="v">--</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- SECTION: PBPK -->
    <section id="pbpk" class="section" data-title="PBPK/QSP">
      <div class="bricks">
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">PBPK/QSP (One-Compartment Oral)</h2>
          <label class="block text-sm font-semibold">Dose (mg)</label><input id="dose" type="number" value="100" class="input">
          <div class="grid grid-cols-2 gap-2 mt-2">
            <div><label class="block text-sm font-semibold">F (%)</label><input id="F" type="number" value="80" class="input"></div>
            <div><label class="block text-sm font-semibold">ka (h⁻¹)</label><input id="ka" type="number" value="1.2" step="0.1" class="input"></div>
            <div><label class="block text-sm font-semibold">ke (h⁻¹)</label><input id="ke" type="number" value="0.2" step="0.05" class="input"></div>
            <div><label class="block text-sm font-semibold">Vd (L)</label><input id="Vd" type="number" value="50" class="input"></div>
          </div>
          <button id="runPBPKBtn" class="btn w-full mt-3">Run PBPK Simulation</button>
          <p class="text-sm text-gray-600 mt-2">Bateman function; E<sub>max</sub> occupancy with demo K<sub>d</sub>=20 mg/L.</p>
        </div>
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">PK Metrics</h2>
          <div class="grid grid-cols-3 gap-2">
            <div class="metric"><div>C<sub>max</sub></div><div id="cmax" class="v">--</div></div>
            <div class="metric"><div>T<sub>max</sub></div><div id="tmax" class="v">--</div></div>
            <div class="metric"><div>AUC<sub>0–48</sub></div><div id="auc" class="v">--</div></div>
          </div>
        </div>
        <div class="glass panel lg:col-span-2">
          <div class="h-72"><canvas id="pkChart"></canvas></div>
        </div>
        <div class="glass panel lg:col-span-2">
          <div class="h-56"><canvas id="occChart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- SECTION: Clinical -->
    <section id="clinical" class="section" data-title="Clinical">
      <div class="bricks">
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">3+3 Dose Escalation Simulator</h2>
          <div class="grid grid-cols-2 gap-2">
            <div><label class="block text-sm font-semibold">Dose Levels</label><input id="levels" type="number" value="6" class="input"></div>
            <div><label class="block text-sm font-semibold">Cohort Size</label><input id="cohort" type="number" value="3" class="input"></div>
            <div><label class="block text-sm font-semibold">Start Dose (mg)</label><input id="startDose" type="number" value="10" class="input"></div>
            <div><label class="block text-sm font-semibold">Target DLT Rate (%)</label><input id="tox" type="number" value="25" class="input"></div>
            <div><label class="block text-sm font-semibold">Escalation Factor</label><input id="esc" type="number" value="1.5" step="0.1" class="input"></div>
            <div><label class="block text-sm font-semibold">Random Seed</label><input id="seed" type="number" value="42" class="input"></div>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-3">
            <button id="runTrialBtn" class="btn w-full">Simulate Trial</button>
            <button id="run100Btn" class="btn w-full">Run 100 Trials</button>
          </div>
          <p class="text-sm text-gray-600 mt-2">0/3 → escalate; 1/3 → expand; ≥2/3 → stop/de-escalate. MTD = highest with ≤1/6 DLTs.</p>
        </div>
        <div class="glass panel lg:col-span-2">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold mb-1">Trial Visualization</h3>
            <div id="trialBadge" class="chip hidden"></div>
          </div>
          <div class="h-72"><canvas id="trialChart"></canvas></div>
          <div class="glass panel mt-3">
            <h4 class="font-semibold mb-2">Cohorts</h4>
            <table class="w-full text-sm">
              <thead><tr class="text-left text-gray-600"><th class="py-1">#</th><th>Dose (mg)</th><th>DLTs</th><th>N</th></tr></thead>
              <tbody id="trialTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- SECTION: Community -->
    <section id="community" class="section" data-title="Community">
      <div class="bricks">
        <div class="glass panel">
          <h2 class="text-lg font-bold mb-2">Create a Post</h2>
          <div class="grid gap-2">
            <div>
              <label class="block text-sm font-semibold">Post Type</label>
              <select id="postType" class="input">
                <option value="dock" selected>Docking Result</option>
                <option value="blog">Blog</option>
                <option value="discussion">Discussion</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold">Protein (Channel)</label>
              <input id="postProtein" placeholder="e.g., Mpro (SARS-CoV-2)" class="input">
              <p class="text-xs text-gray-600 mt-1">If the channel doesn’t exist it will be created.</p>
            </div>

            <div class="dock-only grid gap-2">
              <div><label class="block text-sm font-semibold">PDB ID (optional)</label><input id="postPdbId" placeholder="e.g., 6LU7" class="input"></div>
              <div><label class="block text-sm font-semibold">Ligand (SMILES)</label><input id="postSmiles" placeholder="Paste SMILES" class="input"></div>
              <div class="grid grid-cols-2 gap-2">
                <div><label class="block text-sm font-semibold">Docking ΔG (kcal/mol)</label><input id="postDG" type="number" step="0.01" class="input"></div>
                <div>
                  <label class="block text-sm font-semibold">Mood / Framing</label>
                  <select id="postMood" class="input">
                    <option>Inspired ✨</option><option>Constructive: Needs validation</option>
                    <option>Encouraging 👍</option><option>Curious 🤔</option>
                    <option>Grateful 🙏</option><option>Optimistic 🌱</option>
                  </select>
                </div>
              </div>
              <div><label class="block text-sm font-semibold">Notes (optional)</label><textarea id="postNotes" rows="3" class="input" placeholder="Key interactions, pocket features, next steps…"></textarea></div>
              <div class="grid grid-cols-2 gap-2">
                <button id="prefillFromDock" class="btn-plain">Use Current Dock</button>
                <button id="createPostBtn" class="btn">Post</button>
              </div>
            </div>

            <div class="non-dock-only hidden grid gap-2">
              <div><label class="block text-sm font-semibold">Title</label><input id="postTitle" class="input" placeholder="Write a clear title"></div>
              <div><label class="block text-sm font-semibold">Content</label><textarea id="postContent" rows="6" class="input" placeholder="Educational content, blog, or discussion…"></textarea></div>
              <div class="grid grid-cols-2 gap-2">
                <button id="createNonDockBtn" class="btn">Publish</button>
                <button id="clearNonDockBtn" class="btn-plain">Clear</button>
              </div>
            </div>
          </div>
        </div>

        <div class="glass panel lg:col-span-2">
          <h2 class="text-lg font-bold mb-2">Community Feed</h2>
          <div class="flex items-center gap-2 w-full flex-wrap mb-2">
            <input id="searchInput" placeholder="Search by protein or SMILES…" class="input md:w-80">
            <select id="alphaFilter" class="input md:w-32">
              <option value="">All A–Z</option><option value="#num"># (0–9)</option>
              <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
              <option>F</option><option>G</option><option>H</option><option>I</option><option>J</option>
              <option>K</option><option>L</option><option>M</option><option>N</option><option>O</option>
              <option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option>
              <option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option>
            </select>
            <button id="exportJsonBtn" class="btn-plain">Export DB (JSON)</button>
            <button id="exportCsvBtn" class="btn-plain">Export Posts (CSV)</button>
          </div>
          <div id="feedGrid" class="bricks"></div>
          <div id="emptyFeed" class="text-center text-sm text-white/90 mt-6 hidden">No posts yet—share your first result.</div>
        </div>
      </div>
    </section>

    <!-- SECTION: Channels -->
    <section id="channels" class="section" data-title="Channels">
      <div class="bricks">
        <div class="glass panel lg:col-span-2">
          <div class="flex items-center justify-between flex-wrap gap-2">
            <h2 class="text-lg font-bold">Protein Channels</h2>
            <input id="channelSearch" placeholder="Search channels…" class="input md:w-80">
          </div>
          <div id="channelList" class="bricks mt-3"></div>
          <div id="channelEmpty" class="text-white/90 text-sm mt-6 hidden">No channels yet. Create a docking post to start a channel.</div>
        </div>

        <div id="channelView" class="glass panel lg:col-span-2 hidden">
          <div class="flex items-center justify-between">
            <div>
              <h3 id="chName" class="text-lg font-bold"></h3>
              <div id="chMeta" class="text-sm text-gray-600"></div>
            </div>
            <a id="chHash" class="hash" href="#">Link</a>
          </div>

          <h4 class="font-semibold mt-4 mb-2">Docking Entries</h4>
          <div class="overflow-auto">
            <table class="w-full text-sm">
              <thead>
              <tr class="text-left text-gray-600"><th class="py-1">Date</th><th>PDB</th><th>SMILES</th><th>ΔG</th><th>User</th></tr>
              </thead>
              <tbody id="chTable"></tbody>
            </table>
          </div>

          <h4 class="font-semibold mt-5 mb-2">Recent Posts</h4>
          <div id="chFeed" class="bricks"></div>
        </div>
      </div>
    </section>

    <!-- SECTION: Publications -->
    <section id="pub" class="section" data-title="Publications">
      <div class="bricks">
        <div class="glass panel">
          <h3 class="font-semibold mb-2">Create New Entry</h3>
          <label class="block text-sm font-semibold">Title</label><input id="pub-title" class="input" placeholder="In Silico Analysis of…">
          <label class="block text-sm font-semibold mt-2">Authors</label><input id="pub-authors" class="input" placeholder="Ferguson, D., et al.">
          <label class="block text-sm font-semibold mt-2">Abstract / Key Findings</label><textarea id="pub-abstract" rows="5" class="input"></textarea>
          <button id="pubSubmit" class="btn w-full mt-3">Submit</button>
          <div id="pubError" class="text-sm text-rose-700 mt-2"></div>
        </div>
        <div class="glass panel lg:col-span-2">
          <h3 class="font-semibold mb-2">Publications</h3>
          <div id="pub-list" class="bricks"></div>
          <div id="pub-empty" class="glass panel text-center hidden">No publications yet.</div>
        </div>
      </div>
    </section>

    <!-- SECTION: Learning -->
    <section id="learn" class="section" data-title="Learning">
      <div class="bricks">
        <div class="glass panel lg:col-span-2">
          <h2 class="text-lg font-bold mb-2">Learning Center</h2>
          <div class="flex flex-wrap gap-2">
            <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="pbpk">PBPK Basics</button>
            <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="docking">Docking</button>
            <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="md">MD Setup</button>
            <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="threeplus">3+3 Design</button>
            <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="community">Community Etiquette</button>
          </div>
          <div id="tutorialBox" class="glass panel mt-3 bg-white/70"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Profile modal -->
  <div id="profileModal" class="fixed inset-0 hidden items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative glass p-4 w-full max-w-md">
      <h3 id="authTitle" class="font-bold text-lg mb-2">Sign Up / Sign In</h3>
      <p class="text-xs text-gray-600 -mt-1 mb-3">Local-only (stored in your browser).</p>
      <label class="block text-sm font-semibold">Username</label>
      <input id="authUser" class="input" placeholder="e.g., ligand_lover">
      <label class="block text-sm font-semibold mt-2">Password</label>
      <input id="authPass" type="password" class="input" placeholder="••••••••">
      <label class="block text-sm font-semibold mt-2">Avatar URL (optional)</label>
      <input id="authAvatar" class="input" placeholder="https://…">
      <div class="grid grid-cols-2 gap-2 mt-3">
        <button id="signInBtn" class="btn">Sign In</button>
        <button id="signUpBtn" class="btn-plain">Create Account</button>
      </div>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <button id="closeProfileBtn" class="btn-plain">Cancel</button>
        <button id="signOutBtn" class="btn-plain">Sign Out</button>
      </div>
      <div id="authMsg" class="text-sm mt-2"></div>
    </div>
  </div>

  <!-- =========================
       FULL APP SCRIPT
       ========================= -->
  <script>
  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const on = (s,ev,fn)=>{ const el=$(s); if(el) el.addEventListener(ev,fn); };

  /* ===== Router ===== */
  const ROUTES = { md:'md', pbpk:'pbpk', clinical:'clinical', mdsetup:'mdsetup', community:'community', channels:'channels', pub:'pub', learn:'learn' };
  function setActiveNav(routeKey){
    $$('.navlink').forEach(a=>{
      const isActive = a.getAttribute('data-route') === routeKey;
      if(isActive) a.setAttribute('aria-current','page'); else a.removeAttribute('aria-current');
    });
  }
  function showSectionById(id){
    $$('.section').forEach(s=>s.classList.remove('active'));
    const sec = $('#'+id);
    if(sec){ sec.classList.add('active'); document.title = 'PharmaSim Pro · ' + (sec.dataset.title || ''); }
  }
  function navigateFromHash(){
    const hash = location.hash || '#/md';
    const pm = hash.match(/^#\/p\/(.+)/);
    if(pm){ openChannelBySlug(pm[1]); setActiveNav('channels'); return; }
    const m = hash.match(/^#\/([^/?#]+)/);
    const key = m ? m[1] : 'md';
    const sectionId = ROUTES[key] || 'md';
    showSectionById(sectionId); setActiveNav(key);
  }
  window.addEventListener('hashchange', navigateFromHash);

  /* ===== UI helpers ===== */
  function setStatus(msg, kind='info'){
    const b = $('#statusBadge'); if(!b) return;
    b.textContent = msg;
    b.className = 'chip ' + (kind==='ok' ? 'pos' : kind);
  }
  function trapz(x,y){ let A=0; for(let i=1;i<x.length;i++) A += 0.5*(y[i]+y[i-1])*(x[i]-x[i-1]); return A; }

  /* ===== App state ===== */
  let RDKitModule = null;
  let viewer = null;
  let proteinModel=null, ligandModel=null;
  let currentLigandProps=null;
  let pdbFileFromDrop=null;
  const latestDock = { proteinName:'', pdbId:'', smiles:'', dG:null };

  // Charts registry
  const charts = { pk:null, occ:null, trial:null };
  function makeChart(id, cfg){
    const ctx = document.getElementById(id);
    if(!ctx) return null;
    if(charts[id.replace('Chart','')] && charts[id.replace('Chart','')].destroy){
      charts[id.replace('Chart','')].destroy();
    }
    const chart = new Chart(ctx.getContext('2d'), {
      ...cfg,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        interaction: { mode:'nearest', intersect:false },
        plugins: { legend: { display: true } },
        ...cfg.options
      }
    });
    charts[id.replace('Chart','')] = chart;
    return chart;
  }

  const metricIds = ['mw','logp','aff','vdw_contrib','hbond_contrib','hydro_contrib','rot_contrib','contacts','clashes'];
  function resetMetrics(){ metricIds.forEach(id=>{ const el=$('#'+id); if(el) el.textContent='--'; }); }

  function refreshButtons(){
    const hasProt = !!proteinModel;
    const hasLig  = !!ligandModel;
    if($('#dockBtn'))    $('#dockBtn').disabled   = !(hasProt && hasLig);
    if($('#centerBtn'))  $('#centerBtn').disabled = !(hasProt || hasLig);
    if($('#clearProteinBtn')) $('#clearProteinBtn').disabled = !hasProt;
    if($('#clearLigandBtn'))  $('#clearLigandBtn').disabled  = !hasLig;
    if($('#clearAllBtn'))     $('#clearAllBtn').disabled     = !(hasProt || hasLig);
    if($('#resetViewBtn'))    $('#resetViewBtn').disabled    = !(hasProt || hasLig);
  }

  /* ===== 3Dmol viewer ===== */
  function ensureViewer(){
    if(!viewer){
      const v = $('#viewer'); if(!v) return null;
      viewer = $3Dmol.createViewer(v,{backgroundColor:'#eef2f7'});
    }
    return viewer;
  }
  function safeRemoveModel(m){ try{ if(m) viewer.removeModel(m); }catch(e){} }
  function addProteinFromPDB(txt){
    const v=ensureViewer(); if(!v) return;
    safeRemoveModel(proteinModel);
    proteinModel = v.addModel(txt,'pdb');
    proteinModel.setStyle({hetflag:false},{cartoon:{color:'spectrum'}});
    v.zoomTo(); v.render();
    setStatus('Protein loaded.','ok');
    refreshButtons();
  }
  function addLigandFromMolblock(molblock){
    const v=ensureViewer(); if(!v) return;
    safeRemoveModel(ligandModel);
    ligandModel = v.addModel(molblock,'sdf');
    ligandModel.setStyle({}, {stick:{radius:0.22}});
    v.zoomTo(); v.render();
    setStatus('Ligand loaded.','ok');
    refreshButtons();
  }
  function resetView(){ const v=ensureViewer(); if(!v) return; v.zoomTo(); v.render(); }
  function clearProtein(){ if(!viewer || !proteinModel) return; try{ viewer.removeModel(proteinModel); }catch(_){}
    proteinModel=null; setStatus('Protein cleared.','info'); refreshButtons(); }
  function clearLigand(){ if(!viewer || !ligandModel) return; try{ viewer.removeModel(ligandModel); }catch(_){}
    ligandModel=null; currentLigandProps=null; resetMetrics(); setStatus('Ligand cleared.','info'); refreshButtons(); }
  function clearAll(){ clearLigand(); clearProtein(); resetView(); setStatus('Cleared all.','info'); }

  /* ===== PDB: drop/file/fetch ===== */
  function wirePdbDropZone(){
    const dz=$('#pdbDrop'); if(!dz) return;
    ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{
      e.preventDefault(); e.stopPropagation(); dz.classList.add('ring-2','ring-indigo-400');
    }));
    ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{
      e.preventDefault(); e.stopPropagation(); dz.classList.remove('ring-2','ring-indigo-400');
    }));
    dz.addEventListener('drop', async e=>{
      const file=e.dataTransfer?.files?.[0];
      if(file && file.name.toLowerCase().endsWith('.pdb')){
        pdbFileFromDrop=file;
        dz.innerHTML = `<div class="font-semibold text-indigo-700">Ready: ${file.name}</div>
        <div class="text-xs text-gray-600">Click “Load Local PDB” to display</div>`;
      }else{
        dz.innerHTML = `<div class="font-semibold text-rose-700">Not a .pdb file</div>
        <div class="text-xs text-gray-600">Please drop a valid PDB</div>`;
      }
    });
  }
  async function loadLocalPdb(){
    const input=$('#pdbFile');
    const file=pdbFileFromDrop || input?.files?.[0];
    if(!file){ alert('Choose or drop a .pdb file first.'); return; }
    const txt = await file.text();
    addProteinFromPDB(txt);
    pdbFileFromDrop=null;
    const dz=$('#pdbDrop');
    if(dz) dz.innerHTML = `<div class="font-semibold text-green-700">Loaded: ${file.name}</div>
    <div class="text-xs text-gray-600">Drop a new file to replace it.</div>`;
    latestDock.proteinName = file.name.replace(/\.pdb$/i,'');
    latestDock.pdbId='';
  }
  async function fetchPdb(){
    const el=$('#pdbId'); if(!el) return;
    const id=el.value.trim().toUpperCase(); if(!id) return;
    try{
      setStatus(`Fetching PDB ${id}…`,'info');
      const r=await fetch(`https://files.rcsb.org/download/${id}.pdb`);
      if(!r.ok) throw new Error(`PDB ${id} not found.`);
      const txt=await r.text();
      addProteinFromPDB(txt);
      latestDock.proteinName=id; latestDock.pdbId=id;
    }catch(e){
      console.error(e);
      setStatus(e.message||'PDB fetch failed','err');
      alert(e.message||'PDB fetch failed');
    }
  }

  /* ===== RDKit (SMILES) ===== */
  async function processSmilesString(smiles){
    const v=ensureViewer(); if(!v) return;
    safeRemoveModel(ligandModel); ligandModel=null; currentLigandProps=null; resetMetrics();
    $('#dockBtn') && ($('#dockBtn').disabled = !proteinModel);

    smiles = (smiles||'').trim();
    if(!smiles){ setStatus('Please enter a SMILES string.','warn'); return; }
    if(!RDKitModule){ setStatus('RDKit not ready yet.','warn'); return; }

    let mol=null;
    try{
      mol = RDKitModule.get_mol(smiles);
      if(!mol){ setStatus('Invalid SMILES: RDKit could not parse.','err'); return; }

      // descriptors
      try {
        const desc = JSON.parse(mol.get_descriptors()||'{}');
        const toNum = v => (typeof v === 'number' && isFinite(v)) ? v : null;
        const NumHeavyAtoms     = toNum(desc.NumHeavyAtoms);
        const NumHDonors        = toNum(desc.NumHDonors);
        const NumHAcceptors     = toNum(desc.NumHAcceptors);
        const MolLogP           = toNum(desc.MolLogP ?? desc.CalcLogP);
        const NumRotatableBonds = toNum(desc.NumRotatableBonds);
        const MolWt             = toNum(desc.MolWt ?? desc.MolecularWeight ?? desc.exactmw ?? desc.ExactMolWt);

        if(MolWt!=null) $('#mw').textContent = MolWt.toFixed(2);
        if(MolLogP!=null) $('#logp').textContent = MolLogP.toFixed(2);

        if([NumHeavyAtoms,NumHDonors,NumHAcceptors,MolLogP,NumRotatableBonds].every(x=>x!=null)){
          currentLigandProps = {
            numHeavyAtoms: NumHeavyAtoms,
            hDonors: NumHDonors,
            hAcceptors: NumHAcceptors,
            logp: MolLogP,
            numRotatableBonds: NumRotatableBonds
          };
        }
      } catch(parseErr){ console.warn('Descriptor parse failed', parseErr); }

      // embed
      let molblock = '';
      try{
        mol.add_hs();
        const ok = mol.embed_molecule();
        mol.remove_hs();
        molblock = mol.get_molblock();
        setStatus(ok===0 ? 'SMILES loaded & embedded.':'SMILES loaded (embedding fallback).', ok===0?'ok':'warn');
      }catch(e){
        try{ mol.remove_hs(); }catch(_){}
        molblock = mol.get_molblock();
        setStatus('SMILES loaded (no 3D conformer).','warn');
      }

      addLigandFromMolblock(molblock);
      latestDock.smiles = smiles;

    } catch(e){
      console.error('RDKit SMILES pipeline error:', e);
      setStatus((e && e.message) ? `SMILES error: ${e.message}` : 'SMILES processing failed.', 'err');
    } finally {
      if(mol) mol.delete();
      refreshButtons();
    }
  }
  function loadSmilesBtn(){
    const smiles = $('#smiles')?.value || '';
    if(!smiles.trim()){ alert('Enter a SMILES string first.'); return; }
    processSmilesString(smiles);
  }
  function useExampleSmiles(){
    const sel=$('#exampleSmiles');
    if(sel && sel.value){
      $('#smiles').value=sel.value;
      processSmilesString(sel.value);
    }
  }

  /* ===== Fallback estimator for docking when descriptors missing ===== */
  function getAtomsFromModel(m){
    try{
      if(!m) return [];
      if(typeof m.selectedAtoms==='function') return m.selectedAtoms({});
      if(typeof m.getAtoms==='function') return m.getAtoms();
      if(Array.isArray(m.atoms)) return m.atoms;
    }catch(_){} return [];
  }
  function estimateLigandPropsFromModel(){
    const atoms = getAtomsFromModel(ligandModel);
    if(!atoms.length) return null;
    const heavy = atoms.filter(a=>a.elem!=='H').length;
    const numC  = atoms.filter(a=>a.elem==='C').length;
    const hetero = atoms.filter(a=>a.elem!=='H' && a.elem!=='C').length;
    const donors = atoms.filter(a=>a.elem==='N' || a.elem==='O').length;
    const accept = atoms.filter(a=>a.elem==='N' || a.elem==='O').length;
    const logpRaw = 0.54*numC - 1.5*hetero;
    const logp = Math.max(-2, Math.min(6, logpRaw));
    const rotBonds = Math.round(0.3 * heavy);
    return {
      numHeavyAtoms: heavy,
      hDonors: donors,
      hAcceptors: accept,
      logp: logp,
      numRotatableBonds: Math.max(0, rotBonds)
    };
  }

  /* ===== Heuristic docking score ===== */
  function bindingContrib(l, t='balanced'){
    const M={
      balanced:{I:-1.5,V:-0.035,H:-0.70,Hy:-0.25,R:0.30},
      hbond:{I:-1.0,V:-0.030,H:-1.20,Hy:-0.15,R:0.30},
      hydrophobic:{I:-1.2,V:-0.040,H:-0.50,Hy:-0.45,R:0.25}
    }[t] || {I:-1.5,V:-0.035,H:-0.70,Hy:-0.25,R:0.30};
    const hb=Math.min(l.hDonors,l.hAcceptors);
    return {
      intercept:M.I,
      vdw: M.V*l.numHeavyAtoms,
      hbond: M.H*hb,
      hydrophobic: M.Hy*l.logp,
      rotational: M.R*l.numRotatableBonds
    };
  }
  function getLigandProps(){ return currentLigandProps || estimateLigandPropsFromModel(); }

  function runDock(){
    if(!proteinModel || !ligandModel){
      alert('Please load a protein and a ligand first.');
      return;
    }
    const ligProps = getLigandProps();
    if(!ligProps){
      alert('Could not derive ligand descriptors. Try another SMILES.');
      return;
    }
    const which = $('#scoringModel')?.value || 'balanced';
    const base = bindingContrib(ligProps, which);
    const prot = getAtomsFromModel(proteinModel);
    const lig  = getAtomsFromModel(ligandModel);
    const het=new Set(['N','O','S']);
    let contacts=0, clashes=0;
    for(const la of lig){
      for(const pa of prot){
        const dx=la.x-pa.x, dy=la.y-pa.y, dz=la.z-pa.z;
        const r2=dx*dx+dy*dy+dz*dz;
        if(r2<3.5*3.5 && het.has(pa.elem)) contacts++;
        if(r2<1.8*1.8) clashes++;
      }
    }
    const total = Object.values(base).reduce((s,v)=>s+v,0) + (-0.15*Math.min(contacts,50)) + (0.4*Math.min(clashes,25));
    const set=(id,val)=>{ const el=$('#'+id); if(el) el.textContent=val; };
    set('aff', total.toFixed(2));
    set('vdw_contrib', base.vdw.toFixed(2));
    set('hbond_contrib', base.hbond.toFixed(2));
    set('hydro_contrib', base.hydrophobic.toFixed(2));
    set('rot_contrib', base.rotational.toFixed(2));
    set('contacts', String(contacts));
    set('clashes', String(clashes));
    latestDock.dG = Number(total.toFixed(2));
    setStatus('Docking scored (heuristic).','ok');
    refreshButtons();
  }
  function recenterAndRescore(){ resetView(); if(proteinModel && ligandModel) runDock(); }

  /* ===== Local DB: users/channels/posts ===== */
  const K_USERS='ps_users_v1', K_SESSION='ps_session_v1';
  const K_CHANNELS='ps_channels_v1', K_POSTS='ps_posts_v1', K_IDX='pharmsim_alpha_index_v1';
  const userdb = ()=> JSON.parse(localStorage.getItem(K_USERS)||'[]');
  const saved  = (k)=> JSON.parse(localStorage.getItem(k)||'[]');
  const slugify=s=>s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  function getSession(){ return JSON.parse(localStorage.getItem(K_SESSION)||'null'); }
  function upsertChannel(name){
    const channels=saved(K_CHANNELS); const slug=slugify(name||''); if(!slug) return null;
    let c=channels.find(x=>x.slug===slug);
    if(!c){
      const s=getSession();
      c={id:crypto.randomUUID(),slug,name,description:'',createdBy:s?.username||'anon',createdAt:Date.now()};
      channels.push(c); localStorage.setItem(K_CHANNELS, JSON.stringify(channels));
    }
    return c;
  }
  function addPost(post){ const posts=saved(K_POSTS); posts.push(post); localStorage.setItem(K_POSTS, JSON.stringify(posts)); }
  function readPosts(){ return saved(K_POSTS); }
  function buildAlphaIndex(arr){
    const idx={}; for(const p of arr){
      const ch=(p.proteinName||'').trim()[0]||'#';
      const key=/[A-Za-z]/.test(ch)?ch.toUpperCase():'#';
      (idx[key]=idx[key]||[]).push(p.id);
    }
    localStorage.setItem(K_IDX, JSON.stringify(idx));
  }

  function renderPostCard(p){
    const card=document.createElement('div'); card.className='feed-card';
    const mood=p.mood?.includes('Constructive')?'warn':'pos';
    const ch=saved(K_CHANNELS).find(c=>c.id===p.channelId); const chLink=ch?`<a class="hash" href="#/p/${ch.slug}">#${p.proteinName}</a>`:'';
    const user=p.user||{username:'Anonymous',avatar:'https://i.pravatar.cc/40'};
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-gray-600">${chLink} · ${user.username||''}</div>
          <h4 class="font-semibold text-lg">${p.title||p.proteinName||'Untitled'}</h4>
          <div class="flex flex-wrap gap-2 mt-1">
            ${p.pdbId?`<span class="chip info">PDB ${p.pdbId}</span>`:''}
            ${p.type==='dock'?`<span class="chip ${mood}">ΔG ${p.dG!=null?p.dG:'--'}</span>`:`<span class="chip info">${p.type}</span>`}
          </div>
        </div>
        <img src="${user.avatar||'https://i.pravatar.cc/40'}" class="w-10 h-10 rounded-full" alt="avatar">
      </div>
      ${p.type==='dock'?`
        ${p.smiles?`<div class="text-xs break-all mt-2"><span class="font-semibold">SMILES:</span> ${p.smiles}</div>`:''}
        ${p.notes?`<p class="text-sm mt-2 whitespace-pre-wrap">${p.notes}</p>`:''}
      `:`
        <p class="text-sm mt-2 whitespace-pre-wrap">${p.content||''}</p>
      `}
      <div class="text-xs text-gray-500 mt-2">${new Date(p.createdAt).toLocaleString()}</div>
    `;
    return card;
  }
  function refreshFeed(){
    const q=($('#searchInput')?.value||'').toLowerCase();
    const alpha=$('#alphaFilter')?.value||'';
    const posts=readPosts();
    let f=posts.filter(p=>{
      const s1=(p.proteinName||'').toLowerCase().includes(q);
      const s2=(p.smiles||'').toLowerCase().includes(q);
      const s3=(p.title||'').toLowerCase().includes(q);
      return s1||s2||s3;
    });
    if(alpha){
      f=f.filter(p=>{
        const ch=(p.proteinName||'').trim()[0]||'#';
        const key=/[A-Za-z]/.test(ch)?ch.toUpperCase():'#';
        return alpha===''?true:(alpha==='#num'?key==='#':key===alpha);
      });
    }
    f.sort((a,b)=>b.createdAt-a.createdAt);
    const grid=$('#feedGrid'); if(!grid) return;
    grid.innerHTML=''; f.forEach(p=>grid.appendChild(renderPostCard(p)));
    $('#emptyFeed')?.classList.toggle('hidden', !!f.length);
  }

  function renderChannelCard(ch){
    const posts=readPosts().filter(p=>p.channelId===ch.id);
    const docks=posts.filter(p=>p.type==='dock');
    const best=docks.length?docks.reduce((a,b)=>(a.dG??999)<(b.dG??999)?a:b):null;
    const card=document.createElement('div'); card.className='feed-card';
    card.innerHTML=`
      <div class="flex items-center justify-between">
        <a class="hash" href="#/p/${ch.slug}"><h3 class="font-semibold text-lg">#${ch.name}</h3></a>
        <span class="chip info">${posts.length} posts</span>
      </div>
      <div class="text-sm text-gray-600">Started by ${ch.createdBy} · ${new Date(ch.createdAt).toLocaleDateString()}</div>
      <div class="mt-2 text-sm">${best?`Best ΔG: <strong>${best.dG}</strong> (PDB ${best.pdbId||'—'})`:'No docking yet.'}</div>
    `;
    return card;
  }
  function refreshChannelList(){
    const q=($('#channelSearch')?.value||'').toLowerCase();
    const channels=saved(K_CHANNELS).filter(c=>c.name.toLowerCase().includes(q));
    const list=$('#channelList'); if(!list) return;
    list.innerHTML='';
    channels.sort((a,b)=>a.name.localeCompare(b.name));
    channels.forEach(c=>list.appendChild(renderChannelCard(c)));
    $('#channelEmpty')?.classList.toggle('hidden', !!channels.length);
  }
  function openChannelBySlug(slug){
    const channels=saved(K_CHANNELS); const ch=channels.find(c=>c.slug===slug);
    if(!ch){ alert('Channel not found'); return; }
    $('#chName').textContent='#'+ch.name;
    $('#chMeta').textContent=`Created by ${ch.createdBy} · ${new Date(ch.createdAt).toLocaleString()}`;
    $('#chHash').href=`#/p/${ch.slug}`;
    const posts=readPosts().filter(p=>p.channelId===ch.id).sort((a,b)=>b.createdAt-a.createdAt);

    const tb=$('#chTable'); tb.innerHTML='';
    posts.filter(p=>p.type==='dock').forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="py-1">${new Date(p.createdAt).toLocaleDateString()}</td><td>${p.pdbId||''}</td><td class="break-all">${p.smiles||''}</td><td>${p.dG==null?'':p.dG}</td><td>${p.user?.username||''}</td>`;
      tb.appendChild(tr);
    });

    const feed=$('#chFeed'); feed.innerHTML='';
    posts.slice(0,12).forEach(p=>feed.appendChild(renderPostCard(p)));

    $('#channelView').classList.remove('hidden');
    showSectionById('channels'); setActiveNav('channels');
  }

  /* ===== Auth & Posts ===== */
  function openProfile(){ const m=$('#profileModal'); if(m){ $('#authMsg').textContent=''; m.classList.remove('hidden'); m.classList.add('flex'); } }
  function closeProfile(){ const m=$('#profileModal'); if(m){ m.classList.add('hidden'); m.classList.remove('flex'); } }
  function setSession(u){ localStorage.setItem(K_SESSION, JSON.stringify(u)); $('#profileBtn').textContent=u.username; closeProfile(); }
  function signUp(){
    const username=$('#authUser').value.trim(), pass=$('#authPass').value, avatar=$('#authAvatar').value.trim();
    if(!username||!pass){ $('#authMsg').textContent='Provide username & password.'; $('#authMsg').className='text-rose-700 text-sm'; return; }
    const users=userdb(); if(users.find(u=>u.username===username)){ $('#authMsg').textContent='Username already exists.'; $('#authMsg').className='text-rose-700 text-sm'; return; }
    users.push({id:crypto.randomUUID(),username,pass,avatar}); localStorage.setItem(K_USERS, JSON.stringify(users));
    setSession({username,avatar}); $('#authMsg').textContent='Account created.'; $('#authMsg').className='text-green-700 text-sm';
  }
  function signIn(){
    const username=$('#authUser').value.trim(), pass=$('#authPass').value;
    const users=userdb(); const u=users.find(u=>u.username===username && u.pass===pass);
    if(!u){ $('#authMsg').textContent='Invalid credentials.'; $('#authMsg').className='text-rose-700 text-sm'; return; }
    setSession({username:u.username, avatar:u.avatar});
  }
  function signOut(){ localStorage.removeItem(K_SESSION); $('#profileBtn').textContent='Sign In'; closeProfile(); }
  function createDockPost(){
    const sess=getSession(); if(!sess){ alert('Sign in first'); return; }
    const proteinName=$('#postProtein').value.trim(); if(!proteinName){ alert('Enter protein name'); return; }
    const channel=upsertChannel(proteinName);
    const p={
      id:crypto.randomUUID(),
      type:'dock',
      channelId:channel.id,
      proteinName,
      pdbId:$('#postPdbId').value.trim(),
      smiles:$('#postSmiles').value.trim(),
      dG:parseFloat($('#postDG').value)||null,
      mood:$('#postMood').value,
      notes:$('#postNotes').value,
      user:sess,
      createdAt:Date.now()
    };
    addPost(p); buildAlphaIndex(readPosts()); refreshFeed(); refreshChannelList(); alert('Posted!');
  }
  function createNonDockPost(){
    const sess=getSession(); if(!sess){ alert('Sign in first'); return; }
    const proteinName=$('#postProtein').value.trim();
    const channel=upsertChannel(proteinName||'General');
    const p={
      id:crypto.randomUUID(),
      type:$('#postType').value,
      channelId:channel.id,
      proteinName:proteinName||'General',
      title:$('#postTitle').value,
      content:$('#postContent').value,
      user:sess,
      createdAt:Date.now()
    };
    addPost(p); buildAlphaIndex(readPosts()); refreshFeed(); refreshChannelList(); alert('Published!');
  }

  /* ===== PBPK/QSP ===== */
  function runPBPK(){
    const Dose = parseFloat($('#dose').value)||0;
    const F    = (parseFloat($('#F').value)||0)/100;
    let ka     = parseFloat($('#ka').value)||0;
    let ke     = parseFloat($('#ke').value)||0;
    const Vd   = parseFloat($('#Vd').value)||1;
    if(ka===ke){ ka += 1e-6; } // avoid divide-by-zero

    // time grid 0..48h
    const dt=0.25, t=[], C=[], Occ=[];
    const Kd=20; // mg/L demo
    for(let x=0; x<=48+1e-6; x+=dt){ t.push(+x.toFixed(2)); }
    const A = (F*Dose/Vd)*(ka/(ka-ke));
    for(const ti of t){
      const c = A*(Math.exp(-ke*ti) - Math.exp(-ka*ti));
      const cc = Math.max(0,c);
      C.push(cc);
      Occ.push(cc/(cc+Kd));
    }

    // metrics
    const Cmax = Math.max(...C);
    const Tmax = t[C.indexOf(Cmax)];
    const AUC  = trapz(t,C);

    $('#cmax').textContent = Cmax.toFixed(2)+' mg/L';
    $('#tmax').textContent = Tmax.toFixed(2)+' h';
    $('#auc').textContent  = AUC.toFixed(2)+' mg·h/L';

    // charts
    makeChart('pkChart',{
      type:'line',
      data:{ labels:t, datasets:[{ label:'Plasma Concentration (mg/L)', data:C, borderWidth:2, fill:false }]},
      options:{ scales:{ x:{ title:{display:true, text:'Time (h)'} }, y:{ beginAtZero:true, title:{display:true, text:'mg/L'} } } }
    });
    makeChart('occChart',{
      type:'line',
      data:{ labels:t, datasets:[{ label:'Target Occupancy', data:Occ, borderWidth:2, fill:false }]},
      options:{ scales:{ x:{ title:{display:true, text:'Time (h)'} }, y:{ beginAtZero:true, max:1, title:{display:true, text:'Fraction'} } } }
    });
    setStatus('PBPK run complete.','ok');
  }

  /* ===== 3+3 Clinical Simulator ===== */
  function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
  function simulateTrial(){
    const levels = Math.max(1, parseInt($('#levels').value)||6);
    const cohort = Math.max(1, parseInt($('#cohort').value)||3);
    const startDose = Math.max(0.001, parseFloat($('#startDose').value)||10);
    const target = Math.max(1, Math.min(90, parseFloat($('#tox').value)||25))/100; // target DLT at "MTD"
    const esc = Math.max(1.01, parseFloat($('#esc').value)||1.5);
    const seed = (parseInt($('#seed').value)||42) >>> 0;
    const rand = mulberry32(seed);

    // Construct dose ladder
    const doses = Array.from({length:levels}, (_,i)=> startDose * Math.pow(esc, i));

    // crude toxicity curve such that middle levels are near target, rising with dose
    const base = target/2;
    const pDLT = doses.map((_,i)=>{
      const scale = Math.pow(esc, i - Math.floor(levels/2));
      return Math.max(0.02, Math.min(0.90, base * scale));
    });

    const cohorts=[];
    let level=0;
    let mtdLevel=null;

    function enroll(atLevel, n){
      let dlt=0;
      for(let i=0;i<n;i++){ if(rand() < pDLT[atLevel]) dlt++; }
      cohorts.push({dose:doses[atLevel], level:atLevel+1, n, dlt});
      return dlt;
    }

    // 3+3 rules
    while(true){
      const dlt1 = enroll(level, cohort);
      if(dlt1===0){
        if(level===levels-1){ mtdLevel=level+1; break; }
        level++; // escalate
      }else if(dlt1===1){
        const dlt2 = enroll(level, cohort); // expand to 6
        const total = dlt1 + dlt2;
        if(total<=1){
          if(level===levels-1){ mtdLevel=level+1; break; }
          level++;
        }else{
          mtdLevel = level>0 ? level : 1;
          break;
        }
      }else{ // >=2/3
        mtdLevel = level>0 ? level : 1;
        break;
      }
      if(cohorts.length>50){ mtdLevel = Math.max(1, level); break; } // guard
    }

    return { doses, pDLT, cohorts, mtdLevel };
  }

  function renderTrial(trial){
    // table
    const tb=$('#trialTable'); tb.innerHTML='';
    trial.cohorts.forEach((c,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="py-1">${i+1}</td><td>${c.dose.toFixed(2)}</td><td>${c.dlt}</td><td>${c.n}</td>`;
      tb.appendChild(tr);
    });

    // badge
    const badge=$('#trialBadge');
    badge.classList.remove('hidden');
    const txt = trial.mtdLevel ? `MTD at level ${trial.mtdLevel} (dose ~${trial.doses[trial.mtdLevel-1].toFixed(2)} mg)` : 'No MTD';
    badge.textContent = txt;
    badge.className = 'chip ' + (trial.mtdLevel ? 'pos' : 'warn');

    // chart: show DLTs per cohort + dose ladder reference
    const labels = trial.cohorts.map((_,i)=>`C${i+1}`);
    const dltData = trial.cohorts.map(c=>c.dlt);
    const doseStep = trial.cohorts.map(c=>c.dose);

    makeChart('trialChart',{
      type:'bar',
      data:{
        labels,
        datasets:[
          { type:'bar', label:'DLTs', data:dltData, borderWidth:1 },
          { type:'line', label:'Dose (mg)', data:doseStep, yAxisID:'y2', borderWidth:2 }
        ]
      },
      options:{
        scales:{
          y:{ beginAtZero:true, title:{display:true, text:'DLTs'} },
          y2:{ position:'right', beginAtZero:true, title:{display:true, text:'Dose (mg)'} }
        }
      }
    });
  }

  function runOneTrial(){ const trial=simulateTrial(); renderTrial(trial); setStatus('3+3 trial simulated.','ok'); }
  function runHundredTrials(){
    const N=100, mtds=[];
    for(let i=0;i<N;i++){ const t=simulateTrial(); mtds.push(t.mtdLevel||0); }
    const avg = mtds.reduce((a,b)=>a+b,0)/N;
    const badge=$('#trialBadge');
    badge.classList.remove('hidden');
    badge.textContent = `100 sims · Avg MTD level: ${avg.toFixed(2)}`;
    badge.className = 'chip info';

    // histogram of MTD levels
    const levels = Math.max(1, parseInt($('#levels').value)||6);
    const bins = Array.from({length:levels+1},()=>0); // 0=none
    mtds.forEach(k=>bins[k]++);
    const labels = ['None', ...Array.from({length:levels}, (_,i)=>String(i+1))];

    makeChart('trialChart',{
      type:'bar',
      data:{ labels, datasets:[{ label:'MTD frequency (out of 100)', data:bins, borderWidth:1 }]},
      options:{ scales:{ y:{ beginAtZero:true } } }
    });
    // clear table
    $('#trialTable').innerHTML='';
    setStatus('Ran 100 simulated trials.','ok');
  }

  /* ===== Wire up ===== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    // RDKit WASM load
    const RD_BASE='https://unpkg.com/@rdkit/rdkit/dist/';
    try{
      RDKitModule = await initRDKitModule({ locateFile: file => RD_BASE + file });
      setStatus('Libraries ready. RDKit initialized.','ok');
    }catch(e){
      console.error(e); setStatus('RDKit failed to load.','err');
    }

    ensureViewer(); wirePdbDropZone();

    // Protein buttons
    on('#loadLocalPdbBtn','click',loadLocalPdb);
    on('#fetchPdbBtn','click',fetchPdb);
    on('#clearProteinBtn','click',clearProtein);
    on('#resetViewBtn','click',resetView);

    // Ligand buttons
    on('#useExampleBtn','click',useExampleSmiles);
    on('#loadSmilesBtn','click',loadSmilesBtn);
    on('#clearLigandBtn','click',clearLigand);

    // Docking controls
    on('#dockBtn','click',runDock);
    on('#centerBtn','click',recenterAndRescore);
    on('#clearAllBtn','click',clearAll);

    // Prefill post
    on('#prefillFromDock','click',()=>{
      const map = {
        postProtein: latestDock.proteinName || '',
        postPdbId:   latestDock.pdbId || '',
        postSmiles:  latestDock.smiles || '',
        postDG:      latestDock.dG || ''
      };
      Object.entries(map).forEach(([id,val])=>{ const el=$('#'+id); if(el) el.value=val; });
    });
    on('#createPostBtn','click',createDockPost);
    on('#createNonDockBtn','click',createNonDockPost);

    // Auth
    on('#profileBtn','click',openProfile);
    on('#closeProfileBtn','click',closeProfile);
    on('#signUpBtn','click',signUp);
    on('#signInBtn','click',signIn);
    on('#signOutBtn','click',signOut);

    // PBPK / Clinical
    on('#runPBPKBtn','click',runPBPK);
    on('#runTrialBtn','click',runOneTrial);
    on('#run100Btn','click',runHundredTrials);

    // Model info text
    const infoByModel={
      balanced:"Balances size, H-bonding, hydrophobics, flexibility.",
      hbond:"Rewards donors/acceptors; good for polar pockets.",
      hydrophobic:"Rewards nonpolar fit; penalizes excess polarity."
    };
    const smSel=$('#scoringModel');
    if(smSel){
      smSel.addEventListener('change',()=>{ $('#modelInfoText').textContent = infoByModel[smSel.value] || ''; });
      smSel.dispatchEvent(new Event('change'));
    }

    // Init UI
    navigateFromHash();
    resetMetrics();
    refreshButtons();
    refreshFeed(); refreshChannelList();
  });
  </script>
</body>
</html>
