<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PharmaSim Pro · Full Integrated Suite (Stable In-Browser)</title>

  <!-- Hints improve CDN reliability -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

  <!-- External Libraries (defer so DOM is ready; we’ll wait for globals before using) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" crossorigin="anonymous"></script>
  <script defer src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" crossorigin="anonymous"></script>
  <!-- Optional WASM docking -->
  <!-- <script defer src="./browser-vina.js"></script> -->

  <style>
    /* (Styles unchanged except tiny tweaks for error bar) */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg,#1e3c72 0%,#2a5298 50%,#7e8ba3 100%); color:#0b1630; }
    header { position: sticky; top:0; background: rgba(255,255,255,.95); backdrop-filter: blur(8px);
      box-shadow: 0 6px 20px rgba(0,0,0,.08); z-index:10; }
    .nav { max-width: 1400px; margin:0 auto; padding:14px 18px; display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; }
    .tab { padding:8px 14px; border:2px solid #2a5298; border-radius:18px; background:#fff; color:#2a5298; font-weight:700; cursor:pointer; transition:.2s; }
    .tab.active,.tab:hover { background: linear-gradient(135deg,#2a5298,#1e3c72); color:#fff; border-color:transparent; transform: translateY(-2px); }
    .container { max-width: 1400px; margin:22px auto; padding:0 16px; }
    .grid { display:grid; grid-template-columns:360px 1fr; gap:22px; }
    .panel { background: rgba(255,255,255,.95); backdrop-filter: blur(6px); border-radius:16px; box-shadow: 0 10px 26px rgba(0,0,0,.12); padding:18px; }
    label { display:block; font-size:13px; color:#334; margin:6px 0 4px; }
    input,textarea,select { width:100%; padding:10px 12px; border:2px solid #e0e6ed; border-radius:10px; background:#f8f9fa; font: inherit; font-size:14px; }
    input:focus,textarea:focus,select:focus { outline:none; border-color:#2a5298; background:#fff; box-shadow:0 0 0 3px rgba(42,82,152,.12); }
    button { padding:10px 14px; border:none; border-radius:10px; background: linear-gradient(135deg,#2a5298,#1e3c72); color:#fff; font-weight:700; cursor:pointer; transition:.2s; width:100%; }
    button:hover:not(:disabled) { box-shadow:0 4px 15px rgba(42,82,152,0.4); transform: translateY(-2px); }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .col { flex:1 1 160px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre; overflow:auto; background:#0a142b; color:#e6edf3; border-radius:10px; border:1px solid rgba(255,255,255,.15); padding:10px; font-size:12.5px; }
    .section { display:none; } .section.active { display:block; }
    #viewer { width:100%; min-height:420px; border-radius:10px; background:#eef2f7; position:relative; }
    .metrics { display:grid; grid-template-columns: repeat(auto-fit,minmax(130px,1fr)); gap:10px; }
    .metric { background: linear-gradient(135deg,#f8f9fa,#e9eef6); border-radius:12px; text-align:center; padding:12px; }
    .metric .v { font-size:1.4em; font-weight:800; background: linear-gradient(135deg,#2a5298,#1e3c72); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .hint { font-size:12px; color:#476; margin-top:8px; }
    .disclaimer { background: linear-gradient(135deg,#fff3e0,#ffe0b2); border:2px solid #ff9800; border-radius:12px; padding:12px 16px; margin:16px auto; max-width:1400px; }
    .log { grid-column:1/-1; } .log .wrap { max-height:300px; overflow:auto; border:1px solid #e7e7e7; border-radius:10px; background:#fff; }
    table { width:100%; border-collapse: collapse; } th,td { font-size:12px; padding:8px 10px; border-bottom:1px solid #eee; text-align:left; } th { background:#f5f7fb; }
    .pub-form,.tutorial { background: rgba(255,255,255,.95); backdrop-filter: blur(6px); border-radius:16px; box-shadow:0 10px 26px rgba(0,0,0,.12); padding:18px; }
    .pub-card { background: rgba(255,255,255,.9); border:1px solid #e6eaf2; border-radius:14px; padding:14px; }
    .overlay { position: fixed; inset:0; background: rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999; color:#fff; text-align:center; }
    .spinner { width:48px; height:48px; border-radius:50%; border:5px solid #eee; border-top:5px solid #2a5298; animation: spin 1s linear infinite; margin:0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media(max-width: 1000px) { .grid { grid-template-columns:1fr; } .panel { position: static !important; } }

    /* Error/status bar */
    .statusbar { max-width:1400px; margin:12px auto 0; padding:10px 14px; border-radius:10px;
      background:#fff5f5; border:1px solid #fecaca; color:#7f1d1d; display:none; }
    .statusbar.ok { background:#f0fdf4; border-color:#bbf7d0; color:#14532d; }
  </style>
</head>
<body>
<header>
  <div class="nav">
    <div style="font-weight:800;color:#1e3c72">PharmaSim Pro</div>
    <div class="tabs">
      <button class="tab" data-t="pbpk">PBPK/QSP</button>
      <button class="tab" data-t="clinical">Clinical</button>
      <button class="tab active" data-t="md">Docking</button>
      <button class="tab" data-t="mdsetup">MD Setup</button>
      <button class="tab" data-t="pub">Publications</button>
      <button class="tab" data-t="learn">Learning</button>
    </div>
  </div>
</header>

<div class="disclaimer"><strong>Note:</strong> All models here are approximations for educational use. Validate results experimentally before making decisions.</div>
<div id="status" class="statusbar"></div>

<div class="overlay" id="loading"><div><div class="spinner"></div><div id="loadingText">Processing…</div></div></div>

<div class="container">
  <!-- PBPK/QSP Module -->
  <section id="pbpk" class="section">
    <div class="grid">
      <div class="panel">
        <h3>PBPK/QSP Parameters</h3>
        <label>Dose (mg)</label><input id="dose" type="number" value="100" />
        <div class="row">
          <div class="col"><label>F (%)</label><input id="F" type="number" value="80"/></div>
          <div class="col"><label>ka (h⁻¹)</label><input id="ka" type="number" value="1.2" step="0.1"/></div>
          <div class="col"><label>ke (h⁻¹)</label><input id="ke" type="number" value="0.2" step="0.05"/></div>
          <div class="col"><label>Vd (L)</label><input id="Vd" type="number" value="50"/></div>
        </div>
        <div class="row" style="margin-top:10px;"><button id="runPBPKBtn">Run PBPK Simulation</button></div>
      </div>
      <div class="panel">
        <h3>Pharmacokinetic Outputs</h3>
        <canvas id="pkChart"></canvas>
        <canvas id="occChart" style="margin-top:10px;"></canvas>
      </div>
    </div>
  </section>

  <!-- Clinical Trial Module -->
  <section id="clinical" class="section">
    <div class="grid">
      <div class="panel">
        <h3>3+3 Dose Escalation Simulation</h3>
        <div class="row">
          <div class="col"><label>Dose Levels</label><input id="levels" type="number" value="6"/></div>
          <div class="col"><label>Cohort Size</label><input id="cohort" type="number" value="3"/></div>
          <div class="col"><label>Start Dose (mg)</label><input id="startDose" type="number" value="10"/></div>
          <div class="col"><label>Target DLT Rate (%)</label><input id="tox" type="number" value="25"/></div>
        </div>
        <div class="row" style="margin-top:10px;"><button id="runTrialBtn">Simulate Trial</button></div>
      </div>
      <div class="panel">
        <h3>Trial Visualization</h3>
        <canvas id="trialChart"></canvas>
      </div>
    </div>
  </section>

  <!-- Molecular Docking Module -->
  <section id="md" class="section active">
    <div class="grid">
      <div class="panel">
        <h3>Ligand Prep & Heuristic Docking</h3>
        <label>Protein (PDB)</label><input type="file" id="pdbFile" accept=".pdb" />
        <label>Load Example from Paper</label>
        <select id="exampleSmiles">
          <option value="" disabled selected>Select a Drug Hit...</option>
          <option value="O=P(O)(O)COC(=O)C1CCCN1C(=O)c1ccc(CNS(=O)(=O)c2ccc(C)cc2)cc1">Drug Hit 1 (Zn-Chelator)</option>
          <option value="CC(C)NCc1ccc(S(=O)(=O)Nc2cccc(c2)C(=O)N2CCCC2C(=O)OCC)cc1">Drug Hit 2 (π-π Stacking)</option>
          <option value="N1=C(N)N=C(C1)CCS(=O)(=O)NCc1ccc(C(=O)OCP(=O)(O)O)cc1">Drug Hit 3 (H-Bond)</option>
          <option value="Cc1ccc(OCc2ccc(C(=O)OC[C@H]3O[C@H](O)[C@H](O)[C@@H](O)[C@@H]3CO)cc2)cc1">Drug Hit 4 (Allosteric)</option>
          <option value="CC(C)NC(=O)C1CCN(CC1)c1cccc2OCOc12">Drug Hit 5 (Reversible)</option>
          <option value="CC(C)CC(NC(=O)C1CCN(CC1)c1cccc2OCOc12)Cc1ccccc1">Drug Hit 6 (Irreversible)</option>
        </select>
        <label>Ligand (SMILES)</label><input id="smiles" value="CC(=O)OC1=CC=CC=C1C(=O)O"/>
        <label>Scoring Model</label>
        <select id="scoringModel">
          <option value="balanced" selected>Balanced Model</option>
          <option value="hbond">H-Bond Focused</option>
          <option value="hydrophobic">Hydrophobicity Focused</option>
        </select>
        <button id="dockBtn" disabled>Run Approximate Dock</button>
        <div class="info-box" id="modelInfoBox">
          <p><strong>About the Scoring Model:</strong></p>
          <p class="hint" id="modelInfoText"></p>
        </div>
      </div>
      <div class="panel">
        <h3>Results Breakdown</h3>
        <div class="metrics" style="margin-top:10px">
          <div class="metric"><div>Total ΔG</div><div id="aff" class="v">--</div></div>
          <div class="metric"><div>Ligand MW</div><div id="mw" class="v">--</div></div>
          <div class="metric"><div>Ligand LogP</div><div id="logp" class="v">--</div></div>
        </div>
        <div class="metrics" style="margin-top:10px">
          <div class="metric"><div class="hint">ΔG vdW</div><div id="vdw_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">ΔG H-Bond</div><div id="hbond_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">ΔG Hydrophobic</div><div id="hydro_contrib" class="v">--</div></div>
          <div class="metric"><div class="hint">ΔS Rotational</div><div id="rot_contrib" class="v">--</div></div>
        </div>
      </div>
      <div class="panel" style="grid-column:1/-1">
        <h3>3D Visualization</h3>
        <div id="viewer"></div>
      </div>
      <div class="panel log">
        <div class="row" style="align-items:center;justify-content:space-between">
          <h3>Docking Log</h3><button class="tab" id="exportLog" style="width:auto">Export CSV</button>
        </div>
        <div class="wrap">
          <table>
            <thead><tr><th>Timestamp</th><th>Protein</th><th>SMILES</th><th>Model</th><th>ΔG (kcal/mol)</th><th>MW</th><th>LogP</th></tr></thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- MD Simulation Setup Module -->
  <section id="mdsetup" class="section">
    <div class="grid">
      <div class="panel">
        <h3>MD Simulation File Generator</h3>
        <label>Output Prefix</label><input id="md-out" value="output"/>
        <div class="row">
          <div class="col"><label>Temperature (K)</label><input id="md-temp" type="number" value="310"/></div>
          <div class="col"><label>Production Time (ns)</label><input id="md-ns" type="number" value="10"/></div>
        </div>
        <div class="row">
          <div class="col"><label>switch/cut/pair (Å)</label><input id="md-cuts" value="10/12/14"/></div>
          <div class="col" style="display:flex;align-items:flex-end"><label style="width:100%"><input type="checkbox" id="md-restraints" checked/> Use Restraints</label></div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="generateMDFilesBtn">Generate Files</button>
          <button id="zipBtn" disabled>Download ZIP</button>
        </div>
        <div id="fileList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px"></div>
      </div>
      <div class="panel">
        <h3>In-Browser Restraints PDB Builder</h3>
        <p class="hint">Upload a PDB; backbone atoms (N, CA, C, O) get B-factor 2.0; others 0.0.</p>
        <div class="row">
          <div class="col"><label>Source PDB</label><input type="file" id="md-pdb" accept=".pdb"/></div>
          <div class="col" style="display:flex;align-items:end"><button id="buildRestraints">Generate restraints.pdb</button></div>
        </div>
        <div id="restraintsStatus" class="hint" style="margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- Publications Module -->
  <section id="pub" class="section">
    <div class="pub-form">
      <h3>Create New Publication</h3>
      <label>Title</label><input id="pub-title" placeholder="e.g., In Silico Analysis of Novel Kinase Inhibitors"/>
      <label>Authors</label><input id="pub-authors" placeholder="Ferguson, D., et al."/>
      <label>Abstract / Key Findings</label><textarea id="pub-abstract" rows="6"></textarea>
      <div class="row" style="margin-top:8px"><button id="pubSubmit">Submit Publication</button></div>
    </div>
    <div id="pub-list" style="margin-top:18px;display:grid;gap:12px"></div>
  </section>

  <!-- Learning Center Module -->
  <section id="learn" class="section">
    <div class="tutorial">
      <h3>Learning Center</h3>
      <p>Choose a topic to view a short tutorial.</p>
      <div class="row" style="margin:8px 0">
        <button class="tab" style="width:auto" data-learn="pbpk">PBPK Basics</button>
        <button class="tab" style="width:auto" data-learn="docking">Docking</button>
        <button class="tab" style="width:auto" data-learn="md">MD Setup</button>
      </div>
      <div id="tutorialBox" class="panel" style="margin-top:10px"></div>
    </div>
  </section>
</div>

<script>
  // ===== UTILITIES & STATUS UI =====
  const $ = (sel) => document.querySelector(sel);
  const statusEl = () => document.getElementById('status');
  function showStatus(msg, ok=false) {
    const el = statusEl();
    el.classList.toggle('ok', !!ok);
    el.style.display = 'block';
    el.textContent = msg;
    console[ok ? 'log' : 'error']('[status]', msg);
  }
  function hideStatus(){ const el=statusEl(); el.style.display='none'; el.textContent=''; el.classList.remove('ok'); }

  function hexToRgba(hex, alpha) {
    const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    if (!m) return hex;
    const r = parseInt(m[1],16), g=parseInt(m[2],16), b=parseInt(m[3],16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  async function waitFor(testFn, {timeoutMs=12000, intervalMs=80}={}) {
    const t0 = Date.now();
    return new Promise((resolve, reject) => {
      const tick = () => {
        try {
          if (testFn()) return resolve(true);
        } catch(_) {}
        if (Date.now()-t0 > timeoutMs) return reject(new Error('timeout'));
        setTimeout(tick, intervalMs);
      };
      tick();
    });
  }

  // ===== GLOBAL STATE =====
  let rdkit, viewer;
  const charts = {};
  const dockingLog = [];
  let generatedMDFiles = {};
  let lastDockPosesPDBQT = '';

  document.addEventListener('DOMContentLoaded', initApp);

  async function initApp(){
    try {
      setupNavigation();
      setupEventListeners();
      buildCharts();
      loadPubs();
      updateModelInfo();
      activate('md');

      // Self-test libraries
      const missing = [];
      if (typeof window.$3Dmol === 'undefined') missing.push('3Dmol.js');
      if (typeof window.Chart === 'undefined') missing.push('Chart.js');
      if (typeof window.JSZip === 'undefined') missing.push('JSZip');
      if (typeof window.initRDKitModule === 'undefined') missing.push('RDKit_minimal (init function)');
      if (missing.length) {
        showStatus(`Libraries not ready: ${missing.join(', ')}. If this persists, your network or CSP is blocking CDNs.`, false);
      } else {
        showStatus('Libraries loaded. Initializing RDKit…', true);
      }

      // Initialize RDKit when the init function is actually present
      await waitFor(() => typeof window.initRDKitModule === 'function')
        .catch(() => { throw new Error('RDKit_minimal.js did not expose initRDKitModule'); });

      try {
        const RDKit = await window.initRDKitModule();
        rdkit = RDKit;
        document.getElementById('dockBtn').disabled = false;
        showStatus('RDKit initialized. Docking ready.', true);
      } catch (e) {
        showStatus('Failed to initialize RDKit (WASM). Docking disabled.', false);
        console.error(e);
      }

    } catch (err) {
      showStatus(`Startup error: ${err.message}`, false);
      console.error(err);
    }
  }

  function setupNavigation() {
    document.querySelectorAll('.tab[data-t]').forEach(t => {
      t.addEventListener('click', () => activate(t.dataset.t));
    });
  }

  function setupEventListeners() {
    document.getElementById('dockBtn').addEventListener('click', runApproximation);
    document.getElementById('exportLog').addEventListener('click', exportCSV);
    document.getElementById('buildRestraints').addEventListener('click', buildRestraintsFile);
    document.getElementById('zipBtn').addEventListener('click', downloadMDFiles);
    document.getElementById('pubSubmit').addEventListener('click', submitPub);
    document.getElementById('scoringModel').addEventListener('change', updateModelInfo);
    document.getElementById('runPBPKBtn').addEventListener('click', runPBPK);
    document.getElementById('runTrialBtn').addEventListener('click', runTrial);
    document.getElementById('generateMDFilesBtn').addEventListener('click', generateMDFiles);
    document.querySelectorAll('button[data-learn]').forEach(btn => {
      btn.addEventListener('click', () => loadTutorial(btn.dataset.learn));
    });
    document.getElementById('exampleSmiles').addEventListener('change', (e) => {
      document.getElementById('smiles').value = e.target.value;
    });
  }

  // ===== UI HELPERS =====
  function activate(tabId) {
    document.querySelectorAll('.tab[data-t]').forEach(t => t.classList.toggle('active', t.dataset.t === tabId));
    document.querySelectorAll('.section').forEach(s => s.classList.toggle('active', s.id === tabId));
  }
  function showLoading(msg='Processing…'){ document.getElementById('loadingText').textContent = msg; document.getElementById('loading').style.display='flex'; }
  function hideLoading(){ document.getElementById('loading').style.display='none'; }

  // ===== CHARTING =====
  function buildCharts() {
    if (typeof Chart === 'undefined') return;
    charts.pk = new Chart(document.getElementById('pkChart'), { type:'line', options:{ responsive:true, maintainAspectRatio:false } });
    charts.occ = new Chart(document.getElementById('occChart'), { type:'line', options:{ responsive:true, maintainAspectRatio:false } });
    charts.trial = new Chart(document.getElementById('trialChart'), { type:'scatter', options:{ responsive:true, maintainAspectRatio:false } });
  }

  function updateChart(chart, label, labels, data, color='#2a5298') {
    if (!chart) return;
    chart.data = {
      labels,
      datasets: [{
        label,
        data,
        borderColor: color,
        backgroundColor: hexToRgba(color, 0.35),
        pointRadius: 0,
        tension: 0.1
      }]
    };
    chart.update();
  }

  function updateScatterChart(chart, datasets) {
    if (!chart) return;
    chart.data.datasets = datasets.map(ds => ({
      ...ds,
      pointRadius: 3
    }));
    chart.update();
  }

  // ===== PBPK =====
  function runPBPK() {
    if (!charts.pk || !charts.occ) { showStatus('Charts not ready (Chart.js).', false); return; }
    const D = +document.getElementById('dose').value || 100;
    const Fv = (+document.getElementById('F').value || 80) / 100;
    const kaVal = +document.getElementById('ka').value || 1.2;
    const keVal = +document.getElementById('ke').value || 0.2;
    const V = +document.getElementById('Vd').value || 50;
    if (Math.abs(kaVal - keVal) < 1e-9) { alert('ka and ke cannot be equal.'); return; }

    const times = [], conc = [];
    for (let t=0; t<=48; t++) {
      times.push(t);
      const c = (Fv * D * kaVal / (V * (kaVal - keVal))) * (Math.exp(-keVal * t) - Math.exp(-kaVal * t));
      conc.push(Math.max(0, c));
    }
    const occ = conc.map(c => 100 * c / (20 + c));
    updateChart(charts.pk, 'Plasma (mg/L)', times, conc);
    updateChart(charts.occ, 'Target Occupancy (%)', times, occ, '#e67e22');
  }

  // ===== CLINICAL =====
  function runTrial() {
    if (!charts.trial) { showStatus('Charts not ready (Chart.js).', false); return; }
    const L = +document.getElementById('levels').value || 6;
    const C = +document.getElementById('cohort').value || 3;
    const S = +document.getElementById('startDose').value || 10;
    const T = (+document.getElementById('tox').value || 25) / 100;

    const doses = Array.from({ length:L }, (_,i) => S * Math.pow(1.5, i));
    const trueToxProbs = doses.map((_, i) => 0.05 + 0.4 * (i / (L - 1)));

    const noDLT=[], DLT=[];
    let pt=0, idx=0;
    while (idx < L) {
      let dltCount=0;
      for (let i=0;i<C;i++){
        pt++;
        const hasDLT = Math.random() < trueToxProbs[idx];
        (hasDLT ? DLT : noDLT).push({ x: pt, y: doses[idx] });
        if (hasDLT) dltCount++;
      }
      if (dltCount / C > T) break;
      idx++;
    }
    updateScatterChart(charts.trial, [
      { label:'No DLT', data:noDLT, backgroundColor:'#2ecc71' },
      { label:'DLT', data:DLT, backgroundColor:'#e74c3c' }
    ]);
  }

  // ===== DOCKING (HEURISTIC) =====
  async function runApproximation() {
    if (!rdkit) { alert('RDKit not initialized. Check status bar.'); return; }
    if (typeof $3Dmol === 'undefined') { alert('3Dmol.js not loaded; 3D view unavailable.'); return; }

    const file = document.getElementById('pdbFile').files[0];
    const smi = (document.getElementById('smiles').value || '').trim();
    const modelType = document.getElementById('scoringModel').value;
    if (!file || !smi) { alert('Provide PDB and SMILES.'); return; }

    showLoading('Analyzing molecules & approximating dock…');
    try {
      const ligInfo = processLigandSafe(smi);
      if (!ligInfo) throw new Error('Invalid SMILES or RDKit error.');

      document.getElementById('mw').textContent = Number(ligInfo.mw).toFixed(2);
      document.getElementById('logp').textContent = Number(ligInfo.logp).toFixed(2);

      const pdb = await file.text();
      if (!viewer) viewer = $3Dmol.createViewer(document.getElementById('viewer'), { backgroundColor:'white' });
      viewer.clear();

      const pModel = viewer.addModel(pdb, 'pdb');
      const pocketRes = findPocketHeuristic(pModel.getAtoms());

      pModel.setStyle({}, { cartoon: { color: 'spectrum' } });
      if (pocketRes.length) {
        viewer.addSurface($3Dmol.VDW, { opacity: 0.8, color: 'white' }, { resi: pocketRes });
        pModel.setStyle({ resi: pocketRes }, { stick: { radius: 0.25, colorscheme: 'cyanCarbon' } });
      }

      const ligModel = viewer.addModel(ligInfo.molblock, 'sdf');
      ligModel.setStyle({}, { stick: { radius: 0.22 } });
      if (pocketRes.length) viewer.zoomTo({ resi: pocketRes }); else viewer.zoomTo();
      viewer.render();

      const contributions = calculateBindingContributions(ligInfo, modelType);
      const totalScore = Object.values(contributions).reduce((s,v)=>s+v,0);

      document.getElementById('aff').textContent = totalScore.toFixed(2);
      document.getElementById('vdw_contrib').textContent = contributions.vdw.toFixed(2);
      document.getElementById('hbond_contrib').textContent = contributions.hbond.toFixed(2);
      document.getElementById('hydro_contrib').textContent = contributions.hydrophobic.toFixed(2);
      document.getElementById('rot_contrib').textContent = contributions.rotational.toFixed(2);

      appendLog({ protein:file.name, smiles:smi, model:modelType, score:totalScore, mw:ligInfo.mw, logp:ligInfo.logp });
    } catch (e) {
      console.error(e);
      alert('Docking approximation failed: ' + (e?.message || 'unknown error'));
    } finally {
      hideLoading();
    }
  }

  function processLigandSafe(smi){
    let mol = null;
    try {
      mol = rdkit.get_mol(smi);
      if (!mol) return null;
      mol.add_hs?.();
      if (typeof rdkit.EmbedMolecule === 'function') {
        rdkit.EmbedMolecule(mol, JSON.stringify({ useRandomCoords:true, maxAttempts:500 }));
        rdkit.UFFOptimizeMolecule?.(mol);
      }
      const desc = JSON.parse(mol.get_descriptors());
      const out = {
        molblock: mol.get_molblock(),
        mw: desc.exactmw,
        logp: desc.MolLogP,
        hDonors: desc.NumHDonors,
        hAcceptors: desc.NumHAcceptors,
        numRotatableBonds: desc.NumRotatableBonds,
        numHeavyAtoms: typeof mol.get_n_heavy_atoms === 'function' ? mol.get_n_heavy_atoms() : (desc.NumHeavyAtoms || 0)
      };
      mol.delete?.();
      return out;
    } catch (e) {
      try { mol?.delete?.(); } catch(_) {}
      return null;
    }
  }

  function findPocketHeuristic(atoms) {
    if (!atoms || !atoms.length) return [];
    const byRes = {};
    atoms.forEach(a => { (byRes[a.resi] = byRes[a.resi] || []).push(a); });

    let bestRes = null, bestN = -1, rx=0, ry=0, rz=0;
    for (const [resi, alist] of Object.entries(byRes)) {
      rx=0; ry=0; rz=0;
      alist.forEach(a => { rx+=a.x; ry+=a.y; rz+=a.z; });
      rx/=alist.length; ry/=alist.length; rz/=alist.length;
      const n = atoms.filter(a => { const dx=a.x-rx, dy=a.y-ry, dz=a.z-rz; return (dx*dx+dy*dy+dz*dz) < 100; }).length;
      if (n > bestN) { bestN = n; bestRes = Number(resi); }
    }
    const anchor = byRes[bestRes] || [];
    rx=0; ry=0; rz=0;
    anchor.forEach(a => { rx+=a.x; ry+=a.y; rz+=a.z; });
    if (anchor.length) { rx/=anchor.length; ry/=anchor.length; rz/=anchor.length; }
    return [...new Set(atoms.filter(a => { const dx=a.x-rx, dy=a.y-ry, dz=a.z-rz; return (dx*dx+dy*dy+dz*dz) < 100; }).map(a => a.resi))];
  }

  function calculateBindingContributions(ligand, modelType='balanced') {
    const MODELS = {
      balanced:    { INTERCEPT:-1.5, VDW_PER_ATOM:-0.035, HBOND:-0.7, HYDROPHOBIC:-0.25, ROT_PENALTY:0.3 },
      hbond:       { INTERCEPT:-1.0, VDW_PER_ATOM:-0.030, HBOND:-1.2, HYDROPHOBIC:-0.15, ROT_PENALTY:0.3 },
      hydrophobic: { INTERCEPT:-1.2, VDW_PER_ATOM:-0.040, HBOND:-0.5,  HYDROPHOBIC:-0.45, ROT_PENALTY:0.25 }
    };
    const C = MODELS[modelType] || MODELS.balanced;
    const hBondTerm = Math.min(ligand.hDonors, ligand.hAcceptors);
    return {
      intercept: C.INTERCEPT,
      vdw: C.VDW_PER_ATOM * ligand.numHeavyAtoms,
      hbond: C.HBOND * hBondTerm,
      hydrophobic: C.HYDROPHOBIC * ligand.logp,
      rotational: C.ROT_PENALTY * ligand.numRotatableBonds
    };
  }

  // ===== LOG / EXPORT =====
  function appendLog({ protein, smiles, model, score, mw, logp }) {
    const row = { ts:new Date(), protein, smiles, model, score: Number(score).toFixed(2), mw: Number(mw).toFixed(2), logp: Number(logp).toFixed(2) };
    dockingLog.unshift(row);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.ts.toLocaleString()}</td><td>${escapeHtml(row.protein)}</td><td style="word-break:break-all">${escapeHtml(row.smiles)}</td><td>${escapeHtml(row.model)}</td><td>${row.score}</td><td>${row.mw}</td><td>${row.logp}</td>`;
    document.getElementById('logBody').prepend(tr);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"]/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[m])); }

  function exportCSV() {
    if (!dockingLog.length) { alert('Log is empty.'); return; }
    const header = ['Timestamp','Protein','SMILES','ScoringModel','DeltaG_kcal_per_mol','MW','LogP'];
    const lines = [header.join(',')].concat(dockingLog.map(r =>
      [r.ts.toISOString(), `"${r.protein.replaceAll('"','""')}"`, `"${r.smiles.replaceAll('"','""')}"`, r.model, r.score, r.mw, r.logp].join(',')
    ));
    const blob = new Blob([lines.join('\n')], { type:'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='pharmsim_docking_log.csv'; a.click();
  }

  // ===== WASM docking placeholders =====
  async function runWasmDock(){ alert('Provide browser-vina.js/.wasm alongside this file, then uncomment the script tag.'); }
  function downloadWasmPoses(){
    if (!lastDockPosesPDBQT) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([lastDockPosesPDBQT], { type:'text/plain' }));
    a.download = 'poses.pdbqt'; a.click();
  }

  // ===== MD SETUP =====
  function generateMDFiles() {
    const p = { out: $('#md-out').value || 'output', T: +$('#md-temp').value || 310, ns: +$('#md-ns').value || 10, cuts: ($('#md-cuts').value || '10/12/14').split(/[\/ ,]+/).map(Number), rest: $('#md-restraints').checked };
    const common =
`structure system.psf
coordinates system.pdb
set outputname ${p.out}
outputname $outputname

binaryoutput yes
parameters system.prm
exclude scaled1-4
1-4scaling 1.0
timestep 2.0
rigidBonds all
nonbondedFreq 1
fullElectFrequency 2
stepspercycle 20

switching on
switchdist ${p.cuts[0] || 10}
cutoff ${p.cuts[1] || 12}
pairlistdist ${p.cuts[2] || 14}

PME yes
PMEGridSpacing 1.0

langevin on
langevinDamping 1.0
langevinTemp ${p.T}
langevinHydrogen no
`;
    const pressure =
`
useGroupPressure yes
useFlexibleCell no
langevinPiston on
langevinPistonTarget 1.01325
langevinPistonPeriod 100
langevinPistonDecay 50
langevinPistonTemp ${p.T}
`;
    const restraints = p.rest ? `
constraints on
consRef restraints.pdb
consKFile restraints.pdb
consKCol B
constraintScaling 1.0
` : `constraints off
`;

    generatedMDFiles = {
      'min.conf': common + `minimization 10000\n`,
      'eq.conf': common + pressure + restraints + `run 250000\n`,
      'prod.conf': common + pressure + `run ${Math.round((p.ns * 1e6) / 2)}\n`,
      'README.md': `# Generic MD Simulation Files

1) md-engine min.conf > min.log
2) md-engine eq.conf > eq.log
3) md-engine prod.conf > prod.log
`
    };
    const list = document.getElementById('fileList');
    list.innerHTML='';
    Object.keys(generatedMDFiles).forEach(name => {
      const a = document.createElement('a'); a.textContent=`⬇ ${name}`;
      a.href = URL.createObjectURL(new Blob([generatedMDFiles[name]], { type:'text/plain' })); a.download=name; a.className='tab'; list.appendChild(a);
    });
    document.getElementById('zipBtn').disabled = false;
  }

  async function downloadMDFiles() {
    if (!Object.keys(generatedMDFiles).length) return;
    if (typeof JSZip === 'undefined') { alert('JSZip not loaded.'); return; }
    const zip = new JSZip();
    for (const [k,v] of Object.entries(generatedMDFiles)) zip.file(k, v);
    const blob = await zip.generateAsync({ type:'blob' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='md_simulation_project.zip'; a.click();
  }

  async function buildRestraintsFile() {
    const f = document.getElementById('md-pdb').files[0];
    if (!f) { alert('Select a PDB file first.'); return; }
    const txt = await f.text();
    const out = []; const bb = new Set(['N','CA','C','O']);
    for (const line of txt.split(/\r?\n/)) {
      if (line.startsWith('ATOM') || line.startsWith('HETATM')) {
        const beta = bb.has(line.slice(12,16).trim()) ? 2.0 : 0.0;
        out.push(line.slice(0,60) + beta.toFixed(2).padStart(6,' ') + line.slice(66));
      } else { out.push(line); }
    }
    const res = out.join('\n') + "\n";
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([res], { type:'text/plain' }));
    a.download='restraints.pdb'; a.textContent='⬇ Download restraints.pdb'; a.className='tab';
    const status = document.getElementById('restraintsStatus'); status.innerHTML=''; status.append(a);
    generatedMDFiles['restraints.pdb'] = res;
  }

  // ===== PUBS =====
  function renderPub(p, prepend=false) {
    const card = document.createElement('div'); card.className='pub-card';
    card.innerHTML = `<h4 style="margin:0 0 6px">${escapeHtml(p.title)}</h4><div style="color:#566">By ${escapeHtml(p.authors)} on ${p.date}</div><p style="margin:8px 0 0">${escapeHtml(p.abstract)}</p>`;
    const list = document.getElementById('pub-list'); prepend ? list.prepend(card) : list.append(card);
  }
  function submitPub() {
    const title = $('#pub-title').value.trim(), authors = $('#pub-authors').value.trim(), abstract = $('#pub-abstract').value.trim();
    if (!title || !authors || !abstract) { alert('Fill all fields.'); return; }
    const p = { title, authors, abstract, date: new Date().toLocaleDateString() };
    const arr = JSON.parse(localStorage.getItem('pharmsim_pubs') || '[]');
    arr.unshift(p); localStorage.setItem('pharmsim_pubs', JSON.stringify(arr));
    renderPub(p, true); $('#pub-title').value=''; $('#pub-authors').value=''; $('#pub-abstract').value='';
  }
  function loadPubs(){ (JSON.parse(localStorage.getItem('pharmsim_pubs') || '[]')).forEach(p => renderPub(p)); }

  // ===== Misc =====
  function copyText(id){ navigator.clipboard.writeText(document.getElementById(id).textContent); }
</script>
</body>
</html>
