<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Ferguson's Pharmaceutical Research Idea Platform</title>

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

  <!-- Scientific Libraries -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script defer src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <!-- Firebase (compat) -->
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    :root{--ink:#0b1630;--brand:#2a5298;--brand2:#1e3c72}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);
      background:linear-gradient(135deg,#0b1225 0%,#172144 60%,#1f2e5c 100%)}
    header{position:sticky;top:0;z-index:40}

    .glass{background:rgba(255,255,255,.92);backdrop-filter:blur(10px);box-shadow:0 10px 26px rgba(0,0,0,.12);border-radius:16px}
    .panel{padding:18px}
    .btn{background:linear-gradient(135deg,#2a5298,#1e3c72);color:#fff;font-weight:700;border-radius:10px;padding:.65rem .9rem}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-plain{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:.6rem .9rem;font-weight:600}
    .btn-ghost{background:transparent;border:1px dashed #cbd5e1;color:#0b1630;border-radius:10px;padding:.6rem .9rem;font-weight:600}
    .input,select,textarea{width:100%;padding:.65rem .8rem;border:2px solid #e5e7eb;border-radius:10px;background:#f8f9fa}
    .input:focus,select:focus,textarea:focus{outline:none;border-color:#2a5298;background:#fff;box-shadow:0 0 0 3px rgba(42,82,152,.12)}
    .chip{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .6rem;border-radius:999px;font-weight:700;font-size:.75rem}
    .chip.pos{background:#ecfdf5;color:#065f46}.chip.info{background:#eff6ff;color:#1e3a8a}.chip.warn{background:#fff7ed;color:#9a3412}.chip.err{background:#fee2e2;color:#991b1b}
    .navlink{display:inline-flex;align-items:center;justify-content:center;padding:.5rem .75rem;border-radius:.75rem;font-weight:600;background:#fff}
    .navlink[aria-current="page"]{color:#fff;background:linear-gradient(135deg,#2a5298,#1e3c72)}
    .section{display:none}.section.active{display:block}
    .feed-card{border:1px solid #e6eaf2;border-radius:16px;padding:14px;background:#fff}
    a.hash{color:#1e3c72;font-weight:600}

    .bricks{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px;align-items:start}
    .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
    .metric{background:linear-gradient(135deg,#f8f9fa,#e9eef6);border-radius:12px;padding:14px;text-align:center;min-height:92px;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .metric .v{margin-top:6px;font-size:1.2rem;font-weight:800;background:linear-gradient(135deg,#2a5298,#1e3c72);-webkit-background-clip:text;background-clip:text;color:transparent}

    #viewer{width:100%;min-height:440px;height:440px;border-radius:12px;background:#eef2f7}
    #pdbDrop{min-height:120px;max-height:160px;overflow:auto}
    @media(max-width:640px){#pdbDrop{min-height:100px;max-height:120px}}
    main{scroll-margin-top:84px}

    .player-bar{position:fixed;bottom:0;left:0;right:0;z-index:50;background:rgba(255,255,255,.95);box-shadow:0 -6px 24px rgba(0,0,0,.18);backdrop-filter:blur(6px)}
    footer .tiny{font-size:.8rem;color:#e2e8f0}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="glass">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="text-xl sm:text-2xl font-extrabold text-white">Ferguson’s Pharmaceutical Research Idea Platform</div>
        <span class="chip info">Modern Social Research</span>
      </div>
      <nav class="flex flex-wrap gap-2" role="navigation" aria-label="Primary">
        <a href="#/md"        class="navlink" data-route="md">Docking</a>
        <a href="#/pbpk"      class="navlink" data-route="pbpk">PBPK/QSP</a>
        <a href="#/clinical"  class="navlink" data-route="clinical">Clinical</a>
        <a href="#/mdsetup"   class="navlink" data-route="mdsetup">MD Setup</a>
        <a href="#/community" class="navlink" data-route="community">Community</a>
        <a href="#/channels"  class="navlink" data-route="channels">Channels</a>
        <a href="#/pub"       class="navlink" data-route="pub">Publications</a>
        <a href="#/learn"     class="navlink" data-route="learn">Learning</a>
      </nav>
      <div class="flex items-center gap-3">
        <div id="statusBadge" class="chip warn">Initializing…</div>
        <button id="profileBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Sign In</button>
      </div>
    </div>
  </header>

  <!-- Notice -->
  <div class="max-w-7xl mx-auto px-4 mt-3">
    <div class="glass panel text-sm leading-relaxed">
      <strong>Heads up:</strong> For <em>educational & research</em> use. Docking scores, PBPK/QSP and clinical sims are approximations — verify with primary data before decisions.
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 my-4">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
      <!-- Podcast rail -->
      <aside class="glass panel lg:col-span-1" aria-label="Research Podcasts">
        <h2 class="text-lg font-bold mb-2">🎧 Research Podcasts</h2>
        <p class="text-sm text-slate-600 mb-2">Play episodes while you work.</p>
        <div id="podcastList" class="flex flex-col gap-2 max-h-[520px] overflow-auto" role="list"></div>
      </aside>

      <!-- Sections -->
      <div class="lg:col-span-3">
        <!-- Docking -->
        <section id="md" class="section active" data-title="Docking">
          <div class="bricks">
            <!-- Protein -->
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">Protein (PDB)</h2>
              <div id="pdbDrop" class="w-full border-2 border-dashed border-gray-300 rounded-xl bg-white/70 p-4 text-center text-gray-600 hover:border-indigo-400 hover:bg-white transition" aria-label="PDB Dropzone">
                <div class="font-semibold">Drag & Drop PDB here</div>
                <div class="text-xs">or choose a file below</div>
              </div>
              <div class="mt-3 grid grid-cols-3 gap-2">
                <input type="file" id="pdbFile" accept=".pdb" class="col-span-2 input file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:bg-indigo-50 file:text-indigo-700" aria-label="Choose PDB File">
                <button id="loadLocalPdbBtn" class="btn w-full">Load Local PDB</button>
              </div>
              <div class="grid grid-cols-3 gap-2 mt-3">
                <input id="pdbId" placeholder="Fetch by PDB ID (e.g., 6LU7)" class="col-span-2 input">
                <button id="fetchPdbBtn" class="btn w-full">Fetch PDB</button>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-3">
                <button id="clearProteinBtn" class="btn-plain">Clear Protein</button>
                <button id="resetViewBtn" class="btn-ghost">Reset View</button>
              </div>
            </div>

            <!-- Ligand -->
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">Ligand (SMILES)</h2>
              <input id="smiles" class="input" placeholder="Paste SMILES (e.g., CC(=O)OC1=CC=CC=C1C(=O)O)">
              <div class="grid grid-cols-3 gap-2 mt-2">
                <select id="exampleSmiles" class="col-span-2 input">
                  <option value="" selected>Choose an example…</option>
                  <option value="O=P(O)(O)COC(=O)C1CCCN1C(=O)c1ccc(CNS(=O)(=O)c2ccc(C)cc2)cc1">Drug Hit 1 (Zn-Chelator)</option>
                  <option value="CC(C)NCc1ccc(S(=O)(=O)Nc2cccc(c2)C(=O)N2CCCC2C(=O)OCC)cc1">Drug Hit 2 (π-π)</option>
                  <option value="N1=C(N)N=C(C1)CCS(=O)(=O)NCc1ccc(C(=O)OCP(=O)(O)O)cc1">Drug Hit 3 (H-Bond)</option>
                  <option value="Cc1ccc(OCc2ccc(C(=O)OC[C@H]3O[C@H](O)[C@H](O)[C@@H](O)[C@@H]3CO)cc2)cc1">Drug Hit 4 (Allosteric)</option>
                  <option value="CC(C)NC(=O)C1CCN(CC1)c1cccc2OCOc12">Drug Hit 5 (Reversible)</option>
                  <option value="CC(C)CC(NC(=O)C1CCN(CC1)c1cccc2OCOc12)Cc1ccccc1">Drug Hit 6 (Irreversible)</option>
                </select>
                <button id="useExampleBtn" class="btn-plain w-full">Use Example</button>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <button id="loadSmilesBtn" class="btn w-full">Load SMILES</button>
                <button id="clearLigandBtn" class="btn-plain w-full">Clear Ligand</button>
              </div>
              <div id="smilesErr" class="text-rose-700 text-sm mt-2 hidden" role="alert"></div>
            </div>

            <!-- Scoring -->
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">Scoring & Controls</h2>
              <label class="block text-sm font-semibold mb-1">Scoring Model</label>
              <select id="scoringModel" class="input" aria-label="Scoring Model">
                <option value="balanced" selected>Balanced</option>
                <option value="hbond">H-Bond Focused</option>
                <option value="hydrophobic">Hydrophobicity Focused</option>
              </select>
              <p class="text-sm text-gray-600 mt-2" id="modelInfoText"></p>
              <div class="grid grid-cols-2 gap-2 mt-3">
                <button id="dockBtn" class="btn" disabled>Run Approximate Dock</button>
                <button id="centerBtn" class="btn" disabled>Re-center &amp; Re-score</button>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <button id="clearAllBtn" class="btn-plain">Clear All</button>
                <button id="prefillFromDock" class="btn-plain">Use Current Dock in Post</button>
              </div>
            </div>

            <!-- Viewer -->
            <div class="glass panel lg:col-span-2">
              <h2 class="text-lg font-bold mb-2">3D Visualization</h2>
              <div id="viewer" aria-label="3D Viewer"></div>
            </div>

            <!-- Summary -->
            <div class="glass panel lg:col-span-2">
              <h2 class="text-lg font-bold mb-2">Ligand / Score Summary</h2>
              <div class="metrics-grid">
                <div class="metric" aria-live="polite"><div>Total ΔG</div><div id="aff" class="v">--</div></div>
                <div class="metric"><div>Ligand MW</div><div id="mw" class="v">--</div></div>
                <div class="metric"><div>Ligand LogP</div><div id="logp" class="v">--</div></div>
              </div>
            </div>

            <!-- Contributions -->
            <div class="glass panel lg:col-span-2">
              <h2 class="text-lg font-bold mb-2">Contributions</h2>
              <div class="metrics-grid">
                <div class="metric"><div class="text-xs">ΔG vdW</div><div id="vdw_contrib" class="v">--</div></div>
                <div class="metric"><div class="text-xs">ΔG H-Bond</div><div id="hbond_contrib" class="v">--</div></div>
                <div class="metric"><div class="text-xs">ΔG Hydroph.</div><div id="hydro_contrib" class="v">--</div></div>
                <div class="metric"><div class="text-xs">ΔS Rot.</div><div id="rot_contrib" class="v">--</div></div>
                <div class="metric"><div class="text-xs">Contacts</div><div id="contacts" class="v">--</div></div>
                <div class="metric"><div class="text-xs">Clashes</div><div id="clashes" class="v">--</div></div>
              </div>
            </div>
          </div>
        </section>

        <!-- PBPK -->
        <section id="pbpk" class="section" data-title="PBPK/QSP">
          <div class="bricks">
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">PBPK/QSP (One-Compartment Oral)</h2>
              <label class="block text-sm font-semibold">Dose (mg)</label><input id="dose" type="number" value="100" class="input">
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div><label class="block text-sm font-semibold">F (%)</label><input id="F" type="number" value="80" class="input"></div>
                <div><label class="block text-sm font-semibold">ka (h⁻¹)</label><input id="ka" type="number" value="1.2" step="0.1" class="input"></div>
                <div><label class="block text-sm font-semibold">ke (h⁻¹)</label><input id="ke" type="number" value="0.2" step="0.05" class="input"></div>
                <div><label class="block text-sm font-semibold">Vd (L)</label><input id="Vd" type="number" value="50" class="input"></div>
              </div>
              <button id="runPBPKBtn" class="btn w-full mt-3">Run PBPK Simulation</button>
              <p class="text-sm text-gray-600 mt-2">Bateman function; E<sub>max</sub> occupancy with demo K<sub>d</sub>=20 mg/L.</p>
            </div>
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">PK Metrics</h2>
              <div class="metrics-grid">
                <div class="metric"><div>C<sub>max</sub></div><div id="cmax" class="v">--</div></div>
                <div class="metric"><div>T<sub>max</sub></div><div id="tmax" class="v">--</div></div>
                <div class="metric"><div>AUC<sub>0–48</sub></div><div id="auc" class="v">--</div></div>
              </div>
            </div>
            <div class="glass panel lg:col-span-2"><div class="h-72"><canvas id="pkChart"></canvas></div></div>
            <div class="glass panel lg:col-span-2"><div class="h-56"><canvas id="occChart"></canvas></div></div>
          </div>
        </section>

        <!-- Clinical -->
        <section id="clinical" class="section" data-title="Clinical">
          <div class="bricks">
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">3+3 Dose Escalation Simulator</h2>
              <div class="grid grid-cols-2 gap-2">
                <div><label class="block text-sm font-semibold">Dose Levels</label><input id="levels" type="number" value="6" class="input"></div>
                <div><label class="block text-sm font-semibold">Cohort Size</label><input id="cohort" type="number" value="3" class="input"></div>
                <div><label class="block text-sm font-semibold">Start Dose (mg)</label><input id="startDose" type="number" value="10" class="input"></div>
                <div><label class="block text-sm font-semibold">Target DLT Rate (%)</label><input id="tox" type="number" value="25" class="input"></div>
                <div><label class="block text-sm font-semibold">Escalation Factor</label><input id="esc" type="number" value="1.5" step="0.1" class="input"></div>
                <div><label class="block text-sm font-semibold">Random Seed</label><input id="seed" type="number" value="42" class="input"></div>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-3">
                <button id="runTrialBtn" class="btn w-full">Simulate Trial</button>
                <button id="run100Btn" class="btn w-full">Run 100 Trials</button>
              </div>
              <p class="text-sm text-gray-600 mt-2">0/3 → escalate; 1/3 → expand; ≥2/3 → stop/de-escalate. MTD = highest with ≤1/6 DLTs.</p>
            </div>
            <div class="glass panel lg:col-span-2">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold mb-1">Trial Visualization</h3>
                <div id="trialBadge" class="chip hidden"></div>
              </div>
              <div class="h-72"><canvas id="trialChart"></canvas></div>
              <div class="glass panel mt-3">
                <h4 class="font-semibold mb-2">Cohorts</h4>
                <table class="w-full text-sm">
                  <thead><tr class="text-left text-gray-600"><th class="py-1">#</th><th>Dose (mg)</th><th>DLTs</th><th>N</th></tr></thead>
                  <tbody id="trialTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </section>

        <!-- MD Setup -->
        <section id="mdsetup" class="section" data-title="MD Setup">
          <div class="bricks">
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">MD Simulation File Generator</h2>
              <label class="block text-sm font-semibold">Output Prefix</label><input id="md-out" value="output" class="input"/>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div><label class="block text-sm font-semibold">Temperature (K)</label><input id="md-temp" type="number" value="310" class="input"/></div>
                <div><label class="block text-sm font-semibold">Production Time (ns)</label><input id="md-ns" type="number" value="10" class="input"/></div>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div><label class="block text-sm font-semibold">switch/cut/pair (Å)</label><input id="md-cuts" value="10/12/14" class="input"/></div>
                <div class="flex items-end gap-2"><input type="checkbox" id="md-restraints" checked class="w-5 h-5"/><label for="md-restraints" class="text-sm">Use Restraints</label></div>
              </div>
              <div class="grid grid-cols-2 gap-2 mt-3">
                <button id="generateMDFilesBtn" class="btn w-full">Generate Files</button>
                <button id="zipBtn" class="btn w-full" disabled>Download ZIP</button>
              </div>
              <div id="mdStatus" class="text-sm text-gray-600 mt-2"></div>
              <div id="fileList" class="mt-3 flex flex-col gap-2"></div>
            </div>

            <div class="glass panel">
              <h3 class="font-semibold mb-1">In-Browser Restraints PDB Builder</h3>
              <p class="text-sm text-gray-600">Backbone (N, CA, C, O) → B-factor 2.0; others 0.0.</p>
              <div class="grid grid-cols-3 gap-2 mt-2">
                <div class="col-span-2"><input type="file" id="md-pdb" accept=".pdb" class="input"/></div>
                <div class="flex items-end"><button id="buildRestraints" class="btn w-full">Generate</button></div>
              </div>
              <div id="restraintsStatus" class="text-sm text-gray-700 mt-3"></div>
            </div>
          </div>
        </section>

        <!-- Community -->
        <section id="community" class="section" data-title="Community">
          <div class="bricks">
            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">Create a Post</h2>
              <div class="grid gap-2">
                <div>
                  <label class="block text-sm font-semibold">Post Type</label>
                  <select id="postType" class="input">
                    <option value="dock" selected>Docking Result</option>
                    <option value="blog">Blog</option>
                    <option value="discussion">Discussion</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-semibold">Protein (Channel)</label>
                  <input id="postProtein" placeholder="e.g., Mpro (SARS-CoV-2)" class="input">
                  <p class="text-xs text-gray-600 mt-1">If the channel doesn’t exist it will be created.</p>
                </div>
                <div class="dock-only grid gap-2">
                  <div><label class="block text-sm font-semibold">PDB ID (optional)</label><input id="postPdbId" placeholder="e.g., 6LU7" class="input"></div>
                  <div><label class="block text-sm font-semibold">Ligand (SMILES)</label><input id="postSmiles" placeholder="Paste SMILES" class="input"></div>
                  <div class="grid grid-cols-2 gap-2">
                    <div><label class="block text-sm font-semibold">Docking ΔG (kcal/mol)</label><input id="postDG" type="number" step="0.01" class="input"></div>
                    <div>
                      <label class="block text-sm font-semibold">Mood / Framing</label>
                      <select id="postMood" class="input">
                        <option>Inspired ✨</option><option>Constructive: Needs validation</option>
                        <option>Encouraging 👍</option><option>Curious 🤔</option>
                        <option>Grateful 🙏</option><option>Optimistic 🌱</option>
                      </select>
                    </div>
                  </div>
                  <div><label class="block text-sm font-semibold">Notes (optional)</label><textarea id="postNotes" rows="3" class="input" placeholder="Key interactions, pocket features, next steps…"></textarea></div>
                  <div class="grid grid-cols-2 gap-2">
                    <button id="prefillFromDock" class="btn-plain">Use Current Dock</button>
                    <button id="createPostBtn" class="btn">Post</button>
                  </div>
                </div>

                <div class="non-dock-only hidden grid gap-2">
                  <div><label class="block text-sm font-semibold">Title</label><input id="postTitle" class="input" placeholder="Write a clear title"></div>
                  <div><label class="block text-sm font-semibold">Content</label><textarea id="postContent" rows="6" class="input" placeholder="Educational content, blog, or discussion…"></textarea></div>
                  <div class="grid grid-cols-2 gap-2">
                    <button id="createNonDockBtn" class="btn">Publish</button>
                    <button id="clearNonDockBtn" class="btn-plain">Clear</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="glass panel">
              <h2 class="text-lg font-bold mb-2">Community Feed</h2>
              <div class="flex items-center gap-2 w-full flex-wrap mb-2">
                <input id="searchInput" placeholder="Search by protein or SMILES…" class="input md:w-80" aria-label="Search posts">
                <select id="alphaFilter" class="input md:w-32" aria-label="A–Z Filter">
                  <option value="">All A–Z</option><option value="#num"># (0–9)</option>
                  <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
                  <option>F</option><option>G</option><option>H</option><option>I</option><option>J</option>
                  <option>K</option><option>L</option><option>M</option><option>N</option><option>O</option>
                  <option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option>
                  <option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option>
                </select>
                <button id="exportJsonBtn" class="btn-plain">Export DB (JSON)</button>
                <button id="exportCsvBtn" class="btn-plain">Export Posts (CSV)</button>
              </div>
              <div id="feedGrid" class="bricks"></div>
              <div id="emptyFeed" class="text-center text-sm text-white/90 mt-6 hidden">No posts yet — share your first result.</div>
            </div>
          </div>
        </section>

        <!-- Channels -->
        <section id="channels" class="section" data-title="Channels">
          <div class="bricks">
            <div class="glass panel lg:col-span-2">
              <div class="flex items-center justify-between flex-wrap gap-2">
                <h2 class="text-lg font-bold">Protein Channels</h2>
                <input id="channelSearch" placeholder="Search channels…" class="input md:w-80">
              </div>
              <div id="channelList" class="bricks mt-3"></div>
              <div id="channelEmpty" class="text-white/90 text-sm mt-6 hidden">No channels yet. Create a docking post to start a channel.</div>
            </div>

            <div id="channelView" class="glass panel lg:col-span-2 hidden">
              <div class="flex items-center justify-between">
                <div>
                  <h3 id="chName" class="text-lg font-bold"></h3>
                  <div id="chMeta" class="text-sm text-gray-600"></div>
                </div>
                <a id="chHash" class="hash" href="#">Link</a>
              </div>

              <h4 class="font-semibold mt-4 mb-2">Docking Entries</h4>
              <div class="overflow-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left text-gray-600"><th class="py-1">Date</th><th>PDB</th><th>SMILES</th><th>ΔG</th><th>User</th></tr>
                  </thead>
                  <tbody id="chTable"></tbody>
                </table>
              </div>

              <h4 class="font-semibold mt-5 mb-2">Recent Posts</h4>
              <div id="chFeed" class="bricks"></div>
            </div>
          </div>
        </section>

        <!-- Publications -->
        <section id="pub" class="section" data-title="Publications">
          <div class="bricks">
            <div class="glass panel">
              <h3 class="font-semibold mb-2">Create New Entry</h3>
              <label class="block text-sm font-semibold">Title</label><input id="pub-title" class="input" placeholder="In Silico Analysis of…">
              <label class="block text-sm font-semibold mt-2">Authors</label><input id="pub-authors" class="input" placeholder="Ferguson, D., et al.">
              <label class="block text-sm font-semibold mt-2">Abstract / Key Findings</label><textarea id="pub-abstract" rows="5" class="input"></textarea>
              <button id="pubSubmit" class="btn w-full mt-3">Submit</button>
              <div id="pubError" class="text-sm text-rose-700 mt-2"></div>
            </div>
            <div class="glass panel lg:col-span-2">
              <h3 class="font-semibold mb-2">Publications</h3>
              <div id="pub-list" class="bricks"></div>
              <div id="pub-empty" class="glass panel text-center hidden">No publications yet.</div>
            </div>
          </div>
        </section>

        <!-- Learning -->
        <section id="learn" class="section" data-title="Learning">
          <div class="bricks">
            <div class="glass panel lg:col-span-2">
              <h2 class="text-lg font-bold mb-2">Learning Center</h2>
              <div class="flex flex-wrap gap-2">
                <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="pbpk">PBPK Basics</button>
                <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="docking">Docking</button>
                <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="md">MD Setup</button>
                <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="threeplus">3+3 Design</button>
                <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="community">Community Etiquette</button>
              </div>
              <div id="tutorialBox" class="glass panel mt-3 bg-white/70"></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Podcast player -->
  <div class="player-bar" role="region" aria-label="Podcast Player">
    <div class="max-w-7xl mx-auto px-4 py-2 flex items-center gap-3">
      <div class="min-w-0 flex-1">
        <div class="text-sm font-semibold truncate" id="npTitle">Now Playing: —</div>
        <div class="text-xs text-slate-600 truncate" id="npMeta">Select an episode to start listening</div>
      </div>
      <audio id="audioPlayer" controls preload="none" class="w-full md:w-[480px]" aria-label="Audio Player"></audio>
    </div>
  </div>

  <!-- Footer -->
  <footer class="max-w-7xl mx-auto px-4 my-20">
    <div class="text-center tiny">
      <div><strong>By Mr. David Ferguson, MS, PharmD Candidate, RSci MRSB MRSC</strong></div>
      <div>Powered by Gemini, Anthropic AI and Open AI.</div>
      <div class="mt-2 opacity-80">Disclaimer: This platform is for educational & research use. Always double-check results with primary literature and experimental validation before clinical or business decisions.</div>
    </div>
  </footer>

  <!-- ========================= APP SCRIPT ========================= -->
  <script>
  /* ========= FIREBASE CONFIG: PharmSimFergPro (live) ========= */
  window.FIREBASE_CONFIG = {
    apiKey: "AIzaSyC0jQFJKMSnPyjW0uiiW1E9EV-ww9zw-0w",
    authDomain: "pharmsimfergpro.firebaseapp.com",
    projectId: "pharmsimfergpro",
    storageBucket: "pharmsimfergpro.firebasestorage.app",
    messagingSenderId: "228496856805",
    appId: "1:228496856805:web:07d0ae011906837c6ae60c",
    measurementId: "G-2V7XMZ2ZXW"
  };
  /* ============================================================ */

  /* ---------- Utils ---------- */
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const on=(s,ev,fn)=>{const el=$(s); if(el) el.addEventListener(ev,fn,{passive:true});};
  const statusBadge=()=>$('#statusBadge');
  const setStatus=(msg,kind='info')=>{const b=statusBadge(); if(!b) return; b.textContent=msg; b.className='chip '+(kind==='ok'?'pos':kind);};
  const sleep=ms=>new Promise(r=>setTimeout(r,ms));
  const trapz=(x,y)=>{let A=0;for(let i=1;i<x.length;i++)A+=0.5*(y[i]+y[i-1])*(x[i]-x[i-1]);return A};
  const persist=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const recall=(k,def=null)=>{try{const v=localStorage.getItem(k); return v?JSON.parse(v):def;}catch{return def;}};
  const slugify=s=>s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  /* ---------- Router ---------- */
  const ROUTES={md:'md',pbpk:'pbpk',clinical:'clinical',mdsetup:'mdsetup',community:'community',channels:'channels',pub:'pub',learn:'learn'};
  const setActiveNav=key=>$$('.navlink').forEach(a=>a.getAttribute('data-route')===key?a.setAttribute('aria-current','page'):a.removeAttribute('aria-current'));
  const showSectionById=id=>{$$('.section').forEach(s=>s.classList.remove('active')); const sec=$('#'+id); if(sec){sec.classList.add('active'); document.title='Ferguson’s Platform · '+(sec.dataset.title||''); persist('last_section',id);}}
  const navigateFromHash=()=>{
    const h=location.hash||('#/'+(recall('last_section','md'))); const pm=h.match(/^#\/p\/(.+)/);
    if(pm){ openChannelBySlug(pm[1]); setActiveNav('channels'); return; }
    const m=h.match(/^#\/([^/?#]+)/); const key=m?m[1]:'md'; showSectionById(ROUTES[key]||'md'); setActiveNav(key);
  };
  window.addEventListener('hashchange',navigateFromHash);

  /* ---------- App State ---------- */
  let RDKitModule=null, viewer=null, proteinModel=null, ligandModel=null, currentLigandProps=null, pdbFileFromDrop=null;
  const charts={}; const chartMake=(id,cfg)=>{ try{ charts[id]?.destroy?.(); }catch{} const ctx=document.getElementById(id)?.getContext('2d'); if(!ctx) return null; charts[id]=new Chart(ctx,{...cfg,options:{responsive:true,maintainAspectRatio:false,animation:false,interaction:{mode:'nearest',intersect:false},plugins:{legend:{display:true}},...cfg.options}}); return charts[id];};
  const latestDock={proteinName:'',pdbId:'',smiles:'',dG:null};
  const metricIds=['mw','logp','aff','vdw_contrib','hbond_contrib','hydro_contrib','rot_contrib','contacts','clashes'];
  const resetMetrics=()=>metricIds.forEach(id=>{const el=$('#'+id); if(el) el.textContent='--';});
  const toggleBtn=(id,on)=>{const b=$('#'+id); if(b) b.disabled=!on;};

  /* ---------- Viewer ---------- */
  const ensureViewer=()=> viewer || (viewer=$3Dmol.createViewer('viewer',{backgroundColor:'#eef2f7'}));
  const safeRemoveModel=m=>{try{m && viewer.removeModel(m);}catch{}};
  const refreshButtons=()=> {
    const hasP=!!proteinModel, hasL=!!ligandModel;
    toggleBtn('dockBtn',hasP&&hasL);
    toggleBtn('centerBtn',hasP||hasL);
    toggleBtn('clearProteinBtn',hasP);
    toggleBtn('clearLigandBtn',hasL);
    toggleBtn('clearAllBtn',hasP||hasL);
    toggleBtn('resetViewBtn',hasP||hasL);
  };
  const addProteinFromPDB=txt=>{ensureViewer(); safeRemoveModel(proteinModel); proteinModel=viewer.addModel(txt,'pdb'); proteinModel.setStyle({hetflag:false},{cartoon:{color:'spectrum'}}); viewer.zoomTo(); viewer.render(); setStatus('Protein loaded.','ok'); refreshButtons();};
  const addLigandFromMolblock=mb=>{ensureViewer(); safeRemoveModel(ligandModel); ligandModel=viewer.addModel(mb,'sdf'); ligandModel.setStyle({}, {stick:{radius:0.22}}); viewer.zoomTo(); viewer.render(); setStatus('Ligand loaded.','ok'); refreshButtons();};
  const resetView=()=>{ensureViewer(); viewer.zoomTo(); viewer.render();};
  const clearProtein=()=>{if(!viewer||!proteinModel) return; safeRemoveModel(proteinModel); proteinModel=null; setStatus('Protein cleared.','info'); refreshButtons();};
  const clearLigand=()=>{if(!viewer||!ligandModel) return; safeRemoveModel(ligandModel); ligandModel=null; currentLigandProps=null; resetMetrics(); setStatus('Ligand cleared.','info'); refreshButtons();};
  const clearAll=()=>{clearLigand(); clearProtein(); resetView(); setStatus('Cleared all.','info');};

  /* ---------- PDB load ---------- */
  const wirePdbDropZone=()=>{
    const dz=$('#pdbDrop'); if(!dz) return;
    ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('ring-2','ring-indigo-400');}));
    ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('ring-2','ring-indigo-400');}));
    dz.addEventListener('drop',async e=>{
      const f=e.dataTransfer?.files?.[0];
      if(f?.name?.toLowerCase().endsWith('.pdb')){ pdbFileFromDrop=f; dz.innerHTML=`<div class="font-semibold text-indigo-700">Ready: ${f.name}</div><div class="text-xs text-gray-600">Click “Load Local PDB”</div>`; }
      else { dz.innerHTML=`<div class="font-semibold text-rose-700">Not a .pdb</div><div class="text-xs text-gray-600">Drop a valid PDB</div>`; }
    });
  };
  const loadLocalPdb=async()=>{
    const file=pdbFileFromDrop||$('#pdbFile')?.files?.[0]; if(!file){alert('Choose or drop a .pdb file first.');return;}
    const txt=await file.text(); addProteinFromPDB(txt); pdbFileFromDrop=null; $('#pdbDrop').innerHTML=`<div class="font-semibold text-green-700">Loaded: ${file.name}</div><div class="text-xs text-gray-600">Drop a new file to replace it.</div>`;
    latestDock.proteinName=file.name.replace(/\.pdb$/i,''); latestDock.pdbId=''; persist('last_pdb_name',latestDock.proteinName);
  };
  const fetchPdb=async()=>{
    const id=$('#pdbId').value.trim().toUpperCase(); if(!id) return;
    toggleBtn('fetchPdbBtn',false); setStatus(`Fetching PDB ${id}…`,'info');
    try{
      const r=await fetch(`https://files.rcsb.org/download/${id}.pdb`,{cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const txt=await r.text();
      addProteinFromPDB(txt); latestDock.proteinName=id; latestDock.pdbId=id; persist('last_pdb_id',id);
    }catch(e){ console.error(e); setStatus('PDB fetch failed.','err'); alert('Could not fetch PDB. Check ID or network.'); }
    finally{ toggleBtn('fetchPdbBtn',true); }
  };

  /* ---------- RDKit ---------- */
  const RD_BASE='https://unpkg.com/@rdkit/rdkit/dist/';
  const initRDKit=async()=>{ RDKitModule = await initRDKitModule({locateFile:file=>RD_BASE+file}); setStatus('Libraries ready. RDKit initialized.','ok'); };
  const processSmilesString=async(smiles)=>{
    $('#smilesErr').classList.add('hidden'); $('#smilesErr').textContent='';
    safeRemoveModel(ligandModel); ligandModel=null; currentLigandProps=null; resetMetrics(); toggleBtn('dockBtn',!!proteinModel);
    smiles=(smiles||'').trim(); if(!smiles){ setStatus('Enter a SMILES string.','warn'); return; }
    if(!RDKitModule){ setStatus('RDKit not ready yet.','warn'); return; }
    persist('last_smiles',smiles);

    toggleBtn('loadSmilesBtn',false);
    let mol=null;
    try{
      mol=RDKitModule.get_mol(smiles); if(!mol){ throw new Error('RDKit could not parse SMILES'); }
      const raw=mol.get_descriptors()||'{}'; let d={}; try{d=JSON.parse(raw);}catch{}
      const toNum=v=>(typeof v==='number'&&isFinite(v))?v:null;
      const props={
        numHeavyAtoms: toNum(d.NumHeavyAtoms)??25,
        hDonors: toNum(d.NumHDonors)??0,
        hAcceptors: toNum(d.NumHAcceptors)??0,
        logp: toNum(d.MolLogP??d.CalcLogP)??2.0,
        numRotatableBonds: toNum(d.NumRotatableBonds)??0
      };
      currentLigandProps=props;
      if(d.exactmw) $('#mw').textContent=d.exactmw.toFixed(2);
      if(isFinite(props.logp)) $('#logp').textContent=props.logp.toFixed(2);

      let molblock=''; try{ mol.add_hs(); const ok=mol.embed_molecule(); mol.remove_hs(); molblock=mol.get_molblock(); setStatus(ok===0?'SMILES loaded & embedded.':'SMILES loaded (fallback).', ok===0?'ok':'warn'); }catch(e){ try{mol.remove_hs();}catch{} molblock=mol.get_molblock(); setStatus('SMILES loaded (no 3D conformer).','warn'); }
      addLigandFromMolblock(molblock); latestDock.smiles=smiles;
      toggleBtn('dockBtn',!!proteinModel);
    }catch(e){
      console.error('RDKit error:',e);
      const box=$('#smilesErr'); box.textContent='RDKit error while processing SMILES. Please check the string or try an example.'; box.classList.remove('hidden');
      setStatus('SMILES processing failed.','err');
    }finally{ try{mol?.delete?.();}catch{} toggleBtn('loadSmilesBtn',true); }
  };
  const runDock=()=>{
    if(!proteinModel||!ligandModel){ alert('Load a protein and a ligand first.'); return; }
    const atoms=m=>{try{if(m?.selectedAtoms) return m.selectedAtoms({}); if(m?.getAtoms) return m.getAtoms(); if(Array.isArray(m?.atoms)) return m.atoms;}catch{} return [];}
    const ligProps=currentLigandProps || (()=>{ const A=atoms(ligandModel); if(!A.length) return null; const heavy=A.filter(a=>a.elem!=='H').length; const nC=A.filter(a=>a.elem==='C').length; const het=A.filter(a=>a.elem!=='H'&&a.elem!=='C').length; const donors=A.filter(a=>a.elem==='N'||a.elem==='O').length; const accept=donors; const logp=Math.max(-2,Math.min(6,0.54*nC-1.5*het)); const rot=Math.round(0.3*heavy); return {numHeavyAtoms:heavy,hDonors:donors,hAcceptors:accept,logp, numRotatableBonds:Math.max(0,rot)}; })();
    if(!ligProps){ alert('Could not derive ligand descriptors. Try another SMILES.'); return; }
    const M={balanced:{I:-1.5,V:-0.035,H:-0.70,Hy:-0.25,R:0.30},hbond:{I:-1.0,V:-0.030,H:-1.20,Hy:-0.15,R:0.30},hydrophobic:{I:-1.2,V:-0.040,H:-0.50,Hy:-0.45,R:0.25}}[$('#scoringModel')?.value||'balanced'];
    const hb=Math.min(ligProps.hDonors,ligProps.hAcceptors); const base={vdw:M.V*ligProps.numHeavyAtoms,hbond:M.H*hb,hydrophobic:M.Hy*ligProps.logp,rotational:M.R*ligProps.numRotatableBonds};
    const prot=atoms(proteinModel), lig=atoms(ligandModel); const hetSet=new Set(['N','O','S']); let contacts=0,clashes=0;
    for(const la of lig){ for(const pa of prot){ const dx=la.x-pa.x,dy=la.y-pa.y,dz=la.z-pa.z,r2=dx*dx+dy*dy+dz*dz; if(r2<12.25 && hetSet.has(pa.elem)) contacts++; if(r2<3.24) clashes++; } }
    const total=(M.I+base.vdw+base.hbond+base.hydrophobic+base.rotational)+(-0.15*Math.min(contacts,50))+(0.4*Math.min(clashes,25));
    const set=(id,v)=>{$('#'+id).textContent=v}; set('aff',total.toFixed(2)); set('vdw_contrib',base.vdw.toFixed(2)); set('hbond_contrib',base.hbond.toFixed(2)); set('hydro_contrib',base.hydrophobic.toFixed(2)); set('rot_contrib',base.rotational.toFixed(2)); set('contacts',String(contacts)); set('clashes',String(clashes));
    latestDock.dG=Number(total.toFixed(2)); setStatus('Docking scored (heuristic).','ok');
  };
  const recenterAndRescore=()=>{ resetView(); if(proteinModel&&ligandModel) runDock(); };

  /* ---------- Local store ---------- */
  const K_USERS='ps_users_v4', K_SESSION='ps_session_v4', K_CHANNELS='ps_channels_v4', K_POSTS='ps_posts_v4';
  const saved=k=>recall(k,[]), getSession=()=>recall(K_SESSION,null);
  const setSession=u=>{persist(K_SESSION,u); $('#profileBtn').textContent=u.username; closeProfile();};
  const userdb=()=>recall(K_USERS,[]);
  const upsertChannelLocal=name=>{const slug=slugify(name||''); if(!slug) return null; const arr=saved(K_CHANNELS); let c=arr.find(x=>x.slug===slug); if(!c){ const s=getSession(); c={id:crypto.randomUUID(),slug,name,description:'',createdBy:s?.username||'anon',createdAt:Date.now()}; arr.push(c); persist(K_CHANNELS,arr);} return c;};
  const addPostLocal=p=>{const arr=saved(K_POSTS); arr.push(p); persist(K_POSTS,arr);};

  /* ---------- Firebase (cloud) ---------- */
  let SYNC_MODE='local', fs=null;
  const initCloudIfAvailable=()=>{
    try{
      if(window.FIREBASE_CONFIG && firebase?.initializeApp){
        const app=firebase.initializeApp(window.FIREBASE_CONFIG);
        fs=firebase.firestore(app);
        SYNC_MODE='cloud';
        setStatus('Cloud sync enabled.','ok');
      }
    }catch(e){ console.warn('Cloud init failed; using local only:', e); SYNC_MODE='local'; }
  };
  const cloudAdd=(col,obj)=>fs.collection(col).add(obj);
  const cloudUpsertChannel=async name=>{
    const slug=slugify(name||''); if(!slug) return null;
    const q=await fs.collection('channels').where('slug','==',slug).limit(1).get();
    if(q.empty){ const s=getSession(); const c={slug,name,description:'',createdBy:s?.username||'anon',createdAt:Date.now()}; await fs.collection('channels').add(c); return c; }
    return q.docs[0].data();
  };
  const cloudGetChannels=async()=> (await fs.collection('channels').orderBy('name','asc').get()).docs.map(d=>d.data());
  const cloudOnPosts=(cb)=> fs.collection('posts').orderBy('createdAt','desc').onSnapshot(s=>cb(s.docs.map(d=>({id:d.id,...d.data()}))));
  const cloudOnChannels=(cb)=> fs.collection('channels').orderBy('name','asc').onSnapshot(s=>cb(s.docs.map(d=>({id:d.id,...d.data()}))));

  /* ---------- Community renderers ---------- */
  const renderPostCard=p=>{
    const card=document.createElement('div'); card.className='feed-card';
    const mood=p.mood?.includes('Constructive')?'warn':'pos';
    const chLink=p.channelSlug?`<a class="hash" href="#/p/${p.channelSlug}">#${p.proteinName||'General'}</a>`:`<span class="chip info">#${p.proteinName||'General'}</span>`;
    const user=p.user||{username:'Anonymous',avatar:'https://i.pravatar.cc/40'};
    card.innerHTML=`
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-sm text-gray-600">${chLink} · ${user.username||''}</div>
          <h4 class="font-semibold text-lg">${p.title||p.proteinName||'Untitled'}</h4>
          <div class="flex flex-wrap gap-2 mt-1">
            ${p.pdbId?`<span class="chip info">PDB ${p.pdbId}</span>`:''}
            ${p.type==='dock'?`<span class="chip ${mood}">ΔG ${p.dG!=null?p.dG:'--'}</span>`:`<span class="chip info">${p.type}</span>`}
          </div>
        </div>
        <img src="${user.avatar||'https://i.pravatar.cc/40'}" class="w-10 h-10 rounded-full" alt="avatar">
      </div>
      ${p.type==='dock'?`${p.smiles?`<div class="text-xs break-all mt-2"><span class="font-semibold">SMILES:</span> ${p.smiles}</div>`:''}${p.notes?`<p class="text-sm mt-2 whitespace-pre-wrap">${p.notes}</p>`:''}`:`<p class="text-sm mt-2 whitespace-pre-wrap">${p.content||''}</p>`}
      <div class="text-xs text-gray-500 mt-2">${p.createdAt?new Date(p.createdAt).toLocaleString():''}</div>`;
    return card;
  };

  let CHANNEL_CACHE = []; // for quick channel view in local/cloud

  const refreshFeedLocal=()=>{
    const posts=saved(K_POSTS);
    const q=($('#searchInput')?.value||'').toLowerCase(); const alpha=$('#alphaFilter')?.value||'';
    let f=posts.filter(p=>[(p.proteinName||''),(p.smiles||''),(p.title||'')].some(s=>s.toLowerCase().includes(q)));
    if(alpha){ f=f.filter(p=>{const ch=(p.proteinName||'').trim()[0]||'#'; const key=/[A-Za-z]/.test(ch)?ch.toUpperCase():'#'; return alpha===''?true:(alpha==='#num'?key==='#':key===alpha);}); }
    f.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0) );
    const grid=$('#feedGrid'); grid.innerHTML=''; f.forEach(p=>grid.appendChild(renderPostCard(p))); $('#emptyFeed')?.classList.toggle('hidden',!!f.length);
  };

  const refreshFeedCloud=(posts)=>{
    const q=($('#searchInput')?.value||'').toLowerCase(); const alpha=$('#alphaFilter')?.value||'';
    let f=posts.filter(p=>[(p.proteinName||''),(p.smiles||''),(p.title||'')].some(s=>s.toLowerCase().includes(q)));
    if(alpha){ f=f.filter(p=>{const ch=(p.proteinName||'').trim()[0]||'#'; const key=/[A-Za-z]/.test(ch)?ch.toUpperCase():'#'; return alpha===''?true:(alpha==='#num'?key==='#':key===alpha);}); }
    const grid=$('#feedGrid'); grid.innerHTML=''; f.forEach(p=>grid.appendChild(renderPostCard(p))); $('#emptyFeed')?.classList.toggle('hidden',!!f.length);
  };

  const refreshChannelListLocal=()=>{
    const query=($('#channelSearch')?.value||'').toLowerCase();
    const channels=saved(K_CHANNELS).filter(c=>c.name.toLowerCase().includes(query)).sort((a,b)=>a.name.localeCompare(b.name));
    CHANNEL_CACHE = channels;
    const list=$('#channelList'); list.innerHTML='';
    channels.forEach(c=>{
      const posts=saved(K_POSTS).filter(p=>p.channelId===c.id);
      const docks=posts.filter(p=>p.type==='dock');
      const best=docks.length?docks.reduce((a,b)=>(a.dG??999)<(b.dG??999)?a:b):null;
      const card=document.createElement('div'); card.className='feed-card';
      card.innerHTML=`<div class="flex items-center justify-between">
        <a class="hash" href="#/p/${c.slug}"><h3 class="font-semibold text-lg">#${c.name}</h3></a>
        <span class="chip info">${posts.length} posts</span></div>
        <div class="text-sm text-gray-600">Started by ${c.createdBy} · ${new Date(c.createdAt).toLocaleDateString()}</div>
        <div class="mt-2 text-sm">${best?`Best ΔG: <strong>${best.dG}</strong> (PDB ${best.pdbId||'—'})`:'No docking yet.'}</div>`;
      list.appendChild(card);
    });
    $('#channelEmpty')?.classList.toggle('hidden',!!channels.length);
  };

  const refreshChannelListCloud=(channels)=>{
    const query=($('#channelSearch')?.value||'').toLowerCase();
    const filtered=channels.filter(c=>(c.name||'').toLowerCase().includes(query)).sort((a,b)=>a.name.localeCompare(b.name));
    CHANNEL_CACHE = filtered;
    const list=$('#channelList'); list.innerHTML='';
    filtered.forEach(c=>{
      // posts count not pre-joined — show name and createdBy
      const card=document.createElement('div'); card.className='feed-card';
      card.innerHTML=`<div class="flex items-center justify-between">
        <a class="hash" href="#/p/${c.slug}"><h3 class="font-semibold text-lg">#${c.name}</h3></a>
        <span class="chip info">live</span></div>
        <div class="text-sm text-gray-600">Started by ${c.createdBy||'—'} · ${c.createdAt?new Date(c.createdAt).toLocaleDateString():'—'}</div>
        <div class="mt-2 text-sm">Open to contributions.</div>`;
      list.appendChild(card);
    });
    $('#channelEmpty')?.classList.toggle('hidden',!!filtered.length);
  };

  const openChannelBySlug=(slug)=>{
    const ch = CHANNEL_CACHE.find(c=>c.slug===slug) || saved(K_CHANNELS).find(c=>c.slug===slug);
    if(!ch){ alert('Channel not found'); return; }
    $('#chName').textContent='#'+ch.name;
    $('#chMeta').textContent=`Created by ${ch.createdBy||'—'} · ${ch.createdAt?new Date(ch.createdAt).toLocaleString():'—'}`;
    $('#chHash').href=`#/p/${ch.slug}`;

    // In local mode we can read local posts; in cloud we just show recent feed (posts snapshot already in feed)
    const postsLocal = saved(K_POSTS).filter(p=>p.channelId===ch.id).sort((a,b)=>b.createdAt-a.createdAt);
    const tb=$('#chTable'); tb.innerHTML='';
    postsLocal.filter(p=>p.type==='dock').forEach(p=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="py-1">${new Date(p.createdAt).toLocaleDateString()}</td><td>${p.pdbId||''}</td><td class="break-all">${p.smiles||''}</td><td>${p.dG==null?'':p.dG}</td><td>${p.user?.username||''}</td>`;
      tb.appendChild(tr);
    });
    const feed=$('#chFeed'); feed.innerHTML='';
    postsLocal.slice(0,12).forEach(p=>feed.appendChild(renderPostCard(p)));

    $('#channelView').classList.remove('hidden');
    showSectionById('channels'); setActiveNav('channels');
  };

  /* ---------- Auth (local label) ---------- */
  const openProfile=()=>{$('#profileModal')?.classList.remove('hidden'); $('#profileModal')?.classList.add('flex'); $('#authMsg').textContent='';};
  const closeProfile=()=>{$('#profileModal')?.classList.add('hidden'); $('#profileModal')?.classList.remove('flex');};
  const signUp=()=>{ const username=$('#authUser').value.trim(), pass=$('#authPass').value, avatar=$('#authAvatar').value.trim(); if(!username||!pass){$('#authMsg').textContent='Provide username & password.';$('#authMsg').className='text-rose-700 text-sm';return;} const users=userdb(); if(users.find(u=>u.username===username)){ $('#authMsg').textContent='Username already exists.'; $('#authMsg').className='text-rose-700 text-sm'; return; } users.push({id:crypto.randomUUID(),username,pass,avatar}); persist(K_USERS,users); setSession({username,avatar}); $('#authMsg').textContent='Account created.'; $('#authMsg').className='text-green-700 text-sm'; };
  const signIn=()=>{ const username=$('#authUser').value.trim(), pass=$('#authPass').value; const u=userdb().find(u=>u.username===username&&u.pass===pass); if(!u){$('#authMsg').textContent='Invalid credentials.';$('#authMsg').className='text-rose-700 text-sm';return;} setSession({username:u.username,avatar:u.avatar});};
  const signOut=()=>{ localStorage.removeItem(K_SESSION); $('#profileBtn').textContent='Sign In'; closeProfile(); };

  /* ---------- Posts (create) ---------- */
  const upsertChannel = async (name)=>{
    if(SYNC_MODE==='cloud') return await cloudUpsertChannel(name);
    return upsertChannelLocal(name);
  };
  const addPost = async (p)=>{
    if(SYNC_MODE==='cloud'){ await cloudAdd('posts', p); return; }
    addPostLocal(p);
  };
  const createDockPost=async()=>{
    const sess=getSession(); if(!sess){alert('Sign in first');return;}
    const proteinName=$('#postProtein').value.trim(); if(!proteinName){alert('Enter protein name');return;}
    const channel=await upsertChannel(proteinName);
    const p={type:'dock',channelId:channel.id||null,channelSlug:channel.slug,proteinName,pdbId:$('#postPdbId').value.trim(),smiles:$('#postSmiles').value.trim(),dG:parseFloat($('#postDG').value)||null,mood:$('#postMood').value,notes:$('#postNotes').value,user:sess,createdAt:Date.now()};
    if(SYNC_MODE==='local'){ p.id=crypto.randomUUID(); }
    await addPost(p);
    if(SYNC_MODE==='local'){ // immediate local refresh
      refreshFeedLocal(); refreshChannelListLocal(); 
    }
    alert('Posted!');
  };
  const createNonDockPost=async()=>{
    const sess=getSession(); if(!sess){alert('Sign in first');return;}
    const proteinName=$('#postProtein').value.trim()||'General';
    const channel=await upsertChannel(proteinName);
    const p={type:$('#postType').value,channelId:channel.id||null,channelSlug:channel.slug,proteinName,title:$('#postTitle').value,content:$('#postContent').value,user:sess,createdAt:Date.now()};
    if(SYNC_MODE==='local'){ p.id=crypto.randomUUID(); }
    await addPost(p);
    if(SYNC_MODE==='local'){ refreshFeedLocal(); refreshChannelListLocal(); }
    alert('Published!');
  };

  /* ---------- PBPK ---------- */
  const runPBPK=()=>{
    const Dose=+$('#dose').value||0, F=(+$('#F').value||0)/100, Vd=+$('#Vd').value||1; let ka=+$('#ka').value||0, ke=+$('#ke').value||0; if(ka===ke) ka+=1e-6;
    const dt=0.25,t=[]; for(let x=0;x<=48;x+=dt) t.push(+x.toFixed(2));
    const A=(F*Dose/Vd)*(ka/(ka-ke)), C=t.map(tt=>Math.max(0, A*(Math.exp(-ke*tt)-Math.exp(-ka*tt)))); const Kd=20, Occ=C.map(c=>c/(c+Kd));
    const Cmax=Math.max(...C), Tmax=t[C.indexOf(Cmax)], AUC=trapz(t,C);
    $('#cmax').textContent=Cmax.toFixed(2)+' mg/L'; $('#tmax').textContent=Tmax.toFixed(2)+' h'; $('#auc').textContent=AUC.toFixed(2)+' mg·h/L';
    chartMake('pkChart',{type:'line',data:{labels:t,datasets:[{label:'Plasma (mg/L)',data:C,borderWidth:2,fill:false}]},options:{scales:{x:{title:{display:true,text:'Time (h)'}},y:{beginAtZero:true,title:{display:true,text:'mg/L'}}}}});
    chartMake('occChart',{type:'line',data:{labels:t,datasets:[{label:'Target Occupancy',data:Occ,borderWidth:2,fill:false}]},options:{scales:{x:{title:{display:true,text:'Time (h)'}},y:{beginAtZero:true,max:1,title:{display:true,text:'Fraction'}}}}});
    setStatus('PBPK run complete.','ok');
  };

  /* ---------- Clinical ---------- */
  const mulberry32=a=>()=>{let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296;};
  const simulateTrial=()=>{
    const L=Math.max(1,+$('#levels').value||6), N=Math.max(1,+$('#cohort').value||3), start=Math.max(1e-3,+$('#startDose').value||10), target=Math.max(1,Math.min(90,+$('#tox').value||25))/100, esc=Math.max(1.01,+$('#esc').value||1.5), seed=(+$('#seed').value||42)>>>0, rnd=mulberry32(seed);
    const doses=Array.from({length:L},(_,i)=>start*Math.pow(esc,i)), base=target/2, pDLT=doses.map((_,i)=>Math.max(0.02,Math.min(0.9, base*Math.pow(esc,i-Math.floor(L/2)))));
    const cohorts=[]; let level=0, mtd=null;
    const enroll=(lv,n)=>{let d=0; for(let i=0;i<n;i++) if(rnd()<pDLT[lv]) d++; cohorts.push({dose:doses[lv],n, dlt:d}); return d;};
    while(true){ const d1=enroll(level,N); if(d1===0){ if(level===L-1){mtd=level+1;break;} level++; } else if(d1===1){ const d2=enroll(level,N); if(d1+d2<=1){ if(level===L-1){mtd=level+1;break;} level++; } else { mtd=level>0?level:1; break; } } else { mtd=level>0?level:1; break; } if(cohorts.length>50){mtd=Math.max(1,level); break;} }
    return {doses,cohorts,mtd};
  };
  const renderTrial=t=>{
    const tb=$('#trialTable'); tb.innerHTML=''; t.cohorts.forEach((c,i)=>{const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-1">${i+1}</td><td>${c.dose.toFixed(2)}</td><td>${c.dlt}</td><td>${c.n}</td>`; tb.appendChild(tr);});
    const badge=$('#trialBadge'); badge.classList.remove('hidden'); badge.textContent=t.mtd?`MTD at level ${t.mtd} (≈${t.doses[t.mtd-1].toFixed(2)} mg)`:'No MTD'; badge.className='chip '+(t.mtd?'pos':'warn');
    chartMake('trialChart',{type:'bar',data:{labels:t.cohorts.map((_,i)=>`C${i+1}`),datasets:[{type:'bar',label:'DLTs',data:t.cohorts.map(c=>c.dlt),borderWidth:1},{type:'line',label:'Dose (mg)',data:t.cohorts.map(c=>c.dose),yAxisID:'y2',borderWidth:2}]},options:{scales:{y:{beginAtZero:true,title:{display:true,text:'DLTs'}},y2:{position:'right',beginAtZero:true,title:{display:true,text:'Dose (mg)'}}}}});
  };
  const runOneTrial=()=>{const t=simulateTrial(); renderTrial(t); setStatus('3+3 trial simulated.','ok');};
  const runHundredTrials=()=>{const L=Math.max(1,+$('#levels').value||6); const N=100, m=[]; for(let i=0;i<N;i++) m.push(simulateTrial().mtd||0); const avg=m.reduce((a,b)=>a+b,0)/N; const bins=Array.from({length:L+1},()=>0); m.forEach(k=>bins[k]++); const badge=$('#trialBadge'); badge.classList.remove('hidden'); badge.textContent=`100 sims · Avg MTD level: ${avg.toFixed(2)}`; badge.className='chip info'; chartMake('trialChart',{type:'bar',data:{labels:['None',...Array.from({length:L},(_,i)=>String(i+1))],datasets:[{label:'MTD frequency (out of 100)',data:bins,borderWidth:1}]},options:{scales:{y:{beginAtZero:true}}}}); $('#trialTable').innerHTML=''; setStatus('Ran 100 simulated trials.','ok'); };

  /* ---------- Podcasts ---------- */
  const RSS='https://anchor.fm/s/2ded5364/podcast/rss';
  const fetchWithTimeout=(url,{ms=8000}={})=>Promise.race([fetch(url), new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
  const fetchRSS=async()=>{
    try{ const r=await fetchWithTimeout(RSS); if(!r.ok) throw new Error('rss http '+r.status); return await r.text(); }
    catch{ const r=await fetchWithTimeout('https://api.allorigins.win/raw?url='+encodeURIComponent(RSS)); if(!r.ok) throw new Error('proxy http '+r.status); return await r.text(); }
  };
  const parseRSS=xml=>{const doc=new DOMParser().parseFromString(xml,'application/xml'); const items=[...doc.querySelectorAll('item')].slice(0,60); return items.map(it=>({title:it.querySelector('title')?.textContent?.trim()||'Untitled', pubDate:it.querySelector('pubDate')?.textContent||'', url:it.querySelector('enclosure')?.getAttribute('url')||it.querySelector('link')?.textContent||'', author:it.querySelector('itunes\\:author, author')?.textContent||'', duration:it.querySelector('itunes\\:duration')?.textContent||''})); };
  const renderPodcastList=list=>{ const box=$('#podcastList'); if(!box) return; box.innerHTML=''; list.forEach(ep=>{ const b=document.createElement('button'); b.className='text-left border rounded-lg p-3 bg-white hover:bg-slate-50 transition'; b.innerHTML=`<div class="font-semibold truncate">${ep.title}</div><div class="text-xs text-slate-600">${new Date(ep.pubDate).toLocaleString()} ${ep.duration?('· '+ep.duration):''}</div>`; b.addEventListener('click',()=>{ const ap=$('#audioPlayer'); if(ap){ ap.src=ep.url; ap.play().catch(()=>{});} $('#npTitle').textContent=ep.title; $('#npMeta').textContent=ep.author?`${ep.author} · ${new Date(ep.pubDate).toLocaleDateString()}`:new Date(ep.pubDate).toLocaleDateString();}); box.appendChild(b); }); };

  /* ---------- Wire up ---------- */
  document.addEventListener('DOMContentLoaded', async ()=>{
    // Init Cloud
    initCloudIfAvailable();

    // RDKit
    try{ await initRDKit(); }catch(e){ console.error(e); setStatus('RDKit failed to load.','err'); }

    ensureViewer(); wirePdbDropZone();

    // Buttons
    on('#loadLocalPdbBtn','click',loadLocalPdb);
    on('#fetchPdbBtn','click',fetchPdb);
    on('#clearProteinBtn','click',clearProtein);
    on('#resetViewBtn','click',resetView);
    on('#useExampleBtn','click',()=>{const s=$('#exampleSmiles'); if(s?.value){ $('#smiles').value=s.value; processSmilesString(s.value); }});
    on('#loadSmilesBtn','click',()=>processSmilesString($('#smiles').value));
    on('#clearLigandBtn','click',clearLigand);
    on('#dockBtn','click',runDock);
    on('#centerBtn','click',recenterAndRescore);
    on('#clearAllBtn','click',clearAll);
    on('#prefillFromDock','click',()=>{const map={postProtein:latestDock.proteinName||'',postPdbId:latestDock.pdbId||'',postSmiles:latestDock.smiles||'',postDG:latestDock.dG||''}; Object.entries(map).forEach(([id,v])=>{$('#'+id).value=v}); showSectionById('community'); setActiveNav('community');});
    on('#createPostBtn','click',createDockPost);
    on('#createNonDockBtn','click',createNonDockPost);
    on('#profileBtn','click',openProfile);
    on('#closeProfileBtn','click',closeProfile);
    on('#signUpBtn','click',signUp);
    on('#signInBtn','click',signIn);
    on('#signOutBtn','click',signOut);
    on('#runPBPKBtn','click',runPBPK);
    on('#runTrialBtn','click',runOneTrial);
    on('#run100Btn','click',runHundredTrials);

    // Scoring info
    const infoByModel={balanced:"Balances size, H-bonding, hydrophobics, flexibility.",hbond:"Rewards donors/acceptors; good for polar pockets.",hydrophobic:"Rewards nonpolar fit; penalizes excess polarity."};
    const smSel=$('#scoringModel'); smSel?.addEventListener('change',()=>$('#modelInfoText').textContent=infoByModel[smSel.value]||''); smSel?.dispatchEvent(new Event('change'));

    // Routing
    navigateFromHash(); resetMetrics(); refreshButtons();

    // Live listeners (cloud) or local refresh
    if(SYNC_MODE==='cloud'){
      // Posts live
      cloudOnPosts((posts)=>{ refreshFeedCloud(posts); });
      // Channels live
      cloudOnChannels((channels)=>{ refreshChannelListCloud(channels); });
    }else{
      // Local storage mode
      refreshFeedLocal();
      refreshChannelListLocal();
    }

    // Podcasts
    try{ const xml=await fetchRSS(); renderPodcastList(parseRSS(xml)); }catch(e){ console.warn('Podcast load failed:',e); const box=$('#podcastList'); if(box) box.innerHTML=`<div class="text-sm text-rose-700">Couldn’t load RSS. You can still paste audio URLs into the player.</div>`; }
  });
  </script>

  <!-- Profile Modal -->
  <div id="profileModal" class="fixed inset-0 hidden items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="authTitle">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative glass p-4 w-full max-w-md">
      <h3 id="authTitle" class="font-bold text-lg mb-2">Sign Up / Sign In</h3>
      <p class="text-xs text-gray-600 -mt-1 mb-3">Local session; Firestore provides live multi-user feed. Add Firebase Auth later if desired.</p>
      <label class="block text-sm font-semibold">Username</label>
      <input id="authUser" class="input" placeholder="e.g., ligand_lover">
      <label class="block text-sm font-semibold mt-2">Password</label>
      <input id="authPass" type="password" class="input" placeholder="••••••••">
      <label class="block text-sm font-semibold mt-2">Avatar URL (optional)</label>
      <input id="authAvatar" class="input" placeholder="https://…">
      <div class="grid grid-cols-2 gap-2 mt-3">
        <button id="signInBtn" class="btn">Sign In</button>
        <button id="signUpBtn" class="btn-plain">Create Account</button>
      </div>
      <div class="grid grid-cols-2 gap-2 mt-2">
        <button id="closeProfileBtn" class="btn-plain">Cancel</button>
        <button id="signOutBtn" class="btn-plain">Sign Out</button>
      </div>
      <div id="authMsg" class="text-sm mt-2"></div>
    </div>
  </div>
</body>
</html>
