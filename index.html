<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    :root {
      --ink: #0b1630;
      --brand: #2a5298;
      --brand2: #1e3c72;
    }
    body {
      font-family: system-ui, sans-serif;
      ...
    }
    ...
  </style>

  <style>
    /* Sidebar-friendly docking layout */
    #md .split {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    #md .split > div {
      flex: 1 1 100%;
      min-width: 0;
    }

    @media (min-width: 1024px) {
      #md .split > div:first-child {
        flex: 0 0 380px;
        max-width: 420px;
      }
      #md .split > div:last-child {
        flex: 1 1 auto;
      }
    }

    /* Maintain layout visibility */
    #viewer {
      min-height: 400px;
      max-height: 500px;
      overflow: hidden;
      border-radius: 12px;
      background: #eef2f7;
    }

    #dock-right {
      overflow-y: auto;
      max-height: 800px;
      padding-bottom: 1rem;
    }
  </style>
</head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PharmaSim Pro · Social Computational Chemistry</title>

<!-- UI -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />

<!-- Science libs -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.4/3Dmol-min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script defer src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{--ink:#0b1630;--brand:#2a5298;--brand2:#1e3c72}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);
  background:linear-gradient(135deg,#1e3c72 0%,#2a5298 50%,#7e8ba3 100%)}
.glass{background:rgba(255,255,255,.92);backdrop-filter:blur(10px);box-shadow:0 10px 26px rgba(0,0,0,.12);border-radius:16px}
.panel{padding:18px}
.section{display:none}
.section.active{display:block}
.btn{background:linear-gradient(135deg,#2a5298,#1e3c72);color:#fff;font-weight:700;border-radius:10px;padding:.65rem .9rem}
.btn:disabled{opacity:.6;cursor:not-allowed}
.input,select,textarea{width:100%;padding:.65rem .8rem;border:2px solid #e5e7eb;border-radius:10px;background:#f8f9fa}
.input:focus,select:focus,textarea:focus{outline:none;border-color:#2a5298;background:#fff;box-shadow:0 0 0 3px rgba(42,82,152,.12)}
.metric{background:linear-gradient(135deg,#f8f9fa,#e9eef6);border-radius:12px;padding:12px;text-align:center}
.metric .v{font-size:1.1rem;font-weight:800;background:linear-gradient(135deg,#2a5298,#1e3c72);-webkit-background-clip:text;background-clip:text;color:transparent}
.feed-card{border:1px solid #e6eaf2;border-radius:16px;padding:14px;background:#fff}
.feed-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.split{display:grid;grid-template-columns:360px 1fr;gap:20px;align-items:start}
@media(max-width:1024px){.split{grid-template-columns:1fr}}
.split>div{min-width:0}
#viewer{width:100%;min-height:420px;height:420px;border-radius:12px;background:#eef2f7}
#pdbDrop{min-height:120px;max-height:160px;overflow:auto}
@media(max-width:640px){#pdbDrop{min-height:100px;max-height:120px}}
.chip{display:inline-flex;align-items:center;gap:.5rem;padding:.25rem .6rem;border-radius:999px;font-weight:700;font-size:.75rem}
.chip.pos{background:#ecfdf5;color:#065f46}.chip.info{background:#eff6ff;color:#1e3a8a}.chip.warn{background:#fff7ed;color:#9a3412}.chip.err{background:#fee2e2;color:#991b1b}
#dock-right{max-height:740px;overflow:auto}
main{scroll-margin-top:84px}
a.hash { color:#1e3c72; font-weight:600; }
</style>
    <style>
/* Sidebar-friendly docking layout */
#md .split {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}

#md .split > div {
  flex: 1 1 100%;
  min-width: 0;
}

@media (min-width: 1024px) {
  #md .split > div:first-child {
    flex: 0 0 380px;
    max-width: 420px;
  }
  #md .split > div:last-child {
    flex: 1 1 auto;
  }
}

/* Maintain layout visibility */
#viewer {
  min-height: 400px;
  max-height: 500px;
  overflow: hidden;
  border-radius: 12px;
  background: #eef2f7;
}

#dock-right {
  overflow-y: auto;
  max-height: 800px;
  padding-bottom: 1rem;
}
</style>
</head>
<body>

<!-- NAV -->
<header class="sticky top-0 z-40 glass">
  <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="text-2xl font-extrabold" style="color:#1e3c72">PharmaSim Pro</div>
      <span class="chip info">Social Computational Chemistry</span>
    </div>
    <nav class="hidden md:flex items-center gap-2">
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="md">Docking</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="pbpk">PBPK/QSP</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="clinical">Clinical</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="mdsetup">MD Setup</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="community">Community</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="channels">Channels</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="pub">Publications</button>
      <button class="px-3 py-2 rounded-lg font-semibold nav-tab bg-white" data-t="learn">Learning</button>
    </nav>
    <div class="flex items-center gap-3">
      <div id="statusBadge" class="chip warn hidden">Initializing…</div>
      <button id="profileBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Sign In</button>
    </div>
  </div>
</header>

<!-- DISCLAIMER -->
<div class="max-w-7xl mx-auto px-4 mt-3">
  <div class="glass panel text-sm leading-relaxed">
    <strong>Disclaimer:</strong> For <em>educational/research</em> use only. Docking scores, PBPK/QSP, and clinical simulations are approximations. Validate with experiments before decisions.
  </div>
</div>

<main class="max-w-7xl mx-auto px-4 my-4">
  <!-- DOCKING -->
  <section id="md" class="glass panel section active">
    <h2 class="text-xl font-bold mb-4">Ligand Prep & Structure-Aware Heuristic Docking</h2>
    <div class="split">
      <div>
        <!-- Protein -->
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2">Protein (PDB)</label>
          <div id="pdbDrop" class="w-full border-2 border-dashed border-gray-300 rounded-xl bg-white/70 p-4 text-center text-gray-600 hover:border-indigo-400 hover:bg-white transition">
            <div class="font-semibold">Drag & Drop PDB here</div>
            <div class="text-xs">or choose a file below</div>
          </div>
          <div class="mt-3 grid grid-cols-3 gap-2">
            <input type="file" id="pdbFile" accept=".pdb" class="col-span-2 input file:mr-3 file:py-2 file:px-3 file:rounded-md file:border-0 file:bg-indigo-50 file:text-indigo-700"/>
            <button id="loadLocalPdbBtn" class="btn w-full">Load Local PDB</button>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-3">
            <input id="pdbId" placeholder="Fetch by PDB ID (e.g., 6LU7)" class="col-span-2 input"/>
            <button id="fetchPdbBtn" class="btn w-full">Fetch PDB</button>
          </div>
        </div>

        <!-- Ligand -->
        <div class="mb-4">
          <label class="block text-sm font-semibold mb-2">Ligand (SMILES)</label>
          <input id="smiles" class="input" placeholder="Paste SMILES here (e.g., CC(=O)OC1=CC=CC=C1C(=O)O)"/>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <select id="exampleSmiles" class="col-span-2 input">
              <option value="" selected>Choose an example…</option>
              <option value="O=P(O)(O)COC(=O)C1CCCN1C(=O)c1ccc(CNS(=O)(=O)c2ccc(C)cc2)cc1">Drug Hit 1 (Zn-Chelator)</option>
              <option value="CC(C)NCc1ccc(S(=O)(=O)Nc2cccc(c2)C(=O)N2CCCC2C(=O)OCC)cc1">Drug Hit 2 (π-π)</option>
              <option value="N1=C(N)N=C(C1)CCS(=O)(=O)NCc1ccc(C(=O)OCP(=O)(O)O)cc1">Drug Hit 3 (H-Bond)</option>
              <option value="Cc1ccc(OCc2ccc(C(=O)OC[C@H]3O[C@H](O)[C@H](O)[C@@H](O)[C@@H]3CO)cc2)cc1">Drug Hit 4 (Allosteric)</option>
              <option value="CC(C)NC(=O)C1CCN(CC1)c1cccc2OCOc12">Drug Hit 5 (Reversible)</option>
              <option value="CC(C)CC(NC(=O)C1CCN(CC1)c1cccc2OCOc12)Cc1ccccc1">Drug Hit 6 (Irreversible)</option>
            </select>
            <button id="useExampleBtn" class="px-3 py-2 rounded-lg font-semibold bg-white w-full">Use Example</button>
          </div>
        </div>

        <div class="mb-2">
          <label class="block text-sm font-semibold mb-2">Scoring Model</label>
          <select id="scoringModel" class="input">
            <option value="balanced" selected>Balanced</option>
            <option value="hbond">H-Bond Focused</option>
            <option value="hydrophobic">Hydrophobicity Focused</option>
          </select>
          <p class="text-sm text-gray-600 mt-2" id="modelInfoText"></p>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <button id="dockBtn" class="btn" disabled>Run Approximate Dock</button>
          <button id="centerBtn" class="btn" disabled>Re-center & Re-score</button>
        </div>

        <div class="mt-4">
          <button id="useForPostBtn" class="px-3 py-2 rounded-lg font-semibold bg-white w-full">Use Current Dock in Community Post</button>
        </div>
      </div>

      <div id="dock-right">
        <div class="grid grid-cols-3 gap-2">
          <div class="metric"><div>Total ΔG</div><div id="aff" class="v">--</div></div>
          <div class="metric"><div>Ligand MW</div><div id="mw" class="v">--</div></div>
          <div class="metric"><div>Ligand LogP</div><div id="logp" class="v">--</div></div>
        </div>
        <div class="grid grid-cols-6 gap-2 mt-2">
          <div class="metric"><div class="text-xs">ΔG vdW</div><div id="vdw_contrib" class="v">--</div></div>
          <div class="metric"><div class="text-xs">ΔG H-Bond</div><div id="hbond_contrib" class="v">--</div></div>
          <div class="metric"><div class="text-xs">ΔG Hydroph.</div><div id="hydro_contrib" class="v">--</div></div>
          <div class="metric"><div class="text-xs">ΔS Rot.</div><div id="rot_contrib" class="v">--</div></div>
          <div class="metric"><div class="text-xs">Contacts</div><div id="contacts" class="v">--</div></div>
          <div class="metric"><div class="text-xs">Clashes</div><div id="clashes" class="v">--</div></div>
        </div>
        <div class="mt-3">
          <h3 class="font-semibold mb-1">3D Visualization</h3>
          <div id="viewer"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PBPK -->
  <section id="pbpk" class="glass panel section">
    <h2 class="text-xl font-bold mb-2">PBPK/QSP (One-Compartment Oral)</h2>
    <div class="split">
      <div>
        <label class="block text-sm font-semibold">Dose (mg)</label><input id="dose" type="number" value="100" class="input"/>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div><label class="block text-sm font-semibold">F (%)</label><input id="F" type="number" value="80" class="input"/></div>
          <div><label class="block text-sm font-semibold">ka (h⁻¹)</label><input id="ka" type="number" value="1.2" step="0.1" class="input"/></div>
          <div><label class="block text-sm font-semibold">ke (h⁻¹)</label><input id="ke" type="number" value="0.2" step="0.05" class="input"/></div>
          <div><label class="block text-sm font-semibold">Vd (L)</label><input id="Vd" type="number" value="50" class="input"/></div>
        </div>
        <button id="runPBPKBtn" class="btn w-full mt-3">Run PBPK Simulation</button>
        <p class="text-sm text-gray-600 mt-2">Bateman function; E<sub>max</sub> occupancy with demo K<sub>d</sub>=20 mg/L.</p>
      </div>
      <div>
        <div class="grid grid-cols-3 gap-2">
          <div class="metric"><div>C<sub>max</sub></div><div id="cmax" class="v">--</div></div>
          <div class="metric"><div>T<sub>max</sub></div><div id="tmax" class="v">--</div></div>
          <div class="metric"><div>AUC<sub>0–48</sub></div><div id="auc" class="v">--</div></div>
        </div>
        <div class="h-72 mt-2"><canvas id="pkChart"></canvas></div>
        <div class="h-56 mt-2"><canvas id="occChart"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Clinical -->
  <section id="clinical" class="glass panel section">
    <h2 class="text-xl font-bold mb-2">3+3 Dose Escalation Simulator</h2>
    <div class="split">
      <div>
        <div class="grid grid-cols-2 gap-2">
          <div><label class="block text-sm font-semibold">Dose Levels</label><input id="levels" type="number" value="6" class="input"/></div>
          <div><label class="block text-sm font-semibold">Cohort Size</label><input id="cohort" type="number" value="3" class="input"/></div>
          <div><label class="block text-sm font-semibold">Start Dose (mg)</label><input id="startDose" type="number" value="10" class="input"/></div>
          <div><label class="block text-sm font-semibold">Target DLT Rate (%)</label><input id="tox" type="number" value="25" class="input"/></div>
          <div><label class="block text-sm font-semibold">Escalation Factor</label><input id="esc" type="number" value="1.5" step="0.1" class="input"/></div>
          <div><label class="block text-sm font-semibold">Random Seed</label><input id="seed" type="number" value="42" class="input"/></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-3">
          <button id="runTrialBtn" class="btn w-full">Simulate Trial</button>
          <button id="run100Btn" class="btn w-full">Run 100 Trials</button>
        </div>
        <p class="text-sm text-gray-600 mt-2">0/3 → escalate; 1/3 → expand; ≥2/3 → stop/de-escalate. MTD = highest with ≤1/6 DLTs.</p>
      </div>
      <div>
        <div class="flex items-center justify-between"><h3 class="font-semibold mb-1">Trial Visualization</h3><div id="trialBadge" class="chip hidden"></div></div>
        <div class="h-72"><canvas id="trialChart"></canvas></div>
        <div class="glass panel mt-3">
          <h4 class="font-semibold mb-2">Cohorts</h4>
          <table class="w-full text-sm">
            <thead><tr class="text-left text-gray-600"><th class="py-1">#</th><th>Dose (mg)</th><th>DLTs</th><th>N</th></tr></thead>
            <tbody id="trialTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- MD Setup -->
  <section id="mdsetup" class="glass panel section">
    <h2 class="text-xl font-bold mb-2">MD Simulation File Generator</h2>
    <div class="split">
      <div>
        <label class="block text-sm font-semibold">Output Prefix</label><input id="md-out" value="output" class="input"/>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div><label class="block text-sm font-semibold">Temperature (K)</label><input id="md-temp" type="number" value="310" class="input"/></div>
          <div><label class="block text-sm font-semibold">Production Time (ns)</label><input id="md-ns" type="number" value="10" class="input"/></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div><label class="block text-sm font-semibold">switch/cut/pair (Å)</label><input id="md-cuts" value="10/12/14" class="input"/></div>
          <div class="flex items-end gap-2"><input type="checkbox" id="md-restraints" checked class="w-5 h-5"/><label for="md-restraints" class="text-sm">Use Restraints</label></div>
        </div>
        <div class="grid grid-cols-2 gap-2 mt-3">
          <button id="generateMDFilesBtn" class="btn w-full">Generate Files</button>
          <button id="zipBtn" class="btn w-full" disabled>Download ZIP</button>
        </div>
        <div id="mdStatus" class="text-sm text-gray-600 mt-2"></div>
        <div id="fileList" class="mt-3 flex flex-col gap-2"></div>
      </div>
      <div>
        <h3 class="font-semibold mb-1">In-Browser Restraints PDB Builder</h3>
        <p class="text-sm text-gray-600">Backbone (N, CA, C, O) → B-factor 2.0; others 0.0.</p>
        <div class="grid grid-cols-3 gap-2 mt-2">
          <div class="col-span-2"><input type="file" id="md-pdb" accept=".pdb" class="input"/></div>
          <div class="flex items-end"><button id="buildRestraints" class="btn w-full">Generate</button></div>
        </div>
        <div id="restraintsStatus" class="text-sm text-gray-700 mt-3"></div>
      </div>
    </div>
  </section>

  <!-- Community (global feed + create post) -->
  <section id="community" class="glass panel section">
    <div class="flex items-center justify-between flex-wrap gap-2">
      <h2 class="text-xl font-bold">Community Feed</h2>
      <div class="flex items-center gap-2 w-full md:w-auto">
        <input id="searchInput" placeholder="Search by protein or SMILES…" class="input md:w-80"/>
        <select id="alphaFilter" class="input md:w-32"><option value="">All A–Z</option><option value="#num"># (0–9)</option><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option><option>H</option><option>I</option><option>J</option><option>K</option><option>L</option><option>M</option><option>N</option><option>O</option><option>P</option><option>Q</option><option>R</option><option>S</option><option>T</option><option>U</option><option>V</option><option>W</option><option>X</option><option>Y</option><option>Z</option></select>
        <button id="exportJsonBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Export DB (JSON)</button>
        <button id="exportCsvBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Export Posts (CSV)</button>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-4 mt-4">
      <!-- Create Post -->
      <div class="glass panel">
        <h3 class="font-semibold mb-2">Create a Post</h3>
        <div class="grid gap-2">
          <div><label class="block text-sm font-semibold">Post Type</label>
            <select id="postType" class="input">
              <option value="dock" selected>Docking Result</option>
              <option value="blog">Blog</option>
              <option value="discussion">Discussion</option>
            </select>
          </div>

          <div><label class="block text-sm font-semibold">Protein (Channel)</label>
            <input id="postProtein" placeholder="e.g., Mpro (SARS-CoV-2)" class="input"/>
            <p class="text-xs text-gray-600 mt-1">If the channel doesn’t exist it will be created.</p>
          </div>

          <div class="dock-only grid gap-2">
            <div><label class="block text-sm font-semibold">PDB ID (optional)</label><input id="postPdbId" placeholder="e.g., 6LU7" class="input"/></div>
            <div><label class="block text-sm font-semibold">Ligand (SMILES)</label><input id="postSmiles" placeholder="Paste SMILES" class="input"/></div>
            <div class="grid grid-cols-2 gap-2">
              <div><label class="block text-sm font-semibold">Docking ΔG (kcal/mol)</label><input id="postDG" type="number" step="0.01" class="input"/></div>
              <div><label class="block text-sm font-semibold">Mood / Framing</label>
                <select id="postMood" class="input">
                  <option>Inspired ✨</option><option>Constructive: Needs validation</option>
                  <option>Encouraging 👍</option><option>Curious 🤔</option>
                  <option>Grateful 🙏</option><option>Optimistic 🌱</option>
                </select></div>
            </div>
            <div><label class="block text-sm font-semibold">Notes (optional)</label><textarea id="postNotes" rows="3" class="input" placeholder="Key interactions, pocket features, next steps…"></textarea></div>
            <div class="grid grid-cols-2 gap-2">
              <button id="prefillFromDock" class="px-3 py-2 rounded-lg font-semibold bg-white">Use Current Dock</button>
              <button id="createPostBtn" class="btn">Post</button>
            </div>
          </div>

          <div class="non-dock-only hidden grid gap-2">
            <div><label class="block text-sm font-semibold">Title</label><input id="postTitle" class="input" placeholder="Write a clear title"/></div>
            <div><label class="block text-sm font-semibold">Content</label><textarea id="postContent" rows="6" class="input" placeholder="Educational content, blog, or discussion…"></textarea></div>
            <div class="grid grid-cols-2 gap-2">
              <button id="createNonDockBtn" class="btn">Publish</button>
              <button id="clearNonDockBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Feed -->
      <div class="lg:col-span-2">
        <div id="feedGrid" class="feed-grid"></div>
        <div id="emptyFeed" class="text-center text-sm text-white/90 mt-6 hidden">No posts yet—share your first result.</div>
      </div>
    </div>
  </section>

  <!-- Channels (protein pages) -->
  <section id="channels" class="glass panel section">
    <div class="flex items-center justify-between flex-wrap gap-2">
      <h2 class="text-xl font-bold">Protein Channels</h2>
      <input id="channelSearch" placeholder="Search channels…" class="input md:w-80"/>
    </div>
    <div id="channelList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-3"></div>
    <div id="channelEmpty" class="text-white/90 text-sm mt-6 hidden">No channels yet. Create a docking post to start a channel.</div>

    <div id="channelView" class="glass panel mt-6 hidden">
      <div class="flex items-center justify-between">
        <div>
          <h3 id="chName" class="text-lg font-bold"></h3>
          <div id="chMeta" class="text-sm text-gray-600"></div>
        </div>
        <a id="chHash" class="hash" href="#">Link</a>
      </div>

      <h4 class="font-semibold mt-4 mb-2">Docking Entries</h4>
      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-gray-600"><th class="py-1">Date</th><th>PDB</th><th>SMILES</th><th>ΔG</th><th>User</th></tr>
          </thead>
          <tbody id="chTable"></tbody>
        </table>
      </div>

      <h4 class="font-semibold mt-5 mb-2">Recent Posts</h4>
      <div id="chFeed" class="feed-grid"></div>
    </div>
  </section>

  <!-- Publications -->
  <section id="pub" class="glass panel section">
    <h2 class="text-xl font-bold mb-2">Publications</h2>
    <div class="grid lg:grid-cols-3 gap-4">
      <div class="glass panel">
        <h3 class="font-semibold mb-2">Create New Entry</h3>
        <label class="block text-sm font-semibold">Title</label><input id="pub-title" class="input" placeholder="In Silico Analysis of…"/>
        <label class="block text-sm font-semibold mt-2">Authors</label><input id="pub-authors" class="input" placeholder="Ferguson, D., et al."/>
        <label class="block text-sm font-semibold mt-2">Abstract / Key Findings</label><textarea id="pub-abstract" rows="5" class="input"></textarea>
        <button id="pubSubmit" class="btn w-full mt-3">Submit</button>
        <div id="pubError" class="text-sm text-rose-700 mt-2"></div>
      </div>
      <div class="lg:col-span-2">
        <div id="pub-list" class="grid gap-3"></div>
        <div id="pub-empty" class="glass panel text-center hidden">No publications yet.</div>
      </div>
    </div>
  </section>

  <!-- Learning -->
  <section id="learn" class="glass panel section">
    <h2 class="text-xl font-bold mb-2">Learning Center</h2>
    <div class="flex flex-wrap gap-2">
      <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="pbpk">PBPK Basics</button>
      <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="docking">Docking</button>
      <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="md">MD Setup</button>
      <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="threeplus">3+3 Design</button>
      <button class="px-3 py-2 rounded-lg font-semibold bg-white learn" data-learn="community">Community Etiquette</button>
    </div>
    <div id="tutorialBox" class="glass panel mt-3 bg-white/70"></div>
  </section>
</main>

<!-- Profile Modal (reddit-like local sign up) -->
<div id="profileModal" class="fixed inset-0 hidden items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="relative glass p-4 w-full max-w-md">
    <h3 class="font-bold text-lg mb-2">Sign Up / Sign In</h3>
    <p class="text-xs text-gray-600 -mt-1 mb-3">Local-only (stored in your browser).</p>
    <label class="block text-sm font-semibold">Username</label>
    <input id="authUser" class="input" placeholder="e.g., ligand_lover"/>
    <label class="block text-sm font-semibold mt-2">Password</label>
    <input id="authPass" type="password" class="input" placeholder="••••••••"/>
    <label class="block text-sm font-semibold mt-2">Avatar URL (optional)</label>
    <input id="authAvatar" class="input" placeholder="https://…"/>
    <div class="grid grid-cols-2 gap-2 mt-3">
      <button id="signInBtn" class="btn">Sign In</button>
      <button id="signUpBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Create Account</button>
    </div>
    <div class="grid grid-cols-2 gap-2 mt-2">
      <button id="closeProfileBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Cancel</button>
      <button id="signOutBtn" class="px-3 py-2 rounded-lg font-semibold bg-white">Sign Out</button>
    </div>
    <div id="authMsg" class="text-sm mt-2"></div>
  </div>
</div>

<script>
/* ===== Shortcuts ===== */
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const hexToRgba=(h,a)=>{const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);if(!m)return h;const r=parseInt(m[1],16),g=parseInt(m[2],16),b=parseInt(m[3],16);return`rgba(${r}, ${g}, ${b}, ${a})`}
const escapeHtml=s=>String(s).replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))
const trapz=(x,y)=>{let A=0;for(let i=1;i<x.length;i++)A+=0.5*(y[i]+y[i-1])*(x[i]-x[i-1]);return A}

/* ===== Keys / DB ===== */
const K_USERS='ps_users_v1', K_SESSION='ps_session_v1';
const K_CHANNELS='ps_channels_v1', K_POSTS='ps_posts_v1', K_IDX='pharmsim_alpha_index_v1';
const userdb=()=>JSON.parse(localStorage.getItem(K_USERS)||'[]');
const saved=(k)=>JSON.parse(localStorage.getItem(k)||'[]');
const slugify=s=>s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

/* ===== Global state ===== */
let viewer, rdkit, proteinModel=null, ligandModel=null, pocketResidues=[], pocketCenter=null;
let charts={}, generatedMDFiles={}, latestDock={proteinName:'',pdbId:'',smiles:'',dG:null}, pdbFileFromDrop=null;

/* ===== UI helpers ===== */
function setStatus(msg,kind='warn'){const b=$('#statusBadge'); b.textContent=msg; b.classList.remove('hidden','warn','pos','err','info'); b.classList.add(kind==='ok'?'pos':kind)}
function showSection(id){ $$('.section').forEach(s=>s.classList.remove('active')); $('#'+id).classList.add('active');
  $$('.nav-tab').forEach(b=>{ const on=b.dataset.t===id; b.classList.toggle('bg-white',!on); b.classList.toggle('text-white',on);
    b.classList.toggle('bg-[linear-gradient(135deg,#2a5298,#1e3c72)]',on) }) }

/* ===== Auth (reddit-like: local users, username+password) ===== */
function openProfile(){const s=JSON.parse(localStorage.getItem(K_SESSION)||'null'); $('#authMsg').textContent=''; if(s){$('#authUser').value=s.username;$('#authAvatar').value=s.avatar||''}
  $('#profileModal').classList.remove('hidden');$('#profileModal').classList.add('flex')}
function closeProfile(){$('#profileModal').classList.add('hidden');$('#profileModal').classList.remove('flex')}
function setSession(u){localStorage.setItem(K_SESSION,JSON.stringify(u)); $('#profileBtn').textContent=u.username; closeProfile()}
function signUp(){const username=$('#authUser').value.trim(), pass=$('#authPass').value, avatar=$('#authAvatar').value.trim();
  if(!username||!pass){$('#authMsg').textContent='Provide username & password.';$('#authMsg').className='text-rose-700 text-sm';return}
  const users=userdb(); if(users.find(u=>u.username===username)){ $('#authMsg').textContent='Username already exists.';$('#authMsg').className='text-rose-700 text-sm';return}
  users.push({id:crypto.randomUUID(),username,pass,avatar}); localStorage.setItem(K_USERS,JSON.stringify(users)); setSession({username,avatar}); $('#authMsg').textContent='Account created.';$('#authMsg').className='text-green-700 text-sm'}
function signIn(){const username=$('#authUser').value.trim(), pass=$('#authPass').value; const users=userdb(); const u=users.find(u=>u.username===username&&u.pass===pass);
  if(!u){$('#authMsg').textContent='Invalid credentials.';$('#authMsg').className='text-rose-700 text-sm';return} setSession({username:u.username,avatar:u.avatar})}
function signOut(){localStorage.removeItem(K_SESSION); $('#profileBtn').textContent='Sign In'; closeProfile()}

/* ===== Channels & Posts ===== */
function getSession(){return JSON.parse(localStorage.getItem(K_SESSION)||'null')}
function upsertChannel(name){const channels=saved(K_CHANNELS); const slug=slugify(name||''); if(!slug) return null; let c=channels.find(x=>x.slug===slug);
  if(!c){const s=getSession(); c={id:crypto.randomUUID(),slug,name,description:'',createdBy:s?.username||'anon',createdAt:Date.now()}; channels.push(c); localStorage.setItem(K_CHANNELS,JSON.stringify(channels))}
  return c}
function addPost(post){const posts=saved(K_POSTS); posts.push(post); localStorage.setItem(K_POSTS,JSON.stringify(posts))}
function readPosts(){return saved(K_POSTS)}
function savePosts(arr){localStorage.setItem(K_POSTS,JSON.stringify(arr)); buildAlphaIndex(arr)}
function buildAlphaIndex(arr){const idx={}; for(const p of arr){const ch=(p.proteinName||'').trim()[0]||'#'; const key=/[A-Za-z]/.test(ch)?ch.toUpperCase():'#'; (idx[key]=idx[key]||[]).push(p.id)}
  localStorage.setItem(K_IDX,JSON.stringify(idx))}

/* ===== Community feed ===== */
function renderPostCard(p){const card=document.createElement('div'); card.className='feed-card'; const mood=p.mood?.includes('Constructive')?'warn':'pos'; const svg=p.svg?.length?p.svg:'';
  const ch=saved(K_CHANNELS).find(c=>c.id===p.channelId); const chLink=ch?`<a class="hash" href="#/p/${ch.slug}">#${escapeHtml(ch.name)}</a>`:'';
  const user=p.user||{username:'Anonymous',avatar:'https://i.pravatar.cc/40'};
  card.innerHTML=`<div class="flex items-start justify-between gap-3">
    <div><div class="text-sm text-gray-600">${chLink} · ${escapeHtml(user.username||'')}</div>
    <h4 class="font-semibold text-lg">${escapeHtml(p.title||p.proteinName||'Untitled')}</h4>
    <div class="flex flex-wrap gap-2 mt-1">
      ${p.pdbId?`<span class="chip info">PDB ${escapeHtml(p.pdbId)}</span>`:''}
      ${p.type==='dock'?`<span class="chip ${mood}">ΔG ${p.dG!=null?p.dG:'--'}</span>`:''}
      ${p.type!=='dock'?`<span class="chip info">${p.type}</span>`:''}
    </div></div>
    <img src="${user.avatar||'https://i.pravatar.cc/40'}" class="w-10 h-10 rounded-full" alt="avatar"/></div>
    ${p.type==='dock'?`
      <div class="mt-3 grid grid-cols-2 gap-3">
        <div class="text-xs break-all"><span class="font-semibold">SMILES:</span><br>${escapeHtml(p.smiles||'')}</div>
        <div class="border rounded-lg p-1 bg-white">${svg||'<div class="text-xs text-gray-500 p-2">2D preview unavailable</div>'}</div>
      </div>
      ${p.notes?`<p class="text-sm mt-3 whitespace-pre-wrap">${escapeHtml(p.notes)}</p>`:''}
    `:`
      <p class="text-sm mt-3 whitespace-pre-wrap">${escapeHtml(p.content||'')}</p>
    `}
    <div class="text-xs text-gray-500 mt-2">${new Date(p.createdAt).toLocaleString()}</div>`;
  return card}
function refreshFeed(){const q=($('#searchInput').value||'').toLowerCase(), alpha=$('#alphaFilter').value, posts=readPosts();
  let f=posts.filter(p=>{
    const s1=(p.proteinName||'').toLowerCase().includes(q);
    const s2=(p.smiles||'').toLowerCase().includes(q);
    const s3=(p.title||'').toLowerCase().includes(q);
    return s1||s2||s3;
  });
  if(alpha){f=f.filter(p=>{const ch=(p.proteinName||'').trim()[0]||'#'; const key=/[A-Za-z]/.test(ch)?ch.toUpperCase():'#'; return alpha===''?true:(alpha==='#num'?key==='#':key===alpha)})}
  f.sort((a,b)=>b.createdAt-a.createdAt);
  const grid=$('#feedGrid'); grid.innerHTML=''; f.forEach(p=>grid.appendChild(renderPostCard(p))); $('#emptyFeed').classList.toggle('hidden',!!f.length)}

/* ===== Channel list & view ===== */
function renderChannelCard(ch){const posts=readPosts().filter(p=>p.channelId===ch.id);
  const docks=posts.filter(p=>p.type==='dock'); const best=docks.length?docks.reduce((a,b)=> (a.dG??999)<(b.dG??999)?a:b):null;
  const card=document.createElement('div'); card.className='feed-card'; card.innerHTML=`<div class="flex items-center justify-between">
      <a class="hash" href="#/p/${ch.slug}"><h3 class="font-semibold text-lg">#${escapeHtml(ch.name)}</h3></a>
      <span class="chip info">${posts.length} posts</span>
    </div>
    <div class="text-sm text-gray-600">Started by ${escapeHtml(ch.createdBy)} · ${new Date(ch.createdAt).toLocaleDateString()}</div>
    <div class="mt-2 text-sm">${best?`Best ΔG: <strong>${best.dG}</strong> (PDB ${best.pdbId||'—'})`:'No docking yet.'}</div>`;
  return card}
function refreshChannelList(){const q=($('#channelSearch').value||'').toLowerCase(); const channels=saved(K_CHANNELS).filter(c=>c.name.toLowerCase().includes(q));
  const list=$('#channelList'); list.innerHTML=''; channels.sort((a,b)=>a.name.localeCompare(b.name)); channels.forEach(c=>list.appendChild(renderChannelCard(c))); $('#channelEmpty').classList.toggle('hidden',!!channels.length)}
function openChannelBySlug(slug){const channels=saved(K_CHANNELS); const ch=channels.find(c=>c.slug===slug); if(!ch){alert('Channel not found'); return}
  $('#chName').textContent='#'+ch.name; $('#chMeta').textContent=`Created by ${ch.createdBy} · ${new Date(ch.createdAt).toLocaleString()}`; $('#chHash').href=`#/p/${ch.slug}`;
  const posts=readPosts().filter(p=>p.channelId===ch.id).sort((a,b)=>b.createdAt-a.createdAt);
  // table
  const tb=$('#chTable'); tb.innerHTML=''; posts.filter(p=>p.type==='dock').forEach(p=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td class="py-1">${new Date(p.createdAt).toLocaleDateString()}</td><td>${p.pdbId||''}</td><td class="break-all">${escapeHtml(p.smiles||'')}</td><td>${p.dG==null?'':p.dG}</td><td>${escapeHtml(p.user?.username||'')}</td>`; tb.appendChild(tr)
  });
  // feed
  const feed=$('#chFeed'); feed.innerHTML=''; posts.slice(0,12).forEach(p=>feed.appendChild(renderPostCard(p)));
  $('#channelView').classList.remove('hidden'); showSection('channels')}

/* ===== Docking engine (heuristic) ===== */
function updateModelInfo(){const m={balanced:"Balances size, H-bonding, hydrophobics, flexibility.",hbond:"Rewards donors/acceptors; good for polar pockets.",hydrophobic:"Rewards nonpolar fit; penalizes excess polarity."};$('#modelInfoText').textContent=m[$('#scoringModel').value]||''}
const getModelAtoms=m=>(typeof m?.selectedAtoms==='function'&&m.selectedAtoms({}))||(typeof m?.getAtoms==='function'&&m.getAtoms())||(Array.isArray(m?.atoms)&&m.atoms)||[]
const centroid=L=>{let x=0,y=0,z=0;for(const a of L){x+=a.x;y+=a.y;z+=a.z}const n=Math.max(1,L.length);return{x:x/n,y:y/n,z:z/n}}
function findPocketResidues(at){if(!at.length)return[];const R={};for(const a of at){const k=a.resi??a.resn??'0';(R[k]=R[k]||[]).push(a)}let best=null,bN=-1;
  for(const [resi,alist] of Object.entries(R)){const c=centroid(alist);let n=0;for(const a of at){const dx=a.x-c.x,dy=a.y-c.y,dz=a.z-c.z;if(dx*dx+dy*dy+dz*dz<100)n++}if(n>bN){bN=n;best=resi}}
  if(!best)return[];const core=R[best],c=centroid(core),res=new Set();for(const a of at){const dx=a.x-c.x,dy=a.y-c.y,dz=a.z-c.z;if(dx*dx+dy*dy+dz*dz<100)res.add(a.resi??a.resn??'0')}return[...res]}
const centroidOfResidues=(at,list)=>{if(!list?.length)return null;const pick=at.filter(a=>list.includes(a.resi??a.resn??'0'));return pick.length?centroid(pick):null}
function bindingContrib(l,t='balanced'){const M={balanced:{I:-1.5,V:-0.035,H:-0.7,Hy:-0.25,R:0.3},hbond:{I:-1.0,V:-0.030,H:-1.2,Hy:-0.15,R:0.3},hydrophobic:{I:-1.2,V:-0.040,H:-0.5,Hy:-0.45,R:0.25}}[t];const hb=Math.min(l.hDonors,l.hAcceptors);return{intercept:M.I,vdw:M.V*l.numHeavyAtoms,hbond:M.H*hb,hydrophobic:M.Hy*l.logp,rotational:M.R*l.numRotatableBonds}}
function scoreAndDisplay(l){const base=bindingContrib(l,$('#scoringModel').value);const prot=getModelAtoms(proteinModel),lat=getModelAtoms(ligandModel);
  const het=new Set(['N','O','S']);let contacts=0,clashes=0;for(const la of lat){for(const pa of prot){const dx=la.x-pa.x,dy=la.y-pa.y,dz=la.z-pa.z,r2=dx*dx+dy*dy+dz*dz;if(r2<3.5*3.5&&het.has(pa.elem))contacts++;if(r2<1.8*1.8)clashes++}}
  const total=Object.values(base).reduce((s,v)=>s+v,0)+(-0.15*Math.min(contacts,50))+(0.4*Math.min(clashes,25));
  $('#aff').textContent=total.toFixed(2);$('#vdw_contrib').textContent=base.vdw.toFixed(2);$('#hbond_contrib').textContent=base.hbond.toFixed(2);
  $('#hydro_contrib').textContent=base.hydrophobic.toFixed(2);$('#rot_contrib').textContent=base.rotational.toFixed(2);$('#contacts').textContent=String(contacts);$('#clashes').textContent=String(clashes);
  latestDock.dG=Number(total.toFixed(2))}
function addLigandToViewer(molblock){if(ligandModel)try{viewer.removeModel(ligandModel)}catch{};ligandModel=viewer.addModel(molblock,'sdf');ligandModel.setStyle({}, {stick:{radius:0.22}})}
function addLigandToViewer(molblock){
  if(ligandModel) try{viewer.removeModel(ligandModel);}catch(e){}
  ligandModel=viewer.addModel(molblock,'sdf');
  ligandModel.setStyle({}, {stick:{radius:0.22}});
  viewer.zoomTo();viewer.render();
}

function loadProteinFromText(txt){
  if(proteinModel)try{viewer.removeModel(proteinModel);}catch(e){}
  proteinModel=viewer.addModel(txt,'pdb');
  proteinModel.setStyle({hetflag:false},{cartoon:{color:'spectrum'}});
  viewer.zoomTo();viewer.render();
  const at=getModelAtoms(proteinModel);
  pocketResidues=findPocketResidues(at); pocketCenter=centroidOfResidues(at,pocketResidues);
  $('#dockBtn').disabled=false; $('#centerBtn').disabled=false;
}

function wirePdbDropZone(){
  const dz=$('#pdbDrop');if(!dz)return;
  ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{
    e.preventDefault();e.stopPropagation();dz.classList.add('ring-2','ring-indigo-400');
  }));
  ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{
    e.preventDefault();e.stopPropagation();dz.classList.remove('ring-2','ring-indigo-400');
  }));
  dz.addEventListener('drop',async e=>{
    const file=e.dataTransfer?.files?.[0];
    if(file&&file.name.toLowerCase().endsWith('.pdb')){
      pdbFileFromDrop=file;
      dz.innerHTML=`<div class="font-semibold text-indigo-700">Ready: ${file.name}</div>
      <div class="text-xs text-gray-600">Click “Load Local PDB” to display</div>`;
    }else{
      dz.innerHTML=`<div class="font-semibold text-rose-700">Not a .pdb file</div>
      <div class="text-xs text-gray-600">Please drop a valid PDB</div>`;
    }
  });
}

async function loadLocalPdb(){
  const input=$('#pdbFile');
  const file=pdbFileFromDrop||input.files?.[0];
  if(!file){alert('Choose or drop a .pdb file first.');return}
  const txt=await file.text();
  loadProteinFromText(txt);pdbFileFromDrop=null;
  $('#pdbDrop').innerHTML=`<div class="font-semibold text-green-700">Loaded: ${file.name}</div>
  <div class="text-xs text-gray-600">You can drop a new file to replace it</div>`;
}

async function fetchPdb(){
  const id=$('#pdbId').value.trim();
  if(!id)return;
  const r=await fetch(`https://files.rcsb.org/download/${id}.pdb`);
  if(!r.ok){alert('Could not fetch PDB');return}
  const txt=await r.text();
  loadProteinFromText(txt);
}

function useExampleSmiles(){
  const sel=$('#exampleSmiles');
  if(sel&&sel.value)$('#smiles').value=sel.value;
}

function runDock(){
  if(!ligandModel||!proteinModel)return;
  // ligand props stub
  const lig={numHeavyAtoms:25,hDonors:2,hAcceptors:3,logp:2.5,numRotatableBonds:3};
  scoreAndDisplay(lig);
}

function prefillFromDock(){
  $('#postProtein').value=latestDock.proteinName||'';
  $('#postPdbId').value=latestDock.pdbId||'';
  $('#postSmiles').value=latestDock.smiles||'';
  $('#postDG').value=latestDock.dG||'';
}

function createDockPost(){
  const sess=getSession();if(!sess){alert('Sign in first');return}
  const proteinName=$('#postProtein').value.trim();
  if(!proteinName){alert('Enter protein name');return}
  const channel=upsertChannel(proteinName);
  const p={
    id:crypto.randomUUID(),
    type:'dock',
    channelId:channel.id,
    proteinName,
    pdbId:$('#postPdbId').value.trim(),
    smiles:$('#postSmiles').value.trim(),
    dG:parseFloat($('#postDG').value)||null,
    mood:$('#postMood').value,
    notes:$('#postNotes').value,
    user:sess,
    createdAt:Date.now()
  };
  addPost(p);refreshFeed();refreshChannelList();alert('Posted!');
}

function createNonDockPost(){
  const sess=getSession();if(!sess){alert('Sign in first');return}
  const proteinName=$('#postProtein').value.trim();
  const channel=upsertChannel(proteinName||'General');
  const p={
    id:crypto.randomUUID(),
    type:$('#postType').value,
    channelId:channel.id,
    proteinName:proteinName||'General',
    title:$('#postTitle').value,
    content:$('#postContent').value,
    user:sess,
    createdAt:Date.now()
  };
  addPost(p);refreshFeed();refreshChannelList();alert('Published!');
}

document.addEventListener('DOMContentLoaded',()=>{
  viewer=$3Dmol.createViewer('viewer',{backgroundColor:'#eef2f7'});
  updateModelInfo();setStatus('Libraries ready. RDKit initialized.','ok');
  wirePdbDropZone();
  $('#loadLocalPdbBtn').addEventListener('click',loadLocalPdb);
  $('#fetchPdbBtn').addEventListener('click',fetchPdb);
  $('#useExampleBtn').addEventListener('click',useExampleSmiles);
  $('#dockBtn').addEventListener('click',runDock);
  $('#prefillFromDock').addEventListener('click',prefillFromDock);
  $('#createPostBtn').addEventListener('click',createDockPost);
  $('#createNonDockBtn').addEventListener('click',createNonDockPost);
  $('#profileBtn').addEventListener('click',openProfile);
  $('#closeProfileBtn').addEventListener('click',closeProfile);
  $('#signUpBtn').addEventListener('click',signUp);
  $('#signInBtn').addEventListener('click',signIn);
  $('#signOutBtn').addEventListener('click',signOut);
  $$('.nav-tab').forEach(b=>b.addEventListener('click',()=>showSection(b.dataset.t)));
  refreshFeed();refreshChannelList();
  window.addEventListener('hashchange',()=>{
    const m=location.hash.match(/#\/p\/(.+)/);if(m)openChannelBySlug(m[1]);
  });
});
</script>
</body>
</html>




