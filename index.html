<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Antibody‚ÄìAntigen Studio ‚Ä¢ TriPredict (3 folds) ‚Ä¢ Parallel Docking ‚Ä¢ In‚ÄëBrowser 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0f172a" />
<meta name="description" content="Client‚Äëside TriPredict folding (3 theoretical models) ‚Ä¢ parallel antibody‚Äìantigen docking with in‚Äëbrowser 3D viewer ‚Ä¢ interface analytics ‚Ä¢ audit/reproducibility ‚Äî one HTML file." />
<style>
 :root{--bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--line:#1f2937;--green:#34d399;--red:#f87171;--yellow:#fbbf24;--mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;--sans:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
 *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:var(--sans);line-height:1.6}
 a{color:var(--accent)} header{padding:40px 16px;background:radial-gradient(1200px 600px at 15% -10%,#1d2a4a,transparent 60%),radial-gradient(1000px 500px at 120% 10%,#2a1e4a,transparent 60%)}
 .wrap{max-width:1280px;margin:0 auto} h1{margin:0 0 8px;font-size:32px} p.lead{color:var(--muted);margin:6px 0 0}
 section{padding:22px 16px;border-top:1px solid var(--line);background:var(--panel)} h2{margin:0 0 10px;font-size:24px} h3{margin:14px 0 6px;font-size:18px}
 .grid{display:grid;gap:16px} @media(min-width:980px){.grid{grid-template-columns:1.1fr .9fr}}
 .card{background:#0b1220;border:1px solid var(--line);border-radius:14px;padding:14px}
 .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
 label{font-weight:600}
 input[type=number],input[type=text],textarea,select{background:#0a0f1a;color:var(--text);border:1px solid #1f2937;border-radius:8px;padding:8px 10px;font-family:var(--mono);font-size:13px;min-width:80px}
 textarea{width:100%;min-height:120px}
 .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:10px;font-weight:600;border:1px solid var(--line);background:#0b1220;cursor:pointer}
 .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:0} .btn.green{background:linear-gradient(180deg,#059669,#047857);border:0} .btn.red{background:linear-gradient(180deg,#dc2626,#b91c1c);border:0} .btn[disabled]{opacity:.5;cursor:not-allowed}
 .muted{color:var(--muted)} .small{font-size:12px;color:var(--muted)} .pill{padding:2px 8px;border:1px solid #334155;border-radius:999px;font-size:12px;color:#93c5fd}
 .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px} .tabbtn{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#0b1220;cursor:pointer} .tabbtn.active{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:0}
 .tabsec{display:none} .tabsec.active{display:block}
 .two{display:grid;gap:12px} @media(min-width:780px){.two{grid-template-columns:1fr 1fr}}
 .trigrid{display:grid;gap:12px} @media(min-width:980px){.trigrid{grid-template-columns:1fr 1fr 1fr}}
 .score{font-family:var(--mono);background:#0a0f1a;border:1px solid var(--line);border-radius:8px;padding:8px;overflow:auto}
 .warn{border-left:4px solid var(--yellow);padding-left:10px;margin:10px 0;color:#fbbf24}
 .chainchips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px} .chainchip{border:1px solid #334155;border-radius:999px;padding:2px 8px;display:inline-flex;align-items:center;gap:6px} .chainchip input{accent-color:#60a5fa}
 progress{width:260px;height:10px;border:1px solid #1f2937;border-radius:999px;background:#0b1220}
 progress::-webkit-progress-bar{background:#0b1220;border-radius:999px} progress::-webkit-progress-value{background:#60a5fa;border-radius:999px}
 #viewer,#seqViewer,.triview{position:relative;width:100%;border:1px solid var(--line);border-radius:10px;background:#0a0f1a;overflow:hidden}
 #viewer{height:560px} #seqViewer,.triview{height:260px}
 .stepnav{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0} .stepnav .step{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b1220} .stepnav .step.active{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:0}
 .infobox,.errorbox{border-radius:10px;padding:10px;margin-top:8px} .infobox{border:1px solid #334155;background:#0a0f1a;color:#cbd5e1} .errorbox{border:1px solid #7f1d1d;background:#1a0c0c;color:#fecaca}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>In‚ÄëBrowser Antibody‚ÄìAntigen Studio</h1>
    <p class="lead">TriPredict (3 theoretical folds) ‚Ä¢ parallel docking ‚Ä¢ vdW/contact/electrostatics ‚Ä¢ diversity clustering ‚Ä¢ in‚Äëpage 3D viewer ‚Ä¢ audit & reproducibility</p>
    <div class="tabs">
      <button class="tabbtn active" data-tab="dockTab">üß∑ Docking</button>
      <button class="tabbtn" data-tab="triTab">üß™ TriPredict (3 folds)</button>
      <button class="tabbtn" data-tab="seqTab">üß¨ Sequence ‚Üí PDB</button>
    </div>
  </div>
</header>

<!-- Docking Tab -->
<section id="dockTab" class="tabsec active">
  <div class="wrap grid">
    <div class="card">
      <h2>Step 1 ‚Ä¢ Load Proteins</h2>
      <div class="two">
        <div>
          <h3>Protein A (e.g., antibody)</h3>
          <div class="row"><input type="file" id="pdbAFile" accept=".pdb,.ent,.txt,.pdb.gz" /><button class="btn" onclick="useExample('A')">Use example</button></div>
          <textarea id="pdbAText" placeholder="Paste PDB text for Protein A (optional)"></textarea>
          <div class="row"><label>Chains</label><div id="chainsABox" class="chainchips"></div></div>
          <div id="chainWarnA" class="infobox small">Load/Paste then pick chains (default = all).</div>
          <div class="row" style="margin-top:6px"><button class="btn" onclick="parseOne('A')">üîé Parse & Preview A</button><button class="btn" onclick="selectAllChains('A')">Select all</button><button class="btn" onclick="clearChains('A')">Clear</button></div>
          <input type="text" id="chainsA" style="display:none" />
        </div>
        <div>
          <h3>Protein B (e.g., antigen)</h3>
          <div class="row"><input type="file" id="pdbBFile" accept=".pdb,.ent,.txt,.pdb.gz" /><button class="btn" onclick="useExample('B')">Use example</button></div>
          <textarea id="pdbBText" placeholder="Paste PDB text for Protein B (optional)"></textarea>
          <div class="row"><label>Chains</label><div id="chainsBBox" class="chainchips"></div></div>
          <div id="chainWarnB" class="infobox small">Load/Paste then pick chains (default = all).</div>
          <div class="row" style="margin-top:6px"><button class="btn" onclick="parseOne('B')">üîé Parse & Preview B</button><button class="btn" onclick="selectAllChains('B')">Select all</button><button class="btn" onclick="clearChains('B')">Clear</button></div>
          <input type="text" id="chainsB" style="display:none" />
        </div>
      </div>
      <div class="stepnav"><span class="step active" id="stepLoad">1 ‚Ä¢ Load</span><span class="step" id="stepParams">2 ‚Ä¢ Parameters</span><span class="step" id="stepRun">3 ‚Ä¢ Run</span></div>
      <div class="row"><button class="btn primary" id="toParamsBtn" onclick="gotoDockStep(2)" disabled>Next: Parameters ‚ñ∂</button><button class="btn" onclick="resetAll()">Reset</button></div>
      <details style="margin-top:10px"><summary>About formats</summary><p class="muted">Docking expects PDB (optionally <code>.pdb.gz</code>). SMILES isn‚Äôt suitable for whole proteins.</p></details>
    </div>

    <div class="card">
      <h2>Step 2 ‚Ä¢ Docking Parameters</h2>
      <div class="row"><label>Samples</label><input type="number" id="samples" value="16000" min="500" step="100" /><label>Max Œî (√Ö)</label><input type="number" id="maxTrans" value="12" min="0" step="1" />
        <label>Atom selection</label><select id="atomMode"><option value="CA">CŒ± only (fast)</option><option value="BB">Backbone</option><option value="HEAVY">All heavy atoms</option></select></div>
      <div class="row"><label>Contact cutoff (√Ö)</label><input type="number" id="contactCut" value="4.8" step="0.1" /><label>Clash factor</label><input type="number" id="clashFactor" value="0.85" step="0.05" />
        <label>Contact weight</label><input type="number" id="wContact" value="1.0" step="0.1" /><label>Clash penalty</label><input type="number" id="wClash" value="6.0" step="0.1" /><label>Softening</label><input type="number" id="soft" value="0.5" step="0.1" /></div>
      <div class="row"><label>Top poses</label><input type="number" id="topN" value="20" min="1" max="100" /><label>Rescore</label><select id="rescoreMode"><option value="NONE">Skip</option><option value="HEAVY">Heavy atoms</option><option value="HEAVY_REFINE" selected>Heavy + micro‚Äërefine</option></select><label>Seed</label><input type="number" id="seed" value="42" /></div>
      <div class="row"><label>Diversity (¬∞/√Ö)</label><input type="number" id="dupAngle" value="10" step="1" title="Max rotation angle difference (¬∞)" /><input type="number" id="dupTrans" value="2" step="0.5" title="Max translation difference (√Ö)" /><span class="small">Filters near‚Äëduplicates for diverse top poses</span></div>
      <div class="row" style="margin-top:8px"><label class="row"><input type="checkbox" id="fdaMode"> FDA‚Äëstyle reproducibility mode</label>
        <span class="small">Locks seeds, logs metadata, prompts audit export.</span></div>
      <div class="row" style="margin-top:8px"><button class="btn primary" id="dockBtn" onclick="runDocking()">‚ñ∂Ô∏è Run Docking</button><button class="btn red" id="cancelBtn" onclick="cancelDocking()" disabled>‚úñ Cancel</button><span class="pill" id="statusPill">idle</span><progress id="prog" value="0" max="1"></progress></div>
      <p class="small muted">Score = contacts ‚àí vdW‚Äëaware clash penalty (HB/SB/electrostatics in report). Heavy re‚Äëscore improves ranking; micro‚Äërefine jitters best transforms.</p>
      <div id="perfWarn" class="warn" style="display:none"></div>
    </div>
  </div>
</section>

<section class="tabsec active" id="dockResults">
  <div class="wrap grid">
    <div class="card">
      <h2>Step 3 ‚Ä¢ Results & 3D Viewer</h2>
      <div id="viewer"></div>
      <div class="row" style="margin-top:6px;flex-wrap:wrap" id="poseControls"></div>
      <div class="row" style="margin-top:6px"><button class="btn green" onclick="downloadAllPoses()">‚¨á Multi‚Äëmodel PDB (top N)</button><button class="btn" onclick="downloadCSV()">‚¨á Summary CSV</button><button class="btn" onclick="downloadJSON()">‚¨á Interface JSON</button><button class="btn" onclick="snapshotPNG()">üì∏ PNG Snapshot</button><button class="btn" onclick="exportAuditZip()">‚¨á Audit Bundle (.zip)</button></div>
      <div class="row" style="margin-top:6px"><label class="row"><input type="checkbox" id="toggleContacts" onchange="refreshOverlays()"> Contacts</label><label class="row"><input type="checkbox" id="toggleHB" onchange="refreshOverlays()"> H‚Äëbonds</label><label class="row"><input type="checkbox" id="toggleSB" onchange="refreshOverlays()"> Salt bridges</label></div>
      <div class="score" id="scoreBox" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>Interface Metrics</h2>
      <ul class="small"><li><b>Contacts:</b> atom pairs within contact cutoff.</li><li><b>H‚Äëbonds:</b> N‚Ä¶O < 3.5 √Ö (geometric proxy).</li><li><b>Salt bridges:</b> (Asp/Glu O*)‚Äì(Lys/Arg/His N*) < 4.0 √Ö.</li><li><b>Hydrophobic contacts:</b> C‚Ä¶C < 4.5 √Ö between hydrophobic residues.</li><li><b>Electrostatics:</b> residue‚Äëlevel Coulomb (q‚àà{‚àí1,0,+1,+0.1 for HIS}) within 12 √Ö; scaled by k<sub>elec</sub>.</li><li><b>BSA proxy:</b> ~10 √Ö¬≤ per contact (educational).</li></ul>
      <div class="row"><label>k<sub>elec</sub></label><input type="number" id="kElec" value="0.5" step="0.1" /><label>Elec cutoff (√Ö)</label><input type="number" id="elecCut" value="12" step="0.5" /></div>
      <h3 style="margin-top:12px">Run Metadata (optional)</h3>
      <div class="two"><div class="row"><label>Study/Run ID</label><input type="text" id="metaStudy" placeholder="e.g., PK‚Äë001" /></div><div class="row"><label>Species</label><input type="text" id="metaSpecies" placeholder="e.g., Cyno" /></div><div class="row"><label>Dose (mg/kg)</label><input type="number" id="metaDose" value="0" step="0.1" /></div><div class="row"><label>Regimen</label><input type="text" id="metaRegimen" placeholder="e.g., QW x 4" /></div></div>
      <p class="small muted">Included in Audit Bundle for reproducibility. Not used in scoring.</p>
    </div>
  </div>
</section>

<!-- TriPredict (3 folds) -->
<section id="triTab" class="tabsec">
  <div class="wrap">
    <div class="card">
      <h2>TriPredict ‚Äî three theoretical folds from one sequence <span class="small">(AlphaFold‚Äëinspired, not AlphaFold)</span></h2>
      <div class="two">
        <div>
          <h3>Input</h3>
          <label>Protein Sequence (one‚Äëletter; FASTA ok)</label>
          <textarea id="triSeq" placeholder=">optional header
EVQLVESGGGLVQPGGSLRLSC..."></textarea>
          <div class="row"><input type="file" id="triFASTA" accept=".fasta,.fa,.txt" /><button class="btn" onclick="triLoadFASTA()">Load FASTA</button></div>
          <div class="row"><label>Method</label><select id="triMethod"><option value="SSMC" selected>SSMC ‚Äî SS‚Äëguided Monte Carlo</option><option value="DG">DG ‚Äî Distance‚ÄëGeometry (lite)</option><option value="HC">HC ‚Äî Hydrophobic Collapse</option></select><label>Seed</label><input type="number" id="triSeed" value="12345" /></div>
          <div class="row"><label>Optional SS hint</label><input id="triSSHints" type="text" placeholder="HHHHHCCCCEEE... (H/E/C)" style="min-width:260px" /></div>
          <div class="row" style="margin-top:8px"><button class="btn primary" onclick="triGenerate()" id="triGenBtn">Generate 3 models</button><button class="btn" onclick="triDownloadMulti()">‚¨á Multi‚Äëmodel PDB</button><button class="btn" onclick="triDownloadProvenance()">‚¨á Provenance JSON</button><button class="btn" onclick="triDockAll()">Dock all 3 vs current B</button></div>
          <p class="small muted">Deterministic via seed + method + hyperparams. Each PDB includes REMARK provenance.</p>
        </div>
        <div>
          <h3>Models</h3>
          <div class="trigrid">
            <div><div id="triView1" class="triview"></div><div class="row" style="margin-top:6px"><button class="btn" onclick="triSendToDock(0)">Send to Docking as A</button><button class="btn" onclick="triDownloadPDB(0)">‚¨á PDB 1</button></div></div>
            <div><div id="triView2" class="triview"></div><div class="row" style="margin-top:6px"><button class="btn" onclick="triSendToDock(1)">Send to Docking as A</button><button class="btn" onclick="triDownloadPDB(1)">‚¨á PDB 2</button></div></div>
            <div><div id="triView3" class="triview"></div><div class="row" style="margin-top:6px"><button class="btn" onclick="triSendToDock(2)">Send to Docking as A</button><button class="btn" onclick="triDownloadPDB(2)">‚¨á PDB 3</button></div></div>
          </div>
          <div class="score" id="triLog" style="margin-top:10px;max-height:160px"></div>
        </div>
      </div>
    </div>
    <div class="card"><h2>Method notes</h2><ul class="small"><li><b>SSMC:</b> Monte Carlo on CŒ± with torsion/packing priors; encourages helix i‚Üîi+3/4 and strand pairing per SS hint.</li><li><b>DG:</b> Lite distance geometry with sparse targets + annealing.</li><li><b>HC:</b> Hydrophobic collapse with sterics and bond constraints.</li><li>Conceptual models for rapid hypothesis sketching ‚Äî not substitutes for AF2/OpenFold/ESMFold.</li></ul></div>
  </div>
</section>

<!-- Sequence ‚Üí PDB -->
<section id="seqTab" class="tabsec">
  <div class="wrap grid">
    <div class="card">
      <h2>Sequence ‚Üí PDB (Educational Builder)</h2>
      <div class="two">
        <div>
          <h3>Input</h3>
          <textarea id="seqInput" placeholder=">optional FASTA header
EVQLVESGGGLVQPGGSLRLSC..."></textarea>
          <div class="row"><input type="file" id="fastaFile" accept=".fasta,.fa,.txt" /><button class="btn" onclick="loadFASTA()">Load FASTA</button></div>
          <div class="row"><label>Filename</label><input type="text" id="seqFilename" value="sequence_model.pdb" style="min-width:240px" /></div>
          <div class="row"><label>Chain</label><input type="text" id="seqChain" value="A" style="width:80px" /><label>Start Res#</label><input type="number" id="seqStart" value="1" min="1" /><label>Atoms</label><select id="seqAtoms"><option value="CA">CA‚Äëonly</option><option value="BB">Backbone (N,CA,C,O approx)</option></select></div>
          <h3>Secondary Structure</h3>
          <div class="row"><label>Preset</label><select id="ssPreset"><option value="HELIX">Helix</option><option value="STRAND">Strand</option><option value="COIL">Coil</option></select><label>Helix radius (√Ö)</label><input type="number" id="seqRadius" value="2.3" step="0.1" /><label>Rise/res (√Ö)</label><input type="number" id="seqRise" value="1.5" step="0.1" /></div>
          <div class="row" style="margin-top:8px"><button class="btn green" onclick="seqPreview()">üëÅÔ∏è Preview</button><button class="btn primary" onclick="seqDownload()">‚¨á Download PDB</button></div>
        </div>
        <div><h3>Preview</h3><div id="seqViewer"></div></div>
      </div>
    </div>
    <div class="card"><h2>Notes</h2><ul><li>For realistic structures, use AF2/OpenFold/ESMFold; then refine/dock.</li><li>You can feed the generated PDB back into Docking.</li></ul></div>
  </div>
</section>

<footer class="wrap" style="padding:20px 16px;color:var(--muted);text-align:center">All computations are client‚Äëside. ¬© You. | Build: <span id="buildTag"></span></footer>

<script src="https://unpkg.com/3dmol@2.4.2/build/3Dmol-min.js"></script>
<script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* ===== Globals ===== */
const APP_VERSION="1.2.0"; const BUILD_TAG=`v${APP_VERSION}`; let viewer=null, seqViewer=null; let triViewers=[null,null,null];
let pdbA=null,pdbB=null,pdbAAtoms=[],pdbBAtoms=[],pdbAAllAtoms=[],pdbBAllAtoms=[]; let posesTop=[],currentContacts=[],currentHB=[],currentSB=[]; let heavyUsed=false,currentA=null,currentB0=null,currentPose=null; let workerPool=[],cancelled=false,inProgress=false; let triModels=[];
window.addEventListener('DOMContentLoaded',()=>{document.getElementById('buildTag').textContent=BUILD_TAG; ensureMainViewer();});

/* ===== Tabs ===== */
const tabButtons=document.querySelectorAll('.tabbtn'); tabButtons.forEach(btn=>btn.addEventListener('click',()=>{tabButtons.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); document.querySelectorAll('.tabsec').forEach(s=>s.classList.remove('active')); const id=btn.dataset.tab; document.getElementById(id).classList.add('active'); if(id==='dockTab') document.getElementById('dockResults').classList.add('active'); else document.getElementById('dockResults').classList.remove('active'); if(id==='triTab'){ensureTriViewers(); triViewers.forEach(v=>{v?.resize(); v?.render();});} if(id==='seqTab'){ensureSeqViewer(); seqViewer.resize(); seqViewer.render();} if(id==='dockTab'){viewer.resize(); viewer.render();}}));
window.addEventListener('resize',()=>{if(document.getElementById('dockTab').classList.contains('active')){viewer?.resize();viewer?.render();} if(document.getElementById('triTab').classList.contains('active')) triViewers.forEach(v=>{v?.resize(); v?.render();}); if(document.getElementById('seqTab').classList.contains('active')){seqViewer?.resize(); seqViewer?.render();}});

/* ===== Viewers ===== */
function ensureMainViewer(){if(viewer) return; viewer=$3Dmol.createViewer(document.getElementById('viewer'),{backgroundColor:'#0a0f1a'}); setTimeout(()=>{viewer.resize(); viewer.render();},0);} 
function ensureSeqViewer(){if(seqViewer) return; seqViewer=$3Dmol.createViewer(document.getElementById('seqViewer'),{backgroundColor:'#0a0f1a'}); setTimeout(()=>{seqViewer.resize(); seqViewer.render();},0);} 
function ensureTriViewers(){if(triViewers[0]) return; triViewers[0]=$3Dmol.createViewer(document.getElementById('triView1'),{backgroundColor:'#0a0f1a'}); triViewers[1]=$3Dmol.createViewer(document.getElementById('triView2'),{backgroundColor:'#0a0f1a'}); triViewers[2]=$3Dmol.createViewer(document.getElementById('triView3'),{backgroundColor:'#0a0f1a'});}

/* ===== Helpers ===== */
function status(m){document.getElementById('statusPill').textContent=m;} function setProgress(f){const el=document.getElementById('prog'); el.value=Math.max(0,Math.min(1,f||0));}
function debounce(fn,ms=250){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}} 

/* ===== PDB parse/select ===== */
function parsePDB(text){const atoms=[];const lines=text.split(/
?
/);for(const ln of lines){if(ln.startsWith('ATOM')||ln.startsWith('HETATM')){const name=ln.substring(12,16).trim();const resn=ln.substring(17,20).trim();const chain=(ln.substring(21,22).trim()||'A');const resi=parseInt(ln.substring(22,26));const x=parseFloat(ln.substring(30,38));const y=parseFloat(ln.substring(38,46));const z=parseFloat(ln.substring(46,54));const elem=ln.length>=78?(ln.substring(76,78).trim()||name[0]):name[0];atoms.push({name,resn,chain,resi,x,y,z,elem});}} return atoms;}
function filterChains(atoms,keep){if(!keep||keep.size===0) return atoms; return atoms.filter(a=>keep.has(a.chain));}
function selectAtomSet(atoms,mode){const bb=new Set(['N','CA','C','O']);return atoms.filter(a=>{if(mode==='CA') return a.name==='CA'; if(mode==='BB') return bb.has(a.name); if(mode==='HEAVY') return a.elem!=='H'; return true;});}
function centroid(pts){let sx=0,sy=0,sz=0;for(const p of pts){sx+=p.x;sy+=p.y;sz+=p.z} const n=pts.length||1;return{x:sx/n,y:sy/n,z:sz/n}} function translate(pts,v){return pts.map(p=>({...p,x:p.x+v.x,y:p.y+v.y,z:p.z+v.z}))}
function formatPDB(atoms,shift=0){let out=[],i=1;for(const a of atoms){const name=(a.name||'CA').padStart(4,' '),resn=(a.resn||'RES').padStart(3,' '),chain=a.chain||'A',res=(a.resi||1).toString().padStart(4,' '),x=(a.x??0).toFixed(3).toString().padStart(8,' '),y=(a.y??0).toFixed(3).toString().padStart(8,' '),z=(a.z??0).toFixed(3).toString().padStart(8,' '),elem=(a.elem||'C').toString().padStart(2,' '); const ch=String.fromCharCode(chain.charCodeAt(0)+shift); out.push(`ATOM  ${String(i).padStart(5,' ')} ${name} ${resn} ${ch}${res}    ${x}${y}${z} 1.00  0.00          ${elem}`); i++;} out.push('TER','ENDMDL','END'); return out.join('
');}
const vdw={H:1.2,C:1.7,N:1.55,O:1.52,S:1.8,P:1.8,F:1.47,CL:1.75,BR:1.85,I:1.98};
async function fileToText(file){const name=file.name.toLowerCase();const buf=await file.arrayBuffer(); if(name.endsWith('.gz')){const out=pako.inflate(new Uint8Array(buf));return new TextDecoder().decode(out);} return new TextDecoder().decode(buf);} 

/* ===== Chain UX ===== */
window.addEventListener('DOMContentLoaded',()=>{const tryA=debounce(()=>parseOne('A')), tryB=debounce(()=>parseOne('B')); document.getElementById('pdbAText').addEventListener('input',tryA); document.getElementById('pdbBText').addEventListener('input',tryB); document.getElementById('pdbAFile').addEventListener('change',()=>parseOne('A')); document.getElementById('pdbBFile').addEventListener('change',()=>parseOne('B'));});
function computeChainCounts(atoms){const m={}; for(const a of atoms){const k=a.chain||'A'; if(!m[k]) m[k]={res:0,at:0,set:new Set()}; m[k].at++; m[k].set.add(a.resi);} for(const k in m){m[k].res=m[k].set.size; delete m[k].set;} return m;}
function renderChainSelector(which,counts){const box=document.getElementById(which==='A'?'chainsABox':'chainsBBox'); const hidden=document.getElementById(which==='A'?'chainsA':'chainsB'); const cs=Object.keys(counts).sort(); box.innerHTML=cs.map(c=>{const id=`${which}_ch_${c}`; return `<label class="chainchip" for="${id}"><input type="checkbox" id="${id}" data-chain="${c}" checked /><span>${c}</span><span class=small>${counts[c].res} res / ${counts[c].at} at</span></label>`;}).join(''); box.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.addEventListener('change',()=>{hidden.value=getSelectedChains(which).join(','); updateStepReady();})); hidden.value=cs.join(',');}
function selectAllChains(which){const box=document.getElementById(which==='A'?'chainsABox':'chainsBBox'); const hidden=document.getElementById(which==='A'?'chainsA':'chainsB'); box.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=true); hidden.value=getSelectedChains(which).join(','); updateStepReady();}
function clearChains(which){const box=document.getElementById(which==='A'?'chainsABox':'chainsBBox'); const hidden=document.getElementById(which==='A'?'chainsA':'chainsB'); box.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false); hidden.value=''; updateStepReady();}
function getSelectedChains(which){const box=document.getElementById(which==='A'?'chainsABox':'chainsBBox'); return Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.dataset.chain);}
function updateStepReady(){const okA=(pdbAAllAtoms.length>0)&&((getSelectedChains('A').length>0)||document.getElementById('chainsABox').children.length===0); const okB=(pdbBAllAtoms.length>0)&&((getSelectedChains('B').length>0)||document.getElementById('chainsBBox').children.length===0); document.getElementById('toParamsBtn').disabled=!(okA&&okB);} 
function gotoDockStep(n){document.getElementById('stepLoad').classList.toggle('active',n===1);document.getElementById('stepParams').classList.toggle('active',n===2);document.getElementById('stepRun').classList.toggle('active',n===3);} 
async function parseOne(which){let f=document.getElementById(which==='A'?'pdbAFile':'pdbBFile').files[0]; let txtEl=document.getElementById(which==='A'?'pdbAText':'pdbBText'); let warn=document.getElementById(which==='A'?'chainWarnA':'chainWarnB'); let text=txtEl.value.trim(); if(!text&&f) text=await fileToText(f); if(!text){warn.className='errorbox'; warn.textContent='No PDB detected. Upload or paste a PDB.'; updateStepReady(); return;} const atoms=parsePDB(text); if(!atoms.length){warn.className='errorbox'; warn.textContent='Could not parse atoms. Ensure valid PDB.'; updateStepReady(); return;} if(which==='A'){pdbA=text; pdbAAllAtoms=atoms;} else {pdbB=text; pdbBAllAtoms=atoms;} const counts=computeChainCounts(atoms); renderChainSelector(which,counts); warn.className='infobox small'; warn.innerHTML=`Found <b>${Object.keys(counts).length}</b> chain(s): ${Object.entries(counts).map(([c,v])=>`${c}(${v.res} res/${v.at} at)`).join(', ')}. Default = all.`; updateStepReady();}

/* ===== Examples ===== */
function useExample(w){const egA=`ATOM      1  N   GLY H   1      -2.000   0.000   0.000  1.00  0.00           N
ATOM      2  CA  GLY H   1      -0.650   0.000   0.000  1.00  0.00           C
ATOM      3  C   GLY H   1       0.000   1.300   0.500  1.00  0.00           C
ATOM      4  O   GLY H   1       0.000   2.300  -0.200  1.00  0.00           O
END`; const egB=`ATOM      1  N   GLY A   1       2.000   0.000   0.000  1.00  0.00           N
ATOM      2  CA  GLY A   1       0.650   0.000   0.000  1.00  0.00           C
ATOM      3  C   GLY A   1       0.000  -1.300  -0.500  1.00  0.00           C
ATOM      4  O   GLY A   1       0.000  -2.300   0.200  1.00  0.00           O
END`; if(w==='A'){document.getElementById('pdbAText').value=egA; parseOne('A');} else {document.getElementById('pdbBText').value=egB; parseOne('B');}}

/* ===== Dock workers ===== */
function makeDockWorker(){const src=`const vdw={H:1.2,C:1.7,N:1.55,O:1.52,S:1.8,P:1.8,F:1.47,CL:1.75,BR:1.85,I:1.98};function rand(s){let x=s>>>0;return()=> (x=(1664525*x+1013904223)>>>0,x/0xFFFFFFFF);}function rquat(r){const u1=r(),u2=r(),u3=r(),a=Math.sqrt(1-u1),b=Math.sqrt(u1),t1=2*Math.PI*u2,t2=2*Math.PI*u3;return[a*Math.sin(t1),a*Math.cos(t1),b*Math.sin(t2),b*Math.cos(t2)];}function rot(pts,q){const[x,y,z,w]=q;return pts.map(p=>{const vx=p.x,vy=p.y,vz=p.z;const ix=w*vx+y*vz-z*vy,iy=w*vy+z*vx-x*vz,iz=w*vz+x*vy-y*vx,iw=-x*vx-y*vy-z*vz;const ox=ix*w+iw*(-x)+iy*(-z)-iz*(-y),oy=iy*w+iw*(-y)+iz*(-x)-ix*(-z),oz=iz*w+iw*(-z)+ix*(-y)-iy*(-x);return{x:ox,y:oy,z:oz,elem:p.elem};});}function trans(pts,t){return pts.map(p=>({x:p.x+t.x,y:p.y+t.y,z:p.z+t.z,elem:p.elem}));}function grid(coords,cell){const m=new Map();for(let i=0;i<coords.length;i++){const x=coords[i].x,y=coords[i].y,z=coords[i].z,ix=Math.floor(x/cell),iy=Math.floor(y/cell),iz=Math.floor(z/cell),k=ix+'|'+iy+'|'+iz;if(!m.has(k)) m.set(k,[]); m.get(k).push(i);} return{cell,map:m};}function neigh(g,x,y,z){const c=g.cell,ix=Math.floor(x/c),iy=Math.floor(y/c),iz=Math.floor(z/c),r=[];for(let dx=-1;dx<=1;dx++)for(let dy=-1;dy<=1;dy++)for(let dz=-1;dz<=1;dz++){const k=(ix+dx)+'|'+(iy+dy)+'|'+(iz+dz); if(g.map.has(k)) r.push(...g.map.get(k));} return r;}function score(A,B,cut,cf,wc,wx,soft){const G=grid(A,cut);let C=0, X=0;for(let i=0;i<B.length;i++){const x=B[i].x,y=B[i].y,z=B[i].z,eb=(B[i].elem||'C').toUpperCase();const cand=neigh(G,x,y,z);for(const j of cand){const ax=A[j].x,ay=A[j].y,az=A[j].z,ea=(A[j].elem||'C').toUpperCase();const dx=x-ax,dy=y-ay,dz=z-az;const d=Math.hypot(dx,dy,dz),rv=(vdw[ea]||1.7)+(vdw[eb]||1.7),cc=cf*rv;if(d<=cc){const o=(cc-d+1e-6)/cc; X += wx*o*(1/(1+soft*o));} else if(d<=cut){C+=1;}}} return{score:C-X,contacts:C,clash:X};}onmessage=e=>{const{Apts,Bpts,params,start,end}=e.data;const rng=rand(params.seed+start*1337);let best=[],total=end-start;for(let k=0;k<total;k++){const q=rquat(rng),tx=(rng()*2-1)*params.maxTrans,ty=(rng()*2-1)*params.maxTrans,tz=(rng()*2-1)*params.maxTrans;const Bt=trans(rot(Bpts,q),{x:tx,y:ty,z:tz});const sc=score(Apts,Bt,params.contactCut,params.clashFactor,params.wContact,params.wClash,params.soft);best.push({score:sc.score,contacts:sc.contacts,clash:sc.clash,q:[q[0],q[1],q[2],q[3]],t:{x:tx,y:ty,z:tz}});if(k%1000===0) postMessage({type:'progress',k});} best.sort((a,b)=>b.score-a.score); postMessage({type:'done',list:best.slice(0,Math.min(200,total))});}`; const blob=new Blob([src],{type:'application/javascript'}); return new Worker(URL.createObjectURL(blob));}
function makeRescoreWorker(){const src=`const vdw={H:1.2,C:1.7,N:1.55,O:1.52,S:1.8,P:1.8,F:1.47,CL:1.75,BR:1.85,I:1.98};function score(A,B,cut,cf,wc,wx,soft){let C=0,X=0;for(let i=0;i<B.length;i++){const x=B[i].x,y=B[i].y,z=B[i].z,eb=(B[i].elem||'C').toUpperCase();for(let j=0;j<A.length;j++){const ax=A[j].x,ay=A[j].y,az=A[j].z,ea=(A[j].elem||'C').toUpperCase();const d=Math.hypot(x-ax,y-ay,z-az),rv=(vdw[ea]||1.7)+(vdw[eb]||1.7),cc=cf*rv; if(d<=cc){const o=(cc-d+1e-6)/cc; X+=wx*o*(1/(1+soft*o));} else if(d<=cut){C+=1;}}} return{score:C-X,contacts:C,clash:X};}function xform(P,q,t){const[x,y,z,w]=q;return P.map(p=>{const vx=p.x,vy=p.y,vz=p.z;const ix=w*vx+y*vz-z*vy,iy=w*vy+z*vx-x*vz,iz=w*vz+x*vy-y*vx,iw=-x*vx-y*vy-z*vz;const ox=ix*w+iw*(-x)+iy*(-z)-iz*(-y),oy=iy*w+iw*(-y)+iz*(-x)-ix*(-z),oz=iz*w+iw*(-z)+ix*(-y)-iy*(-x);return{x:ox+t.x,y:oy+t.y,z:oz+t.z,elem:p.elem,resn:p.resn,chain:p.chain,resi:p.resi,name:p.name};});}function jig(p){const j=0.5,r=()=> (Math.random()*2-1)*j;const dq=[p.q[0]+r()*0.01,p.q[1]+r()*0.01,p.q[2]+r()*0.01,p.q[3]+r()*0.01];const n=Math.hypot(dq[0],dq[1],dq[2],dq[3]);for(let i=0;i<4;i++) dq[i]/=n;const dt={x:p.t.x+r(),y:p.t.y+r(),z:p.t.z+r()};return{q:dq,t:dt};}onmessage=e=>{const{Aheavy,Bheavy0,params,topCoarse,refine}=e.data;const out=[];for(const p of topCoarse){let best={...p};let B=xform(Bheavy0,p.q,p.t);let sc=score(Aheavy,B,params.contactCut,params.clashFactor,params.wContact,params.wClash,params.soft);best.score=sc.score;best.contacts=sc.contacts;best.clash=sc.clash;if(refine){for(let i=0;i<50;i++){const jt=jig(best);const Bt=xform(Bheavy0,jt.q,jt.t);const sc2=score(Aheavy,Bt,params.contactCut,params.clashFactor,params.wContact,params.wClash,params.soft);if(sc2.score>best.score){best.q=jt.q;best.t=jt.t;best.score=sc2.score;best.contacts=sc2.contacts;best.clash=sc2.clash;}}} out.push(best);} out.sort((a,b)=>b.score-a.score); postMessage({list:out});}`; const blob=new Blob([src],{type:'application/javascript'}); return new Worker(URL.createObjectURL(blob));}

/* ===== Docking flow ===== */
async function loadInputs(){const fA=document.getElementById('pdbAFile').files[0], fB=document.getElementById('pdbBFile').files[0]; let tA=document.getElementById('pdbAText').value.trim(), tB=document.getElementById('pdbBText').value.trim(); if(!tA&&fA) tA=await fileToText(fA); if(!tB&&fB) tB=await fileToText(fB); if(!tA||!tB) throw new Error('Provide PDB for both A and B.'); if(!pdbAAllAtoms.length) pdbAAllAtoms=parsePDB(tA); if(!pdbBAllAtoms.length) pdbBAllAtoms=parsePDB(tB); if(!pdbAAllAtoms.length||!pdbBAllAtoms.length) throw new Error('Could not parse atoms from a PDB.'); const selA=new Set((document.getElementById('chainsA').value||'').split(',').map(s=>s.trim()).filter(Boolean)); const selB=new Set((document.getElementById('chainsB').value||'').split(',').map(s=>s.trim()).filter(Boolean)); const countsA=computeChainCounts(pdbAAllAtoms), countsB=computeChainCounts(pdbBAllAtoms); let A=(selA.size?filterChains(pdbAAllAtoms,selA):pdbAAllAtoms); let B=(selB.size?filterChains(pdbBAllAtoms,selB):pdbBAllAtoms); if(!A.length){document.getElementById('chainWarnA').className='errorbox'; document.getElementById('chainWarnA').innerHTML=`No atoms with selected chains. Using <b>All chains</b>. Available: ${Object.keys(countsA).sort().join(', ')}`; A=pdbAAllAtoms; selectAllChains('A');} if(!B.length){document.getElementById('chainWarnB').className='errorbox'; document.getElementById('chainWarnB').innerHTML=`No atoms with selected chains. Using <b>All chains</b>. Available: ${Object.keys(countsB).sort().join(', ')}`; B=pdbBAllAtoms; selectAllChains('B');} pdbA=tA; pdbB=tB; pdbAAtoms=A; pdbBAtoms=B; const heavyA=selectAtomSet(pdbAAtoms,'HEAVY').length, heavyB=selectAtomSet(pdbBAtoms,'HEAVY').length; const cap=40000, warn=document.getElementById('perfWarn'); if(heavyA+heavyB>cap){warn.style.display='block'; warn.textContent=`Large system (~${heavyA+heavyB} heavy atoms). Consider CA/BB mode or Rescore=NONE to speed up.`;} else warn.style.display='none';}

async function runDocking(){if(inProgress) return; if(!(pdbAAllAtoms.length&&pdbBAllAtoms.length)){alert('Parse both proteins first (Step 1).'); return;} gotoDockStep(3); cancelled=false; inProgress=true; const btn=document.getElementById('dockBtn'), can=document.getElementById('cancelBtn'); btn.disabled=true; can.disabled=false; btn.textContent='Running‚Ä¶'; posesTop=[]; currentContacts=currentHB=currentSB=[]; document.getElementById('poseControls').innerHTML=''; document.getElementById('scoreBox').textContent=''; setProgress(0); status('loading'); ensureMainViewer(); try{await loadInputs(); const p={samples:parseInt(document.getElementById('samples').value),maxTrans:parseFloat(document.getElementById('maxTrans').value),contactCut:parseFloat(document.getElementById('contactCut').value),clashFactor:parseFloat(document.getElementById('clashFactor').value),wContact:parseFloat(document.getElementById('wContact').value),wClash:parseFloat(document.getElementById('wClash').value),soft:parseFloat(document.getElementById('soft').value),topN:Math.max(1,parseInt(document.getElementById('topN').value)),seed:parseInt(document.getElementById('seed').value)||42,atomMode:document.getElementById('atomMode').value,rescoreMode:document.getElementById('rescoreMode').value}; const dupA=parseFloat(document.getElementById('dupAngle').value)||10, dupT=parseFloat(document.getElementById('dupTrans').value)||2; let A=selectAtomSet(pdbAAtoms,p.atomMode).map(a=>({x:a.x,y:a.y,z:a.z,elem:a.elem})), B=selectAtomSet(pdbBAtoms,p.atomMode).map(a=>({x:a.x,y:a.y,z:a.z,elem:a.elem})); if(!A.length||!B.length) throw new Error('No atoms selected with current atom mode.'); const cA=centroid(A), cB=centroid(B); A=translate(A,{x:-cA.x,y:-cA.y,z:-cA.z}); B=translate(B,{x:-cB.x,y:-cB.y,z:-cB.z}); status('sampling'); const cores=Math.max(1,(navigator.hardwareConcurrency||4)-1), pool=Math.min(cores,8), per=Math.floor(p.samples/pool), extra=p.samples%pool; let done=0, lists=[]; workerPool=[]; for(let i=0;i<pool;i++){const start=i*per+Math.min(i,extra), end=start+per+(i<extra?1:0); const w=makeDockWorker(); workerPool.push(w); w.onmessage=(e)=>{if(cancelled) return; const m=e.data; if(m.type==='progress'){done+=1000; setProgress(Math.min(1,done/p.samples)); status(`scan ${Math.min(done,p.samples)}/${p.samples}`);} if(m.type==='done'){lists.push(m.list); w.terminate(); if(lists.length===pool){let merged=lists.flat().sort((a,b)=>b.score-a.score); const diverse=diverseTop(merged,dupA,dupT); resolveAfterSampling(diverse,p);}}}; w.onerror=(err)=>{console.error(err); w.terminate();}; w.postMessage({Apts:A,Bpts:B,params:p,start,end});}}
  catch(e){alert(e.message||e); status('error'); inProgress=false; btn.disabled=false; can.disabled=true; btn.textContent='‚ñ∂Ô∏è Run Docking';}}

function cancelDocking(){cancelled=true; workerPool.forEach(w=>{try{w.terminate();}catch{}}); workerPool=[]; status('cancelled'); setProgress(0); const btn=document.getElementById('dockBtn'), can=document.getElementById('cancelBtn'); btn.disabled=false; can.disabled=true; btn.textContent='‚ñ∂Ô∏è Run Docking'; inProgress=false;}

async function resolveAfterSampling(diverse,p){ if(cancelled){cancelDocking(); return;} status(p.rescoreMode==='NONE'?'ranking':(p.rescoreMode==='HEAVY'?'rescore':'refine')); const Aheavy=translate(selectAtomSet(pdbAAllAtoms,'HEAVY').map(a=>({...a})),{x:-centroid(pdbAAllAtoms).x,y:-centroid(pdbAAllAtoms).y,z:-centroid(pdbAAllAtoms).z}); const Bheavy0=translate(selectAtomSet(pdbBAllAtoms,'HEAVY').map(a=>({...a})),{x:-centroid(pdbBAllAtoms).x,y:-centroid(pdbBAllAtoms).y,z:-centroid(pdbBAllAtoms).z}); let top=diverse; if(p.rescoreMode!=='NONE'){const rw=makeRescoreWorker(); rw.onmessage=e=>{posesTop=e.data.list; heavyUsed=true; finish(); rw.terminate();}; rw.onerror=err=>{console.error(err); heavyUsed=false; posesTop=diverse; finish(); rw.terminate();}; rw.postMessage({Aheavy,Bheavy0,params:p,topCoarse:diverse,refine:p.rescoreMode==='HEAVY_REFINE'});} else {heavyUsed=false; posesTop=top; finish();}
  function finish(){currentA=Aheavy; currentB0=Bheavy0; buildPoseButtons(posesTop); if(posesTop.length>0) document.querySelector('#poseControls button.btn[data-rank="1"]')?.click(); const btn=document.getElementById('dockBtn'), can=document.getElementById('cancelBtn'); btn.disabled=false; can.disabled=true; btn.textContent='‚ñ∂Ô∏è Run Docking'; status('done'); setProgress(1); inProgress=false; if(document.getElementById('fdaMode').checked){setTimeout(()=>{if(confirm('Run completed in FDA reproducibility mode. Export Audit Bundle now?')) exportAuditZip();},50);} }
}

function angleBetweenQuats(a,b){const d=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]; return 2*Math.acos(Math.min(1,Math.abs(d)))*180/Math.PI}
function diverseTop(sorted,ang,tran){const out=[]; for(const p of sorted){let dup=false; for(const q of out){const ad=angleBetweenQuats(p.q,q.q); const td=Math.hypot(p.t.x-q.t.x,p.t.y-q.t.y,p.t.z-q.t.z); if(ad<=ang&&td<=tran){dup=true;break;}} if(!dup) out.push(p); if(out.length>=parseInt(document.getElementById('topN').value)) break;} return out}

/* ===== Render & overlays ===== */
function buildPoseButtons(top){const pc=document.getElementById('poseControls'); pc.innerHTML=''; top.forEach((p,i)=>{const b=document.createElement('button'); b.className='btn'; b.dataset.rank=i+1; b.textContent=`Pose ${i+1} (S=${p.score.toFixed(1)}, C=${p.contacts|0}, X=${p.clash.toFixed(1)})`; b.onclick=()=>showPose(i); pc.appendChild(b); const d=document.createElement('button'); d.className='btn green'; d.style.marginLeft='6px'; d.textContent='‚¨á PDB'; d.onclick=()=>downloadPose(i); pc.appendChild(d);});}
function applyTransform(P,q,t){const[x,y,z,w]=q; return P.map(p=>{const vx=p.x,vy=p.y,vz=p.z; const ix=w*vx+y*vz-z*vy,iy=w*vy+z*vx-x*vz,iz=w*vz+x*vy-y*vx,iw=-x*vx-y*vy-z*vz; const ox=ix*w+iw*(-x)+iy*(-z)-iz*(-y),oy=iy*w+iw*(-y)+iz*(-x)-ix*(-z),oz=iz*w+iw*(-z)+ix*(-y)-iy*(-x); return{x:ox+t.x,y:oy+t.y,z:oz+t.z,elem:p.elem,resn:p.resn,chain:p.chain,resi:p.resi,name:p.name};});}
function showPose(i){currentPose=posesTop[i]; const B=applyTransform(currentB0,currentPose.q,currentPose.t); viewer.clear(); viewer.addModel(formatPDB(currentA),'pdb'); viewer.setStyle({model:0},{cartoon:{colorscheme:'Chain'}}); viewer.addModel(formatPDB(B,1),'pdb'); viewer.setStyle({model:1},{cartoon:{color:'#f97316'}}); viewer.zoomTo(); const cut=parseFloat(document.getElementById('contactCut').value); const m=computeInterfaceMetrics(currentA,B,cut); currentContacts=m.contactsPairs; currentHB=m.hbPairs; currentSB=m.sbPairs; refreshOverlays(); const kE=parseFloat(document.getElementById('kElec').value)||0.5, eCut=parseFloat(document.getElementById('elecCut').value)||12; const E=coulombResidueEnergy(currentA,B,kE,eCut), BSA=m.contacts*10.0; const H=(m.contacts)-(m.clash)+(m.hb*0.5)+(m.sb*1.0)-(E); document.getElementById('scoreBox').textContent=`Pose ${i+1} ‚Äî Score=${currentPose.score.toFixed(2)}  Contacts=${m.contacts}  Clash=${m.clash.toFixed(2)}  HB=${m.hb}  SB=${m.sb}  Hydrophobics=${m.hydrophobics}  BSA‚âà${BSA.toFixed(0)} √Ö¬≤  Electrostatics‚âà${E.toFixed(2)}  Pseudo-enthalpy‚âà${H.toFixed(2)}`; viewer.render();}
function refreshOverlays(){if(!currentPose) return; viewer.removeAllShapes(); if(document.getElementById('toggleContacts').checked) drawPairs(currentContacts,'#60a5fa'); if(document.getElementById('toggleHB').checked) drawPairs(currentHB,'#34d399'); if(document.getElementById('toggleSB').checked) drawPairs(currentSB,'#f87171'); viewer.render();}
function drawPairs(pairs,color){pairs.slice(0,400).forEach(pr=>viewer.addLine({start:{x:pr.x1,y:pr.y1,z:pr.z1},end:{x:pr.x2,y:pr.y2,z:pr.z2},dashed:true,dashLength:0.5,color,linewidth:2}));}

/* ===== Metrics ===== */
const hydrophobic=new Set(['ALA','VAL','LEU','ILE','PRO','PHE','MET','TRP','TYR','CYS']);
function computeInterfaceMetrics(A,B,contactCut){let contacts=0,clash=0,hb=0,sb=0,hyd=0; const contactsPairs=[],hbPairs=[],sbPairs=[]; for(const b of B){for(const a of A){const d=Math.hypot(b.x-a.x,b.y-a.y,b.z-a.z); const rv=(vdw[(a.elem||'C').toUpperCase()]||1.7)+(vdw[(b.elem||'C').toUpperCase()]||1.7); const cCut=parseFloat(document.getElementById('clashFactor').value)*rv; if(d<=cCut){const over=(cCut-d+1e-6)/cCut; clash+=6.0*over*(1/(1+0.5*over));} if(d<=contactCut){contacts++; contactsPairs.push({x1:a.x,y1:a.y,z1:a.z,x2:b.x,y2:b.y,z2:b.z});} const aN=a.name?.trim().startsWith('N'), bO=b.name?.trim().startsWith('O'), aO=a.name?.trim().startsWith('O'), bN=b.name?.trim().startsWith('N'); if((aN&&bO||aO&&bN)&&d<=3.5){hb++; hbPairs.push({x1:a.x,y1:a.y,z1:a.z,x2:b.x,y2:b.y,z2:b.z});} const acid=x=> (x.resn==='ASP'&&x.name.startsWith('OD'))||(x.resn==='GLU'&&x.name.startsWith('OE')); const base=x=> (x.resn==='LYS'&&x.name==='NZ')||(x.resn==='ARG'&&(x.name==='NH1'||x.name==='NH2'||x.name==='NE'))||(x.resn==='HIS'&&(x.name==='ND1'||x.name==='NE2')); if((acid(a)&&base(b)||acid(b)&&base(a))&&d<=4.0){sb++; sbPairs.push({x1:a.x,y1:a.y,z1:a.z,x2:b.x,y2:b.y,z2:b.z});} if(hydrophobic.has(a.resn)&&hydrophobic.has(b.resn)&&(a.elem==='C'||b.elem==='C')&&d<=4.5) hyd++; }} return {contacts,clash,hb,sb,hydrophobics:hyd,contactsPairs,hbPairs,sbPairs};}
function residueCharges(atoms){const charges=new Map(), qRes={ASP:-1,GLU:-1,LYS:+1,ARG:+1,HIS:+0.1}; const pos=new Map(); for(const a of atoms){const k=a.chain+':'+a.resi; if(!pos.has(k)) pos.set(k,[]); pos.get(k).push(a);} for(const [k,arr] of pos.entries()){const resn=arr[0].resn||'UNK', q=qRes[resn]||0; if(q!==0){let ca=arr.find(x=>x.name==='CA'), x,y,z; if(ca){x=ca.x;y=ca.y;z=ca.z;} else {let sx=0,sy=0,sz=0; for(const a of arr){sx+=a.x;sy+=a.y;sz+=a.z} x=sx/arr.length; y=sy/arr.length; z=sz/arr.length;} charges.set(k,{x,y,z,q,resn,chain:arr[0].chain,resi:arr[0].resi});}} return Array.from(charges.values());}
function coulombResidueEnergy(A,B,k=0.5,cut=12){const cA=residueCharges(A), cB=residueCharges(B); let e=0, c2=cut*cut; for(const a of cA){for(const b of cB){const d2=(a.x-b.x)**2+(a.y-b.y)**2+(a.z-b.z)**2; if(d2>c2) continue; e += k*(a.q*b.q)/(Math.sqrt(d2)+1e-3);}} return e;}

/* ===== Downloads & Audit ===== */
function downloadBlob(text,name){const blob=new Blob([text],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),0);} 
function downloadPose(i){const p=posesTop[i]; const A=currentA, B=applyTransform(currentB0,p.q,p.t); const out=formatPDB(A)+'
'+formatPDB(B,1); downloadBlob(out,`pose_${i+1}.pdb`);} 
function downloadAllPoses(){if(!posesTop.length){alert('No poses yet.'); return;} let out=[]; posesTop.forEach((p,i)=>{out.push(`MODEL     ${i+1}`); out.push(formatPDB(currentA)); out.push(formatPDB(applyTransform(currentB0,p.q,p.t),1)); out.push('ENDMDL');}); out.push('END'); downloadBlob(out.join('
'),'top_poses.pdb');}
function downloadCSV(){if(!posesTop.length){alert('No poses yet.'); return;} const rows=["rank,score,contacts,clash,qx,qy,qz,qw,tx,ty,tz"]; posesTop.forEach((p,i)=>rows.push([i+1,p.score,p.contacts,p.clash,p.q[0],p.q[1],p.q[2],p.q[3],p.t.x,p.t.y,p.t.z].join(','))); downloadBlob(rows.join('
'),'poses_summary.csv');}
function downloadJSON(){if(!posesTop.length){alert('No poses yet.'); return;} const kE=parseFloat(document.getElementById('kElec').value)||0.5, eCut=parseFloat(document.getElementById('elecCut').value)||12, cut=parseFloat(document.getElementById('contactCut').value); const rep=posesTop.map((p,i)=>{const B=applyTransform(currentB0,p.q,p.t); const m=computeInterfaceMetrics(currentA,B,cut); return{rank:i+1,score:p.score,contacts:m.contacts,clash:m.clash,hb:m.hb,sb:m.sb,hydrophobic:m.hydrophobics,BSA_proxy_A2:m.contacts*10.0,electrostatics:coulombResidueEnergy(currentA,B,kE,eCut),transform:{q:p.q,t:p.t}};}); downloadBlob(JSON.stringify(rep,null,2),'interface_report.json');}
async function sha256Hex(s){const b=new TextEncoder().encode(s); const h=await crypto.subtle.digest('SHA-256',b); return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join('');}
async function exportAuditZip(){if(!posesTop.length){alert('Run docking first.'); return;} const zip=new JSZip(); const meta={app_version:APP_VERSION,date:new Date().toISOString(),params:{samples:+samples.value,maxTrans:+maxTrans.value,contactCut:+contactCut.value,clashFactor:+clashFactor.value,wContact:+wContact.value,wClash:+wClash.value,soft:+soft.value,topN:+topN.value,seed:+seed.value,atomMode:atomMode.value,rescoreMode:rescoreMode.value},study:metaStudy.value||null,species:metaSpecies.value||null,dose_mg_per_kg:+metaDose.value||0,regimen:metaRegimen.value||null,notes:'Educational tool; not validated for clinical decision-making.'}; const inA=pdbAText.value, inB=pdbBText.value; if(inA) zip.file('input_A.pdb',inA); if(inB) zip.file('input_B.pdb',inB); let csvRows=["rank,score,contacts,clash,qx,qy,qz,qw,tx,ty,tz"]; posesTop.forEach((p,i)=>csvRows.push([i+1,p.score,p.contacts,p.clash,p.q[0],p.q[1],p.q[2],p.q[3],p.t.x,p.t.y,p.t.z].join(','))); const csv=csvRows.join('
'); zip.file('poses_summary.csv',csv); const kE=+kElec.value||0.5,eCut=+elecCut.value||12,cut=+contactCut.value; const iface=posesTop.map((p,i)=>{const B=applyTransform(currentB0,p.q,p.t); const m=computeInterfaceMetrics(currentA,B,cut); return{rank:i+1,score:p.score,contacts:m.contacts,clash:m.clash,hb:m.hb,sb:m.sb,hydrophobic:m.hydrophobics,BSA_proxy_A2:m.contacts*10.0,electrostatics:coulombResidueEnergy(currentA,B,kE,eCut),transform:{q:p.q,t:p.t}};}); zip.file('interface_report.json',JSON.stringify(iface,null,2)); meta.hashes={poses_summary_csv_sha256:await sha256Hex(csv), interface_report_json_sha256:await sha256Hex(JSON.stringify(iface))}; zip.file('audit_meta.json',JSON.stringify(meta,null,2)); if(posesTop.length){let out=[]; posesTop.forEach((p,i)=>{out.push(`MODEL     ${i+1}`); out.push(formatPDB(currentA)); out.push(formatPDB(applyTransform(currentB0,p.q,p.t),1)); out.push('ENDMDL');}); out.push('END'); zip.file('top_poses.pdb',out.join('
'));} const blob=await zip.generateAsync({type:'blob'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`audit_bundle_${Date.now()}.zip`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),0);} 

/* ===== TriPredict (worker) ===== */
function makeTriWorker(){const src=`const AA='ARNDCEQGHILKMFPSTWYV';const HY=new Set(['A','V','I','L','M','F','Y','W','C']);const HEL=new Set(['A','L','M','Q','E','K','H','R']);const STR=new Set(['V','I','Y','F','W','T','C','L']);function clean(raw){return (raw||'').toUpperCase().replace(/[^A-Z]/g,'').split('').filter(x=>AA.includes(x)).join('')}function guessSS(seq,h){if(h&&/^[HEC]+$/.test(h)&&h.length===seq.length) return h; const arr=seq.split('').map(a=>HEL.has(a)?'H':(STR.has(a)?'E':'C')); for(let i=1;i<arr.length-1;i++){ if(arr[i]!==arr[i-1]&&arr[i]!==arr[i+1]) arr[i]=arr[i-1]; } return arr.join('')}function initCA(seq,rng){const ca=[]; let x=0,y=0,z=0; for(let i=0;i<seq.length;i++){const step=3.8; x+=(rng()*2-1)*0.5; y+=(rng()*2-1)*0.5; z+=step+(rng()*2-1)*0.5; ca.push({x,y,z});} return ca;}function energyModel(seq,ss,method){const n=seq.length; const hydro=seq.split('').map(a=>HY.has(a)?1:0); const targets=[]; for(let i=0;i<n-4;i++){ if(ss[i]==='H'&&ss[i+4]==='H') targets.push({i:i,j:i+4,d:6,w:1}); if(ss[i]==='H'&&ss[i+3]==='H') targets.push({i:i,j:i+3,d:5.5,w:0.6}); } let segs=[]; let s=-1; for(let i=0;i<=n;i++){ if(i<n&&ss[i]==='E'){if(s<0)s=i;} else { if(s>=0&&i-s>=3){segs.push([s,i-1]);} s=-1; } } for(let k=0;k<segs.length-1;k++){ const[a1,a2]=segs[k],[b1,b2]=segs[k+1]; const len=Math.min(a2-a1+1,b2-b1+1); for(let t=0;t<len;t++){ const i=a1+t,j=b2-t; targets.push({i,j,d:6.5,w:1}); } } for(let i=0;i<n;i++){ if(!hydro[i]) continue; for(let j=i+6;j<n;j++){ if(hydro[j]) targets.push({i,j,d:7.5,w:0.35}); } } const w={bond:6,angle:0.2,rep:2,tgt:1.5,hydro:0}; if(method==='SSMC'){w.bond=7;w.angle=0.6;w.tgt=2.8;w.rep=2.2;} if(method==='DG'){w.bond=8;w.angle=0.4;w.tgt=4;w.rep=2;} if(method==='HC'){w.bond=6;w.angle=0.2;w.tgt=0.8;w.rep=3;w.hydro=1.2;} const repCut=3.2; function E(ca){let E=0; for(let i=0;i<n-1;i++){const d=Math.hypot(ca[i+1].x-ca[i].x,ca[i+1].y-ca[i].y,ca[i+1].z-ca[i].z)-3.8; E+=w.bond*d*d;} for(let i=0;i<n-2;i++){const d=Math.hypot(ca[i+2].x-ca[i].x,ca[i+2].y-ca[i].y,ca[i+2].z-ca[i].z)-7.6; E+=w.angle*d*d;} for(let i=0;i<n;i++){ for(let j=i+2;j<n;j++){const d=Math.hypot(ca[j].x-ca[i].x,ca[j].y-ca[i].y,ca[j].z-ca[i].z); if(d<repCut){const e=repCut-d; E+=w.rep*e*e;} if(w.hydro&&hydro[i]&&hydro[j]){const e=d-7.5; E+=w.hydro*e*e;} } } for(const t of targets){const a=ca[t.i],b=ca[t.j]; const e=Math.hypot(b.x-a.x,b.y-a.y,b.z-a.z)-t.d; E+=w.tgt*t.w*e*e;} return E;} function dE(ca,k,tr){let dE=0; for(const i of [k-1,k]){ if(i<0||i>=n-1) continue; const d1=Math.hypot(ca[i+1].x-ca[i].x,ca[i+1].y-ca[i].y,ca[i+1].z-ca[i].z)-3.8; const ai=(i===k)?tr:ca[i], aj=(i+1===k)?tr:ca[i+1]; const d2=Math.hypot(aj.x-ai.x,aj.y-ai.y,aj.z-ai.z)-3.8; dE+=w.bond*(d2*d2-d1*d1);} for(const i of [k-2,k]){ if(i<0||i>=n-2) continue; const d1=Math.hypot(ca[i+2].x-ca[i].x,ca[i+2].y-ca[i].y,ca[i+2].z-ca[i].z)-7.6; const ai=(i===k)?tr:ca[i], aj=(i+2===k)?tr:ca[i+2]; const d2=Math.hypot(aj.x-ai.x,aj.y-ai.y,aj.z-ai.z)-7.6; dE+=w.angle*(d2*d2-d1*d1);} for(let j=0;j<n;j++){ if(j===k||Math.abs(k-j)<=2) continue; const d1=Math.hypot(ca[j].x-ca[k].x,ca[j].y-ca[k].y,ca[j].z-ca[k].z); const d2=Math.hypot(ca[j].x-tr.x,ca[j].y-tr.y,ca[j].z-tr.z); const rc=3.2; if(d1<rc||d2<rc){const e1=rc-d1,e2=rc-d2; dE+=w.rep*((d2<rc?e2*e2:0)-(d1<rc?e1*e1:0));} } return dE;} return{E,dE,w};}function anneal(seq,ss,method,seed,steps){let s=(seed>>>0)||1; const rng=()=> (s=(1664525*s+1013904223)>>>0,s/0xFFFFFFFF); let ca=initCA(seq,rng); const {E,dE}=energyModel(seq,ss,method); let En=E(ca),acc=0,T0=2,T1=0.2; for(let k=0;k<steps;k++){const i=Math.floor(rng()*seq.length),amp=1-0.8*(k/steps); const tr={x:ca[i].x+(rng()*2-1)*amp,y:ca[i].y+(rng()*2-1)*amp,z:ca[i].z+(rng()*2-1)*amp}; const d= dE(ca,i,tr); const T=T0*Math.pow(T1/T0,k/steps); if(d<=0||rng()<Math.exp(-d/Math.max(1e-6,T))){ca[i]=tr; En+=d; acc++;} if(k%400===0) postMessage({type:'progress',k}); } return{ca,E:En,accept:acc/steps};} onmessage=e=>{const{rawSeq,method,seed0,ssHint,steps}=e.data; const seq=clean(rawSeq); if(!seq){postMessage({type:'error',msg:'Invalid sequence'});return;} const ss=guessSS(seq,ssHint); const list=[]; for(let m=0;m<3;m++){const seed=seed0+m; const r=anneal(seq,ss,method,seed,steps); list.push({ca:r.ca,E:r.E,accept:r.accept,seed,method,ss}); postMessage({type:'partial',index:m,ca:r.ca,E:r.E,accept:r.accept,seed}); } postMessage({type:'done',list});}`; const blob=new Blob([src],{type:'application/javascript'}); return new Worker(URL.createObjectURL(blob));}

/* ===== TriPredict UI ===== */
function triLoadFASTA(){const f=document.getElementById('triFASTA').files[0]; if(!f) return alert('Choose a FASTA file first.'); f.text().then(txt=>{const seq=txt.split(/
?
/).filter(l=>!l.startsWith('>')).join(''); document.getElementById('triSeq').value=seq;});}
function triSendToDock(i){const pdb=triPDB(i,'A',1, document.getElementById('triSeq').value); document.getElementById('pdbAText').value=pdb; parseOne('A'); tabButtons[0].click(); window.scrollTo({top:0,behavior:'smooth'});} 
function triDownloadPDB(i){const pdb=triPDB(i,'A',1, document.getElementById('triSeq').value); downloadBlob(pdb,`TriPredict_${i+1}.pdb`);} 
function triDownloadMulti(){if(!triModels.length){alert('Generate models first.'); return;} let out=[]; triModels.forEach((m,i)=>{out.push(`MODEL     ${i+1}`); out.push(triPDBFromCA(m.ca,'A',1,m.seq)); out.push('ENDMDL');}); out.push('END'); downloadBlob(out.join('
'),'TriPredict_models.pdb');}
function triDownloadProvenance(){if(!triModels.length){alert('Generate models first.'); return;} const prov=triModels.map((m,i)=>({rank:i+1,seed:m.seed,method:m.method,accept:m.accept,seq_len:m.ca.length,ss:m.ss})); downloadBlob(JSON.stringify(prov,null,2),'TriPredict_provenance.json');}
async function triDockAll(){if(!triModels.length){alert('Generate models first.'); return;} const savedA=pdbAText.value; for(let i=0;i<triModels.length;i++){pdbAText.value=triPDB(i,'A',1, document.getElementById('triSeq').value); await parseOne('A'); await runDocking();} pdbAText.value=savedA; if(savedA) parseOne('A');}
function triPDB(i,chain,start,seq){return triPDBFromCA(triModels[i].ca,chain,start,seq)}
function triPDBFromCA(ca,chain,start,seq){const aa3={'A':'ALA','R':'ARG','N':'ASN','D':'ASP','C':'CYS','E':'GLU','Q':'GLN','G':'GLY','H':'HIS','I':'ILE','L':'LEU','K':'LYS','M':'MET','F':'PHE','P':'PRO','S':'SER','T':'THR','W':'TRP','Y':'TYR','V':'VAL'}; let out=[],i=1; for(let k=0;k<ca.length;k++){const resi=start+k,resn=aa3[seq?.[k]||'G']||'GLY',c=ca[k]; out.push(`ATOM  ${String(i).padStart(5,' ')}  CA  ${resn} ${chain}${String(resi).padStart(4,' ')}    ${c.x.toFixed(3).padStart(8,' ')}${c.y.toFixed(3).padStart(8,' ')}${c.z.toFixed(3).padStart(8,' ')} 1.00  0.00           C`); i++;} out.push('TER','END'); return out.join('
');}
function triGenerate(){const raw=document.getElementById('triSeq').value; if(!raw.trim()) return alert('Enter a sequence first.'); const method=document.getElementById('triMethod').value; const seed0=parseInt(document.getElementById('triSeed').value)||12345; const ssHint=document.getElementById('triSSHints').value.trim(); const w=makeTriWorker(); triModels=[]; ensureTriViewers(); triViewers.forEach(v=>{v.clear(); v.render();}); const log=document.getElementById('triLog'); log.textContent=''; w.onmessage=e=>{const m=e.data; if(m.type==='partial'){const i=m.index, ca=m.ca; triModels[i]={ca:ca,seed:m.seed,accept:m.accept,method:method,ss:m.ss,seq:cleanSequence(raw)}; const pdb=triPDBFromCA(ca,'A',1,triModels[i].seq); triViewers[i].clear(); triViewers[i].addModel(pdb,'pdb'); triViewers[i].setStyle({cartoon:{color:'#60a5fa'}}); triViewers[i].zoomTo(); triViewers[i].render(); log.textContent += `Model ${i+1}: E‚âà${m.E.toFixed(1)} accept‚âà${(m.accept*100).toFixed(1)}% seed=${m.seed}
`; }
    if(m.type==='done'){log.textContent += 'Done.'; w.terminate();}
    if(m.type==='error'){alert(m.msg); w.terminate();}
  }; w.postMessage({rawSeq:raw,method,seed0,ssHint,steps:8000});}
function cleanSequence(raw){return (raw||'').toUpperCase().replace(/[^A-Z]/g,'').replace(/[^ARNDCEQGHILKMFPSTWYV]/g,'');}

/* ===== Sequence ‚Üí PDB builder ===== */
const aa3={'A':'ALA','R':'ARG','N':'ASN','D':'ASP','C':'CYS','E':'GLU','Q':'GLN','G':'GLY','H':'HIS','I':'ILE','L':'LEU','K':'LYS','M':'MET','F':'PHE','P':'PRO','S':'SER','T':'THR','W':'TRP','Y':'TYR','V':'VAL'};
function loadFASTA(){const f=document.getElementById('fastaFile').files[0]; if(!f) return alert('Choose a FASTA file first.'); f.text().then(txt=>{const seq=txt.split(/
?
/).filter(l=>!l.startsWith('>')).join(''); document.getElementById('seqInput').value=seq;});}
function helixCA(seq,radius,rise){const ca=[],deg=100*Math.PI/180; for(let i=0;i<seq.length;i++){const ang=i*deg; ca.push({x:radius*Math.cos(ang),y:radius*Math.sin(ang),z:i*rise});} return ca;}
function strandCA(seq){const ca=[]; for(let i=0;i<seq.length;i++){const s=i%2? -1:1; ca.push({x:i*3.5,y:s*1.2,z:0});} return ca;}
function coilCA(seq){const ca=[]; let x=0,y=0,z=0; for(let i=0;i<seq.length;i++){x+=(Math.random()*2-1)*2.5; y+=(Math.random()*2-1)*2.5; z+=3.2; ca.push({x,y,z});} return ca;}
function buildBackboneFromCA(ca,chain,start,mode,seq){const out=[]; for(let i=0;i<ca.length;i++){const r=start+i,resn=aa3[seq[i]]||'GLY',c=ca[i],pr=ca[Math.max(0,i-1)],nx=ca[Math.min(ca.length-1,i+1)],tx=nx.x-pr.x,ty=nx.y-pr.y,tz=nx.z-pr.z,len=Math.hypot(tx,ty,tz)||1,ux=tx/len,uy=ty/len,uz=tz/len; if(mode==='BB') out.push({x:c.x-1.33*ux,y:c.y-1.33*uy,z:c.z-1.33*uz,name:' N  ',elem:'N',resn,chain,resi:r}); out.push({x:c.x,y:c.y,z:c.z,name:' CA ',elem:'C',resn,chain,resi:r}); if(mode==='BB'){out.push({x:c.x+1.52*ux,y:c.y+1.52*uy,z:c.z+1.52*uz,name:' C  ',elem:'C',resn,chain,resi:r}); const nxv=-uy,nyv=ux,nzv=0; out.push({x:c.x+2.30*ux+0.5*nxv,y:c.y+2.30*uy+0.5*nyv,z:c.z+2.30*uz+0.5*nzv,name:' O  ',elem:'O',resn,chain,resi:r}); }} return out;}
function seqToPDB(opts){const seq=cleanSequence(opts.rawSeq); if(!seq) throw new Error('Enter a valid sequence.'); let ca; if(opts.preset==='HELIX') ca=helixCA(seq,opts.radius,opts.rise); else if(opts.preset==='STRAND') ca=strandCA(seq); else ca=coilCA(seq); const bb=buildBackboneFromCA(ca,opts.chain,opts.start,opts.atomsMode,seq); return formatPDB(bb);} 
function seqPreview(){ensureSeqViewer(); const o={rawSeq:seqInput.value,chain:(seqChain.value||'A').charAt(0).toUpperCase(),start:parseInt(seqStart.value)||1,atomsMode:seqAtoms.value,preset:ssPreset.value,radius:parseFloat(seqRadius.value)||2.3,rise:parseFloat(seqRise.value)||1.5}; try{const pdb=seqToPDB(o); seqViewer.clear(); seqViewer.addModel(pdb,'pdb'); seqViewer.setStyle({cartoon:{color:'#60a5fa'}}); seqViewer.zoomTo(); seqViewer.render();}catch(e){alert(e.message||e);}}
function seqDownload(){const o={rawSeq:seqInput.value,chain:(seqChain.value||'A').charAt(0).toUpperCase(),start:parseInt(seqStart.value)||1,atomsMode:seqAtoms.value,preset:ssPreset.value,radius:parseFloat(seqRadius.value)||2.3,rise:parseFloat(seqRise.value)||1.5}; try{const pdb=seqToPDB(o); downloadBlob(pdb, seqFilename.value||'sequence_model.pdb');}catch(e){alert(e.message||e);}}
</script>
</body>
</html>
