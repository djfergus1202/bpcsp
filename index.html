<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Antibody Docking + MM/GBSA Toolkit</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="One-file site for antibody‚Äìantigen docking workflows and MM/GBSA scoring (OpenMM GBSA-OBC2). Includes live downloads for environment.yml, prepare_structures.py, mmgbsa_openmm.py, and run_example.sh." />
<meta name="theme-color" content="#0f172a" />
<style>
  :root{
    --bg:#0b1220;--panel:#0f172a;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#60a5fa;--line:#1f2937;--green:#34d399;--red:#f87171;--yellow:#fbbf24;
    --mono: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
    --sans: Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial;
  }
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:var(--sans);line-height:1.6}
  a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
  header{padding:56px 20px;background:radial-gradient(1200px 600px at 20% -10%,#1d2a4a,transparent 60%),
                               radial-gradient(1000px 500px at 120% 10%,#2a1e4a,transparent 60%)}
  .wrap{max-width:1040px;margin:0 auto}
  .hero h1{font-size:40px;margin:0 0 8px}
  .hero p{color:var(--muted);margin:10px 0 20px}
  .cta{display:flex;gap:10px;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;font-weight:600;border:1px solid var(--line);background:#0b1220}
  .btn.primary{background:linear-gradient(180deg,#2563eb,#1d4ed8);border:0}
  .btn.green{background:linear-gradient(180deg,#059669,#047857);border:0}
  section{padding:28px 20px;border-top:1px solid var(--line);background:var(--panel)}
  h2{margin:0 0 12px;font-size:28px}h3{margin:18px 0 8px;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}@media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
  .card{background:#0b1220;border:1px solid var(--line);border-radius:14px;padding:16px}
  .muted{color:var(--muted)}.tag{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
  pre{position:relative;background:#0a0f1a;border:1px solid var(--line);border-radius:12px;padding:14px;overflow:auto}
  code,pre{font-family:var(--mono);font-size:13px}
  .copy{position:absolute;top:8px;right:8px;border:1px solid var(--line);background:#0b1220;color:var(--text);border-radius:8px;padding:6px 10px;cursor:pointer}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .small{font-size:12px;color:var(--muted)}
  footer{padding:28px 20px;color:var(--muted);text-align:center;border-top:1px solid var(--line)}
  .anchor{float:right;font-size:13px;color:var(--muted)}
  details{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#0b1220}
  details summary{cursor:pointer;font-weight:600}
</style>
</head>
<body>

<header>
  <div class="wrap hero">
    <h1>Antibody Docking + MM/GBSA Toolkit</h1>
    <p>Prep PDBs, dock externally (HADDOCK / ClusPro / Rosetta), then rank poses with fast
       <strong>MM/GBSA</strong> using <strong>OpenMM</strong> (GBSA-OBC2). This single file ships everything: docs, code, and one-click downloads.</p>
    <div class="cta">
      <a class="btn primary" href="#quickstart">üöÄ Quick Start</a>
      <a class="btn" href="#files">üì¶ Files</a>
      <a class="btn green" href="#advanced">üß™ Advanced</a>
      <a class="btn" href="#faq">‚ùì FAQ</a>
    </div>
    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <span class="tag">OpenMM</span><span class="tag">PDBFixer</span><span class="tag">MDTraj</span><span class="tag">ParmEd</span><span class="tag">MM/GBSA (OBC2)</span>
    </div>
  </div>
</header>

<section id="quickstart">
  <div class="wrap grid">
    <div class="card">
      <h2>Quick Start <a class="anchor" href="#quickstart">#</a></h2>
      <p class="muted">Create the conda environment, prepare structures, dock externally, then score poses with <code>mmgbsa_openmm.py</code>.</p>

      <h3>1) Create environment</h3>
      <div class="row">
        <button class="btn" onclick="downloadFile('environment.yml')">‚¨á Download environment.yml</button>
        <button class="btn" onclick="copyTextFrom('env-yml')">üìã Copy</button>
      </div>
      <pre><code id="env-yml">name: abdock
channels:
  - conda-forge
dependencies:
  - python=3.11
  - openmm>=8.0
  - pdbfixer>=1.9
  - mdtraj>=1.9.9
  - biopython>=1.83
  - numpy>=1.26
  - pandas>=2.2
  - tqdm
  - pip
  - pip:
    - parmed>=4.2.2
</code></pre>

      <h3>2) Prepare structures</h3>
      <div class="row">
        <button class="btn" onclick="downloadFile('prepare_structures.py')">‚¨á Download prepare_structures.py</button>
        <button class="btn" onclick="copyTextFrom('prep-py')">üìã Copy</button>
      </div>
      <pre><code id="prep-py">#!/usr/bin/env python3
"""
Prepare antibody (Ab) and antigen (Ag) PDBs for docking/energy work:
- Keep only specified chains
- Remove waters/hetero ligands
- Fix missing heavy atoms and assign reasonable positions
- Save cleaned PDBs

Usage:
  python prepare_structures.py --pdb input.pdb --chains H,L --out cleaned.pdb

Run separately for Ab and Ag.
"""
import argparse
from pdbfixer import PDBFixer
from openmm.app import PDBFile
from io import StringIO

def subset_chains(pdb_stream, keep_chains):
    out = []
    for line in pdb_stream.splitlines():
        if line.startswith(("ATOM", "HETATM")):
            chain = line[21].strip()
            if chain in keep_chains:
                out.append(line)
        elif line.startswith(("TER","END")):
            continue
    out.append("END")
    return "\n".join(out)

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--pdb", required=True)
    ap.add_argument("--chains", required=True, help="comma sep chain IDs, e.g., H,L or A")
    ap.add_argument("--out", required=True)
    args = ap.parse_args()

    keep = set([c.strip() for c in args.chains.split(",") if c.strip()])
    with open(args.pdb,"r") as f: pdb_txt = f.read()
    sub_txt = subset_chains(pdb_txt, keep)

    fixer = PDBFixer(pdbfile=StringIO(sub_txt))
    fixer.removeHeterogens(True)
    fixer.findMissingResidues()
    fixer.findMissingAtoms(); fixer.addMissingAtoms()
    fixer.addMissingHydrogens(pH=7.4)

    with open(args.out,"w") as out:
        PDBFile.writeFile(fixer.topology, fixer.positions, out, keepIds=True)
    print(f"[OK] Wrote {args.out}")

if __name__ == "__main__":
    main()
</code></pre>

      <h3>3) Dock externally (HADDOCK / ClusPro / Rosetta)</h3>
      <p class="muted">Generate <code>complex.pdb</code> with chains <strong>H,L</strong> (antibody) and <strong>A</strong> (antigen). Then score:</p>

      <h3>4) Score poses (MM/GBSA)</h3>
      <div class="row">
        <button class="btn" onclick="downloadFile('mmgbsa_openmm.py')">‚¨á Download mmgbsa_openmm.py</button>
        <button class="btn" onclick="copyTextFrom('mmgbsa-py')">üìã Copy</button>
      </div>
      <pre><code id="mmgbsa-py">#!/usr/bin/env python3
"""
Rigid complex energy + GBSA (OBC2) evaluation to estimate binding enthalpy-like term:

ŒîH_approx ‚âà ŒîE_MM + ŒîG_solv_GB  (potential + implicit-solvent polar + surface area)
ŒîG_binding ‚âà ŒîH_approx - TŒîS   (entropy default 0; add if available)

Input:
  --complex  complex.pdb      (Ab+Ag docked pose)
  --ab_chains H,L             (comma sep chain IDs for antibody)
  --ag_chains A               (comma sep chain IDs for antigen)

Output: CSV with energies (kcal/mol).

Requires: OpenMM >=8, PDBFixer, MDTraj, ParmEd.
"""
import argparse, io, numpy as np, mdtraj as md, pandas as pd
from openmm import unit, LangevinIntegrator, Platform
from openmm.app import PDBFile, Modeller, ForceField, Simulation, NoCutoff
from pdbfixer import PDBFixer

def select_chains(top, chain_ids):
    idx = [c.index for c in top.chains if c.chain_id in chain_ids]
    atom_idx = [a.index for a in top.atoms if a.residue.chain.index in idx]
    return atom_idx

def build_system(pdb, implicit=True):
    ff = ForceField("amber14-all.xml","implicit/gbsa_obc2.xml") if implicit else ForceField("amber14-all.xml")
    modeller = Modeller(pdb.topology, pdb.positions)
    system = ff.createSystem(modeller.topology, nonbondedMethod=NoCutoff if implicit else None,
                             constraints=None, removeCMMotion=True)
    return modeller, system

def energy_kcal(system, modeller, minimize=True):
    integrator = LangevinIntegrator(300*unit.kelvin, 1.0/unit.picosecond, 0.004*unit.picoseconds)
    sim = Simulation(modeller.topology, system, integrator, Platform.getPlatformByName("Reference"))
    sim.context.setPositions(modeller.positions)
    if minimize: sim.minimizeEnergy(maxIterations=200)
    E = sim.context.getState(getEnergy=True).getPotentialEnergy().value_in_unit(unit.kilocalories_per_mole)
    return E

def split_components(traj, ab_chains, ag_chains):
    top = traj.topology
    ab_idx = select_chains(top, set(ab_chains))
    ag_idx = select_chains(top, set(ag_chains))
    complex_pdb = PDBFile(io.StringIO(traj.to_pdb_string()))
    ab_pdb = PDBFile(io.StringIO(traj.atom_slice(ab_idx).to_pdb_string()))
    ag_pdb = PDBFile(io.StringIO(traj.atom_slice(ag_idx).to_pdb_string()))
    return complex_pdb, ab_pdb, ag_pdb

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("--complex", required=True)
    ap.add_argument("--ab_chains", required=True)
    ap.add_argument("--ag_chains", required=True)
    ap.add_argument("--temp", type=float, default=300.0)
    ap.add_argument("--entropy", type=float, default=0.0, help="TŒîS (kcal/mol) if you have it")
    args = ap.parse_args()

    ab_ch = [c.strip() for c in args.ab_chains.split(",") if c.strip()]
    ag_ch = [c.strip() for c in args.ag_chains.split(",") if c.strip()]

    traj = md.load(args.complex)
    complex_pdb, ab_pdb, ag_pdb = split_components(traj, ab_ch, ag_ch)

    m_c, s_c = build_system(complex_pdb, implicit=True)
    m_a, s_a = build_system(ab_pdb, implicit=True)
    m_b, s_b = build_system(ag_pdb, implicit=True)

    Ec = energy_kcal(s_c, m_c, minimize=True)
    Ea = energy_kcal(s_a, m_a, minimize=True)
    Eb = energy_kcal(s_b, m_b, minimize=True)

    dH = Ec - (Ea + Eb)
    dG = dH - args.entropy

    import csv
    with open("mmgbsa_result.csv","w",newline="") as f:
        w = csv.DictWriter(f, fieldnames=["E_complex_kcal","E_ab_kcal","E_ag_kcal","DeltaH_approx_kcal","T_deltaS_input_kcal","DeltaG_est_kcal","Temp_K"])
        w.writeheader()
        w.writerow({"E_complex_kcal":Ec,"E_ab_kcal":Ea,"E_ag_kcal":Eb,"DeltaH_approx_kcal":dH,"T_deltaS_input_kcal":args.entropy,"DeltaG_est_kcal":dG,"Temp_K":args.temp})
    print(f"E_complex={Ec:.2f}  E_ab={Ea:.2f}  E_ag={Eb:.2f}  ŒîH‚âà{dH:.2f} kcal/mol  ŒîG‚âà{dG:.2f} (TŒîS={args.entropy:.2f})")
    print("[NOTE] This ŒîH-like term is MM + GBSA at minimized geometry; average over MD frames + add entropy for robust ŒîG.")

if __name__ == "__main__":
    main()
</code></pre>

      <h3>5) (Optional) Helper script</h3>
      <div class="row">
        <button class="btn" onclick="downloadFile('run_example.sh')">‚¨á Download run_example.sh</button>
        <button class="btn" onclick="copyTextFrom('run-sh')">üìã Copy</button>
      </div>
      <pre><code id="run-sh">#!/usr/bin/env bash
set -e
# 1) Create env:
#    conda env create -f environment.yml
#    conda activate abdock
#
# 2) Prepare structures:
#    python prepare_structures.py --pdb antibody_raw.pdb --chains H,L --out antibody_clean.pdb
#    python prepare_structures.py --pdb antigen_raw.pdb  --chains A   --out antigen_clean.pdb
#
# 3) Dock externally (HADDOCK/ClusPro/Rosetta) ‚Üí complex.pdb with chains H,L (Ab) and A (Ag)
#
# 4) MM/GBSA on the pose:
#    python mmgbsa_openmm.py --complex complex.pdb --ab_chains H,L --ag_chains A --temp 300 --entropy 0
#
# Output: mmgbsa_result.csv with ŒîH_approx and ŒîG_est (kcal/mol).
</code></pre>
      <p class="small">Tip: Commit this index.html alone; users can download all files from this page.</p>
    </div>

    <div class="card">
      <h2>Why this approach? <a class="anchor" href="#why">#</a></h2>
      <ul>
        <li><strong>Fast ranking:</strong> score many poses quickly with MM/GBSA (OBC2).</li>
        <li><strong>Flexible:</strong> use any docking engine (HADDOCK, ClusPro-Ab, RosettaDock/SnugDock).</li>
        <li><strong>Extensible:</strong> add MD sampling + entropy for stronger ŒîG estimates.</li>
      </ul>
      <details open>
        <summary>TL;DR</summary>
        <p>Dock Ab‚ÄìAg ‚Üí minimize ‚Üí compute ŒîE_MM + GBSA. For robust ŒîG, average over MD snapshots and add TŒîS (quasi-harmonic/normal-mode).</p>
      </details>
    </div>
  </div>
</section>

<section id="files">
  <div class="wrap">
    <div class="card">
      <h2>Repository Layout <a class="anchor" href="#files">#</a></h2>
      <ul>
        <li><code>environment.yml</code> ‚Äî conda env (OpenMM, PDBFixer, MDTraj, ParmEd)</li>
        <li><code>prepare_structures.py</code> ‚Äî trim/clean PDBs (chains, add atoms/H)</li>
        <li><code>mmgbsa_openmm.py</code> ‚Äî ŒîH<sub>approx</sub> & ŒîG<sub>est</sub> from a docked pose</li>
        <li><code>run_example.sh</code> ‚Äî quick how-to</li>
      </ul>
      <details>
        <summary>Assumptions</summary>
        <ul>
          <li>Antibody chains labeled <code>H,L</code>; antigen <code>A</code> in <code>complex.pdb</code>.</li>
          <li>Implicit solvent GBSA-OBC2; no PME (NoCutoff) for speed.</li>
          <li>Enthalpy-like estimate at minimized geometry; improve with MD sampling + entropy.</li>
        </ul>
      </details>
    </div>
  </div>
</section>

<section id="advanced">
  <div class="wrap grid">
    <div class="card">
      <h2>Advanced: Batch & MD Sampling <a class="anchor" href="#advanced">#</a></h2>
      <h3>Batch score multiple poses</h3>
      <pre><code>for f in poses/*.pdb; do
  python mmgbsa_openmm.py --complex "$f" --ab_chains H,L --ag_chains A --temp 300 --entropy 0
  awk 'NR==2{print FILENAME, $4, $6}' mmgbsa_result.csv
done | sort -k2,2n</code></pre>

      <h3>Framewise averaging (pseudo-workflow)</h3>
      <pre><code># (1) Minimize & equilibrate in OpenMM
# (2) 1‚Äì5 ns restrained MD; save 100‚Äì500 frames
# (3) For each frame ‚Üí compute ŒîH_approx; average ¬± SE
# (4) Estimate entropy (quasi-harmonic/normal-mode) and subtract TŒîS for ŒîG</code></pre>
    </div>

    <div class="card">
      <h2>Notes on Ab Docking <a class="anchor" href="#advanced2">#</a></h2>
      <ul>
        <li>Model multiple CDR-H3 conformers (IgFold/ABodyBuilder2/RosettaAntibody) and dock each.</li>
        <li>Use the correct antigen oligomer (e.g., TL1A trimer) for neutralization.</li>
        <li>Refine top clusters (Rosetta SnugDock / HADDOCK water-refine) before scoring.</li>
      </ul>
    </div>
  </div>
</section>

<section id="faq">
  <div class="wrap grid">
    <div class="card">
      <h2>FAQ <a class="anchor" href="#faq">#</a></h2>
      <h3>Which docking engine?</h3>
      <p>HADDOCK (restraints), ClusPro-Ab (antibody mode), RosettaDock/SnugDock (refinement). Global‚Üílocal works well.</p>
      <h3>What about entropy?</h3>
      <p>Default is 0. Add quasi-harmonic (from MD covariance) or normal-mode to estimate TŒîS ‚Üí ŒîG.</p>
    </div>
    <div class="card">
      <h2>License <a class="anchor" href="#license">#</a></h2>
      <p class="muted">MIT License (replace owner/year in your repo LICENSE):</p>
      <pre><code>MIT License
Copyright (c) 2025 Your Name
Permission is hereby granted, free of charge, to any person obtaining a copy...
</code></pre>
    </div>
  </div>
</section>

<footer>
  One-file site for reproducible Ab‚ÄìAg docking/energy workflows. Questions? Open an issue on your GitHub repo.
</footer>

<script>
  // Map file names to code block IDs
  const files = {
    "environment.yml": "env-yml",
    "prepare_structures.py": "prep-py",
    "mmgbsa_openmm.py": "mmgbsa-py",
    "run_example.sh": "run-sh"
  };

  function copyTextFrom(id){
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.innerText;
    navigator.clipboard.writeText(text).then(()=>{
      toast("Copied to clipboard");
    });
  }

  function downloadFile(name){
    const id = files[name];
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.innerText;
    const blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // tiny toast
  let toastTimer;
  function toast(msg){
    clearTimeout(toastTimer);
    let t = document.getElementById("toast");
    if(!t){
      t = document.createElement("div");
      t.id = "toast";
      t.style.position="fixed"; t.style.zIndex=9999; t.style.left="50%"; t.style.bottom="24px";
      t.style.transform="translateX(-50%)"; t.style.padding="10px 14px";
      t.style.background="#0b1220"; t.style.color="#e5e7eb"; t.style.border="1px solid #1f2937";
      t.style.borderRadius="10px"; t.style.boxShadow="0 4px 22px rgba(0,0,0,.25)";
      document.body.appendChild(t);
    }
    t.textContent = msg; t.style.opacity=1;
    toastTimer = setTimeout(()=>{ t.style.opacity=0; }, 1200);
  }
</script>
</body>
</html>
